<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üèÅ Winners ‚Äî Live View</title>
  <style>
    :root { --green:#39ff14; --border:#0f2510; --ink:#e5ffe5; --bg:#000; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--green); font-family: ui-sans-serif,system-ui,Arial,Helvetica,sans-serif; }
    .wrap{ max-width:980px; margin:16px auto 64px; padding:0 16px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; border:1px solid var(--border);
      padding:10px 12px; border-radius:12px; background:rgba(7,7,7,.6); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .btn{
      border:1px solid var(--green); color:var(--green); text-decoration:none; padding:8px 12px;
      border-radius:10px; display:inline-flex; align-items:center; gap:8px; background:transparent; cursor:pointer;
    }
    .muted{ color:var(--ink); opacity:.8 }
    .badge{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; }
    .live{ display:inline-flex; gap:6px; align-items:center }
    .dot{ width:8px; height:8px; border-radius:999px; background:#39ff14; box-shadow:0 0 10px #39ff14 }
    .grid{ margin-top:16px; display:grid; grid-template-columns:1fr; gap:12px; }
    .card{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(7,7,7,.6); }
    .hero{ aspect-ratio:16/9; width:100%; display:block; }
    .hero.red{ background: repeating-linear-gradient(45deg, #3a0000 0, #3a0000 12px, #5a0000 12px, #5a0000 24px), #a60000; }
    .hero.blue{ background: repeating-linear-gradient(45deg, #001c3a 0, #001c3a 12px, #00325a 12px, #00325a 24px), #0058a6; }
    .meta{ padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .rowhead{ display:grid; grid-template-columns: 140px 1fr 1fr; gap:10px; padding:10px; background:rgba(7,7,7,.4); font-weight:700 }
    .rowitem{ display:grid; grid-template-columns: 140px 1fr 1fr; gap:10px; padding:10px; border-top:1px solid #0b1c0b; align-items:center }
    .chip{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; }
    .empty{ opacity:.7; padding:16px; border:1px dashed var(--border); border-radius:12px; text-align:center }
    a{ color:#9ae6b4; text-decoration:none } a:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <h1 style="margin:0">üèÅ Winners</h1>
        <div class="badge live"><span class="dot"></span><span id="liveStatus">listening‚Ä¶</span></div>
        <div class="muted" id="lastUpdated">‚Äî</div>
      </div>
      <div class="row">
        <a class="btn" href="matchup.html">‚Üê Back to Matchup</a>
        <a class="btn" href="winners_test.html" target="_blank" rel="noopener">üìù Test Log</a>
        <button id="btnClear" class="btn">üßπ Clear</button>
      </div>
    </header>

    <div id="content" class="grid"></div>
  </div>

  <script>
    const winnersKey = 'rs_winners_v1';
    const pingKey    = 'rs_winners_ping_v1';   // fire-and-forget ping to wake listeners
    const MAX_ROWS   = 100;                     // display cap
    let   lastJSON   = null;                    // change detection for polling

    function readWinners(){
      try{ return JSON.parse(localStorage.getItem(winnersKey) || '[]') }catch{ return [] }
    }
    function clearWinners(){
      if (!confirm('Clear local winners history?')) return;
      localStorage.removeItem(winnersKey);
      localStorage.setItem(pingKey, String(Date.now())); // notify other tabs
      render();
    }
    function fmt(ts){ return new Date(ts).toLocaleString(); }

    function winnerCard(w){
      const card = document.createElement('div'); card.className='card';
      const hero = document.createElement('div'); hero.className='hero ' + (w.color==='red' ? 'red' : 'blue');
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div><b>${w.name}</b> won<br><span class="muted">${fmt(w.ts)}</span></div>
                        <div><span class="chip">#${w.id}</span></div>`;
      card.append(hero, meta);
      return card;
    }
    function listTable(rows){
      const box = document.createElement('div'); box.className='list';
      const head= document.createElement('div'); head.className='rowhead';
      head.innerHTML = `<div>When</div><div>Winner</div><div>Color</div>`;
      box.append(head);
      rows.forEach(r=>{
        const row = document.createElement('div'); row.className='rowitem';
        row.innerHTML = `<div>${new Date(r.ts).toLocaleTimeString()}</div>
                         <div>${r.name}</div>
                         <div><span class="chip">${r.color.toUpperCase()}</span></div>`;
        box.append(row);
      });
      return box;
    }

    function render(){
      const root = document.getElementById('content');
      root.innerHTML = '';
      const winners = readWinners();
      lastJSON = JSON.stringify(winners);

      if (!winners.length){
        const empty = document.createElement('div'); empty.className='empty';
        empty.textContent = 'No winners yet. Keep Matchup running (or open Test Log).';
        root.append(empty);
      } else {
        root.append(winnerCard(winners[0]));
        root.append(listTable(winners.slice(0, MAX_ROWS)));
      }
      document.getElementById('lastUpdated').textContent = 'Last update: ' + new Date().toLocaleTimeString();
    }

    // react instantly when another tab writes a result
    window.addEventListener('storage', (e)=>{
      if (e.key === winnersKey || e.key === pingKey) render();
    });

    // light polling as a safety net (background throttling is real on mobile)
    setInterval(()=>{
      const nowJSON = localStorage.getItem(winnersKey);
      if (nowJSON !== lastJSON){
        render();
      }
    }, 2000);

    document.getElementById('btnClear').addEventListener('click', clearWinners);
    render();
    document.getElementById('liveStatus').textContent = 'live';
  </script>
</body>
</html>