<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Winners Test — Zero Log</title>
  <style>
    :root { color-scheme: dark; }
    html,body { height:100%; margin:0; font-family: system-ui, Arial, sans-serif; background:#0b0b0b; color:#fff; }
    .page { min-height:100%; display:grid; grid-template-rows:auto 1fr; }
    header { padding:14px 16px; border-bottom:1px solid #222; }
    h1 { font-size:20px; margin:0; }
    .muted { opacity:.75; font-size:12px; }
    main { padding:16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button { background:#161616; color:#fff; border:1px solid #333; border-radius:10px; padding:8px 12px; cursor:pointer; }
    button:hover { background:#1f1f1f; }
    .panel { border:1px solid #222; border-radius:14px; padding:12px; background:#0f0f0f; max-width:900px; margin:0 auto; }
    .list { margin-top:8px; border-top:1px solid #222; }
    .item { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; padding:10px 6px; border-bottom:1px solid #1a1a1a; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px; }
    .head { font-weight:700; opacity:.9; }
    .empty { padding:10px 6px; opacity:.7; }
    a { color:#9ae6b4; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="page">
    <header>
      <h1>Winners Test — Zero Log</h1>
      <div class="muted">Centralized record of each countdown rollover to 0 (from your matchup page).</div>
    </header>

    <main>
      <div class="panel">
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button id="btnRefresh">Refresh</button>
            <button id="btnExport">Export CSV</button>
          </div>
          <div class="row">
            <a href="matchup.html" target="_blank"><button>Open matchup</button></a>
          </div>
        </div>

        <div class="list" id="list"></div>
      </div>
    </main>
  </div>

  <script>
    const SUPABASE_URL  = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const listEl = document.getElementById('list');

    function rowEl(idx, r) {
      const div = document.createElement('div');
      div.className = 'item';
      const idCell  = document.createElement('div');
      const recCell = document.createElement('div');
      const rollCell= document.createElement('div');
      idCell.textContent  = `#${idx.toString().padStart(2,'0')} — ${r.source || 'matchup'}`;
      recCell.textContent = new Date(r.recorded_at).toLocaleString();
      rollCell.textContent= r.rollover_at ? new Date(r.rollover_at).toLocaleString() : '—';
      div.append(idCell, recCell, rollCell);
      return div;
    }

    function headerEl() {
      const div = document.createElement('div');
      div.className = 'item head';
      div.innerHTML = `<div>id / source</div><div>recorded_at (local)</div><div>rollover_at (local)</div>`;
      return div;
    }

    function renderList(rows) {
      listEl.innerHTML = '';
      if (!rows.length) {
        const d = document.createElement('div');
        d.className = 'empty';
        d.textContent = 'No rollovers yet.';
        listEl.appendChild(d);
        return;
      }
      listEl.appendChild(headerEl());
      rows.forEach((r, i) => listEl.appendChild(rowEl(i+1, r)));
    }

    async function fetchRows() {
      const { data, error } = await supabase
        .from('zero_rollovers')
        .select('*')
        .order('recorded_at', { ascending: false })
        .limit(500);
      if (error) { console.error(error); return []; }
      return data || [];
    }

    function exportCSV(rows){
      const header = ['id','source','recorded_at_iso','recorded_at_local','rollover_at_iso','rollover_at_local','phase_end_at_iso'];
      const lines = [header.join(',')];
      rows.slice().reverse().forEach(r =>{
        const recLocal = new Date(r.recorded_at).toLocaleString();
        const rollLocal= r.rollover_at ? new Date(r.rollover_at).toLocaleString() : '';
        lines.push([
          r.id, r.source || '', r.recorded_at, recLocal, r.rollover_at || '', rollLocal, r.phase_end_at || ''
        ].map(v => `"${String(v ?? '').replace(/"/g,'""')}"`).join(','));
      });
      const blob = new Blob([lines.join('\n')], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'zero_rollovers.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // live updates
    function subscribe(){
      supabase
        .channel('zero_rollovers_live')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'zero_rollovers' }, async () => {
          const rows = await fetchRows();
          renderList(rows);
        })
        .subscribe();
    }

    document.getElementById('btnRefresh').addEventListener('click', async ()=>{
      const rows = await fetchRows(); renderList(rows);
    });
    document.getElementById('btnExport').addEventListener('click', async ()=>{
      const rows = await fetchRows(); exportCSV(rows);
    });

    (async ()=>{
      const rows = await fetchRows();
      renderList(rows);
      subscribe();
    })();
  </script>
</body>
</html>