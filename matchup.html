<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rage Space ‚Äî Matchup</title>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{
  --green:#39ff14; --green-bright:#7dff62;
  --bg:#000; --ink:#e5e5e5;
  --card:#0b0b0b; --border:#153b16; --muted:#8aff8a; --maxw:980px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--green);font-family:system-ui,Arial,Helvetica,sans-serif}
.wrap{max-width:var(--maxw);margin:16px auto 64px;padding:0 16px}

/* top controls */
.scorebar{
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  border:1px solid var(--border); padding:12px; border-radius:12px; background:rgba(7,7,7,.6); flex-wrap:wrap
}
.btn{border:1px solid var(--green);color:var(--green);background:transparent;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn:hover{box-shadow:0 0 12px rgba(57,255,20,.18)}
.tiny{display:flex;gap:8px;align-items:center;font-variant-numeric:tabular-nums;font-size:12px;color:var(--muted)}
.clock{font-weight:700;border:1px solid var(--border);border-radius:8px;padding:2px 8px}

/* tiles */
.tile{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(7,7,7,.6);margin-top:16px}
.art{aspect-ratio:4/3;width:100%}
.art.red{background:#a60000}
.art.blue{background:#0058a6}
.caption{display:block;text-align:center;font-size:12px;color:var(--muted);padding:6px 8px;border-top:1px dashed var(--border)}
.meta{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-top:1px solid var(--border)}
.btn.primary.selected{background:rgba(57,255,20,.22);color:var(--ink);box-shadow:0 0 18px rgba(125,255,98,.35), inset 0 0 12px rgba(57,255,20,.15)}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:14px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#071c07;color:var(--green);border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:none;box-shadow:0 0 18px rgba(57,255,20,.18)}
.toast.show{display:block}
.badge{border:1px solid var(--border);border-radius:8px;padding:2px 8px}
.badge.warn{border-color:#3b1616;color:#ff6b6b}
.badge.ok{border-color:#153b16;color:#8aff8a}

/* === DEBUG overlay styles === */
#dbgBtn{position:fixed;right:14px;bottom:18px;z-index:9999;border:1px solid #39ff14;background:#071c07;color:#39ff14;border-radius:10px;padding:10px 12px}
#dbg{display:none;position:fixed;inset:auto 8px 68px 8px;z-index:9998;background:#000;border:1px solid #153b16;border-radius:12px;box-shadow:0 0 18px rgba(57,255,20,.18)}
#dbg[data-open="1"]{display:block}
#dbg h3{margin:8px 10px;font:700 14px/1.2 system-ui;color:#7dff62}
#dbg pre{margin:6px 10px 12px;padding:8px;border:1px dashed #153b16;border-radius:8px;max-height:38vh;overflow:auto;color:#8aff8a;background:#060}
#dbg .row{display:flex;gap:8px;flex-wrap:wrap;margin:0 10px 10px}
#dbg .pill{border:1px solid #39ff14;color:#39ff14;background:transparent;border-radius:999px;padding:8px 12px}
</style>
</head>

<body>
  <div class="wrap">
    <!-- top controls bar -->
    <div class="scorebar">
      <div class="tiny">
        <strong>Decision in</strong>
        <span id="clock" class="clock">Sync‚Ä¶</span>
        <span id="state" class="clock">‚Äî</span>
        <span id="phaseKey" class="clock">phase: ‚Äî</span>
        <span id="loginBadge" class="badge">checking auth‚Ä¶</span>
      </div>
      <div class="row">
        <button id="btnPause" class="btn">‚è∏Ô∏è Pause</button>
        <button id="btnForce" class="btn">üèÅ Force Decide</button>
        <a class="btn" href="./winners.html">üèÅ Winners</a>
      </div>
    </div>

    <!-- RED -->
    <div class="tile">
      <div class="art red"></div>
      <div class="caption" id="redCount">0 votes</div>
      <div class="meta">
        <span>Entry ‚Äî RED</span>
        <button class="btn primary" id="voteRed">Vote Red</button>
      </div>
    </div>

    <!-- BLUE -->
    <div class="tile">
      <div class="art blue"></div>
      <div class="caption" id="blueCount">0 votes</div>
      <div class="meta">
        <span>Entry ‚Äî BLUE</span>
        <button class="btn primary" id="voteBlue">Vote Blue</button>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="submitBtn" disabled>‚úÖ Submit Vote</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Debug overlay (shows when URL has ?debug=1) -->
  <button id="dbgBtn" style="display:none">üîé Debug</button>
  <div id="dbg" aria-live="polite">
    <h3>RageSpace ‚Äî Debug</h3>
    <div class="row">
      <button class="pill" id="dbgRefresh">Refresh Stats</button>
      <button class="pill" id="dbgTestInsert">Test Insert</button>
      <button class="pill" id="dbgClear">Clear</button>
    </div>
    <pre id="dbgOut"></pre>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer`;

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   DOM
========================= */
const clockEl = document.getElementById('clock');
const stateEl = document.getElementById('state');
const phaseBadge = document.getElementById('phaseKey');
const loginBadge = document.getElementById('loginBadge');

const pauseBtn = document.getElementById('btnPause');
const forceBtn = document.getElementById('btnForce');

const voteRedBtn  = document.getElementById('voteRed');
const voteBlueBtn = document.getElementById('voteBlue');
const submitBtn   = document.getElementById('submitBtn');

const redCountEl  = document.getElementById('redCount');
const blueCountEl = document.getElementById('blueCount');
const toastEl     = document.getElementById('toast');

function toast(msg, ms=1600){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }
const toIso = (d)=> new Date(d).toISOString();

/* =========================
   STATE
========================= */
let rafId = null;
let paused = false;
let remainingSec = null;
let serverPhaseEndISO = null;
let lastSyncAt = 0;
let lastCountsAt = 0;
let chosen = null; // 'red'|'blue'|null
let lastFinishedKey = null;
let currentUid = null; // logged-in user id or null

// Expose for debug overlay
window.paused = paused;
window.remainingSec = remainingSec;
window.serverPhaseEndISO = serverPhaseEndISO;

/* =========================
   AUTH (no anonymous)
========================= */
async function getUidOrNull() {
  const { data: { session } } = await supabase.auth.getSession();
  return session?.user?.id ?? null;
}
function paintLoginBadge() {
  if (currentUid) {
    loginBadge.textContent = "logged in";
    loginBadge.classList.remove('warn'); loginBadge.classList.add('ok');
  } else {
    loginBadge.textContent = "not logged in";
    loginBadge.classList.remove('ok'); loginBadge.classList.add('warn');
  }
}

/* =========================
   EDGE CALLS
========================= */
async function callEdge(method='GET', body=null){
  const res = await fetch(EDGE_URL, {
    method,
    headers: {
      'Content-Type':'application/json',
      'Authorization':`Bearer ${SUPABASE_ANON_KEY}`,
      'apikey': SUPABASE_ANON_KEY
    },
    body: body ? JSON.stringify(body) : null
  });
  const raw = await res.text();
  let j=null; try{ j=JSON.parse(raw); }catch{}
  if(!res.ok) throw new Error((j && j.error) || raw || 'edge error');
  return j?.state || j || {};
}
const normalize = (s)=>({
  phase_end_at: s.phase_end_at ?? null,
  period_sec: s.period_sec ?? 10,
  paused: !!s.paused,
  remaining_sec: (typeof s.remaining_sec === 'number') ? s.remaining_sec : null
});

/* =========================
   VOTE COUNTS
========================= */
const fmtVotes = (n)=> `${n} ${n===1?'vote':'votes'}`;

async function refreshVoteCounts(){
  try{
    if(!serverPhaseEndISO) { redCountEl.textContent = '0 votes'; blueCountEl.textContent = '0 votes'; return; }
    const phaseKey = toIso(serverPhaseEndISO);
    const { data, error } = await supabase
      .from('phase_votes')
      .select('vote')
      .eq('phase_key', phaseKey);
    if (error) throw error;
    let r=0, b=0;
    (data||[]).forEach(row => { if(row.vote==='red') r++; else if(row.vote==='blue') b++; });
    redCountEl.textContent  = fmtVotes(r);
    blueCountEl.textContent = fmtVotes(b);
    lastCountsAt = Date.now();
  }catch(e){}
}

function showWinnerBanner(color){ toast(`üèÅ ${color.toUpperCase()} won!`); }
async function pollWinnerForKey(key){
  try{
    const { data } = await supabase.from('winners').select('color').eq('phase_key', toIso(key)).limit(1);
    const c = (data?.[0]?.color||'').toLowerCase();
    if (c==='red' || c==='blue') showWinnerBanner(c);
  }catch(e){}
}

/* =========================
   PHASE & CLOCK
========================= */
function setStateUI(){
  stateEl.textContent = paused ? 'PAUSED' : 'LIVE';
  pauseBtn.textContent = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
  phaseBadge.textContent = 'phase: ' + (serverPhaseEndISO || '‚Äî');
}

async function fetchState(){
  const s = normalize(await callEdge('GET'));
  const prev = serverPhaseEndISO;

  serverPhaseEndISO = s.phase_end_at;
  paused = s.paused;
  remainingSec = s.remaining_sec;
  lastSyncAt = Date.now();

  // update globals for debug overlay
  window.paused = paused;
  window.remainingSec = remainingSec;
  window.serverPhaseEndISO = serverPhaseEndISO;

  setStateUI();

  // phase rolled
  if (prev && serverPhaseEndISO && prev !== serverPhaseEndISO) {
    lastFinishedKey = toIso(prev);
    chosen = null;
    voteRedBtn.classList.remove('selected');
    voteBlueBtn.classList.remove('selected');
    submitBtn.textContent = '‚úÖ Submit Vote';
    submitBtn.disabled = true;
    redCountEl.textContent = '0 votes';
    blueCountEl.textContent = '0 votes';
    pollWinnerForKey(lastFinishedKey);
  } else {
    submitBtn.disabled = !chosen || !currentUid;
  }

  refreshVoteCounts();
}

function stop(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; }

async function start(){
  stop();
  const tick = async ()=>{
    if (paused){
      const remCalc = serverPhaseEndISO ? Math.max(0, Date.parse(serverPhaseEndISO) - Date.now()) : 0;
      const sec = (typeof remainingSec === 'number' && !Number.isNaN(remainingSec))
        ? Number(remainingSec)
        : Math.ceil(remCalc/1000);
      clockEl.textContent = String(Math.max(0, Math.ceil(sec)));
      if (Date.now() - lastSyncAt > 5000) { try{ await fetchState(); }catch{} }
    } else {
      const rem = Math.max(0, Date.parse(serverPhaseEndISO) - Date.now());
      clockEl.textContent = String(Math.ceil(rem/1000));
      if (rem <= 0 || Date.now()-lastSyncAt > 5000) { try{ await fetchState(); }catch{} }
      if (Date.now() - lastCountsAt > 2000) refreshVoteCounts();
    }
    rafId = requestAnimationFrame(tick);
  };
  rafId = requestAnimationFrame(tick);
}

/* =========================
   CONTROLS & VOTING
========================= */
pauseBtn.onclick = async ()=>{ try{
  if (paused) await callEdge('POST',{action:'resume'}); else await callEdge('POST',{action:'pause'});
  await fetchState();
}catch(e){ toast('Pause/resume failed'); }};

forceBtn.onclick = async ()=>{ try{
  await callEdge('POST',{force:true}); await fetchState(); toast('Forced decision');
}catch(e){ toast('Force failed'); }};

voteRedBtn.onclick  = ()=>{ chosen='red';  voteRedBtn.classList.add('selected');  voteBlueBtn.classList.remove('selected'); submitBtn.disabled = !currentUid; if(!currentUid) toast('Log in to vote'); };
voteBlueBtn.onclick = ()=>{ chosen='blue'; voteBlueBtn.classList.add('selected'); voteRedBtn.classList.remove('selected');  submitBtn.disabled = !currentUid; if(!currentUid) toast('Log in to vote'); };

submitBtn.onclick = async ()=>{
  if (!chosen || !serverPhaseEndISO) return;
  if (!currentUid) { toast('Log in to vote'); return; }
  try{
    const phaseKey = toIso(serverPhaseEndISO);

    const { error } = await supabase
      .from('phase_votes')
      .upsert({ phase_key: phaseKey, vote: chosen, user_id: currentUid }, { onConflict:'phase_key,user_id' });

    if (error) throw error;
    toast(`Voted ${chosen.toUpperCase()}`);
    submitBtn.textContent = '‚úî Voted';
    submitBtn.disabled = true;
    refreshVoteCounts();
  }catch(e){
    console.error('VOTE ERROR:', e);
    if (window.RSDBG) RSDBG.out('VOTE ERROR', e?.message || e);
    toast('Vote failed');
  }
};

/* =========================
   REALTIME (optional)
========================= */
supabase.channel('winners-phase')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'winners'}, (payload)=>{
    const rowKey = payload?.new?.phase_key;
    const color  = (payload?.new?.color || '').toLowerCase();
    if (!rowKey || !lastFinishedKey) return;
    if (toIso(rowKey) === toIso(lastFinishedKey) && (color === 'red' || color === 'blue')) showWinnerBanner(color);
  })
  .subscribe();

supabase.channel('phase-votes-live')
  .on('postgres_changes',{event:'*',schema:'public',table:'phase_votes'}, async (payload)=>{
    try{
      const pk = payload?.new?.phase_key || payload?.old?.phase_key;
      if (!pk || !serverPhaseEndISO) return;
      if (toIso(pk) === toIso(serverPhaseEndISO)) await refreshVoteCounts();
    }catch(e){}
  })
  .subscribe();

/* =========================
   BOOT
========================= */
(async()=>{ try{
  // Get current login status (no anonymous sign-in)
  currentUid = await getUidOrNull();
  paintLoginBadge();

  // React to auth state changes (e.g., user logs in/out elsewhere)
  supabase.auth.onAuthStateChange(async (_evt, session) => {
    currentUid = session?.user?.id ?? null;
    paintLoginBadge();
    submitBtn.disabled = !chosen || !currentUid;
  });

  await fetchState();
  await start();
}catch(e){
  clockEl.textContent='ERR'; stateEl.textContent='ERR';
}})();

/* =========================
   MOBILE DEBUG OVERLAY
   Enable with ?debug=1 in the URL
========================= */
(function mobileDebug(){
  const params = new URLSearchParams(location.search);
  if (!params.has('debug')) return;

  const logEl = document.getElementById('dbgOut');
  const btn = document.getElementById('dbgBtn');
  const panel = document.getElementById('dbg');
  const btnRefresh = document.getElementById('dbgRefresh');
  const btnInsert = document.getElementById('dbgTestInsert');
  const btnClear = document.getElementById('dbgClear');

  const showBtn = ()=> btn.style.display = 'block';
  const toggle = ()=> panel.dataset.open = panel.dataset.open === '1' ? '0' : '1';
  const out = (label, obj) => {
    const time = new Date().toLocaleTimeString();
    const body = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    logEl.textContent = `[${time}] ${label}\n${body}\n\n` + logEl.textContent;
  };

  // global hook
  window.RSDBG = { out };

  // wrap existing functions to log
  if (typeof fetchState === 'function') {
    const orig = fetchState;
    window.fetchState = async function(){
      try {
        const r = await orig();
        RSDBG.out('fetchState ok', { phase_end_at: window.serverPhaseEndISO, paused: window.paused, remainingSec: window.remainingSec });
        return r;
      } catch(e) {
        RSDBG.out('fetchState error', e?.message || e);
        throw e;
      }
    }
  }
  if (typeof refreshVoteCounts === 'function') {
    const origC = refreshVoteCounts;
    window.refreshVoteCounts = async function(){
      try { await origC(); RSDBG.out('counts ok', {}); }
      catch(e){ RSDBG.out('counts error', e?.message || e); }
    }
  }

  btn.onclick = toggle;

  btnRefresh.onclick = async () => {
    try {
      const { data:{ session } } = await supabase.auth.getSession();
      const uid = session?.user?.id || null;
      RSDBG.out('auth session', session ? { uid, email: session.user.email || null } : 'NO SESSION');

      const sel = await supabase.from('phase_votes').select('vote', { count: 'exact', head: false }).limit(1);
      RSDBG.out('select phase_votes', sel.error ? sel.error : { rows: (sel.data||[]).length });

      RSDBG.out('phase+clock', {
        phase_end_at: window.serverPhaseEndISO || null,
        paused: window.paused || false,
        remainingSec: window.remainingSec ?? null
      });
    } catch(e) {
      RSDBG.out('dbgRefresh error', e?.message || e);
    }
  };

  btnInsert.onclick = async () => {
    try {
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session?.user?.id) {
        RSDBG.out('Test Insert', 'NO SESSION ‚Äî login required');
        return;
      }
      const uid = session.user.id;
      const pk = (window.serverPhaseEndISO ? new Date(window.serverPhaseEndISO).toISOString() : new Date().toISOString());
      const { error } = await supabase
        .from('phase_votes')
        .upsert({ phase_key: pk, vote: 'red', user_id: uid }, { onConflict: 'phase_key,user_id' });

      if (error) RSDBG.out('Test Insert ERROR', { message: error.message, details: error.details, hint: error.hint, code: error.code });
      else RSDBG.out('Test Insert OK', { phase_key: pk, user_id: uid });
    } catch(e) {
      RSDBG.out('Test Insert EXCEPTION', e?.message || e);
    }
  };

  btnClear.onclick = () => logEl.textContent = '';

  // show & open panel
  showBtn();
  setTimeout(() => { panel.dataset.open = '1'; }, 250);
})();
</script>
</body>
</html>