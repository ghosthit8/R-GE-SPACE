<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space — Matchup (32-up → 2-up)</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0f13; --accent:#39ff14; --muted:#8b8b8b; --card:#0f1318; --border:#20242a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:32px; line-height:1; padding:8px 14px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .state { color:var(--muted); font-size:12px; }

    .round-label { font-size:13px; color:var(--muted); }

    .card { margin-top:12px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--card); }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img, .imgBox video { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.55); color:var(--accent); border:1px solid var(--accent); border-radius:8px; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid var(--border); }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .btn, .vote, .linkbtn, .backbtn { appearance:none; border:1px solid #24303a; background:#131920; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }

    /* tiny AFK row under vote */
    .autoRow {
      display:flex;
      justify-content:flex-end;
      padding:0 12px 8px;
    }

    /* tiny AFK auto-vote button */
    .autoVoteBtn {
      padding: 2px 6px;
      font-size: 9px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      cursor: pointer;
      white-space: nowrap;
    }
    .autoVoteBtn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .navArrow {
      border: 1px solid var(--accent);
      background: rgba(0,0,0,0.45);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
    }
    .navArrow:disabled {
      opacity: .35;
      cursor: default;
    }

    .piece-meta {
      padding:6px 12px 10px;
      border-top:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
    }
    .piece-meta .piece-desc { white-space:pre-wrap; }
    .piece-meta .seeMoreBtn {
      margin-top:4px;
      font-size:11px;
      border-radius:999px;
      padding:3px 8px;
      border:1px solid var(--accent);
      background:transparent;
      color:var(--accent);
      cursor:pointer;
    }

    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card); cursor:pointer; position:relative; }
    .thumb.disabled { opacity:.55; cursor:default; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }

    .thumb-img {
      position:relative;
      width:100%;
      aspect-ratio:3/4;
      background:#0b0f13;
      overflow:hidden;
    }
    .thumb-img img,
    .thumb-img video {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-img.diag img.half,
    .thumb-img.diag video.half {
      position:absolute;
      inset:0;
    }
    .thumb-img.diag img.left,
    .thumb-img.diag video.left {
      clip-path:polygon(0 0, 100% 0, 0 100%);
    }
    .thumb-img.diag img.right,
    .thumb-img.diag video.right {
      clip-path:polygon(100% 0, 100% 100%, 0 100%);
    }
    .thumb-img.diag::before {
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:linear-gradient(135deg, rgba(0,0,0,0.75) 48%, rgba(57,255,20,0.7) 50%, rgba(0,0,0,0.75) 52%);
      mix-blend-mode:screen;
      opacity:0.5;
    }

    .video-badge {
      position:absolute;
      top:6px;
      left:6px;
      padding:2px 6px;
      font-size:9px;
      font-weight:700;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#0b0f13;
      background:var(--accent);
      border-radius:999px;
      box-shadow:0 0 8px rgba(57,255,20,.8);
      pointer-events:none;
      z-index:2;
    }

    .thumb-preview {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      z-index:3;
    }

    .thumb-label { padding:6px 8px 8px; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
    .thumb-count { font-variant-numeric: tabular-nums; font-weight:700; }
    .ghostBox { width:100%; height:100%; display:grid; place-items:center; color:#3b3b3b; font-weight:700; font-size:13px; letter-spacing:.08em; }

    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:#39ff14; }

    .final-card { margin-top:14px; }
    .final-inner { display:flex; gap:12px; flex-wrap:wrap; padding:12px; }
    .final-slot { flex:1 1 150px; background:#0b0f13; border:1px dashed var(--border); border-radius:10px; padding:8px; text-align:center; }
    .final-slot .label { display:block; margin-bottom:4px; }
    .final-slot .thumb-final { width:100%; aspect-ratio:3/4; background:#000; border-radius:8px; overflow:hidden; display:grid; place-items:center; position:relative; }
    .final-slot .thumb-final img,
    .final-slot .thumb-final video { width:100%; height:100%; object-fit:cover; }

    .final-footer { padding:0 12px 12px; font-size:12px; color:#9aa0a6; }

    .fullscreen-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:9999; }
    .fullscreen-overlay img,
    .fullscreen-overlay video { max-width:90%; max-height:90%; border-radius:8px; }
    .fullscreen-overlay button { position:absolute; top:20px; right:20px; background:#111; border:1px solid var(--accent); color:var(--accent); padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }

    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
    .hidden { display:none !important; }

    .artist-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
    }
    .artist-link:hover { text-decoration: underline; }

    </style>
</head>
<body>

<div class="wrap">
  <h1 class="glitch-title" data-text="ART BATTLE. Faction I.">ART BATTLE. Faction I.</h1>

  <div class="header">
    <div class="row">
      <div class="timer" id="tRemain">04:48:00</div>
      <div class="round-label" id="currentRound">Current round: —</div>
    </div>
    <div class="row">
      <a class="backbtn" href="menu.html">← Menu</a>
      <a class="linkbtn" href="winners.html">Winners</a>
      <button class="navArrow" id="prevMatch">⟨</button>
      <button class="navArrow" id="nextMatch">⟩</button>
    </div>
  </div>

  <!-- TOP CARD -->
  <div class="card" id="activeTop">
    <div class="imgBox">
      <img id="imgActive1" alt="Active top">
      <video id="vidActive1" class="hidden" muted playsinline loop controls></video>
      <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
    </div>
    <div class="bar">
      <div class="label" id="labelActive1">Top</div>
      <div class="counts" id="countActive1">0</div>
      <button class="vote" id="btnActive1">Vote</button>
    </div>
    <div class="autoRow">
      <button class="autoVoteBtn" id="autoActive1">vote this art for every round</button>
    </div>
    <div class="piece-meta hidden" id="metaActive1"></div>
  </div>

  <!-- BOTTOM CARD -->
  <div class="card" id="activeBottom">
    <div class="imgBox">
      <img id="imgActive2" alt="Active bottom">
      <video id="vidActive2" class="hidden" muted playsinline loop controls></video>
      <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
    </div>
    <div class="bar">
      <div class="label" id="labelActive2">Bottom</div>
      <div class="counts" id="countActive2">0</div>
      <button class="vote" id="btnActive2">Vote</button>
    </div>
    <div class="autoRow">
      <button class="autoVoteBtn" id="autoActive2">vote this art for every round</button>
    </div>
    <div class="piece-meta hidden" id="metaActive2"></div>
  </div>

  <!-- THUMBS -->
  <div class="thumbs-wrap">
    <div class="thumbs-title">Matches (tap to switch)</div>
    <div class="thumbs" id="thumbGrid"></div>
  </div>

  <div class="winner" id="winnerText">
    <b>First to 2 wins.</b> (Timer removed)
  </div>

  <!-- FINAL BOX -->
  <div class="card final-card" id="finalCard">
    <div class="bar">
      <div class="label">Final</div>
      <div style="font-size:12px;color:#a1a1a1;">Decides at 0s</div>
    </div>
    <div class="final-inner">
      <div class="final-slot">
        <span class="label" id="finalLeftLabel">Winner of Semi 1</span>
        <div class="thumb-final">
          <img id="finalImg1" alt="Final slot 1">
          <video id="finalVid1" class="hidden" muted playsinline loop controls></video>
        </div>
      </div>
      <div class="final-slot">
        <span class="label" id="finalRightLabel">Winner of Semi 2</span>
        <div class="thumb-final">
          <img id="finalImg2" alt="Final slot 2">
          <video id="finalVid2" class="hidden" muted playsinline loop controls></video>
        </div>
      </div>
    </div>
    <div class="final-footer" id="finalFooter">Waiting… (tap a card’s ⤢ for audio)</div>
  </div>

  <div class="hint">
    24-hour tournament: 32 images → R32 (first 4h48m) → R16 → QF → SF → Final (last 4h48m).
  </div>
</div>

<!-- FULLSCREEN OVERLAY -->
<div class="fullscreen-overlay" id="overlay">
  <button id="closeFull">✕ Close</button>
  <img id="fullImg" src=\"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=\">
  <video id="fullVideo" class="hidden" playsinline controls></video>
</div>

<script>
  const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const WIN_TO = 2;

  const currentRoundEl = document.getElementById("currentRound");
  const winnerText = document.getElementById("winnerText");

  const imgActive1 = document.getElementById("imgActive1");
  const imgActive2 = document.getElementById("imgActive2");
  const vidActive1 = document.getElementById("vidActive1");
  const vidActive2 = document.getElementById("vidActive2");
  const labelActive1 = document.getElementById("labelActive1");
  const labelActive2 = document.getElementById("labelActive2");
  const countActive1 = document.getElementById("countActive1");
  const countActive2 = document.getElementById("countActive2");
  const btnActive1 = document.getElementById("btnActive1");
  const btnActive2 = document.getElementById("btnActive2");

  const overlay  = document.getElementById("overlay");
  const fullImg  = document.getElementById("fullImg");
  const fullVideo = document.getElementById("fullVideo");
  const btnClose = document.getElementById("closeFull");

  const grid = document.getElementById("thumbGrid");
  const prevBtn = document.getElementById("prevMatch");
  const nextBtn = document.getElementById("nextMatch");

  btnClose.onclick = ()=>{
    overlay.style.display='none';
    try {
      fullVideo.pause();
      fullVideo.removeAttribute('src');
      fullVideo.load();
    } catch(e){}
  };

  function isVideoUrl(url){
    if (typeof url !== "string") return false;
    const base = url.split("#")[0];
    return /\.(mp4|webm|mov)(\?|$)/i.test(base);
  }

  window.openFull = function(which){
    let url = "";
    if (which==="active1"){
      if (!vidActive1.classList.contains("hidden") && vidActive1.src) url = vidActive1.src;
      else url = imgActive1.src;
    } else if (which==="active2"){
      if (!vidActive2.classList.contains("hidden") && vidActive2.src) url = vidActive2.src;
      else url = imgActive2.src;
    }
    if (!url) return;

    const video = isVideoUrl(url);
    if (video){
      fullImg.classList.add("hidden");
      fullVideo.classList.remove("hidden");
      fullVideo.src = url;
      try { fullVideo.play().catch(()=>{}); } catch(e){}
    } else {
      fullVideo.classList.add("hidden");
      try { fullVideo.pause(); fullVideo.removeAttribute("src"); fullVideo.load(); } catch(e){}
      fullImg.classList.remove("hidden");
      fullImg.src = url;
    }
    overlay.style.display = 'flex';
  }

  function placeholder(letter){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960">
      <rect width="100%" height="100%" fill="#000"/>
      <text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace"
        text-anchor="middle" dominant-baseline="middle">${letter}</text>
    </svg>`;
    return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
  }

  function setMedia(slot, url){
    const img = (slot===1)?imgActive1:imgActive2;
    const vid = (slot===1)?vidActive1:vidActive2;

    if (isVideoUrl(url)){
      img.classList.add("hidden");
      vid.classList.remove("hidden");
      vid.src = url;
      vid.load();
      try { vid.play().catch(()=>{}); } catch(e){}
    } else {
      vid.classList.add("hidden");
      try { vid.pause(); vid.removeAttribute("src"); vid.load(); } catch(e){}
      img.classList.remove("hidden");
      img.src = url;
    }
  }

  function seedKeys(){
    // a..z then aa..af (32)
    const single = Array.from({length:26}, (_,i)=>String.fromCharCode(97+i));
    const double = ['aa','ab','ac','ad','ae','af'];
    return single + double;
  }

  function buildSeedUrls(cycleRow){
    const keys = [];
    for (let i=0;i<26;i++) keys.push(String.fromCharCode(97+i));
    keys.push('aa','ab','ac','ad','ae','af');

    const urls = [];
    for (const k of keys){
      const col = `seed_${k}_url`;
      const v = cycleRow && cycleRow[col];
      urls.push((typeof v === 'string' && v) ? v : placeholder(k.toUpperCase()));
    }
    return urls; // length 32
  }

  let cycle = null;
  let seeds = [];
  let activeIdx = 0; // 0..15 match index

  function render(){
    if (currentRoundEl) currentRoundEl.textContent = "Current round: Round of 32";
    winnerText.innerHTML = `<b>First to ${WIN_TO} wins.</b> (images loading from cycles_v2)`;

    const left = seeds[activeIdx*2] || placeholder('?');
    const right = seeds[activeIdx*2+1] || placeholder('?');

    labelActive1.textContent = `R32 Match ${activeIdx+1} — Top`;
    labelActive2.textContent = `R32 Match ${activeIdx+1} — Bottom`;
    countActive1.textContent = '0';
    countActive2.textContent = '0';

    setMedia(1, left);
    setMedia(2, right);

    // votes not wired in this step
    btnActive1.disabled = true;
    btnActive2.disabled = true;

    renderThumbs();
    updateArrows();
  }

  function updateArrows(){
    prevBtn.disabled = activeIdx <= 0;
    nextBtn.disabled = activeIdx >= 15;
  }

  function renderThumbs(){
    grid.innerHTML = '';

    for (let i=0;i<16;i++){
      const left = seeds[i*2] || placeholder('?');
      const right = seeds[i*2+1] || placeholder('?');

      const box = document.createElement('div');
      box.className = 'thumb' + (i===activeIdx ? ' active' : '');

      const imgWrap = document.createElement('div');
      imgWrap.className = 'thumb-img diag';

      const leftEl = document.createElement(isVideoUrl(left)?'video':'img');
      leftEl.className = 'half left';
      if (leftEl.tagName==='VIDEO'){
        leftEl.muted = true; leftEl.playsInline = true; leftEl.loop = true;
        leftEl.src = left;
      } else {
        leftEl.src = left;
      }

      const rightEl = document.createElement(isVideoUrl(right)?'video':'img');
      rightEl.className = 'half right';
      if (rightEl.tagName==='VIDEO'){
        rightEl.muted = true; rightEl.playsInline = true; rightEl.loop = true;
        rightEl.src = right;
      } else {
        rightEl.src = right;
      }

      imgWrap.appendChild(leftEl);
      imgWrap.appendChild(rightEl);

      const label = document.createElement('div');
      label.className = 'thumb-label';
      label.innerHTML = `<span>R32-${i+1}</span><span class="thumb-count">0–0</span>`;

      box.appendChild(imgWrap);
      box.appendChild(label);

      box.onclick = ()=>{
        activeIdx = i;
        render();
      };

      grid.appendChild(box);
    }
  }

  async function loadLatestCycle(){
    const { data, error } = await supabase
      .from('cycles_v2')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(1);

    if (error) throw error;
    if (!data || !data.length) throw new Error('No cycles_v2 rows found');
    return data[0];
  }

  prevBtn.onclick = ()=>{ if (activeIdx>0){ activeIdx--; render(); }};
  nextBtn.onclick = ()=>{ if (activeIdx<15){ activeIdx++; render(); }};

  (async function boot(){
    try{
      cycle = await loadLatestCycle();
      seeds = buildSeedUrls(cycle);
      render();
    }catch(e){
      console.error('Seed load failed', e);
      seeds = Array.from({length:32}, (_,i)=>placeholder(String(i+1)));
      render();
      winnerText.innerHTML = `<b>Could not load seeds.</b> Check cycles_v2 columns seed_a_url…seed_af_url.`;
    }
  })();
</script>

</body>
</html>
