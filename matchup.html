<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space — Matchup (32-up → 2-up)</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0f13; --accent:#39ff14; --muted:#8b8b8b; --card:#0f1318; --border:#20242a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:28px; padding:10px 14px; border-radius:16px; background:radial-gradient(circle at 0 0,#122a1b,#050608); box-shadow:0 0 16px rgba(0,0,0,.8),0 0 40px rgba(57,255,20,.4); color:#39ff14; border:1px solid rgba(57,255,20,.28); }
    .round-label { font-size:13px; color:var(--muted); margin-left:4px; }
    .card { margin-top:14px; border:1px solid var(--border); border-radius:18px; background:var(--card); box-shadow:0 14px 40px rgba(0,0,0,.6); overflow:hidden; }
    .imgBox { position:relative; background:#050608; }
    .imgBox img,
    .imgBox video {
      display:block;
      width:100%;
      height:auto;
      max-height:80vh;
      object-fit:cover;
    }
    .imgBox video { background:#000; }
    .bar { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; gap:8px; }
    .label { font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .btn, .vote, .linkbtn, .backbtn { appearance:none; border:1px solid rgba(148,163,184,.5); background:transparent; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; font-size:14px; color:var(--fg); text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    .navArrow { padding-inline:10px; min-width:40px; justify-content:center; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }

    /* piece meta under active cards */
    .piece-meta {
      padding:6px 12px 10px;
      border-top:1px solid var(--border);
      font-size:12px;
      color:#9ca3af;
      line-height:1.4;
    }
    .piece-meta a.artist-link {
      color:var(--accent);
      text-decoration:none;
    }
    .piece-meta a.artist-link:hover {
      text-decoration:underline;
    }
    .piece-meta.hidden { display:none; }

    /* thumbnails grid */
    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:12px; padding:4px; display:flex; flex-direction:column; gap:4px; background:var(--card); cursor:pointer; position:relative; }
    .thumb.disabled { opacity:.55; cursor:default; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }

    /* THUMB IMAGE: DIAGONAL SPLIT (BOTH COMPETITORS) */
    .thumb-img {
      position:relative;
      width:100%;
      aspect-ratio:3/4;
      background:#0b0f13;
      overflow:hidden;
    }
    .thumb-img img,
    .thumb-img video {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-img.diag img.half,
    .thumb-img.diag video.half {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      clip-path:polygon(0 0,100% 0,0 100%);
    }
    .thumb-img.diag img.half.right,
    .thumb-img.diag video.half.right {
      clip-path:polygon(100% 0,100% 100%,0 100%);
    }

    .thumb-label { display:flex; justify-content:space-between; font-size:11px; align-items:center; }
    .thumb-label span.left { opacity:.8; }
    .thumb-label span.right { font-variant-numeric: tabular-nums; }

    .phase-badge {
      position:absolute;
      top:4px;
      left:4px;
      font-size:10px;
      padding:2px 5px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#e5e7eb;
    }

    .fullscreenBtn {
      position:absolute;
      top:10px;
      right:10px;
      border-radius:999px;
      border:1px solid rgba(57,255,20,.6);
      background:rgba(0,0,0,.7);
      padding:4px 7px;
      font-size:12px;
      color:var(--accent);
      cursor:pointer;
    }

    .fullscreen-overlay {
      position:fixed;
      inset:0;
      background:rgba(5,6,8,0.96);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .fullscreen-inner {
      max-width:min(900px,96vw);
      max-height:96vh;
      position:relative;
    }
    .fullscreen-inner img,
    .fullscreen-inner video {
      display:block;
      max-width:100%;
      max-height:96vh;
      object-fit:contain;
    }
    .fullscreen-close {
      position:absolute;
      top:6px;
      right:6px;
      background:rgba(0,0,0,.7);
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      color:#e5e7eb;
      padding:3px 10px;
      cursor:pointer;
      font-size:12px;
    }

    .glitch-title {
      position:relative;
      display:inline-block;
      font-size:22px;
      letter-spacing:2px;
      color:#39ff14;
      text-shadow:0 0 8px rgba(57,255,20,.7);
      text-transform:uppercase;
    }
    .glitch-title::before,
    .glitch-title::after {
      content:attr(data-text);
      position:absolute;
      top:0;
      left:0;
      mix-blend-mode:screen;
      opacity:.6;
      clip-path:polygon(0 0,100% 0,100% 45%,0 45%);
    }
    .glitch-title::before {
      transform:translateX(-1px);
      color:#00f2ff;
    }
    .glitch-title::after {
      transform:translateX(1px);
      color:#ff4bfb;
      clip-path:polygon(0 55%,100% 55%,100% 100%,0 100%);
    }

    /* small "loading tournament" overlay */
    #loadingOverlay {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 20% 0,rgba(0,0,0,.9),#020617);
      z-index:999999;
      color:#39ff14;
      font-size:22px;
      letter-spacing:2px;
      font-weight:700;
      font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif;
    }
  </style>
</head>
<body>
<div id="loadingOverlay">
  LOADING…
</div>
  <div class="wrap">
    <h1 class="glitch-title" data-text="ART BATTLE. Faction I.">ART BATTLE. Faction I.</h1>

    <div class="header">
      <div class="row">
        <!-- start a round at 4h48m = 17,280s -->
        <div class="timer" id="tRemain">04:48:00</div>
        <div class="round-label" id="currentRound">Current round: —</div>
      </div>
      <div class="row">
        <a class="backbtn" href="menu.html">← Menu</a>
        <button class="btn navArrow" id="prevMatchBtn" type="button">⟨⟨</button>
        <button class="btn navArrow" id="nextMatchBtn" type="button">⟩⟩</button>
        <a class="linkbtn" href="winners.html">Winners</a>
      </div>
    </div>

    <!-- ACTIVE MATCH -->
    <div class="card" id="activeTop">
      <div class="imgBox">
        <img id="imgActive1" alt="Active top">
        <video id="vidActive1" class="hidden" muted playsinline loop controls></video>
        <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive1">Top</div>
        <div class="counts" id="countActive1">0</div>
        <button class="vote" id="btnActive1">Vote</button>
      </div>
      <div class="piece-meta hidden" id="metaActive1"></div>
    </div>

    <div class="card" id="activeBottom">
      <div class="imgBox">
        <img id="imgActive2" alt="Active bottom">
        <video id="vidActive2" class="hidden" muted playsinline loop controls></video>
        <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive2">Bottom</div>
        <div class="counts" id="countActive2">0</div>
        <button class="vote" id="btnActive2">Vote</button>
      </div>
      <div class="piece-meta hidden" id="metaActive2"></div>
    </div>

    <!-- THUMBS -->
    <div class="thumbs-wrap">
      <div class="thumbs-title">Tap a battle to view &amp; vote</div>
      <div class="thumbs" id="thumbGrid"></div>
    </div>
  </div>

  <!-- fullscreen overlay -->
  <div class="fullscreen-overlay" id="fullOverlay">
    <div class="fullscreen-inner">
      <button class="fullscreen-close" onclick="closeFull()">Close ✕</button>
      <img id="fullImg" class="hidden" alt="Full piece">
      <video id="fullVideo" class="hidden" controls playsinline></video>
    </div>
  </div>

<script>
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXV...CI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID){
      RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now());
      localStorage.setItem(RSID_KEY, RSID);
    }

    const elRemain = document.getElementById("tRemain");
    const winnerText = document.getElementById("winnerText");

    const imgActive1 = document.getElementById("imgActive1");
    const imgActive2 = document.getElementById("imgActive2");
    const vidActive1 = document.getElementById("vidActive1");
    const vidActive2 = document.getElementById("vidActive2");

    const btnActive1 = document.getElementById("btnActive1");
    const btnActive2 = document.getElementById("btnActive2");

    const activeMeta1 = document.getElementById("metaActive1");
    const activeMeta2 = document.getElementById("metaActive2");

    const activeTop = document.getElementById("activeTop");
    const activeBottom = document.getElementById("activeBottom");

    const currentRoundEl = document.getElementById("currentRound");

    const fullOverlay = document.getElementById("fullOverlay");
    const fullImg = document.getElementById("fullImg");
    const fullVideo = document.getElementById("fullVideo");

    const thumbGrid = document.getElementById("thumbGrid");

    const loadingEl = document.getElementById("loadingOverlay");

    function hideLoading(){
      if (loadingEl) loadingEl.style.display = "none";
    }

    function isVideoUrl(url){
      if (!url) return false;
      return /\.(mp4|webm|mov|m4v)(\?|$)/i.test(url);
    }

    function openFull(which){
      const src = (which==="active1")
        ? (isVideoUrl(vidActive1.src) ? vidActive1.src : imgActive1.src)
        : (isVideoUrl(vidActive2.src) ? vidActive2.src : imgActive2.src);
      if (!src) return;
      const isVid = isVideoUrl(src);
      if (isVid){
        fullImg.classList.add("hidden");
        fullVideo.classList.remove("hidden");
        fullVideo.src = src;
        fullVideo.play().catch(()=>{});
      } else {
        fullVideo.classList.add("hidden");
        try {
          fullVideo.pause();
          fullVideo.removeAttribute("src");
          fullVideo.load();
        } catch(e){}
        fullImg.classList.remove("hidden");
        fullImg.src = src;
      }
      fullOverlay.style.display = "flex";
    }

    function closeFull(){
      fullOverlay.style.display = "none";
      try {
        fullVideo.pause();
        fullVideo.removeAttribute("src");
        fullVideo.load();
      } catch(e){}
    }

    function placeholder(letter){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960">
        <rect width="100%" height="100%" fill="#000"/>
        <text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace"
          text-anchor="middle" dominant-baseline="middle">${letter}</text>
      </svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    const thumbs = {};
    const thumbMeta = {};
    const lastGoodThumb = {};

    const currentVote = { key:null, color:null };

    let state = null;
    let pollTimer = null;

    const VOTE_MEMORY_KEY = "rs_vote_memory_v4";
    let voteUserKey = "guest";
    let currentUserId = null;

    async function initVoteUserKey(){
      try {
        const { data } = await supabase.auth.getUser();
        const user = data?.user;
        if (user) {
          currentUserId = user.id || null;
          voteUserKey = user.id || user.email || "user";
        } else {
          currentUserId = null;
          voteUserKey = "guest";
        }
      } catch(e) {
        voteUserKey = "guest";
      } finally {
        // once we know which user we are, re-render so vote buttons
        // reflect THIS account's votes (not whoever used the browser earlier)
        renderActive();
      }
    }

    function memRead(base){
      try{
        const all = JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}");
        const perUser = all[voteUserKey] || {};
        return perUser[base] || {};
      }catch{
        return {};
      }
    }
    function memWrite(base,key,val){
      const all = (()=>{ try { return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}"); } catch { return {}; }})();
      const perUser = all[voteUserKey] || {};
      perUser[base] = Object.assign({}, perUser[base]||{}, { [key]: val });
      all[voteUserKey] = perUser;
      localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all));
    }

    let activeMatch = "rr1";

    function pauseOtherVideos(keep){
      const vs = document.querySelectorAll("video");
      vs.forEach(v=>{
        if (v!==keep){
          try{ v.pause(); }catch{}
        }
      });
    }

    fullVideo.addEventListener("play", ()=> pauseOtherVideos(fullVideo));

    function markActive(){
      for (const k in thumbs) {
        thumbs[k].box.classList.toggle("active", k===activeMatch);
      }
    }

    function goRelativeMatch(delta){
      if (!order || !order.length) return;
      let idx = order.findIndex(o => o.key === activeMatch);
      if (idx === -1) idx = 0;
      const len = order.length;

      for (let step = 0; step < len; step++){
        idx = (idx + delta + len) % len;
        const key = order[idx].key;
        const th = thumbs[key];
        if (!th) continue;
        const box = th.box;
        if (box.classList.contains("hidden") || box.classList.contains("disabled")) continue;
        activeMatch = key;
        renderActive();
        break;
      }
    }


    /* MATCH INDEX */
    const order = [
      {key:"rr1",  label:"R32 1",  left:"seed_a_url",  right:"seed_b_url",  lct:"seed_a_count",  rct:"seed_b_count"},
      {key:"rr2",  label:"R32 2",  left:"seed_c_url",  right:"seed_d_url",  lct:"seed_c_count",  rct:"seed_d_count"},
      {key:"rr3",  label:"R32 3",  left:"seed_e_url",  right:"seed_f_url",  lct:"seed_e_count",  rct:"seed_f_count"},
      {key:"rr4",  label:"R32 4",  left:"seed_g_url",  right:"seed_h_url",  lct:"seed_g_count",  rct:"seed_h_count"},
      {key:"rr5",  label:"R32 5",  left:"seed_i_url",  right:"seed_j_url",  lct:"seed_i_count",  rct:"seed_j_count"},
      {key:"rr6",  label:"R32 6",  left:"seed_k_url",  right:"seed_l_url",  lct:"seed_k_count",  rct:"seed_l_count"},
      {key:"rr7",  label:"R32 7",  left:"seed_m_url",  right:"seed_n_url",  lct:"seed_m_count",  rct:"seed_n_count"},
      {key:"rr8",  label:"R32 8",  left:"seed_o_url",  right:"seed_p_url",  lct:"seed_o_count",  rct:"seed_p_count"},
      {key:"rr9",  label:"R32 9",  left:"seed_q_url",  right:"seed_r_url",  lct:"seed_q_count",  rct:"seed_r_count"},
      {key:"rr10", label:"R32 10", left:"seed_s_url",  right:"seed_t_url",  lct:"seed_s_count",  rct:"seed_t_count"},
      {key:"rr11", label:"R32 11", left:"seed_u_url",  right:"seed_v_url",  lct:"seed_u_count",  rct:"seed_v_count"},
      {key:"rr12", label:"R32 12", left:"seed_w_url",  right:"seed_x_url",  lct:"seed_w_count",  rct:"seed_x_count"},
      {key:"rr13", label:"R32 13", left:"seed_y_url",  right:"seed_z_url",  lct:"seed_y_count",  rct:"seed_z_count"},
      {key:"rr14", label:"R32 14", left:"seed_aa_url", right:"seed_ab_url", lct:"seed_aa_count", rct:"seed_ab_count"},
      {key:"rr15", label:"R32 15", left:"seed_ac_url", right:"seed_ad_url", lct:"seed_ac_count", rct:"seed_ad_count"},
      {key:"rr16", label:"R32 16", left:"seed_ae_url", right:"seed_af_url", lct:"seed_ae_count", rct:"seed_af_count"},

      {key:"r1", label:"R16 A–B", left:"seed_a_url", right:"seed_b_url", lct:"seed_a_count", rct:"seed_b_count"},
      {key:"r2", label:"R16 C–D", left:"seed_c_url", right:"seed_d_url", lct:"seed_c_count", rct:"seed_d_count"},
      {key:"r3", label:"R16 E–F", left:"seed_e_url", right:"seed_f_url", lct:"seed_e_count", rct:"seed_f_count"},
      {key:"r4", label:"R16 G–H", left:"seed_g_url", right:"seed_h_url", lct:"seed_g_count", rct:"seed_h_count"},
      {key:"r5", label:"R16 I–J", left:"seed_i_url", right:"seed_j_url", lct:"seed_i_count", rct:"seed_j_count"},
      {key:"r6", label:"R16 K–L", left:"seed_k_url", right:"seed_l_url", lct:"seed_k_count", rct:"seed_l_count"},
      {key:"r7", label:"R16 M–N", left:"seed_m_url", right:"seed_n_url", lct:"seed_m_count", rct:"seed_n_count"},
      {key:"r8", label:"R16 O–P", left:"seed_o_url", right:"seed_p_url", lct:"seed_o_count", rct:"seed_p_count"},

      {key:"q1", label:"QF A–B", left:"q1_a_url", right:"q1_b_url", lct:"q1_a_count", rct:"q1_b_count", fbL:"A", fbR:"B", fbLct:"seed_a_count", fbRct:"seed_b_count"},
      {key:"q2", label:"QF C–D", left:"q2_c_url", right:"q2_d_url", lct:"q2_c_count", rct:"q2_d_count", fbL:"C", fbR:"D", fbLct:"seed_c_count", fbRct:"seed_d_count"},
      {key:"q3", label:"QF E–F", left:"q3_e_url", right:"q3_f_url", lct:"q3_e_count", rct:"q3_f_count", fbL:"E", fbR:"F", fbLct:"seed_e_count", fbRct:"seed_f_count"},
      {key:"q4", label:"QF G–H", left:"q4_g_url", right:"q4_h_url", lct:"q4_g_count", rct:"q4_h_count", fbL:"G", fbR:"H", fbLct:"seed_g_count", fbRct:"seed_h_count"},

      {key:"s1", label:"SF 1", left:"semi_1_left_url",  right:"semi_1_right_url",  lct:"semi_1_left_count",  rct:"semi_1_right_count",  fbL:"S1", fbR:"S1", fbLct:"seed_a_count", fbRct:"seed_b_count"},
      {key:"s2", label:"SF 2", left:"semi_2_left_url",  right:"semi_2_right_url",  lct:"semi_2_left_count",  rct:"semi_2_right_count",  fbL:"S2", fbR:"S2", fbLct:"seed_c_count", fbRct:"seed_d_count"},

      {key:"final", label:"FINAL", left:"mid_winner_1_url", right:"mid_winner_2_url", lct:"seed_a_count", rct:"seed_b_count", fbL:"F", fbR:"F", fbLct:"seed_a_count", fbRct:"seed_b_count"},
    ];

    function escapeHtml(str){
      return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function buildThumb(item){
      const div = document.createElement("div");
      div.className = "thumb";
      div.id = "thumb_"+item.key;

      const imgWrap = document.createElement("div");
      imgWrap.className = "thumb-img diag";

      const imgL = document.createElement("img");
      imgL.id = "imgL_"+item.key;
      imgL.className = "half";
      imgWrap.appendChild(imgL);

      const imgR = document.createElement("img");
      imgR.id = "imgR_"+item.key;
      imgR.className = "half right";
      imgWrap.appendChild(imgR);

      const vidL = document.createElement("video");
      vidL.id = "vidL_"+item.key;
      vidL.className = "half hidden";
      vidL.muted = true;
      vidL.playsInline = true;
      imgWrap.appendChild(vidL);

      const vidR = document.createElement("video");
      vidR.id = "vidR_"+item.key;
      vidR.className = "half right hidden";
      vidR.muted = true;
      vidR.playsInline = true;
      imgWrap.appendChild(vidR);

      const badge = document.createElement("div");
      badge.className = "phase-badge";
      badge.id = "badge_"+item.key;
      badge.textContent = item.label;
      div.appendChild(imgWrap);
      div.appendChild(badge);

      const row = document.createElement("div");
      row.className = "thumb-label";
      const spanL = document.createElement("span");
      spanL.className = "left";
      spanL.textContent = item.label;
      const spanR = document.createElement("span");
      spanR.className = "right";
      spanR.id = "cnt_"+item.key;
      spanR.textContent = "0-0";
      row.appendChild(spanL);
      row.appendChild(spanR);
      div.appendChild(row);

      div.addEventListener("click", ()=>{
        if (!state) return;
        if (div.classList.contains("disabled")) return;

        const itemKey = item.key;
        if (itemKey.startsWith("rr") && state.r32_done) return;
        if (itemKey.startsWith("r") && !state.r32_done) return;
        if (itemKey.startsWith("r") && state.r16_done) return;
        if (itemKey.startsWith("q") && !state.r16_done) return;
        if (itemKey.startsWith("q") && state.qf_done) return;
        if (itemKey.startsWith("s")) {
          if (!state.mid1_done || state.mid2_done) return;
        }
        if (itemKey==="final" && !state.mid2_done) return;

        activeMatch = itemKey;
        renderActive();
      });
      thumbGrid.appendChild(div);
      thumbs[item.key] = {
        box:   div,
        imgL:  div.querySelector("#imgL_"+item.key),
        imgR:  div.querySelector("#imgR_"+item.key),
        vidL:  div.querySelector("#vidL_"+item.key),
        vidR:  div.querySelector("#vidR_"+item.key),
        count: div.querySelector("#cnt_"+item.key),
        badge: div.querySelector("#badge_"+item.key)
      };
    }

    order.forEach(buildThumb);

    const hoverEnabled = window.matchMedia && window.matchMedia("(pointer:fine)").matches;
    if (hoverEnabled) {
      for (const k in thumbs) {
        const t = thumbs[k];
        t.box.addEventListener("mouseenter", handleThumbEnter);
        t.box.addEventListener("mouseleave", handleThumbLeave);
      }
    }

    function handleThumbEnter(e){
      const id = e.currentTarget.id.replace("thumb_","");
      const t = thumbs[id];
      if (!t) return;
      const any = [t.vidL,t.vidR].some(v=>!v.classList.contains("hidden"));
      if (!any) return;
      [t.vidL,t.vidR].forEach(v=>{
        if (v && !v.classList.contains("hidden")){
          try { v.play().catch(()=>{}); } catch(e){}
        }
      });
    }
    function handleThumbLeave(e){
      const id = e.currentTarget.id.replace("thumb_","");
      const t = thumbs[id];
      if (!t) return;
      [t.vidL,t.vidR].forEach(v=>{
        if (v){
          try { v.pause(); } catch(e){}
        }
      });
    }

    async function fetchState(force=false){
      const url = FUNCTION_URL + (force ? "?force=1" : "");
      const res = await fetch(url, { headers:{ "x-rsid":RSID }});
      const data = await res.json();

      state = data;
      renderThumbs();
      renderActive();
      updateCurrentRoundLabel();

      if (!pollTimer){
        pollTimer = setInterval(()=> fetchState(true).catch(()=>{}), 30_000);
      }
      return data;
    }

    function setThumb(key,leftUrl,rightUrl,leftCt,rightCt,fallback){
      const th = thumbs[key]; if (!th) return;

      const leftKey = key + "_L";
      const rightKey = key + "_R";

      let lUrl = leftUrl;
      let rUrl = rightUrl;
      if (!lUrl && lastGoodThumb[leftKey]) lUrl = lastGoodThumb[leftKey];
      if (!rUrl && lastGoodThumb[rightKey]) rUrl = lastGoodThumb[rightKey];

      const leftIsVid = isVideoUrl(lUrl);
      const rightIsVid = isVideoUrl(rUrl);

      if (lUrl) lastGoodThumb[leftKey] = lUrl;
      if (rUrl) lastGoodThumb[rightKey] = rUrl;

      if (leftIsVid) {
        th.imgL.classList.add("hidden");
        th.vidL.classList.remove("hidden");
        th.vidL.src = lUrl + "#t=0.1";
        th.vidL.preload = "metadata";
        try { th.vidL.pause(); } catch(e){}
      } else {
        th.vidL.classList.add("hidden");
        th.imgL.classList.remove("hidden");
        th.imgL.src = lUrl || placeholder(fallback||"?");
      }

      if (rightIsVid) {
        th.imgR.classList.add("hidden");
        th.vidR.classList.remove("hidden");
        th.vidR.src = rUrl + "#t=0.1";
        th.vidR.preload = "metadata";
        try { th.vidR.pause(); } catch(e){}
      } else {
        th.vidR.classList.add("hidden");
        th.imgR.classList.remove("hidden");
        th.imgR.src = rUrl || placeholder(fallback||"?");
      }

      const lc = leftCt ?? 0;
      const rc = rightCt ?? 0;
      th.count.textContent = `${lc}-${rc}`;
    }

    function renderThumbs(){
      setThumb("rr1",  state.seed_a_url,  state.seed_b_url,  state.seed_a_count,  state.seed_b_count, "A");
      setThumb("rr2",  state.seed_c_url,  state.seed_d_url,  state.seed_c_count,  state.seed_d_count, "C");
      setThumb("rr3",  state.seed_e_url,  state.seed_f_url,  state.seed_e_count,  state.seed_f_count, "E");
      setThumb("rr4",  state.seed_g_url,  state.seed_h_url,  state.seed_g_count,  state.seed_h_count, "G");
      setThumb("rr5",  state.seed_i_url,  state.seed_j_url,  state.seed_i_count,  state.seed_j_count, "I");
      setThumb("rr6",  state.seed_k_url,  state.seed_l_url,  state.seed_k_count,  state.seed_l_count, "K");
      setThumb("rr7",  state.seed_m_url,  state.seed_n_url,  state.seed_m_count,  state.seed_n_count, "M");
      setThumb("rr8",  state.seed_o_url,  state.seed_p_url,  state.seed_o_count,  state.seed_p_count, "O");
      setThumb("rr9",  state.seed_q_url,  state.seed_r_url,  state.seed_q_count,  state.seed_r_count, "Q");
      setThumb("rr10", state.seed_s_url,  state.seed_t_url,  state.seed_s_count,  state.seed_t_count, "S");
      setThumb("rr11", state.seed_u_url,  state.seed_v_url,  state.seed_u_count,  state.seed_v_count, "U");
      setThumb("rr12", state.seed_w_url,  state.seed_x_url,  state.seed_w_count,  state.seed_x_count, "W");
      setThumb("rr13", state.seed_y_url,  state.seed_z_url,  state.seed_y_count,  state.seed_z_count, "Y");
      setThumb("rr14", state.seed_aa_url, state.seed_ab_url, state.seed_aa_count, state.seed_ab_count, "AA");
      setThumb("rr15", state.seed_ac_url, state.seed_ad_url, state.seed_ac_count, state.seed_ad_count, "AC");
      setThumb("rr16", state.seed_ae_url, state.seed_af_url, state.seed_ae_count, state.seed_af_count, "AE");

      for (let i=1;i<=16;i++){
        const k = "rr"+i;
        thumbs[k].box.classList.toggle("disabled", !!state.r32_done);
      }

      for (let i=1;i<=8;i++){
        const key = "r"+i;
        const disabled = !state.r32_done || !!state.r16_done;
        thumbs[key].box.classList.toggle("disabled", disabled);
      }

      setThumb("q1", state.qf_1_left_url || state.seed_a_url, state.qf_1_right_url || state.seed_b_url,
               state.qf_1_left_count ?? state.seed_a_count, state.qf_1_right_count ?? state.seed_b_count, "Q1");
      setThumb("q2", state.qf_2_left_url || state.seed_c_url, state.qf_2_right_url || state.seed_d_url,
               state.qf_2_left_count ?? state.seed_c_count, state.qf_2_right_count ?? state.seed_d_count, "Q2");
      setThumb("q3", state.qf_3_left_url || state.seed_e_url, state.qf_3_right_url || state.seed_f_url,
               state.qf_3_left_count ?? state.seed_e_count, state.qf_3_right_count ?? state.seed_f_count, "Q3");
      setThumb("q4", state.qf_4_left_url || state.seed_g_url, state.qf_4_right_url || state.seed_h_url,
               state.qf_4_left_count ?? state.seed_g_count, state.qf_4_right_count ?? state.seed_h_count, "Q4");

      for (const k of ["q1","q2","q3","q4"]){
        const disabled = !state.r16_done || !!state.qf_done;
        thumbs[k].box.classList.toggle("disabled", disabled);
      }

      if (!state.mid1_done){
        thumbs.s1.imgL.src = placeholder("S1");
        thumbs.s1.imgR.src = placeholder("S1");
        thumbs.s1.count.textContent = "0-0";
        thumbs.s1.box.classList.add("disabled"); thumbs.s1.box.classList.add("hidden");

        thumbs.s2.imgL.src = placeholder("S2");
        thumbs.s2.imgR.src = placeholder("S2");
        thumbs.s2.count.textContent = "0-0";
        thumbs.s2.box.classList.add("disabled"); thumbs.s2.box.classList.add("hidden");
      }else{
        setThumb("s1", state.semi_1_left_url, state.semi_1_right_url, state.semi_1_left_count, state.semi_1_right_count, "S1");
        setThumb("s2", state.semi_2_left_url, state.semi_2_right_url, state.semi_2_left_count, state.semi_2_right_count, "S2");
        thumbs.s1.box.classList.toggle("disabled", !!state.mid2_done);
        thumbs.s1.box.classList.remove("hidden");
        thumbs.s2.box.classList.toggle("disabled", !!state.mid2_done);
        thumbs.s2.box.classList.remove("hidden");
      }

      if (!state.mid2_done){
        thumbs.final.imgL.src = placeholder("F");
        thumbs.final.imgR.src = placeholder("F");
        thumbs.final.count.textContent = "0-0";
        thumbs.final.box.classList.add("disabled"); thumbs.final.box.classList.add("hidden");
      }else{
        setThumb("final", state.mid_winner_1_url, state.mid_winner_2_url, state.seed_a_count, state.seed_b_count, "F");
        thumbs.final.box.classList.remove("disabled"); thumbs.final.box.classList.remove("hidden");
      }

      markActive();
    }

    function renderActive(){
      if (!state) return;

      const base = state.base_iso || "";
      const mem = memRead(base);

      const entry = order.find(o=>o.key===activeMatch) || order[0];

      const leftUrlKey  = entry.left;
      const rightUrlKey = entry.right;
      const leftCtKey   = entry.lct;
      const rightCtKey  = entry.rct;
      const fbLct       = entry.fbLct;
      const fbRct       = entry.fbRct;

      let leftImg = state[leftUrlKey];
      let rightImg = state[rightUrlKey];

      if (!leftImg && entry.fbL) leftImg = state[entry.fbLct ? entry.fbLct.replace("_count","_url") : leftUrlKey];
      if (!rightImg && entry.fbR) rightImg = state[entry.fbRct ? entry.fbRct.replace("_count","_url") : rightUrlKey];

      const leftCt  = state[leftCtKey]  ?? (fbLct ? state[fbLct] : 0);
      const rightCt = state[rightCtKey] ?? (fbRct ? state[fbRct] : 0);

      const segLabel = entry.label || "";
      const picked = mem[activeMatch] || null;

      const metaByUrl = state.meta_by_url || {};
      const leftMeta = metaByUrl[leftImg] || {};
      const rightMeta = metaByUrl[rightImg] || {};

      function buildLabel(defaultLabel, meta){
        const t = meta && meta.title ? String(meta.title) : "";
        const a = meta && meta.artist ? String(meta.artist) : "";
        if (!t && !a) return defaultLabel;

        let line = "";
        if (t) line += `"${escapeHtml(t)}"`;
        if (a){
          const safeA = escapeHtml(a);
          line += (line ? " · " : "") +
                  `<a href="profile.html?u=${safeA}" class="artist-link">@${safeA}</a>`;
        }
        return line;
      }

      let baseLabel1 = buildLabel(segLabel+" — Left", leftMeta);
      let baseLabel2 = buildLabel(segLabel+" — Right", rightMeta);

      if (picked==="red")  baseLabel1 += " • you voted";
      if (picked==="blue") baseLabel2 += " • you voted";

      activeMeta1.innerHTML = baseLabel1;
      activeMeta2.innerHTML = baseLabel2;

      activeMeta1.classList.toggle("hidden", !baseLabel1);
      activeMeta2.classList.toggle("hidden", !baseLabel2);

      const redDisabled = !!mem[activeMatch];
      const blueDisabled = !!mem[activeMatch];

      btnActive1.disabled = redDisabled;
      btnActive2.disabled = blueDisabled;

      const leftIsVid = isVideoUrl(leftImg);
      const rightIsVid = isVideoUrl(rightImg);

      function setActiveMedia(which,url){
        const isVid = isVideoUrl(url);
        if (which==="active1"){
          if (isVid){
            imgActive1.classList.add("hidden");
            vidActive1.classList.remove("hidden");
            vidActive1.src = url;
            vidActive1.play().catch(()=>{});
          }else{
            vidActive1.classList.add("hidden");
            try { vidActive1.pause(); } catch(e){}
            imgActive1.classList.remove("hidden");
            imgActive1.src = url || placeholder("A");
          }
        } else {
          if (isVid){
            imgActive2.classList.add("hidden");
            vidActive2.classList.remove("hidden");
            vidActive2.src = url;
            vidActive2.play().catch(()=>{});
          }else{
            vidActive2.classList.add("hidden");
            try { vidActive2.pause(); } catch(e){}
            imgActive2.classList.remove("hidden");
            imgActive2.src = url || placeholder("B");
          }
        }
      }

      setActiveMedia("active1", leftImg);
      setActiveMedia("active2", rightImg);

      const count1 = document.getElementById("countActive1");
      const count2 = document.getElementById("countActive2");
      count1.textContent = leftCt ?? 0;
      count2.textContent = rightCt ?? 0;

      markActive();
    }

    function updateCurrentRoundLabel(){
      if (!currentRoundEl) return;
      if (!state) {
        currentRoundEl.textContent = "Current round: —";
        return;
      }
      let name;
      if (!state.r32_done) {
        name = "Round of 32";
      } else if (!state.r16_done) {
        name = "Round of 16";
      } else if (!state.mid1_done) {
        name = "Quarterfinals";
      } else if (!state.mid2_done) {
        name = "Semifinals";
      } else {
        name = "Final";
      }
      currentRoundEl.textContent = "Current round: " + name;
    }

    function tick(){
      if (!state?.ends_at) return requestAnimationFrame(tick);
      const ms = Math.max(0, new Date(state.ends_at).getTime() - Date.now());

      const SEG_MS = 17_280_000;
      let segMs = ms % SEG_MS;

      const totalSeconds = Math.floor(segMs / 1000);
      let hours   = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;

      const pad = (n)=> String(n).padStart(2,"0");
      elRemain.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

      requestAnimationFrame(tick);
    }

    async function init(){
      await initVoteUserKey().catch(()=>{});
      await fetchState(true).catch(()=>{});
      tick();
    }

    async function vote(color){
      if (!state) return;

      const base = state.base_iso || "";
      const mem  = memRead(base);
      const key  = activeMatch;
      if (mem[key]) return; // already marked as voted in this browser for this account

      if (!currentUserId) {
        try {
          const { data } = await supabase.auth.getUser();
          const user = data?.user;
          if (user) {
            currentUserId = user.id || null;
            voteUserKey = user.id || user.email || "user";
          }
        } catch(e) {
        }
      }
      if (!currentUserId) {
        alert("You need to be signed in to vote.");
        return;
      }

      const red = color === "red";

      const serverPhase = activeMatch.startsWith("rr")
        ? ("r" + activeMatch.slice(2))
        : activeMatch;

      const post = {
        phase: serverPhase,
        side:  red ? "left" : "right",
        user_id: currentUserId,
        base_iso: base
      };

      try{
        const res = await fetch(FUNCTION_URL, {
          method:"POST",
          headers:{"Content-Type":"application/json","x-rsid":RSID},
          body: JSON.stringify(post)
        });

        let payload = {};
        try { payload = await res.json(); } catch {}

        if (!res.ok){
          if (res.status === 409 && payload && payload.error === "already_voted") {
            memWrite(base, key, true);
            renderActive();
            alert("You already voted in this battle with this account.");
            return;
          }
          await fetchState(true);
          return;
        }

        await fetchState(true);
        memWrite(base, key, color);
        renderActive();
      }catch{
        await fetchState(true);
      }
    }
    btnActive1.onclick = ()=> vote("red");
    btnActive2.onclick = ()=> vote("blue");

    const prevMatchBtn = document.getElementById("prevMatchBtn");
    const nextMatchBtn = document.getElementById("nextMatchBtn");
    if (prevMatchBtn) prevMatchBtn.onclick = () => goRelativeMatch(-1);
    if (nextMatchBtn) nextMatchBtn.onclick = () => goRelativeMatch(1);

    init().catch(()=>{});

    if (loadingEl) loadingEl.style.display = "none";

  const originalFetchState = fetchState;
  fetchState = async function(force=false){
    const result = await originalFetchState(force);
    if (state?.ends_at) hideLoading();
    return result;
  };

  const originalTick = tick;
  tick = function(){
    if (state?.ends_at) hideLoading();
    originalTick();
  };
</script>
</body>
</html>