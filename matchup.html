<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rage Space ‚Äî Tournament</title>
<style>
  :root{ --green:#39ff14; --border:#0f2510; --ink:#e5ffe5; --bg:#000; --card:#070707; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#000;color:var(--green);font-family:ui-sans-serif,system-ui,Arial}
  a.btn,button.btn{border:1px solid var(--green);color:var(--green);background:transparent;border-radius:10px;padding:8px 12px;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 14px}
  .app{display:grid;grid-template-columns: 360px 1fr;gap:14px;height:calc(100vh - 56px);padding:0 14px 14px}
  .listWrap{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:rgba(7,7,7,.55);display:flex;flex-direction:column;min-height:0}
  .listHead{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .list{overflow:auto;flex:1;min-height:0}
  .matchItem{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid rgba(15,37,16,.6);cursor:pointer}
  .thumbMini{width:64px;height:64px;background:#050505;border-radius:8px;overflow:hidden;display:flex}
  .thumbMini img{width:50%;object-fit:cover}
  .title{color:#e5ffe5;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .metaRow{display:flex;gap:8px;align-items:center}
  .badge{font-size:.75rem;border:1px solid var(--border);border-radius:8px;padding:2px 6px;opacity:.85}
  .timer{font-variant-numeric:tabular-nums;opacity:.85}
  .selected{outline:2px solid rgba(57,255,20,.55);outline-offset:-2px}
  .detail{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:rgba(7,7,7,.55);display:flex;flex-direction:column;min-height:0}
  .detailHead{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .stage{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:14px}
  @media (max-width:820px){ .stage{ grid-template-columns:1fr; gap:22px; } }
  .tile{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:rgba(7,7,7,.6);position:relative;display:flex;flex-direction:column}
  .frame{position:relative;width:100%;aspect-ratio:4/3;background:#050505;border-bottom:1px solid var(--border);overflow:hidden}
  @media (max-width:1000px){ .frame{ aspect-ratio:3/4; max-height:72vh; } }
  .art{position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;object-fit:contain;background:#000}
  .tbd{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:900;color:rgba(57,255,20,.75);pointer-events:none}
  .tileMeta{display:flex;justify-content:space-between;gap:8px;padding:10px;align-items:center}
  .countdown{padding:0 14px 10px}
  .actions{padding:0 14px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hint{opacity:.75;padding:0 14px 14px}
  .choice.btn{border-style:solid}
  .choice.btn.active{box-shadow:0 0 0 2px rgba(57,255,20,.6) inset}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0a0a0a;border:1px solid var(--border);color:#e5ffe5;padding:8px 12px;border-radius:10px;display:none;z-index:50}
  .timer:not([data-ends]){display:none}
  @media (max-width:900px){ .app{grid-template-columns:1fr;height:auto} .detail{order:-1} }
</style>
</head>
<body>
  <header>
    <h1 style="margin:0">R<span style="letter-spacing:.03em">‚í∂</span>GE SPACE ‚Äî TOURNAMENT</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnReset" class="btn">üîÅ Reset test</button>
      <button id="btnForce" class="btn">‚ö° Force decide (selected)</button>
      <button id="btnClearVotes" class="btn">üßπ Clear my votes</button>
      <a class="btn" href="#" onclick="return false">üèÅ Bracket (coming soon)</a>
    </div>
  </header>

  <div class="app">
    <section class="listWrap">
      <div class="listHead">
        <strong>Bracket</strong>
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:.85rem;opacity:.9">
          <input type="checkbox" id="toggleFinished"> Show finished rounds
        </label>
      </div>
      <div class="list" id="matchList"></div>
    </section>

    <section class="detail">
      <div class="detailHead">
        <div>
          <span class="badge" id="detailRound">Round ‚Äì</span>
          <span class="badge" id="detailIndex">Match ‚Äì/‚Äì</span>
        </div>
        <span class="badge" id="detailState">‚Äî</span>
      </div>

      <div class="countdown">Decision in: <span class="timer" id="detailClock">00:00:00</span></div>

      <div class="stage">
        <div class="tile" id="tileLeft">
          <div class="frame">
            <img id="leftArt" class="art" alt="">
            <div id="leftTbd" class="tbd" style="display:none">?</div>
          </div>
          <div class="tileMeta">
            <span id="leftName">TBD</span>
            <span class="badge" id="leftVotes">0</span>
          </div>
        </div>

        <div class="tile" id="tileRight">
          <div class="frame">
            <img id="rightArt" class="art" alt="">
            <div id="rightTbd" class="tbd" style="display:none">?</div>
          </div>
          <div class="tileMeta">
            <span id="rightName">TBD</span>
            <span class="badge" id="rightVotes">0</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnLeft" class="btn choice">Vote TOP</button>
        <button id="btnRight" class="btn choice">Vote BOTTOM</button>
        <button id="btnSubmit" class="btn" disabled>‚úÖ Submit Vote</button>
        <span id="voteLock" class="badge" style="display:none">You voted.</span>
      </div>
      <div class="hint">One vote per match. Timer & votes sync via Supabase; local fallback keeps the timer through refresh.</div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
/*** CONFIG ***/
const ROUND_MS = 30000;
const SUPABASE_URL  = 'https://YOUR-PROJECT.supabase.co';   // <-- replace
const SUPABASE_ANON = 'YOUR_PUBLIC_ANON_KEY';               // <-- replace
const MATCH_TABLE = 'matches';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/*** HELPERS ***/
const BLANK='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
const roundLabel = ['','R32','R16','QF','SF','FINAL'];
const nowMs = ()=> Date.now();
const toIso = (ms)=> new Date(ms).toISOString();
const fmt = (ms)=>{ if(ms<=0) return '00:00:00'; const s=Math.floor(ms/1000);
  return String(Math.floor(s/3600)).padStart(2,'0')+':' +
         String(Math.floor((s%3600)/60)).padStart(2,'0')+':' +
         String(s%60).padStart(2,'0'); };
const toast = (m)=>{ const el=document.getElementById('toast'); el.textContent=m; el.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display='none',1500); };

/*** LOCAL PERSISTENCE (timer + vote lock) ***/
const VOTE_NS='rs_vote_'; const TIMER_NS='rs_timer_';
const lockKey =(id)=> VOTE_NS+id;
const timerKey=(id)=> TIMER_NS+id;
const setLocalTimer =(id,ends)=> localStorage.setItem(timerKey(id), String(ends));
const getLocalTimer =(id)=> { const v=localStorage.getItem(timerKey(id)); return v?Number(v):null; };
const clearLocalTimer=(id)=> localStorage.removeItem(timerKey(id));
const clearVoteLocks=()=>{ const rm=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && (k.startsWith(VOTE_NS)||k.startsWith(TIMER_NS))) rm.push(k); } rm.forEach(k=>localStorage.removeItem(k)); };

/*** DATA MODEL ***/
let rounds, flat, sel=null, tickHandle=null, chosen=null, showFinished=false;
function makeTournament(){
  const entries = Array.from({length:32}, (_,i)=>({name:`Seed ${i+1}`, img:`https://picsum.photos/seed/e${i+1}/800/1000`}));
  rounds = {1:[],2:[],3:[],4:[],5:[]};
  for (let i=0;i<16;i++){
    rounds[1].push({ id:`R32_${i+1}`, round:1, index:i+1,
      A:{name:entries[2*i].name, img:entries[2*i].img},
      B:{name:entries[2*i+1].name, img:entries[2*i+1].img},
      votesA:0, votesB:0, ends:null, decided:false });
  }
  for (let r=2, size=8; r<=5; r++, size=Math.max(1,size/2)){
    for (let i=0;i<size;i++){
      rounds[r].push({ id:`${roundLabel[r]}_${i+1}`, round:r, index:i+1,
        A:{}, B:{}, votesA:0, votesB:0, ends:null, decided:false });
    }
  }
  flat=[...rounds[1],...rounds[2],...rounds[3],...rounds[4],...rounds[5]];
}

/*** DOM REFS ***/
const listEl=document.getElementById('matchList');
const detailRound=document.getElementById('detailRound');
const detailIndex=document.getElementById('detailIndex');
const detailState=document.getElementById('detailState');
const detailClock=document.getElementById('detailClock');
const leftArt=document.getElementById('leftArt'), rightArt=document.getElementById('rightArt');
const leftTbd=document.getElementById('leftTbd'), rightTbd=document.getElementById('rightTbd');
const leftName=document.getElementById('leftName'), rightName=document.getElementById('rightName');
const leftVotes=document.getElementById('leftVotes'), rightVotes=document.getElementById('rightVotes');
const btnLeft=document.getElementById('btnLeft'), btnRight=document.getElementById('btnRight');
const btnSubmit=document.getElementById('btnSubmit');
const voteLockBadge=document.getElementById('voteLock');
const btnReset=document.getElementById('btnReset'), btnForce=document.getElementById('btnForce'), btnClearVotes=document.getElementById('btnClearVotes');
const toggleFinished=document.getElementById('toggleFinished');

/*** SUPABASE SYNC ***/
async function ensureRowsExist(){
  const rows = flat.map(m => ({ slug:m.id, round:m.round, idx:m.index }));
  const { error } = await supabase.from(MATCH_TABLE).insert(rows, { onConflict:'slug', ignoreDuplicates:true });
  if (error) { console.warn('ensureRowsExist error', error); toast('DB insert blocked (RLS?)'); }
}
async function loadServerState(){
  const { data, error } = await supabase.from(MATCH_TABLE).select('slug,ends,decided,votesA,votesB');
  if (error) { console.warn('loadServerState error', error); return; }
  const map = new Map(data.map(r=>[r.slug,r]));
  for (const m of flat){
    const row = map.get(m.id);
    if (row){
      m.decided=!!row.decided;
      m.ends   = row.ends ? new Date(row.ends).getTime() : null;
      m.votesA = row.votesA ?? 0;
      m.votesB = row.votesB ?? 0;
    }
    if (!m.ends){ const local=getLocalTimer(m.id); if(local && local>nowMs()) m.ends=local; }
  }
}
async function startFreshTimerIfReady(node){
  if(node.A?.img && node.B?.img && !node.ends && !node.decided){
    const proposedEnds = nowMs()+ROUND_MS;
    // server first
    const resp = await supabase.rpc('start_timer_by_slug', { p_slug: node.id, p_ends: toIso(proposedEnds) });
    if (!resp.error && (resp.data?.ends || (Array.isArray(resp.data)&&resp.data[0]?.ends))){
      const row = Array.isArray(resp.data) ? resp.data[0] : resp.data;
      node.ends = new Date(row.ends).getTime();
      setLocalTimer(node.id, node.ends);
    } else {
      // local fallback
      node.ends = proposedEnds;
      setLocalTimer(node.id, node.ends);
      console.warn('[timer] local fallback', node.id, resp.error||'(no row updated)');
    }
    repaintRow(node.id);
    if (sel===node.id) select(node.id);
  }
}
async function decideOnServer(slug, decided=true){
  const { error } = await supabase.rpc('decide_match_by_slug', { p_slug: slug, p_decided: decided });
  if (error) console.warn('decide rpc error', error);
}
async function castVoteOnServer(slug, side){
  const { data, error } = await supabase.rpc('cast_vote_by_slug', { p_slug: slug, p_side: side });
  if (error) throw error;
  return Array.isArray(data)?data[0]:data;
}

/*** UI BUILDERS ***/
function isRoundComplete(r){ return rounds[r].every(m=>m.decided); }
function visibleMatches(){ const cur=[1,2,3,4,5].find(r=>rounds[r].some(m=>!m.decided))||5; return flat.filter(m=> showFinished ? true : m.round>=cur); }

function buildList(preserveId){
  listEl.innerHTML='';
  for (const m of visibleMatches()){
    const item=document.createElement('div'); item.className='matchItem'; item.dataset.id=m.id;
    const mini=document.createElement('div'); mini.className='thumbMini';
    mini.innerHTML=`<img src="${m.A?.img||BLANK}"><img src="${m.B?.img||BLANK}">`;
    const mid=document.createElement('div');
    const title=document.createElement('div'); title.className='title';
    title.textContent=`${m.A?.name||'TBD'} vs ${m.B?.name||'TBD'}`;
    const row=document.createElement('div'); row.className='metaRow';
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=roundLabel[m.round];
    const timer=document.createElement('span'); timer.className='timer';
    if(m.ends){timer.dataset.ends=m.ends; timer.textContent=fmt(m.ends-nowMs());}
    row.append(badge,timer); mid.append(title,row);
    const score=document.createElement('div'); score.textContent=`${m.votesA||0} - ${m.votesB||0}`;
    item.append(mini,mid,score);
    item.addEventListener('click',()=>select(m.id));
    listEl.appendChild(item);
  }
  const first = (visibleMatches().find(x=>x.A.img&&x.B.img) || visibleMatches()[0])?.id;
  if (first) select(preserveId||first);
}

function repaintRow(id){
  const m=flat.find(x=>x.id===id); if(!m) return;
  const row=[...listEl.children].find(c=>c.dataset.id===id); if(!row) return;
  const imgs=row.querySelectorAll('.thumbMini img');
  if(imgs[0]) imgs[0].src=m.A?.img||BLANK;
  if(imgs[1]) imgs[1].src=m.B?.img||BLANK;
  row.querySelector('.title').textContent=`${m.A?.name||'TBD'} vs ${m.B?.name||'TBD'}`;
  const t=row.querySelector('.timer');
  if(m.ends){ t.dataset.ends=m.ends; t.textContent=fmt(m.ends-nowMs()); }
  else { t.removeAttribute('data-ends'); t.textContent=''; }
  row.lastChild.textContent=`${m.votesA||0} - ${m.votesB||0}`;
}

/*** SELECTION & TICK ***/
function select(id){
  sel=id; chosen=null;
  [...listEl.children].forEach(li=>li.classList.toggle('selected',li.dataset.id===id));
  const m=flat.find(x=>x.id===id); if(!m) return;

  detailRound.textContent=roundLabel[m.round];
  detailIndex.textContent=`Match ${m.index}/${rounds[m.round].length}`;

  const canVote=!!(m.A.img&&m.B.img);
  detailState.textContent=m.decided?'DECIDED':(m.ends?'OPEN':(canVote?'READY':'TBD'));

  leftArt.src=m.A.img||BLANK; rightArt.src=m.B.img||BLANK;
  leftTbd.style.display=m.A.img?'none':'flex';
  rightTbd.style.display=m.B.img?'none':'flex';
  leftName.textContent=m.A.name||'TBD'; rightName.textContent=m.B.name||'TBD';
  leftVotes.textContent=m.votesA||0; rightVotes.textContent=m.votesB||0;

  const already=!!localStorage.getItem(lockKey(m.id));
  btnLeft.disabled=btnRight.disabled=!m.ends||already||m.decided;
  btnSubmit.disabled=true;
  voteLockBadge.style.display=already?'inline-block':'none';
  btnLeft.classList.remove('active'); btnRight.classList.remove('active');

  if(m.ends){detailClock.dataset.ends=m.ends;} else {detailClock.removeAttribute('data-ends');}
  updateClock();

  clearInterval(tickHandle); tickHandle=setInterval(updateClock,1000);
}
function updateClock(){ const m=flat.find(x=>x.id===sel); if(!m) return;
  const ms=(m.ends||0)-nowMs(); detailClock.textContent=fmt(ms>0?ms:0); }

const nextId=(id)=>{const [r,i]=id.split('_');const idx=parseInt(i,10);
  if(r==='R32')return`R16_${Math.ceil(idx/2)}`;
  if(r==='R16')return`QF_${Math.ceil(idx/2)}`;
  if(r==='QF')return`SF_${Math.ceil(idx/2)}`;
  if(r==='SF')return`FINAL_1`; return null;};

function winnerObj(m){ const a=m.votesA||0,b=m.votesB||0; return a>b?m.A:b>a?m.B:(Math.random()<.5?m.A:m.B); }
async function finalizeMatch(m){
  if(m.decided) return false;
  m.decided=true; m.ends=null; clearLocalTimer(m.id);
  await decideOnServer(m.id,true);
  const winner=winnerObj(m);
  const nid=nextId(m.id);
  if(!nid){ repaintRow(m.id); if(sel===m.id) select(m.id); return true; }
  const nr=flat.find(x=>x.id===nid); if(!nr) return true;
  if(!nr.A.img) nr.A={...winner}; else if(!nr.B.img) nr.B={...winner};
  repaintRow(m.id); repaintRow(nr.id);
  startFreshTimerIfReady(nr);
  if(rounds[m.round].every(x=>x.decided)) buildList(nr.id); else select(nr.id);
  return true;
}
function globalTick(){
  let any=false;
  for(const m of flat){
    if(m.ends && !m.decided){
      const left=m.ends-nowMs();
      const row=[...listEl.children].find(c=>c.dataset.id===m.id);
      const t=row?.querySelector('.timer'); if(t){t.textContent=fmt(Math.max(left,0)); t.dataset.ends=m.ends;}
      if(left<=0){ any = (finalizeMatch(m) || any); }
    }
  }
  if(sel){ const m=flat.find(x=>x.id===sel); if(m){ leftVotes.textContent=m.votesA||0; rightVotes.textContent=m.votesB||0; const can=!!(m.A.img&&m.B.img); detailState.textContent=m.decided?'DECIDED':(m.ends?'OPEN':(can?'READY':'TBD')); updateClock(); } }
  if(any) buildList(sel);
}

/*** VOTING ***/
function setChoice(side){ const m=flat.find(x=>x.id===sel); if(!m) return;
  if(!m.ends || m.decided) return;
  chosen=side; btnLeft.classList.toggle('active',side==='A'); btnRight.classList.toggle('active',side==='B'); btnSubmit.disabled=false;
}
btnLeft.addEventListener('click',()=>setChoice('A'));
btnRight.addEventListener('click',()=>setChoice('B'));
btnSubmit.addEventListener('click', async ()=>{
  const m=flat.find(x=>x.id===sel); if(!m) return;
  if(!m.ends || m.decided){ toast('Voting closed'); return; }
  const key=lockKey(m.id);
  if(localStorage.getItem(key)){ toast('You already voted here'); return; }
  if(!chosen){ toast('Pick a side'); return; }
  try{
    const row=await castVoteOnServer(m.id, chosen);
    m.votesA=row.votesa ?? row.votesA ?? m.votesA;
    m.votesB=row.votesb ?? row.votesB ?? m.votesB;
    localStorage.setItem(key, chosen);
    voteLockBadge.style.display='inline-block';
    btnLeft.disabled=btnRight.disabled=true; btnSubmit.disabled=true;
    repaintRow(m.id); toast('Vote submitted');
  }catch(e){ console.warn('vote error', e); toast('Vote failed (RPC/RLS)'); }
});

/*** CONTROLS ***/
btnReset.addEventListener('click', async ()=>{
  clearVoteLocks();
  makeTournament();
  await initAfterBuild();
  toast('Reset complete');
});
btnForce.addEventListener('click', ()=>{ const m=flat.find(x=>x.id===sel); if(!m||m.decided) return; m.ends=nowMs(); finalizeMatch(m); });
btnClearVotes.addEventListener('click', ()=>{ clearVoteLocks(); voteLockBadge.style.display='none'; const m=flat.find(x=>x.id===sel); if(m && m.ends && !m.decided){ btnLeft.disabled=btnRight.disabled=false; } toast('Local votes cleared'); });
toggleFinished.addEventListener('change',(e)=>{ showFinished=e.target.checked; buildList(sel); });

/*** INIT ***/
async function initAfterBuild(){
  await ensureRowsExist();
  await loadServerState();
  for(const m of flat) await startFreshTimerIfReady(m);
  buildList();
  clearInterval(tickHandle); tickHandle=setInterval(globalTick,250);
}
async function init(){
  makeTournament();
  await initAfterBuild();
}
init();
</script>
</body>
</html>