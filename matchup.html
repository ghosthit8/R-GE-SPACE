<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Matchup (8→2→1, 90s)</title>
  <link rel="preconnect" href="https://tuqvpcevrhciursxrgav.supabase.co">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#8b8b8b; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0; font-size:20px; font-weight:800; letter-spacing:.4px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:800; font-size:24px; padding:6px 10px; border:1px solid #20242a; border-radius:12px; background:#0f1318; }
    .state { color:var(--muted); font-size:12px; }
    .btn, .linkbtn { appearance:none; border:1px solid #20242a; background:#0b0f13; color:#e5e7eb; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    .card { margin-top:12px; border:1px solid #20242a; border-radius:16px; overflow:hidden; background:#0f1318; }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:#0b0f13; color:#e5e7eb; border:1px solid #20242a; border-radius:8px; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid #20242a; }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .vote { appearance:none; border:1px solid #20242a; background:#0b0f13; color:#e5e7eb; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; }
    .vote:disabled { opacity:.6; cursor:default; }
    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:flex; gap:10px; flex-wrap:wrap; }
    .thumb { width:110px; border:1px solid #20242a; border-radius:12px; overflow:hidden; background:#0f1318; cursor:pointer; }
    .thumb.hidden { display:none; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }
    .thumb-img { width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .thumb-img img { width:100%; height:100%; object-fit:cover; }
    .thumb-label { padding:4px 6px 6px; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
    .thumb-count { font-variant-numeric: tabular-nums; font-weight:700; }
    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:#39ff14; }
    .final-card { margin-top:14px; }
    .final-inner { display:flex; gap:12px; flex-wrap:wrap; padding:12px; }
    .final-slot { flex:1 1 150px; background:#0b0f13; border:1px solid #20242a; border-radius:10px; padding:8px; text-align:center; }
    .final-slot .label { display:block; margin-bottom:4px; }
    .final-slot .thumb-final { width:100%; aspect-ratio:3/4; background:#111; border-radius:8px; overflow:hidden; display:grid; place-items:center; }
    .final-slot .thumb-final img { width:100%; height:100%; object-fit:cover; }
    .final-footer { padding:0 12px 12px; font-size:12px; color:#9aa0a6; }
    .fullscreen-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.95); justify-content:center; align-items:center; z-index:9999; }
    .fullscreen-overlay img { max-width:90%; max-height:90%; border-radius:8px; }
    .fullscreen-overlay button { position:absolute; top:20px; right:20px; background:#0b0f13; border:1px solid #20242a; color:#e5e7eb; padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Rage Space</h1>
      <div class="row">
        <a class="linkbtn" href="./winners.html">Winners</a>
        <div class="timer" id="tRemain">0.0</div>
        <div class="state" id="tMeta"></div>
      </div>
    </div>

    <!-- ACTIVE — TOP -->
    <div class="card" id="activeTop">
      <div class="imgBox">
        <img id="imgActive1" alt="Active 1">
        <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive1">Seed A</div>
        <div class="counts" id="countActive1">0</div>
        <button class="vote" id="btnActive1">Vote</button>
      </div>
    </div>

    <!-- ACTIVE — BOTTOM -->
    <div class="card" id="activeBottom">
      <div class="imgBox">
        <img id="imgActive2" alt="Active 2">
        <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive2">Seed B</div>
        <div class="counts" id="countActive2">0</div>
        <button class="vote" id="btnActive2">Vote</button>
      </div>
    </div>

    <!-- OTHER MATCHES -->
    <div class="thumbs-wrap">
      <div class="thumbs-title">Other round</div>
      <div class="thumbs">
        <div class="thumb" id="thumbAB">
          <div class="thumb-img"><img id="thumbABimg" alt="A vs B"></div>
          <div class="thumb-label"><span>A vs B</span><span class="thumb-count" id="thumbABcount">0-0</span></div>
        </div>
        <div class="thumb" id="thumbCD">
          <div class="thumb-img"><img id="thumbCDimg" alt="C vs D"></div>
          <div class="thumb-label"><span>C vs D</span><span class="thumb-count" id="thumbCDcount">0-0</span></div>
        </div>
        <!-- NEW: EF & GH for 8-up quarters -->
        <div class="thumb" id="thumbEF">
          <div class="thumb-img"><img id="thumbEFimg" alt="E vs F"></div>
          <div class="thumb-label"><span>E vs F</span><span class="thumb-count" id="thumbEFcount">0-0</span></div>
        </div>
        <div class="thumb" id="thumbGH">
          <div class="thumb-img"><img id="thumbGHimg" alt="G vs H"></div>
          <div class="thumb-label"><span>G vs H</span><span class="thumb-count" id="thumbGHcount">0-0</span></div>
        </div>
        <div class="thumb" id="thumbFinal">
          <div class="thumb-img"><img id="thumbFinalImg" alt="Final"></div>
          <div class="thumb-label"><span>Final</span><span class="thumb-count" id="thumbFinalCount">0-0</span></div>
        </div>
      </div>
    </div>

    <div class="winner" id="winnerText">Quarters running…</div>

    <!-- FINAL BOX -->
    <div class="card final-card" id="finalCard">
      <div class="bar">
        <div class="label">Final</div>
        <div style="font-size:12px;color:#a1a1a1;">Decides at 0s</div>
      </div>
      <div class="final-inner">
        <div class="final-slot">
          <span class="label">Winner of A vs B</span>
          <div class="thumb-final"><img id="finalImg1" alt="Final slot 1"></div>
        </div>
        <div class="final-slot">
          <span class="label">Winner of C vs D</span>
          <div class="thumb-final"><img id="finalImg2" alt="Final slot 2"></div>
        </div>
      </div>
      <div class="final-footer" id="finalFooter">Waiting for semis…</div>
    </div>

    <div class="hint">8 images → QFs at 60s → SFs at 30s → Final at 0s.</div>

    <div class="row" style="margin-top:10px; gap:6px;">
      <button class="btn" id="forceBtn">Sync</button>
      <button class="btn ghost" id="resetBtn">Reset View</button>
    </div>

    <div id="debugBox" style="margin-top:8px;font-size:12px;color:#9aa0a6;">debug: idle…</div>
  </div>

  <!-- Fullscreen overlay -->
  <div class="fullscreen-overlay" id="overlay" onclick="closeFull()">
    <img id="fullImg" alt="Full view">
    <button onclick="closeFull()">×</button>
  </div>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTcyOTU1NjQ0NCwiZXhwIjoyMDcyMDc2NDQ0fQ.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    // === DOM ===
    const elRemain = document.getElementById("tRemain");
    const elMeta   = document.getElementById("tMeta");
    const dbg      = document.getElementById("debugBox");
    const winnerText = document.getElementById("winnerText");

    const imgActive1 = document.getElementById("imgActive1");
    const imgActive2 = document.getElementById("imgActive2");
    const labelActive1 = document.getElementById("labelActive1");
    const labelActive2 = document.getElementById("labelActive2");
    const countActive1 = document.getElementById("countActive1");
    const countActive2 = document.getElementById("countActive2");
    const btnActive1 = document.getElementById("btnActive1");
    const btnActive2 = document.getElementById("btnActive2");

    const thumbAB = document.getElementById("thumbAB");
    const thumbABimg = document.getElementById("thumbABimg");
    const thumbABcount = document.getElementById("thumbABcount");

    const thumbCD = document.getElementById("thumbCD");
    const thumbCDimg = document.getElementById("thumbCDimg");
    const thumbCDcount = document.getElementById("thumbCDcount");

    const thumbEF = document.getElementById("thumbEF");
    const thumbEFimg = document.getElementById("thumbEFimg");
    const thumbEFcount = document.getElementById("thumbEFcount");

    const thumbGH = document.getElementById("thumbGH");
    const thumbGHimg = document.getElementById("thumbGHimg");
    const thumbGHcount = document.getElementById("thumbGHcount");

    const thumbFinal = document.getElementById("thumbFinal");
    const thumbFinalImg = document.getElementById("thumbFinalImg");
    const thumbFinalCount = document.getElementById("thumbFinalCount");

    const finalImg1 = document.getElementById("finalImg1");
    const finalImg2 = document.getElementById("finalImg2");
    const finalFooter = document.getElementById("finalFooter");

    const overlay  = document.getElementById("overlay");
    const fullImg  = document.getElementById("fullImg");

    function openFull(which){ const src = (which==='active1'? imgActive1.src: imgActive2.src); fullImg.src = src; overlay.style.display='flex'; }
    function closeFull(){ overlay.style.display='none'; }

    const placeholder = (s)=>`https://picsum.photos/seed/${encodeURIComponent(s)}/900/1200`;

    // === CLIENT STATE ===
    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID) { RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now()); localStorage.setItem(RSID_KEY, RSID); }

    let state = {
      base_iso: null, ends_at: null, period_sec: 90,
      seed_a_url: null, seed_b_url: null, seed_c_url: null, seed_d_url: null,
      seed_e_url: null, seed_f_url: null, seed_g_url: null, seed_h_url: null,
      seed_a_count: 0, seed_b_count: 0, seed_c_count: 0, seed_d_count: 0,
      seed_e_count: 0, seed_f_count: 0, seed_g_count: 0, seed_h_count: 0,
      q_done: false, mid_done: false, final_ready: false,
      mid_winner_1_url: null, mid_winner_2_url: null,
      remaining_sec: 0,
    };

    let activeMatch = "ab"; // "ab" | "cd" | "ef" | "gh" | "final"

    // === RENDERING ===
    function renderFinal() {
      if (!state.mid_done) {
        finalImg1.src = placeholder("?");
        finalImg2.src = placeholder("?");
        finalFooter.textContent = "Waiting for semis…";
        thumbFinal.style.display = "none";
        return;
      }
      finalImg1.src = state.mid_winner_1_url || placeholder("?");
      finalImg2.src = state.mid_winner_2_url || placeholder("?");
      finalFooter.textContent = "Decides at 0s";
      thumbFinal.style.display = "block";
      thumbFinalImg.src = state.mid_winner_1_url || state.mid_winner_2_url || placeholder("Final");
      const fcA = state.seed_a_count|0, fcB = state.seed_b_count|0;
      thumbFinalCount.textContent = `${fcA}-${fcB}`;
    }

    function renderThumbs(){
      thumbABimg.src = state.seed_a_url || placeholder("A");
      thumbABcount.textContent = `${state.seed_a_count|0}-${state.seed_b_count|0}`;
      thumbCDimg.src = state.seed_c_url || placeholder("C");
      thumbCDcount.textContent = `${state.seed_c_count|0}-${state.seed_d_count|0}`;

      // EF/GH visible only until quarters are cut
      const showQ = !state.q_done;
      thumbEF.classList.toggle("hidden", !showQ);
      thumbGH.classList.toggle("hidden", !showQ);
      thumbEFimg.src = state.seed_e_url || placeholder("E");
      thumbEFcount.textContent = `${state.seed_e_count|0}-${(state.seed_f_count|0)}`;
      thumbGHimg.src = state.seed_g_url || placeholder("G");
      thumbGHcount.textContent = `${state.seed_g_count|0}-${(state.seed_h_count|0)}`;

      renderFinal();

      // active ring
      for (const id of ["thumbAB","thumbCD","thumbEF","thumbGH","thumbFinal"]) {
        const el = document.getElementById(id);
        if (!el) continue;
        const key = id.replace("thumb","").toLowerCase();
        const isFinal = id==="thumbFinal";
        el.classList.toggle("active", isFinal ? (activeMatch==="final") : (activeMatch===key));
      }

      if (!state.q_done) winnerText.textContent = "Quarters running…";
      else if (!state.mid_done) winnerText.textContent = "Semis running…";
      else winnerText.textContent = "Semis decided — final at 0s.";
    }

    function renderActive(){
      let l1="Seed A", l2="Seed B", u1=state.seed_a_url, u2=state.seed_b_url, c1=state.seed_a_count, c2=state.seed_b_count;

      if (activeMatch === "cd") {
        l1="Seed C"; l2="Seed D";
        u1 = state.seed_c_url; u2 = state.seed_d_url;
        c1 = state.seed_c_count|0; c2 = state.seed_d_count|0;
      } else if (activeMatch === "ef") {
        l1="Seed E"; l2="Seed F";
        u1 = state.seed_e_url; u2 = state.seed_f_url;
        c1 = state.seed_e_count|0; c2 = state.seed_f_count|0;
      } else if (activeMatch === "gh") {
        l1="Seed G"; l2="Seed H";
        u1 = state.seed_g_url; u2 = state.seed_h_url;
        c1 = state.seed_g_count|0; c2 = state.seed_h_count|0;
      } else if (activeMatch === "final") {
        l1="Final — Left"; l2="Final — Right";
        u1 = state.mid_winner_1_url || state.seed_a_url;
        u2 = state.mid_winner_2_url || state.seed_b_url;
        c1 = state.seed_a_count|0; c2 = state.seed_b_count|0;
      }

      imgActive1.src = u1 || placeholder("?");
      imgActive2.src = u2 || placeholder("?");
      labelActive1.textContent = l1;
      labelActive2.textContent = l2;
      countActive1.textContent = c1|0;
      countActive2.textContent = c2|0;

      renderThumbs();
    }

    // === EVENTS ===
    thumbAB.addEventListener("click", () => { activeMatch="ab"; renderActive(); });
    thumbCD.addEventListener("click", () => { activeMatch="cd"; renderActive(); });
    thumbEF.addEventListener("click", () => { if (!state.q_done) { activeMatch="ef"; renderActive(); } });
    thumbGH.addEventListener("click", () => { if (!state.q_done) { activeMatch="gh"; renderActive(); } });
    thumbFinal.addEventListener("click", () => { if (state.mid_done) { activeMatch="final"; renderActive(); } });

    async function sendVote(whichSide){
      let side = activeMatch; // ab|cd|ef|gh|final
      const color = whichSide === "right" ? "blue" : "red";
      if (side === "final") side = "ab";
      const voterId = `${(localStorage.getItem("rsid_v2")||"rs")}-${state.base_iso || "noiso"}-${side}-${state.q_done ? (state.mid_done ? "final" : "semi") : "quarter"}`;

      try {
        const res = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json', 'x-rsid': voterId },
          body: JSON.stringify({ color, side })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "vote failed");

        state.seed_a_count = data.seed_a_count ?? state.seed_a_count;
        state.seed_b_count = data.seed_b_count ?? state.seed_b_count;
        state.seed_c_count = data.seed_c_count ?? state.seed_c_count;
        state.seed_d_count = data.seed_d_count ?? state.seed_d_count;
        state.seed_e_count = data.seed_e_count ?? state.seed_e_count;
        state.seed_f_count = data.seed_f_count ?? state.seed_f_count;
        state.seed_g_count = data.seed_g_count ?? state.seed_g_count;
        state.seed_h_count = data.seed_h_count ?? state.seed_h_count;

        renderActive();
        dbg.textContent = "debug: vote ok on " + side;
      } catch (err) {
        dbg.textContent = "debug: vote error → " + err.message;
      }
    }

    btnActive1.onclick = () => sendVote("left");
    btnActive2.onclick = () => sendVote("right");

    // === SYNC / TICK ===
    let fetching = false;
    let lastEnds = "";

    async function fetchState(force=false){
      if (fetching) return;
      fetching = true;
      try {
        const res = await fetch(FUNCTION_URL);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || JSON.stringify(data));

        const newRound = state.base_iso && state.base_iso !== data.base_iso;
        state = { ...state, ...data };
        elMeta.textContent = `cycle: ${data.base_iso}`;
        if (newRound) {
          activeMatch = "ab";
          dbg.textContent = "debug: new cycle synced";
        }
        if (state.ends_at !== lastEnds) lastEnds = state.ends_at;
        renderActive();
      } catch (err) {
        dbg.textContent = "debug: sync error → " + err.message;
      } finally {
        fetching = false;
      }
    }

    function tick(){
      if (!state.ends_at) { requestAnimationFrame(tick); return; }
      const ms = new Date(state.ends_at).getTime() - Date.now();
      elRemain.textContent = Math.max(0, (ms/1000)).toFixed(1);

      // Phase hints + server syncs right after thresholds
      if (ms <= 60000 + 400 && !state.q_done) winnerText.textContent = 'Quarters about to be decided…';
      if (ms <= 30000 + 400 && state.q_done && !state.mid_done) winnerText.textContent = 'Semis about to be decided…';

      if (ms <= 60000 && !state.q_done) {
        fetch(FUNCTION_URL).then(r=>r.json()).then(d=>{ state=d; renderActive(); dbg.textContent="debug: quarters synced (≤60s)"; }).catch(()=>{});
      }
      if (ms <= 30000 && state.q_done && !state.mid_done) {
        fetch(FUNCTION_URL).then(r=>r.json()).then(d=>{ state=d; renderActive(); dbg.textContent="debug: semis synced (≤30s)"; }).catch(()=>{});
      }
      if (ms <= 0 && state.mid_done) {
        fetch(FUNCTION_URL).then(r=>r.json()).then(d=>{ state=d; renderActive(); dbg.textContent="debug: final synced (0s)"; }).catch(()=>{});
      }

      if (ms <= -900) { fetchState().catch(()=>{}); }

      requestAnimationFrame(tick);
    }

    document.getElementById('forceBtn').addEventListener('click', ()=> fetchState(true));
    document.getElementById('resetBtn').addEventListener('click', ()=> { activeMatch="ab"; renderActive(); });

    // optional realtime auto-sync
    supabase.channel('cycles-v2-live')
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'cycles_v2' }, async ()=>{ await fetchState(true); })
      .subscribe();

    fetchState(true).then(()=>tick());
  </script>
</body>
</html>