<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî Matchup</title>
  <link rel="stylesheet" href="style.css?v=4" />
  <style>
    :root{ --green:#39ff14; --red:#ff0033; --bg:#000; --ink:#e5ffe5; --card:#070707; --muted:#8aff8a; --border:#0f2510; --maxw: 980px; }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; background:#000; color:var(--green); font-family: ui-sans-serif,system-ui,Arial,Helvetica,sans-serif; -webkit-font-smoothing: antialiased; }
    .wrap{ max-width:var(--maxw); margin:16px auto 64px; padding:0 16px; }
    h1{ letter-spacing:.06em }
    .scorebar{ display:flex; gap:12px; align-items:center; justify-content:space-between; border:1px solid var(--border); padding:8px 12px; border-radius:10px; background:rgba(7,7,7,.6); box-shadow: 0 0 18px rgba(57,255,20,.08) inset; }
    .btn{ border:1px solid var(--green); color:var(--green); text-decoration:none; padding:8px 12px; border-radius:10px; display:inline-flex; align-items:center; gap:8px; background:transparent; cursor:pointer; }
    .btn.primary{ background:rgba(57,255,20,.08) }
    .btn:disabled{ opacity:.45; cursor:not-allowed }
    .grid{ margin-top:18px; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .tile{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(7,7,7,.6); position:relative; }
    .art{ aspect-ratio:4/5; background:linear-gradient(45deg, rgba(57,255,20,.08), transparent 60%), #050505; display:block; width:100%; object-fit:cover; }
    .tbdBadge{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:3rem; font-weight:900; color:rgba(57,255,20,.75); text-shadow:0 0 10px rgba(57,255,20,.4); pointer-events:none; }
    .meta{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 12px; border-top:1px solid var(--border); }
    .badge{ font-size:.9rem; color:var(--ink); opacity:.75; }
    .countdown{ margin-top:12px; text-align:center; font-variant-numeric:tabular-nums; }
    .vote-row{ margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:center; }
    .stateTag{ padding:3px 8px; border:1px solid var(--border); border-radius:999px; font-size:.8rem; opacity:.85; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#0a0a0a; color:#e5ffe5; border:1px solid var(--border); border-radius:12px; padding:10px 14px; display:none; box-shadow:0 0 18px rgba(57,255,20,.2); z-index:9999; }
    @media (max-width:760px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header class="wrap" style="padding-top:0">
    <h1>R<span class="anarchy">‚í∂</span>GE SPACE ‚Äî MATCHUP</h1>
  </header>

  <div class="wrap">
    <div class="scorebar">
      <div>
        <span class="stateTag" id="stateTag">‚Äî</span>
        <span class="badge">Round <span id="roundNum">‚Äì</span>, Match <span id="battleIndex">1</span>/<span id="battleTotal">1</span></span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="btn" href="tournament-brackets.html">üèÅ Brackets</a>
        <a class="btn" href="menu.html">‚Üê Menu</a>
      </div>
    </div>

    <div class="countdown">Decision in: <span id="clock">00:00:00</span></div>

    <div class="grid" id="grid">
      <div class="tile" id="leftTile">
        <img id="leftArt" class="art" alt="Left entry" />
        <div id="leftTbd" class="tbdBadge" style="display:none">?</div>
        <div class="meta">
          <span id="leftLabel">Entry ‚Äî LEFT</span>
          <button class="btn primary" id="voteLeft">Vote Left</button>
        </div>
      </div>

      <div class="tile" id="rightTile">
        <img id="rightArt" class="art" alt="Right entry" />
        <div id="rightTbd" class="tbdBadge" style="display:none">?</div>
        <div class="meta">
          <span id="rightLabel">Entry ‚Äî RIGHT</span>
          <button class="btn primary" id="voteRight">Vote Right</button>
        </div>
      </div>
    </div>

    <div class="vote-row">
      <button class="btn" id="submitBtn" disabled>‚úÖ Submit Vote</button>
      <button class="btn" id="skipBtn" title="Go to next battle">‚è≠ Next</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Keep true while brackets are in demo (R32_1..16). Flip to false when live.
    const DEMO_MODE = true;

    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const TOURNAMENT_ID = "682da23f-6e32-4782-8b8a-8e59527d6b58";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const toast = document.getElementById('toast');
    const clock = document.getElementById('clock');
    const roundNumEl = document.getElementById('roundNum');
    const battleIndexEl = document.getElementById('battleIndex');
    const battleTotalEl = document.getElementById('battleTotal');
    const stateTag = document.getElementById('stateTag');
    const leftArt = document.getElementById('leftArt'), rightArt = document.getElementById('rightArt');
    const leftLabel = document.getElementById('leftLabel'), rightLabel = document.getElementById('rightLabel');
    const leftTbd = document.getElementById('leftTbd'), rightTbd = document.getElementById('rightTbd');
    const voteLeftBtn = document.getElementById('voteLeft'), voteRightBtn = document.getElementById('voteRight');
    const submitBtn = document.getElementById('submitBtn'), skipBtn = document.getElementById('skipBtn');

    let BATTLES = []; let idx = 0; let chosen = null; let tickHandle = null;

    const SESSION_KEY = 'rs_session_id';
    let sessionId = localStorage.getItem(SESSION_KEY);
    if (!sessionId){ sessionId = crypto.randomUUID(); localStorage.setItem(SESSION_KEY, sessionId); }

    const urlParams = new URLSearchParams(location.search);
    const deepId = urlParams.get('battle');

    const lockKey = (id)=> `rs_vote_${id}`;

    function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none', 1400); }
    function fmt(ms){ if(ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
    function safeImg(el, url){ if (!url){ el.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; return false; } el.src = url; return true; }

    function demoBattles32(){
      const now = Date.now(), ends = now + 24*60*60*1000;
      const entries = Array.from({length:32}, (_,i)=>({ name:`Seed ${i+1}`, img:`https://picsum.photos/seed/e${i+1}/800/1000` }));
      const arr=[];
      for (let i=0;i<16;i++){
        const A=entries[2*i], B=entries[2*i+1];
        arr.push({ id:`R32_${i+1}`, round:1, indexInRound:i+1, state:'open',
          start:new Date(now-60*1000).toISOString(), end:new Date(ends).toISOString(),
          A:{id:`E${2*i+1}`, name:A.name, img:A.img},
          B:{id:`E${2*i+2}`, name:B.name, img:B.img},
          votesA:0, votesB:0
        });
      }
      return arr;
    }

    async function loadBattles(){
      if (DEMO_MODE){
        BATTLES = demoBattles32();
      } else {
        const { data, error } = await supabase
          .from('match_public')
          .select('*')
          .eq('tournament_id', TOURNAMENT_ID)
          .order('round_number', { ascending: true })
          .order('index_in_round', { ascending: true });
        if (error){ console.error(error); showToast('Failed to load matches.'); return; }
        BATTLES = (data||[]).map(r => ({
          id:r.id, round:r.round_number, indexInRound:r.index_in_round,
          state:r.state, start:r.start_time, end:r.end_time,
          A:{id:r.a_id, name:r.a_name, img:r.a_image},
          B:{id:r.b_id, name:r.b_name, img:r.b_image},
          votesA:r.votes_a ?? 0, votesB:r.votes_b ?? 0
        }));
      }

      battleTotalEl.textContent = BATTLES.length;

      if (deepId){
        const j = BATTLES.findIndex(b => b.id === deepId);
        if (j >= 0) idx = j; else {
          const k = BATTLES.findIndex(b => b.state === 'open');
          idx = (k >= 0 ? k : 0);
        }
      } else {
        const k = BATTLES.findIndex(b => b.state === 'open');
        idx = (k >= 0 ? k : 0);
      }

      if (!BATTLES.length){
        leftLabel.textContent='No matches available'; rightLabel.textContent='Check back soon';
        voteLeftBtn.disabled = voteRightBtn.disabled = submitBtn.disabled = true; return;
      }
      render(true);
    }

    function setVotedUI(){
      submitBtn.textContent = 'üéâ Vote submitted!';
      submitBtn.disabled = true;
      voteLeftBtn.disabled = true;
      voteRightBtn.disabled = true;
    }

    function render(replaceUrl=false){
      const b = BATTLES[idx];
      battleIndexEl.textContent = (idx+1).toString();
      roundNumEl.textContent = b.round;

      const targetUrl = `?battle=${encodeURIComponent(b.id)}`;
      if (replaceUrl) history.replaceState(null, '', targetUrl); else history.pushState(null, '', targetUrl);

      const now = Date.now(), starts = new Date(b.start).getTime(), ends = new Date(b.end).getTime();
      const inWindow = now >= starts && now < ends;
      const votable = b.state === 'open' && inWindow && b.A.img && b.B.img;
      stateTag.textContent = votable ? 'OPEN' : (now < starts ? 'SCHEDULED' : 'CLOSED');

      const hasA = safeImg(leftArt, b.A.img); const hasB = safeImg(rightArt, b.B.img);
      leftTbd.style.display = hasA ? 'none' : 'flex'; rightTbd.style.display = hasB ? 'none' : 'flex';
      leftLabel.textContent = hasA ? b.A.name : 'TBD'; rightLabel.textContent = hasB ? b.B.name : 'TBD';

      const alreadyVoted = !!localStorage.getItem(lockKey(b.id));
      submitBtn.textContent = '‚úÖ Submit Vote';
      submitBtn.disabled = true;
      voteLeftBtn.disabled = !votable || alreadyVoted;
      voteRightBtn.disabled = !votable || alreadyVoted;

      if (alreadyVoted) setVotedUI();

      chosen = null;
      if (tickHandle) clearInterval(tickHandle);
      updateClock(); tickHandle = setInterval(updateClock, 1000);
    }

    function updateClock(){
      const b = BATTLES[idx];
      const ms = new Date(b.end).getTime() - Date.now();
      clock.textContent = fmt(ms);
      if (ms <= 0){ setVotedUI(); }
    }

    voteLeftBtn.addEventListener('click', ()=>{ if (voteLeftBtn.disabled) return; chosen = 'A'; submitBtn.disabled = false; showToast('Selected LEFT'); });
    voteRightBtn.addEventListener('click', ()=>{ if (voteRightBtn.disabled) return; chosen = 'B'; submitBtn.disabled = false; showToast('Selected RIGHT'); });

    submitBtn.addEventListener('click', async ()=>{
      const b = BATTLES[idx]; if (!chosen) return;
      submitBtn.disabled = true;

      if (!DEMO_MODE){
        const { error } = await supabase.from('votes').insert({ match_id: b.id, slot: chosen, session_id: sessionId });
        if (error){ console.error(error); showToast('Vote failed.'); submitBtn.disabled = false; return; }
      }

      localStorage.setItem(lockKey(b.id), chosen);
      setVotedUI();
      showToast(`Vote submitted: ${chosen==='A'?'LEFT':'RIGHT'}`);
      setTimeout(nextBattle, 800);
    });

    skipBtn.addEventListener('click', nextBattle);
    function nextBattle(){ if (!BATTLES.length) return; idx = (idx + 1) % BATTLES.length; render(); }

    window.addEventListener('popstate', ()=>{
      const p = new URLSearchParams(location.search).get('battle');
      const j = BATTLES.findIndex(b => b.id === p);
      if (j >= 0){ idx = j; render(true); }
    });

    loadBattles();
  </script>
</body>
</html>