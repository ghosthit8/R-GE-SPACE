<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Matchup (4-up)</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#8b8b8b; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 88px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:32px; line-height:1; padding:8px 14px; border:1px solid #20242a; border-radius:12px; background:#0f1318; }
    .state { color:var(--muted); font-size:12px; }
    .card { margin-top:12px; border:1px solid #20242a; border-radius:16px; overflow:hidden; background:#0f1318; }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.55); color:var(--accent); border:1px solid var(--accent); border-radius:8px; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid #20242a; }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .btn, .vote, .linkbtn, .backbtn { appearance:none; border:1px solid #24303a; background:#131920; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }
    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:#39ff14; }
    .fullscreen-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:9999; }
    .fullscreen-overlay img { max-width:90%; max-height:90%; border-radius:8px; }
    .fullscreen-overlay button { position:absolute; top:20px; right:20px; background:#111; border:1px solid var(--accent); color:var(--accent); padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
    .splitTitle { font-size:12px; opacity:.6; margin-top:4px; }
    .debugbox { position:fixed; left:0; right:0; bottom:0; background:rgba(0,0,0,.75); color:#9ca3af; font-size:11px; padding:6px 10px; border-top:1px solid #111; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Rage Space — Matchup (4-up)</h1>

    <div class="header">
      <div class="row">
        <div class="timer" id="tRemain">60.0</div>
        <div class="state" id="tMeta">syncing…</div>
      </div>
      <div class="row">
        <button id="forceQueue" class="btn ghost">Pull Now</button>
        <button id="resetPair" class="btn ghost">Reset Pair</button>
        <a class="backbtn" href="menu.html">← Menu</a>
        <a class="linkbtn" href="winners.html">Winners</a>
      </div>
    </div>

    <!-- SEMI A/B -->
    <div class="splitTitle">Semi 1: A vs B</div>
    <div class="card" id="cardAB">
      <div class="imgBox">
        <img id="imgA" alt="Seed A">
        <button class="fullscreenBtn" onclick="openFull('A')">⤢</button>
      </div>
      <div class="bar">
        <div class="label">Seed A</div>
        <div class="counts" id="countA">0</div>
        <button class="vote" id="btnA">Vote A</button>
      </div>
    </div>

    <div class="card" id="cardBB">
      <div class="imgBox">
        <img id="imgB" alt="Seed B">
        <button class="fullscreenBtn" onclick="openFull('B')">⤢</button>
      </div>
      <div class="bar">
        <div class="label">Seed B</div>
        <div class="counts" id="countB">0</div>
        <button class="vote" id="btnB">Vote B</button>
      </div>
    </div>

    <!-- SEMI C/D -->
    <div class="splitTitle">Semi 2: C vs D</div>
    <div class="card" id="cardCD">
      <div class="imgBox">
        <img id="imgC" alt="Seed C">
        <button class="fullscreenBtn" onclick="openFull('C')">⤢</button>
      </div>
      <div class="bar">
        <div class="label">Seed C</div>
        <div class="counts" id="countC">0</div>
        <button class="vote" id="btnC">Vote C</button>
      </div>
    </div>

    <div class="card" id="cardDD">
      <div class="imgBox">
        <img id="imgD" alt="Seed D">
        <button class="fullscreenBtn" onclick="openFull('D')">⤢</button>
      </div>
      <div class="bar">
        <div class="label">Seed D</div>
        <div class="counts" id="countD">0</div>
        <button class="vote" id="btnD">Vote D</button>
      </div>
    </div>

    <div class="winner" id="winnerText">No winner yet — semis running.</div>
    <div class="hint">
      4 images per round. At ~30s the server decides 2 semifinal winners and logs them.
      At 0s the server decides the final and logs it (same endpoint as before).
    </div>
  </div>

  <div class="fullscreen-overlay" id="overlay">
    <button id="closeFull">✕ Close</button>
    <img id="fullImg" src="">
  </div>

  <div class="debugbox" id="debugBox">debug: idle…</div>

  <script>
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID) {
      RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now());
      localStorage.setItem(RSID_KEY, RSID);
    }

    const elRemain = document.getElementById("tRemain");
    const elMeta   = document.getElementById("tMeta");
    const imgA     = document.getElementById("imgA");
    const imgB     = document.getElementById("imgB");
    const imgC     = document.getElementById("imgC");
    const imgD     = document.getElementById("imgD");
    const cA       = document.getElementById("countA");
    const cB       = document.getElementById("countB");
    const cC       = document.getElementById("countC");
    const cD       = document.getElementById("countD");
    const btnA     = document.getElementById("btnA");
    const btnB     = document.getElementById("btnB");
    const btnC     = document.getElementById("btnC");
    const btnD     = document.getElementById("btnD");
    const winnerText = document.getElementById("winnerText");
    const overlay  = document.getElementById("overlay");
    const fullImg  = document.getElementById("fullImg");
    const btnClose = document.getElementById("closeFull");
    const dbg      = document.getElementById("debugBox");

    const forceBtn = document.getElementById("forceQueue");
    const resetBtn = document.getElementById("resetPair");

    btnClose.onclick = () => overlay.style.display = 'none';
    window.openFull = (which) => {
      if (which === 'A') fullImg.src = imgA.src;
      else if (which === 'B') fullImg.src = imgB.src;
      else if (which === 'C') fullImg.src = imgC.src;
      else fullImg.src = imgD.src;
      overlay.style.display = 'flex';
    };

    function placeholder(letter){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960">
        <rect width="100%" height="100%" fill="#000"/>
        <text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace" text-anchor="middle" dominant-baseline="middle">${letter}</text>
      </svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    let state = {
      base_iso: null,
      ends_at: null,
      period_sec: 60,
      seed_a_url: null,
      seed_b_url: null,
      seed_c_url: null,
      seed_d_url: null,
      seed_a_count: 0,
      seed_b_count: 0,
      seed_c_count: 0,
      seed_d_count: 0,
      mid_done: false,
      mid_winner_1_url: null,
      mid_winner_2_url: null,
    };
    let fetching = false;

    async function sendVote(color, side){
      try {
        const res = await fetch(FUNCTION_URL, {
          method:'POST',
          headers:{ 'content-type':'application/json', 'x-rsid': RSID },
          body: JSON.stringify({ color, side })
        });
        const data = await res.json();
        console.log("[VOTE RES]", data);
        if (!res.ok) throw new Error(data.error || 'vote failed');
        if (!data.ignored) {
          cA.textContent = data.seed_a_count;
          cB.textContent = data.seed_b_count;
          cC.textContent = data.seed_c_count;
          cD.textContent = data.seed_d_count;
        }
        dbg.textContent = "debug: vote ok ("+color+"/"+side+")";
      } catch (err) {
        console.error(err);
        dbg.textContent = "debug: vote error → " + err.message;
      }
    }

    btnA.onclick = () => sendVote('red', 'ab');
    btnB.onclick = () => sendVote('blue', 'ab');
    btnC.onclick = () => sendVote('red', 'cd');
    btnD.onclick = () => sendVote('blue', 'cd');

    async function fetchState(force=false){
      if (fetching) return;
      fetching = true;
      try{
        const res = await fetch(FUNCTION_URL);
        const data = await res.json();
        console.log("[EDGE GET]", data);
        if (!res.ok) throw new Error(data.error || 'GET failed');

        const prevBase = state.base_iso;
        const newRound = prevBase && prevBase !== data.base_iso;

        state = data;

        // ====== IMAGE FALLBACKS ======
        imgA.src = data.seed_a_url && data.seed_a_url !== "" ? data.seed_a_url : placeholder('A');
        imgB.src = data.seed_b_url && data.seed_b_url !== "" ? data.seed_b_url : placeholder('B');
        imgC.src = data.seed_c_url && data.seed_c_url !== "" ? data.seed_c_url : placeholder('C');
        imgD.src = data.seed_d_url && data.seed_d_url !== "" ? data.seed_d_url : placeholder('D');

        cA.textContent = data.seed_a_count ?? 0;
        cB.textContent = data.seed_b_count ?? 0;
        cC.textContent = data.seed_c_count ?? 0;
        cD.textContent = data.seed_d_count ?? 0;

        elMeta.textContent = `cycle: ${data.base_iso}`;

        if (data.mid_done) {
          winnerText.textContent = 'Semis decided — final at 0s.';
        } else {
          winnerText.textContent = 'Semis running…';
        }

        if (newRound) {
          btnA.disabled = btnB.disabled = btnC.disabled = btnD.disabled = false;
        }

        dbg.textContent = "debug: ok " + new Date().toLocaleTimeString();
      }catch(e){
        console.error(e);
        dbg.textContent = "debug: GET error → " + e.message;
        // show placeholders so UI is not blank
        imgA.src = placeholder('A');
        imgB.src = placeholder('B');
        imgC.src = placeholder('C');
        imgD.src = placeholder('D');
      }finally{
        fetching = false;
      }
    }

    function tick(){
      if (!state?.ends_at) return requestAnimationFrame(tick);
      const remain = new Date(state.ends_at).getTime() - Date.now();
      const ms = Math.max(0, remain);
      elRemain.textContent = (ms/1000).toFixed(1);

      const halfMs = (state.period_sec || 60) * 1000 / 2;

      if (ms <= halfMs + 200 && !state.mid_done) {
        winnerText.textContent = 'Semis about to be decided…';
      }

      if (ms <= -900) {
        fetchState().catch(()=>{});
      }

      requestAnimationFrame(tick);
    }

    forceBtn.addEventListener('click', ()=> fetchState(true));
    resetBtn.addEventListener('click', ()=> fetchState(true));

    // live updates
    supabase
      .channel('cycles-v2-live')
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cycles_v2' },
        async () => { await fetchState(true); })
      .subscribe();

    supabase
      .channel('matchup-sync')
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'art_queue', filter: 'status=in.(locked,used)' },
        async () => { await fetchState(true); })
      .subscribe();

    fetchState(true).then(()=>tick());
  </script>
</body>
</html>