<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space ‚Äî Matchup</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --panel:#0f1318; --muted:#9aa0a6; --line:#1f2530; --accent:#39ff14; }
    * { box-sizing:border-box }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, Segoe UI, Inter, Roboto; }
    .wrap { max-width:960px; margin:0 auto; padding:16px 12px 48px; }
    .header { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size:26px; letter-spacing:.3px }
    .sub { color:var(--muted); font-size:12px }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn { appearance:none; border:1px solid var(--line); background:var(--panel); color:var(--fg);
           padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .chip { padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:var(--panel); font-variant-numeric:tabular-nums; font-weight:700 }
    .grid { margin-top:14px; display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width:860px){ .grid{ grid-template-columns:1fr 1fr } }
    .card { position:relative; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#111419; min-height:340px }
    .card img { width:100%; height:100%; display:block; object-fit:cover; aspect-ratio:4/3; background:#ff0095; }
    .corner { position:absolute; right:10px; top:10px; width:36px; height:36px; border-radius:9px; border:1px solid var(--line); background:rgba(0,0,0,.35); display:grid; place-items:center; cursor:pointer }
    .corner:after { content:"‚§¢"; font-size:16px }
    .state { margin-top:6px; color:var(--muted); font-size:12px }
    .debugDock { position:fixed; left:12px; right:12px; bottom:12px; z-index:50 }
    .debugBox { display:none; font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#0a0c10; color:#b7ffb7; border:1px solid #223; border-radius:12px; padding:10px; max-height:44vh; overflow:auto }
    .debugHead { display:flex; gap:8px; align-items:center; margin:0 0 8px 0 }
    .dbgBtn { font:12px/1 ui-sans-serif; padding:6px 10px; border-radius:8px; border:1px solid #223; background:#0f1318; color:#b7ffb7; cursor:pointer }
    .right { margin-left:auto }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Rage Space ‚Äî Matchup</h1>
        <div class="sub">cycle: <span id="cycle">‚Äî</span></div>
      </div>
      <div class="row">
        <div class="chip"><span id="count">0</span>.0</div>
        <label class="btn" style="display:flex;gap:8px;align-items:center">
          <input id="adminToggle" type="checkbox" style="accent-color:#39ff14; width:16px; height:16px"> Admin mode
        </label>
      </div>
    </div>

    <div class="row" style="margin:10px 0 8px">
      <button id="btnNext" class="btn" title="(Admin) Pull next pair from queue" disabled>Use Next From Queue Now</button>
      <button id="btnReset" class="btn" title="Forget current pair (no server call)">Reset Pair</button>
      <a class="btn" href="./winners.html">Winners</a>
      <button id="btnDebug" class="btn">üêõ Debug</button>
    </div>

    <div class="grid">
      <div class="card">
        <img id="imgA" alt="">
        <button class="corner" data-img="A" title="Open full"></button>
      </div>
      <div class="card">
        <img id="imgB" alt="">
        <button class="corner" data-img="B" title="Open full"></button>
      </div>
    </div>

    <div class="state" id="state">‚Äî</div>
  </div>

  <!-- Debug dock -->
  <div class="debugDock">
    <div class="debugHead">
      <strong style="color:#b7ffb7">Rage Debug</strong>
      <select id="dbgLevel" class="dbgBtn">
        <option value="none">Off</option>
        <option value="info" selected>Info</option>
        <option value="all">All</option>
      </select>
      <button id="dbgCopy" class="dbgBtn">Copy</button>
      <button id="dbgClear" class="dbgBtn">Clear</button>
      <span class="right" style="color:#607b60">client rAF + steady 1s poll</span>
    </div>
    <div id="debugBox" class="debugBox"></div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const imgA = $("#imgA");
  const imgB = $("#imgB");
  const cycleEl = $("#cycle");
  const countEl = $("#count");
  const stateEl = $("#state");
  const btnNext = $("#btnNext");
  const btnReset = $("#btnReset");
  const btnDebug = $("#btnDebug");
  const adminToggle = $("#adminToggle");
  const dbgBox = $("#debugBox");
  const dbgLevel = $("#dbgLevel");
  const dbgCopy = $("#dbgCopy");
  const dbgClear = $("#dbgClear");

  // -------- debug helpers
  let debugOpen = false;
  const log = (type, msg) => {
    if (dbgLevel.value === "none") return;
    if (dbgLevel.value === "info" && type === "spam") return;
    const ts = new Date().toLocaleTimeString();
    const line = `[${ts}] ${msg}`;
    if (debugOpen) {
      const div = document.createElement("div");
      div.textContent = line;
      dbgBox.appendChild(div);
      dbgBox.scrollTop = dbgBox.scrollHeight;
    }
    // Also mirror to console for dev tools.
    if (type === "error") console.error(line);
    else console.log(line);
  };

  btnDebug.addEventListener("click", () => {
    debugOpen = !debugOpen;
    dbgBox.style.display = debugOpen ? "block" : "none";
  });
  dbgCopy.addEventListener("click", async () => {
    const text = Array.from(dbgBox.childNodes).map(n => n.textContent).join("\n");
    await navigator.clipboard.writeText(text);
    log("info", "Debug copied to clipboard.");
  });
  dbgClear.addEventListener("click", () => { dbgBox.innerHTML = ""; });

  // -------- admin gate (prevents anon viewers from hitting queue)
  const setAdminUI = () => {
    const on = adminToggle.checked;
    btnNext.disabled = !on;
  };
  adminToggle.addEventListener("change", setAdminUI);
  setAdminUI();

  // -------- config
  const EDGE_BASE = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1";
  const TIMER_URL = `${EDGE_BASE}/global-timer-v2`;

  // cache of last round key to avoid redundant swaps
  let lastBaseISO = null;
  let clockRemain = 0;

  const preload = src => new Promise((resolve, reject) => {
    const im = new Image();
    im.onload  = () => resolve(src);
    im.onerror = reject;
    im.src = src;
  });

  const swapImages = async (redUrl, blueUrl) => {
    try {
      const [a, b] = await Promise.all([preload(redUrl), preload(blueUrl)]);
      imgA.src = a;
      imgB.src = b;
      log("info", `IMG: swapped\n  A ${a}\n  B ${b}`);
    } catch (e) {
      log("error", `IMG: preload failed: ${e}`);
    }
  };

  // -------- poller (de-duped; at most one in-flight fetch)
  let inflight = false;
  let wantedNextAt = 0; // ms epoch for the next scheduled fetch

  async function pullState(reason = "poll") {
    if (inflight) return;
    inflight = true;
    const started = performance.now();
    try {
      const res = await fetch(TIMER_URL, { method:"GET", cache:"no-store" });
      const ms = (performance.now() - started).toFixed(1);
      log("info", `EDGE: GET ${TIMER_URL} ‚Üí ${res.status} (${ms}ms)`);
      if (!res.ok) throw new Error(`timer http ${res.status}`);
      const raw = await res.json();

      // normalize server state
      const baseISO = (raw.base_iso || "").replace(".000Z","Z");
      const endsAt  = new Date(raw.ends_at || 0).getTime();
      const now     = new Date(raw.now || Date.now()).getTime();
      const period  = +(raw.period_sec || 20);
      const remainingMs = Math.max(0, endsAt - now);

      // countdown (secs)
      clockRemain = Math.ceil(remainingMs / 1000);
      countEl.textContent = String(clockRemain).padStart(2, "0");
      cycleEl.textContent = baseISO || "‚Äî";

      stateEl.textContent =
        `period: ${period}s ‚Ä¢ remaining: ${clockRemain}s ‚Ä¢ caught_up: ${raw.caught_up ? 1 : 0}`;

      // on cycle change, update images exactly once
      if (baseISO && baseISO !== lastBaseISO) {
        lastBaseISO = baseISO;

        // IMPORTANT: we only display what the timer tells us.
        // No automatic "next from queue" pulls here.
        const red = raw.red_url || raw.seed_a_url;
        const blue = raw.blue_url || raw.seed_b_url;
        if (red && blue) await swapImages(red, blue);
        else log("error", "TIMER: missing image urls in response");
      }

      // schedule next poll close to 1s cadence, but align around boundaries
      const nowMs = Date.now();
      const jitter = 80 + Math.random()*60; // small jitter avoids thundering herd
      const nearBoundary = remainingMs <= 1300 ? 300 : 1000;
      wantedNextAt = nowMs + (nearBoundary === 300 ? 280 : 1000) + jitter;

    } catch (err) {
      log("error", `EDGE: timer error: ${err.message || err}`);
      // backoff on errors
      wantedNextAt = Date.now() + 1500;
    } finally {
      inflight = false;
    }
  }

  // steady 1s loop using rAF, but only fetch when scheduled
  function loop() {
    const now = Date.now();
    if (now >= wantedNextAt) pullState("due");
    requestAnimationFrame(loop);
  }

  // Buttons
  btnReset.addEventListener("click", () => {
    lastBaseISO = null;
    imgA.removeAttribute("src");
    imgB.removeAttribute("src");
    log("info", "RESET: pair cleared locally (no server call).");
  });

  // NOTE: This is intentionally a NO-OP unless Admin is enabled.
  // If you have a backend function to lock/pull next queue pair, connect it here.
  btnNext.addEventListener("click", async () => {
    if (!adminToggle.checked) return;
    const endpoint = `${EDGE_BASE}/queue-next`; // change to your real function name if needed
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ reason: "manual", exclude_anonymous: true, filter: "ready_only" })
      });
      log("info", `EDGE: POST ${endpoint} ‚Üí ${res.status}`);
      // We do NOT automatically swap images; the timer response will drive display next cycle.
    } catch (e) {
      log("error", `EDGE: queue-next error: ${e.message || e}`);
    }
  });

  // Fullscreen open on corner buttons
  document.querySelectorAll(".corner").forEach(btn => {
    btn.addEventListener("click", e => {
      const which = e.currentTarget.dataset.img;
      const src = which === "A" ? imgA.src : imgB.src;
      if (src) window.open(src, "_blank");
    });
  });

  // boot
  wantedNextAt = 0;
  pullState("boot");
  loop();
})();
</script>
</body>
</html>