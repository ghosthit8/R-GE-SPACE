<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Minimal Matchup (v2)</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#8b8b8b; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 28px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:32px; line-height:1; padding:8px 14px; border:1px solid #20242a; border-radius:12px; background:#0f1318; }
    .state { color:var(--muted); font-size:12px; }
    .card { margin-top:12px; border:1px solid #20242a; border-radius:16px; overflow:hidden; background:#0f1318; }
    .imgBox { position:relative; width:100%; aspect-ratio: 3/4; background:#0b0d0f; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-top:1px solid #20242a; gap:8px; }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    button.vote { appearance:none; border:1px solid #24303a; background:#131920; color:var(--fg); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; }
    button.vote:disabled { opacity:.6; cursor:default; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:var(--accent); }
    .linkbtn { text-decoration:none; display:inline-flex; align-items:center; padding:8px 12px; border:1px solid #20242a; border-radius:12px; background:#131920; color:var(--fg); font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Rage Space — Minimal Matchup (v2)</h1>

    <div class="header">
      <div class="row">
        <div class="timer" id="tRemain">20.0</div>
        <div class="state" id="tMeta">syncing…</div>
      </div>
      <a class="linkbtn" href="winners.html">Winners</a>
    </div>

    <!-- SEED A -->
    <div class="card">
      <div class="imgBox"><img id="imgA" alt="Seed A contender" /></div>
      <div class="bar">
        <div class="label">Seed A</div>
        <div class="counts" id="countA">0</div>
        <button class="vote" id="btnA">Vote Seed A</button>
      </div>
    </div>

    <!-- SEED B -->
    <div class="card">
      <div class="imgBox"><img id="imgB" alt="Seed B contender" /></div>
      <div class="bar">
        <div class="label">Seed B</div>
        <div class="counts" id="countB">0</div>
        <button class="vote" id="btnB">Vote Seed B</button>
      </div>
    </div>

    <div class="winner" id="winnerText">No winner yet — first round in progress.</div>
    <div class="hint">Timer auto-loops every 20 s. A winner is decided at 0 (random if tied). One vote per device per round.</div>
  </div>

  <script>
    const FUNCTION_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer-v2";

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID) {
      RSID = crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2) + Date.now());
      localStorage.setItem(RSID_KEY, RSID);
    }

    const votedKey = (baseIso) => `voted:${baseIso}`;
    const hasVoted = (b) => localStorage.getItem(votedKey(b)) === "1";
    const markVoted = (b) => localStorage.setItem(votedKey(b), "1");

    const elRemain = document.getElementById("tRemain");
    const elMeta = document.getElementById("tMeta");
    const imgA = document.getElementById("imgA");
    const imgB = document.getElementById("imgB");
    const cA = document.getElementById("countA");
    const cB = document.getElementById("countB");
    const btnA = document.getElementById("btnA");
    const btnB = document.getElementById("btnB");
    const winnerText = document.getElementById("winnerText");

    let state = {
      ends_at: null,
      base_iso: null,
      red_url: "",
      blue_url: "",
      red_count: 0,
      blue_count: 0,
      last_winner: null,
    };

    function setVoteButtons(enabled) {
      btnA.disabled = btnB.disabled = !enabled;
    }

    function showWinner(winner) {
      if (!winner) {
        winnerText.textContent = "No winner yet — first round in progress.";
        return;
      }
      const by = winner.decided_by === "random_tie" ? "random tie" : "votes";
      const score = `${winner.red_count}–${winner.blue_count}`;
      const name = winner.winner_color === "red" ? "Seed A" : "Seed B";
      winnerText.innerHTML = `Last winner: <b>${name}</b> (${by}, ${score})`;
    }

    async function fetchState() {
      const res = await fetch(FUNCTION_URL);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "GET failed");

      const newRound = state.base_iso && state.base_iso !== data.base_iso;
      state = data;
      imgA.src = state.red_url;
      imgB.src = state.blue_url;
      cA.textContent = state.red_count;
      cB.textContent = state.blue_count;
      elMeta.textContent = `cycle: ${state.base_iso}`;
      showWinner(state.last_winner);

      if (newRound) setVoteButtons(!hasVoted(state.base_iso));
    }

    async function sendVote(color) {
      const res = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: { "content-type": "application/json", "x-rsid": RSID },
        body: JSON.stringify({ color }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "vote failed");
      if (data.ignored && data.reason === "already_voted") return setVoteButtons(false);
      if (!data.ignored) {
        markVoted(state.base_iso);
        setVoteButtons(false);
        cA.textContent = data.red_count;
        cB.textContent = data.blue_count;
      }
    }

    btnA.onclick = () => !btnA.disabled && sendVote("red");
    btnB.onclick = () => !btnB.disabled && sendVote("blue");

    function tick() {
      const remain = new Date(state.ends_at).getTime() - Date.now();
      elRemain.textContent = (Math.max(0, remain) / 1000).toFixed(1);
      if (remain <= -900) fetchState().catch(console.error);
      requestAnimationFrame(tick);
    }

    setInterval(() => fetchState().catch(() => {}), 1000);
    (async () => {
      await fetchState();
      tick();
    })();
  </script>
</body>
</html>