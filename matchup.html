<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space — Matchup (32-up → 2-up)</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0f13; --accent:#39ff14; --muted:#8b8b8b; --card:#0f1318; --border:#20242a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:32px; line-height:1; padding:8px 14px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .state { color:var(--muted); font-size:12px; }

    .card { margin-top:12px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--card); }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.55); color:var(--accent); border:1px solid var(--accent); border-radius:8px; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid var(--border); }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .btn, .vote, .linkbtn, .backbtn { appearance:none; border:1px solid #24303a; background:#131920; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }

    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card); cursor:pointer; }
    .thumb.disabled { opacity:.55; cursor:default; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }
    .thumb-img { width:100%; aspect-ratio:3/4; background:#0b0f13; display:grid; place-items:center; }
    .thumb-img img { width:100%; height:100%; object-fit:cover; }
    .thumb-label { padding:6px 8px 8px; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
    .thumb-count { font-variant-numeric: tabular-nums; font-weight:700; }
    .ghostBox { width:100%; height:100%; display:grid; place-items:center; color:#3b3b3b; font-weight:700; font-size:13px; letter-spacing:.08em; }

    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:#39ff14; }

    .final-card { margin-top:14px; }
    .final-inner { display:flex; gap:12px; flex-wrap:wrap; padding:12px; }
    .final-slot { flex:1 1 150px; background:#0b0f13; border:1px dashed var(--border); border-radius:10px; padding:8px; text-align:center; }
    .final-slot .label { display:block; margin-bottom:4px; }
    .final-slot .thumb-final { width:100%; aspect-ratio:3/4; background:#000; border-radius:8px; overflow:hidden; display:grid; place-items:center; }
    .final-slot .thumb-final img { width:100%; height:100%; object-fit:cover; }
    .final-footer { padding:0 12px 12px; font-size:12px; color:#9aa0a6; }

    .fullscreen-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:9999; }
    .fullscreen-overlay img { max-width:90%; max-height:90%; border-radius:8px; }
    .fullscreen-overlay button { position:absolute; top:20px; right:20px; background:#111; border:1px solid var(--accent); color:var(--accent); padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
    .debugbox { position:fixed; left:0; right:0; bottom:0; background:rgba(0,0,0,.75); color:#9ca3af; font-size:11px; padding:6px 10px; border-top:1px solid #111; }

    .hidden { display: none !important; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Rage Space — Matchup (32-up → 2-up)</h1>

    <div class="header">
      <div class="row">
        <div class="timer" id="tRemain">150.0</div>
        <div class="state" id="tMeta">syncing…</div>
      </div>
      <div class="row">
        <button id="forceQueue" class="btn ghost">Pull Now</button>
        <button id="resetPair" class="btn ghost">Reset Pair</button>
        <a class="backbtn" href="menu.html">← Menu</a>
        <a class="linkbtn" href="winners.html">Winners</a>
      </div>
    </div>

    <!-- ACTIVE MATCH -->
    <div class="card" id="activeTop">
      <div class="imgBox">
        <img id="imgActive1" alt="Active left">
        <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive1">Left</div>
        <div class="counts" id="countActive1">0</div>
        <button class="vote" id="btnActive1">Vote</button>
      </div>
    </div>

    <div class="card" id="activeBottom">
      <div class="imgBox">
        <img id="imgActive2" alt="Active right">
        <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive2">Right</div>
        <div class="counts" id="countActive2">0</div>
        <button class="vote" id="btnActive2">Vote</button>
      </div>
    </div>

    <!-- THUMBS -->
    <div class="thumbs-wrap">
      <div class="thumbs-title">Matches (tap to switch)</div>
      <div class="thumbs" id="thumbGrid"></div>
    </div>

    <div class="winner" id="winnerText">R32 locks at 120s → R16 at 90s → Quarters at 60s → Semis at 30s → Final at 0s.</div>

    <!-- FINAL BOX -->
    <div class="card final-card" id="finalCard">
      <div class="bar">
        <div class="label">Final</div>
        <div style="font-size:12px;color:#a1a1a1;">Decides at 0s</div>
      </div>
      <div class="final-inner">
        <div class="final-slot">
          <span class="label" id="finalLeftLabel">Winner of Semi 1</span>
          <div class="thumb-final"><img id="finalImg1" alt="Final slot 1"></div>
        </div>
        <div class="final-slot">
          <span class="label" id="finalRightLabel">Winner of Semi 2</span>
          <div class="thumb-final"><img id="finalImg2" alt="Final slot 2"></div>
        </div>
      </div>
      <div class="final-footer" id="finalFooter">Waiting…</div>
    </div>

    <div class="hint">32 images → 16 R32 matches (120s) → 8 R16 (90s) → 4 QF (60s) → 2 SF (30s) → Final (0s).</div>
  </div>

  <div class="fullscreen-overlay" id="overlay">
    <button id="closeFull">✕ Close</button>
    <img id="fullImg" src="">
  </div>

  <div class="debugbox" id="debugBox">debug: idle…</div>

  <script>
    // === config ===
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID){ RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now()); localStorage.setItem(RSID_KEY, RSID); }

    const elRemain = document.getElementById("tRemain");
    const elMeta   = document.getElementById("tMeta");
    const dbg      = document.getElementById("debugBox");
    const winnerText = document.getElementById("winnerText");

    const imgActive1 = document.getElementById("imgActive1");
    const imgActive2 = document.getElementById("imgActive2");
    const labelActive1 = document.getElementById("labelActive1");
    const labelActive2 = document.getElementById("labelActive2");
    const countActive1 = document.getElementById("countActive1");
    const countActive2 = document.getElementById("countActive2");
    const btnActive1 = document.getElementById("btnActive1");
    const btnActive2 = document.getElementById("btnActive2");

    const finalImg1 = document.getElementById("finalImg1");
    const finalImg2 = document.getElementById("finalImg2");
    const finalLeftLabel  = document.getElementById("finalLeftLabel");
    const finalRightLabel = document.getElementById("finalRightLabel");
    const finalFooter = document.getElementById("finalFooter");

    const overlay  = document.getElementById("overlay");
    const fullImg  = document.getElementById("fullImg");
    const btnClose = document.getElementById("closeFull"); btnClose.onclick = ()=> overlay.style.display='none';

    const forceBtn = document.getElementById("forceQueue");
    const resetBtn = document.getElementById("resetPair");
    const grid = document.getElementById("thumbGrid");

    function openFull(which){
      const url = which==="active1" ? imgActive1.src : which==="active2" ? imgActive2.src : "";
      fullImg.src = url; overlay.style.display = 'flex';
    }
    function placeholder(text){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960"><rect width="100%" height="100%" fill="#000"/><text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace" text-anchor="middle" dominant-baseline="middle">${text}</text></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }
    function pick(a,b){ return (a!=null && a!=="") ? a : b; }

    // ---- letters → numbers mapping for 32 seeds (for any future use) ----
    const L32 = [..."abcdefghijklmnopqrstuvwxyz".split(""), "aa","ab","ac","ad","ae","af"];
    const L2N = Object.fromEntries(L32.map((s,i)=>[s, i+1]));

    // For R32 grid: derive absolute seed numbers by slot (rr1..rr16)
    function r32SeedNumber(key, side){ // side: "left"|"right"
      const n = Number(key.replace("rr",""));
      const leftNum  = 2*n - 1;
      const rightNum = 2*n;
      return side==="left" ? leftNum : rightNum;
    }

    // ---------- MATCH INDEX ----------
    const order = [
      {key:"rr1",  label:"R32 1",  left:"seed_a_url",  right:"seed_b_url",  lct:"seed_a_count",  rct:"seed_b_count"},
      {key:"rr2",  label:"R32 2",  left:"seed_c_url",  right:"seed_d_url",  lct:"seed_c_count",  rct:"seed_d_count"},
      {key:"rr3",  label:"R32 3",  left:"seed_e_url",  right:"seed_f_url",  lct:"seed_e_count",  rct:"seed_f_count"},
      {key:"rr4",  label:"R32 4",  left:"seed_g_url",  right:"seed_h_url",  lct:"seed_g_count",  rct:"seed_h_count"},
      {key:"rr5",  label:"R32 5",  left:"seed_i_url",  right:"seed_j_url",  lct:"seed_i_count",  rct:"seed_j_count"},
      {key:"rr6",  label:"R32 6",  left:"seed_k_url",  right:"seed_l_url",  lct:"seed_k_count",  rct:"seed_l_count"},
      {key:"rr7",  label:"R32 7",  left:"seed_m_url",  right:"seed_n_url",  lct:"seed_m_count",  rct:"seed_n_count"},
      {key:"rr8",  label:"R32 8",  left:"seed_o_url",  right:"seed_p_url",  lct:"seed_o_count",  rct:"seed_p_count"},
      {key:"rr9",  label:"R32 9",  left:"seed_q_url",  right:"seed_r_url",  lct:"seed_q_count",  rct:"seed_r_count"},
      {key:"rr10", label:"R32 10", left:"seed_s_url",  right:"seed_t_url",  lct:"seed_s_count",  rct:"seed_t_count"},
      {key:"rr11", label:"R32 11", left:"seed_u_url",  right:"seed_v_url",  lct:"seed_u_count",  rct:"seed_v_count"},
      {key:"rr12", label:"R32 12", left:"seed_w_url",  right:"seed_x_url",  lct:"seed_w_count",  rct:"seed_x_count"},
      {key:"rr13", label:"R32 13", left:"seed_y_url",  right:"seed_z_url",  lct:"seed_y_count",  rct:"seed_z_count"},
      {key:"rr14", label:"R32 14", left:"seed_aa_url", right:"seed_ab_url", lct:"seed_aa_count", rct:"seed_ab_count"},
      {key:"rr15", label:"R32 15", left:"seed_ac_url", right:"seed_ad_url", lct:"seed_ac_count", rct:"seed_ad_count"},
      {key:"rr16", label:"R32 16", left:"seed_ae_url", right:"seed_af_url", lct:"seed_ae_count", rct:"seed_af_count"},

      {key:"r1", label:"R16 1", left:"seed_a_url", right:"seed_b_url", lct:"seed_a_count", rct:"seed_b_count"},
      {key:"r2", label:"R16 2", left:"seed_c_url", right:"seed_d_url", lct:"seed_c_count", rct:"seed_d_count"},
      {key:"r3", label:"R16 3", left:"seed_e_url", right:"seed_f_url", lct:"seed_e_count", rct:"seed_f_count"},
      {key:"r4", label:"R16 4", left:"seed_g_url", right:"seed_h_url", lct:"seed_g_count", rct:"seed_h_count"},
      {key:"r5", label:"R16 5", left:"seed_i_url", right:"seed_j_url", lct:"seed_i_count", rct:"seed_j_count"},
      {key:"r6", label:"R16 6", left:"seed_k_url", right:"seed_l_url", lct:"seed_k_count", rct:"seed_l_count"},
      {key:"r7", label:"R16 7", left:"seed_m_url", right:"seed_n_url", lct:"seed_m_count", rct:"seed_n_count"},
      {key:"r8", label:"R16 8", left:"seed_o_url", right:"seed_p_url", lct:"seed_o_count", rct:"seed_p_count"},

      {key:"q1", label:"QF 1", left:"q1_a_url", right:"q1_b_url", lct:"q1_a_count", rct:"q1_b_count", fbLeft:"seed_a_url", fbRight:"seed_b_url", fbLct:"seed_a_count", fbRct:"seed_b_count"},
      {key:"q2", label:"QF 2", left:"q2_c_url", right:"q2_d_url", lct:"q2_c_count", rct:"q2_d_count", fbLeft:"seed_c_url", fbRight:"seed_d_url", fbLct:"seed_c_count", fbRct:"seed_d_count"},
      {key:"q3", label:"QF 3", left:"q3_e_url", right:"q3_f_url", lct:"q3_e_count", rct:"q3_f_count", fbLeft:"seed_e_url", fbRight:"seed_f_url", fbLct:"seed_e_count", fbRct:"seed_f_count"},
      {key:"q4", label:"QF 4", left:"q4_g_url", right:"q4_h_url", lct:"q4_g_count", rct:"q4_h_count", fbLeft:"seed_g_url", fbRight:"seed_h_url", fbLct:"seed_g_count", fbRct:"seed_h_count"},
      {key:"s1", label:"Semi 1", semi:true},
      {key:"s2", label:"Semi 2", semi:true},
      {key:"final", label:"Final"}
    ];

    // Build grid
    const thumbs = {};
    function makeThumb(item){
      const div = document.createElement("div");
      div.className = "thumb"; div.id = "thumb_"+item.key;
      div.innerHTML = `
        <div class="thumb-img"><img id="img_${item.key}" alt="${item.label}"></div>
        <div class="thumb-label"><span>${item.label}</span><span class="thumb-count" id="cnt_${item.key}">0-0</span></div>
      `;
      div.addEventListener("click", ()=>{
        if (item.key.startsWith("rr") && state.r32_done) return;
        if (item.key.startsWith("r") && !item.key.startsWith("rr") && !state.r32_done) return;
        if (item.key.startsWith("q") && !state.r16_done) return;
        if (item.key.startsWith("s") && !state.mid1_done) return;
        if (item.key==="final" && !state.mid2_done) return;
        activeMatch = item.key; renderActive();
      });
      grid.appendChild(div);
      thumbs[item.key] = {
        box:div,
        img: div.querySelector("#img_"+item.key),
        count: div.querySelector("#cnt_"+item.key)
      };
    }
    order.forEach(makeThumb);

    // ---------- STATE ----------
    let state = {
      base_iso:null, ends_at:null, period_sec:150,

      // 32 seeds (urls + counts)
      seed_a_url:null, seed_b_url:null, seed_c_url:null, seed_d_url:null,
      seed_e_url:null, seed_f_url:null, seed_g_url:null, seed_h_url:null,
      seed_i_url:null, seed_j_url:null, seed_k_url:null, seed_l_url:null,
      seed_m_url:null, seed_n_url:null, seed_o_url:null, seed_p_url:null,
      seed_q_url:null, seed_r_url:null, seed_s_url:null, seed_t_url:null,
      seed_u_url:null, seed_v_url:null, seed_w_url:null, seed_x_url:null,
      seed_y_url:null, seed_z_url:null, seed_aa_url:null, seed_ab_url:null,
      seed_ac_url:null, seed_ad_url:null, seed_ae_url:null, seed_af_url:null,

      seed_a_count:0, seed_b_count:0, seed_c_count:0, seed_d_count:0,
      seed_e_count:0, seed_f_count:0, seed_g_count:0, seed_h_count:0,
      seed_i_count:0, seed_j_count:0, seed_k_count:0, seed_l_count:0,
      seed_m_count:0, seed_n_count:0, seed_o_count:0, seed_p_count:0,
      seed_q_count:0, seed_r_count:0, seed_s_count:0, seed_t_count:0,
      seed_u_count:0, seed_v_count:0, seed_w_count:0, seed_x_count:0,
      seed_y_count:0, seed_z_count:0, seed_aa_count:0, seed_ab_count:0,
      seed_ac_count:0, seed_ad_count:0, seed_ae_count:0, seed_af_count:0,

      r32_done:false, r16_done:false, mid1_done:false, mid2_done:false,

      q1_a_url:null, q1_b_url:null, q1_a_count:0, q1_b_count:0,
      q2_c_url:null, q2_d_url:null, q2_c_count:0, q2_d_count:0,
      q3_e_url:null, q3_f_url:null, q3_e_count:0, q3_f_count:0,
      q4_g_url:null, q4_h_url:null, q4_g_count:0, q4_h_count:0,

      semi_1_left_url:null, semi_1_right_url:null, semi_1_left_count:0, semi_1_right_count:0,
      semi_2_left_url:null, semi_2_right_url:null, semi_2_left_count:0, semi_2_right_count:0,

      mid_winner_1_url:null, mid_winner_2_url:null,
    };

    // vote memory
    const VOTE_MEMORY_KEY="rs_vote_memory_v3";
    function memRead(base){ try{ return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")[base]||{} }catch{return{}} }
    function memWrite(base,key,val){ const all=(()=>{try{return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")}catch{return{}}})(); all[base]=Object.assign({},all[base]||{}, {[key]:val}); localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all)); }
    function pruneMem(keep){ const all=(()=>{try{return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")}catch{return{}}})(); for(const k of Object.keys(all)) if(k!==keep) delete all[k]; localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all)); }

    // start on R32 #1
    let activeMatch = "rr1";

    async function vote(color){
      const base = state.base_iso||"";
      const mem = memRead(base);
      const key = activeMatch;
      if (mem[key]) return;

      const red = color==="red";
      const inc = (k)=> state[k] = (state[k]||0)+1;

      const serverPhase = activeMatch.startsWith("rr")
        ? ("r"+activeMatch.slice(2))
        : activeMatch;

      const post = { phase: serverPhase, side: red ? "left":"right" };

      const map = {
        rr1:["seed_a_count","seed_b_count"],   rr2:["seed_c_count","seed_d_count"],
        rr3:["seed_e_count","seed_f_count"],   rr4:["seed_g_count","seed_h_count"],
        rr5:["seed_i_count","seed_j_count"],   rr6:["seed_k_count","seed_l_count"],
        rr7:["seed_m_count","seed_n_count"],   rr8:["seed_o_count","seed_p_count"],
        rr9:["seed_q_count","seed_r_count"],   rr10:["seed_s_count","seed_t_count"],
        rr11:["seed_u_count","seed_v_count"],  rr12:["seed_w_count","seed_x_count"],
        rr13:["seed_y_count","seed_z_count"],  rr14:["seed_aa_count","seed_ab_count"],
        rr15:["seed_ac_count","seed_ad_count"],rr16:["seed_ae_count","seed_af_count"],

        r1:["seed_a_count","seed_b_count"], r2:["seed_c_count","seed_d_count"],
        r3:["seed_e_count","seed_f_count"], r4:["seed_g_count","seed_h_count"],
        r5:["seed_i_count","seed_j_count"], r6:["seed_k_count","seed_l_count"],
        r7:["seed_m_count","seed_n_count"], r8:["seed_o_count","seed_p_count"],

        q1:["seed_a_count","seed_b_count"], q2:["seed_c_count","seed_d_count"],
        q3:["seed_e_count","seed_f_count"], q4:["seed_g_count","seed_h_count"],
        s1:["seed_a_count","seed_b_count"], s2:["seed_c_count","seed_d_count"],
        final:["seed_a_count","seed_b_count"]
      };
      const arr = map[activeMatch];
      if (arr){ inc(red?arr[0]:arr[1]); renderActive(); }

      try{
        const res = await fetch(FUNCTION_URL, { method:"POST", headers:{"Content-Type":"application/json","x-rsid":RSID}, body: JSON.stringify(post) });
        if (!res.ok){ await fetchState(true); return; }
        const s = await res.json().catch(()=> ({}));
        Object.assign(state, s||{});
        memWrite(base,key,color);
        renderActive();
      }catch{ await fetchState(true); }
    }
    btnActive1.onclick = ()=> vote("red");
    btnActive2.onclick = ()=> vote("blue");

    function setThumb(key,leftUrl,rightUrl,leftCt,rightCt,fallback){
      const th = thumbs[key]; if (!th) return;
      th.img.src = leftUrl || rightUrl || placeholder(fallback||"?");
      th.count.textContent = (leftCt??0) + "-" + (rightCt??0);
    }
    function markActive(){
      for (const k in thumbs) thumbs[k].box.classList.toggle("active", k===activeMatch);
    }

    // ---- numeric placeholders (1–32) for R32 thumbs ----
    function renderThumbs(){
      setThumb("rr1",  state.seed_a_url,  state.seed_b_url,  state.seed_a_count,  state.seed_b_count,  "1");
      setThumb("rr2",  state.seed_c_url,  state.seed_d_url,  state.seed_c_count,  state.seed_d_count,  "3");
      setThumb("rr3",  state.seed_e_url,  state.seed_f_url,  state.seed_e_count,  state.seed_f_count,  "5");
      setThumb("rr4",  state.seed_g_url,  state.seed_h_url,  state.seed_g_count,  state.seed_h_count,  "7");
      setThumb("rr5",  state.seed_i_url,  state.seed_j_url,  state.seed_i_count,  state.seed_j_count,  "9");
      setThumb("rr6",  state.seed_k_url,  state.seed_l_url,  state.seed_k_count,  state.seed_l_count,  "11");
      setThumb("rr7",  state.seed_m_url,  state.seed_n_url,  state.seed_m_count,  state.seed_n_count,  "13");
      setThumb("rr8",  state.seed_o_url,  state.seed_p_url,  state.seed_o_count,  state.seed_p_count,  "15");
      setThumb("rr9",  state.seed_q_url,  state.seed_r_url,  state.seed_q_count,  state.seed_r_count,  "17");
      setThumb("rr10", state.seed_s_url,  state.seed_t_url,  state.seed_s_count,  state.seed_t_count,  "19");
      setThumb("rr11", state.seed_u_url,  state.seed_v_url,  state.seed_u_count,  state.seed_v_count,  "21");
      setThumb("rr12", state.seed_w_url,  state.seed_x_url,  state.seed_w_count,  state.seed_x_count,  "23");
      setThumb("rr13", state.seed_y_url,  state.seed_z_url,  state.seed_y_count,  state.seed_z_count,  "25");
      setThumb("rr14", state.seed_aa_url, state.seed_ab_url, state.seed_aa_count, state.seed_ab_count, "27");
      setThumb("rr15", state.seed_ac_url, state.seed_ad_url, state.seed_ac_count, state.seed_ad_count, "29");
      setThumb("rr16", state.seed_ae_url, state.seed_af_url, state.seed_ae_count, state.seed_af_count, "31");

      setThumb("r1", state.seed_a_url, state.seed_b_url, state.seed_a_count, state.seed_b_count, "R16");
      setThumb("r2", state.seed_c_url, state.seed_d_url, state.seed_c_count, state.seed_d_count, "R16");
      setThumb("r3", state.seed_e_url, state.seed_f_url, state.seed_e_count, state.seed_f_count, "R16");
      setThumb("r4", state.seed_g_url, state.seed_h_url, state.seed_g_count, state.seed_h_count, "R16");
      setThumb("r5", state.seed_i_url, state.seed_j_url, state.seed_i_count, state.seed_j_count, "R16");
      setThumb("r6", state.seed_k_url, state.seed_l_url, state.seed_k_count, state.seed_l_count, "R16");
      setThumb("r7", state.seed_m_url, state.seed_n_url, state.seed_m_count, state.seed_n_count, "R16");
      setThumb("r8", state.seed_o_url, state.seed_p_url, state.seed_o_count, state.seed_p_count, "R16");

      setThumb("q1", state.q1_a_url||state.seed_a_url, state.q1_b_url||state.seed_b_url, state.q1_a_count||state.seed_a_count, state.q1_b_count||state.seed_b_count, "QF");
      setThumb("q2", state.q2_c_url||state.seed_c_url, state.q2_d_url||state.seed_d_url, state.q2_c_count||state.seed_c_count, state.q2_d_count||state.seed_d_count, "QF");
      setThumb("q3", state.q3_e_url||state.seed_e_url, state.q3_f_url||state.seed_f_url, state.q3_e_count||state.seed_e_count, state.q3_f_count||state.seed_f_count, "QF");
      setThumb("q4", state.q4_g_url||state.seed_g_url, state.q4_h_url||state.seed_h_url, state.q4_g_count||state.seed_g_count, state.q4_h_count||state.seed_h_count, "QF");

      if (state.mid_winner_1_url) finalImg1.src = state.mid_winner_1_url;
      if (state.mid_winner_2_url) finalImg2.src = state.mid_winner_2_url;

      markActive();
    }

    function renderActive(){
      const item = order.find(o=>o.key===activeMatch);
      if (!item) return;

      let leftUrl, rightUrl, leftCt, rightCt;

      if (item.semi){
        if (activeMatch==="s1"){
          leftUrl  = state.semi_1_left_url;
          rightUrl = state.semi_1_right_url;
          leftCt   = state.semi_1_left_count;
          rightCt  = state.semi_1_right_count;
        } else {
          leftUrl  = state.semi_2_left_url;
          rightUrl = state.semi_2_right_url;
          leftCt   = state.semi_2_left_count;
          rightCt  = state.semi_2_right_count;
        }
        labelActive1.textContent = "Winner of QF 1/2";
        labelActive2.textContent = "Winner of QF 3/4";
      } else if (item.key.startsWith("q")){
        leftUrl  = state[item.left]  ?? state[item.fbLeft];
        rightUrl = state[item.right] ?? state[item.fbRight];
        leftCt   = state[item.lct]   ?? state[item.fbLct];
        rightCt  = state[item.rct]   ?? state[item.fbRct];
        labelActive1.textContent = "Quarterfinal";
        labelActive2.textContent = "Quarterfinal";
      } else if (item.key==="final"){
        leftUrl  = state.mid_winner_1_url || state.seed_a_url;
        rightUrl = state.mid_winner_2_url || state.seed_b_url;
        leftCt   = state.seed_a_count;
        rightCt  = state.seed_b_count;
        labelActive1.textContent = "Finalist";
        labelActive2.textContent = "Finalist";
      } else {
        // R32 or R16
        leftUrl  = state[item.left];
        rightUrl = state[item.right];
        leftCt   = state[item.lct];
        rightCt  = state[item.rct];

        if (activeMatch.startsWith("rr")){
          const nL = r32SeedNumber(activeMatch, "left");
          const nR = r32SeedNumber(activeMatch, "right");
          labelActive1.textContent = `Seed #${nL}`;
          labelActive2.textContent = `Seed #${nR}`;
        } else {
          labelActive1.textContent = "Round of 16";
          labelActive2.textContent = "Round of 16";
        }
      }

      imgActive1.src = pick(leftUrl,  placeholder("L"));
      imgActive2.src = pick(rightUrl, placeholder("R"));
      countActive1.textContent = leftCt ?? 0;
      countActive2.textContent = rightCt ?? 0;

      markActive();
    }

    function secondsLeft(){
      if (!state.ends_at) return 0;
      const diff = new Date(state.ends_at).getTime() - Date.now();
      return Math.max(0, diff/1000);
    }
    function phaseMeta(sec){
      const t = Math.round(sec);
      let phase = "R32 open";
      if (t <= 120) phase = "R32 decided • R16 open";
      if (t <= 90)  phase = "R16 decided • QF open";
      if (t <= 60)  phase = "QF decided • SF open";
      if (t <= 30)  phase = "SF decided • Final open";
      if (t <= 0)   phase = "Final decided";
      return phase;
    }

    async function fetchState(verbose){
      try{
        const res = await fetch(FUNCTION_URL, { headers: {"x-rsid": RSID}, cache:"no-store" });
        const s = await res.json().catch(()=> ({}));
        Object.assign(state, s||{});
        renderThumbs(); renderActive();
        if (verbose) dbg.textContent = "debug: fetched";
      }catch(e){
        if (verbose) dbg.textContent = "debug: fetch failed";
      }
    }

    // controls
    forceBtn.onclick = async ()=>{
      try{ await fetch(FUNCTION_URL+"?force=1", {headers:{"x-rsid":RSID}}); }catch{}
      await fetchState(true);
    };
    resetBtn.onclick = async ()=>{
      try{ await fetch(FUNCTION_URL+"?reset=1", {headers:{"x-rsid":RSID}}); }catch{}
      await fetchState(true);
    };

    // ticking UI
    function tick(){
      const sec = secondsLeft();
      elRemain.textContent = sec.toFixed(1);
      elMeta.textContent = phaseMeta(sec);
      requestAnimationFrame(tick);
    }

    // boot
    fetchState(true);
    requestAnimationFrame(tick);
  </script>
</body>
</html>