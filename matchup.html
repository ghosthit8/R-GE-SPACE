<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space ‚Äî Matchup</title>
  <style>
    :root{ --green:#39ff14; --green-bright:#7dff62; --bg:#000; --ink:#e5ffe5; --card:#0b0b0b; --border:#153b16; --muted:#8aff8a; --maxw:980px; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--green);font-family:system-ui,Arial,Helvetica,sans-serif}
    .wrap{max-width:var(--maxw);margin:16px auto 64px;padding:0 16px}
    .scorebar{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px solid var(--border);padding:8px 12px;border-radius:12px;background:rgba(7,7,7,.6);flex-wrap:wrap}
    .btn{border:1px solid var(--green);color:var(--green);background:transparent;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{box-shadow:0 0 12px rgba(57,255,20,.18)}
    .tiny{display:flex;gap:8px;align-items:center;font-variant-numeric:tabular-nums;font-size:12px;color:var(--muted)}
    .clock{font-weight:700;border:1px solid var(--border);border-radius:8px;padding:2px 8px}
    .tile{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(7,7,7,.6);margin-top:16px}
    .art{aspect-ratio:4/3;width:100%}.art.red{background:#a60000}.art.blue{background:#0058a6}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-top:1px solid var(--border)}
    .btn.primary.selected{background:rgba(57,255,20,.22);color:var(--green-bright);box-shadow:0 0 18px rgba(125,255,98,.35),inset 0 0 12px rgba(57,255,20,.15)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:14px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0a0a0a;color:#e5ffe5;border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:none;box-shadow:0 0 18px rgba(57,255,20,.2);z-index:9999}
    .winner-banner{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:8px 14px;border-radius:12px;border:1px solid var(--border);background:#0b0b0b;color:var(--ink);box-shadow:0 0 18px rgba(57,255,20,.25);display:none;z-index:9999;font-weight:700}
    .winner-red{color:#ff8b8b}
    .winner-blue{color:#8bb6ff}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="scorebar">
      <div class="tiny"><span>Decision in</span> <span id="clock" class="clock">‚Äî</span> <span id="state">LIVE</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="phaseKey" style="font-size:12px;opacity:.8;border:1px solid var(--border);border-radius:999px;padding:2px 8px">phase: ‚Äî</span>
        <button id="pauseBtn" class="btn">‚è∏Ô∏è Pause</button>
        <button id="forceBtn" class="btn">üèÅ Force Decide</button>
        <a class="btn" href="winners.html" target="_blank" rel="noopener">üèÅ Winners</a>
      </div>
    </div>

    <div class="tile">
      <div class="art red"></div>
      <div class="meta"><span>Entry ‚Äî RED</span><button class="btn primary" id="voteRed">Vote Red</button></div>
    </div>

    <div class="tile">
      <div class="art blue"></div>
      <div class="meta"><span>Entry ‚Äî BLUE</span><button class="btn primary" id="voteBlue">Vote Blue</button></div>
    </div>

    <div class="row">
      <button class="btn" id="submitBtn" disabled>‚úÖ Submit Vote</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="winBanner" class="winner-banner"></div>

<script>
const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer`;

const clockEl = document.getElementById('clock');
const stateEl = document.getElementById('state');
const phaseBadge = document.getElementById('phaseKey');
const pauseBtn = document.getElementById('pauseBtn');
const forceBtn = document.getElementById('forceBtn');
const voteRedBtn = document.getElementById('voteRed');
const voteBlueBtn = document.getElementById('voteBlue');
const submitBtn = document.getElementById('submitBtn');
const toastEl = document.getElementById('toast');
const winBanner = document.getElementById('winBanner');

function toast(msg){ toastEl.textContent=msg; toastEl.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.display='none',1200); }
const canonicalISO = (iso) => new Date(iso).toISOString();   // force Z format
const normalizeKey = (k) => new Date(k).toISOString();       // tolerant compare

function showWinnerBanner(color){
  winBanner.innerHTML = color === 'blue' ? '<span class="winner-blue">BLUE WON</span>' : '<span class="winner-red">RED WON</span>';
  winBanner.style.display = 'block';
  clearTimeout(showWinnerBanner._t);
  showWinnerBanner._t = setTimeout(()=> winBanner.style.display = 'none', 3000);
}

// Stable anonymous voter key per device
function getVoterKey(){
  let k = localStorage.getItem('rs_voter_key');
  if(!k){ k = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)) + '-' + Date.now(); localStorage.setItem('rs_voter_key', k); }
  return k;
}
const VOTER_KEY = getVoterKey();

let chosen = null;
let serverPhaseEndISO = null;
let paused = false;
let remainingSec = null;
let lastSyncAt = 0;
let rafId = null;

// voting ui
voteRedBtn.onclick  = ()=>{ chosen='red';  submitBtn.disabled=false; voteRedBtn.classList.add('selected');  voteBlueBtn.classList.remove('selected');  toast('Selected RED'); };
voteBlueBtn.onclick = ()=>{ chosen='blue'; submitBtn.disabled=false; voteBlueBtn.classList.add('selected'); voteRedBtn.classList.remove('selected');  toast('Selected BLUE'); };

submitBtn.onclick = async ()=>{
  if(!chosen || !serverPhaseEndISO) return;
  try{
    const phaseKey = canonicalISO(serverPhaseEndISO);
    const { error } = await supabase.from('phase_votes').upsert(
      { phase_key: phaseKey, voter_key: VOTER_KEY, choice: chosen },
      { onConflict: 'phase_key,voter_key' }
    );
    if (error) throw error;
    submitBtn.disabled = true;
    submitBtn.textContent = 'üéâ Vote submitted!';
    toast('Vote saved');
  }catch(e){
    console.error(e);
    toast('Vote failed: ' + (e?.message || 'unknown error'));
  }
};

function setStateUI(){
  stateEl.textContent = paused ? 'PAUSED' : 'LIVE';
  pauseBtn.textContent = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
  phaseBadge.textContent = 'phase: ' + (serverPhaseEndISO || '‚Äî');
}

async function callEdge(method='GET', body=null){
  const res = await fetch(EDGE_URL,{
    method,
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${SUPABASE_ANON_KEY}`,
      'apikey': SUPABASE_ANON_KEY
    },
    body: body ? JSON.stringify(body) : null
  });
  const raw = await res.text();
  let j=null; try{ j=JSON.parse(raw); }catch{}
  if(!res.ok) throw new Error((j && j.error) || raw || 'edge error');
  return j?.state || j || {};
}

function normalize(s){ return {
  phase_end_at: s.phase_end_at ?? null,
  period_sec: s.period_sec ?? 10,
  paused: !!s.paused,
  remaining_sec: s.remaining_sec ?? null
};}

async function fetchState(){
  const s = normalize(await callEdge('GET'));
  const prevPhase = serverPhaseEndISO;
  serverPhaseEndISO = s.phase_end_at;
  paused = s.paused;
  remainingSec = s.remaining_sec;
  lastSyncAt = Date.now();
  setStateUI();

  // new phase ‚Üí reset vote UI
  if(prevPhase && serverPhaseEndISO && prevPhase !== serverPhaseEndISO){
    chosen = null;
    voteRedBtn.classList.remove('selected');
    voteBlueBtn.classList.remove('selected');
    submitBtn.textContent = '‚úÖ Submit Vote';
    submitBtn.disabled = true;
  } else {
    submitBtn.disabled = !chosen;
  }
}

function stop(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; }
async function start(){
  stop();
  const tick = async ()=>{
    if (paused){
      clockEl.textContent = String(Math.max(0, Math.ceil(Number(remainingSec ?? 0))));
    } else {
      const rem = Math.max(0, Date.parse(serverPhaseEndISO) - Date.now());
      clockEl.textContent = String(Math.ceil(rem/1000));
      if (rem <= 0 || Date.now()-lastSyncAt > 5000) {
        try{ await fetchState(); }catch(e){ clockEl.textContent='ERR'; stateEl.textContent='ERR'; }
      }
    }
    rafId = requestAnimationFrame(tick);
  };
  rafId = requestAnimationFrame(tick);
}

// controls
pauseBtn.onclick = async ()=>{ try{
  if (paused) await callEdge('POST',{action:'resume'});
  else        await callEdge('POST',{action:'pause'});
  await fetchState();
}catch(e){ toast('Pause/resume failed'); }};

forceBtn.onclick = async ()=>{ try{
  await callEdge('POST',{force:true});
  await fetchState();
  toast('Forced decision & rolled phase');
}catch(e){ toast('Force failed'); }};

// üîî WINNER BANNER: only for THIS phase (format-tolerant)
supabase.channel('winners-current')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'winners'}, (payload)=>{
    const insertedKey = payload?.new?.phase_key;
    const color = (payload?.new?.color || '').toLowerCase();
    if (!insertedKey || !serverPhaseEndISO) return;
    // compare in canonical ISO to avoid Z vs +00:00 issues
    if (normalizeKey(insertedKey) === normalizeKey(serverPhaseEndISO) &&
        (color === 'red' || color === 'blue')) {
      showWinnerBanner(color);
    }
  })
  .subscribe();

// boot
(async()=>{ try{ await fetchState(); await start(); }catch(e){ clockEl.textContent='ERR'; stateEl.textContent='ERR'; }})();
</script>
</body>
</html>