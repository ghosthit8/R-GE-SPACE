<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space — Matchup (32-up → 2-up)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root{
      --green:#39ff14;
      --ink:#030807;
      --panel:#06140f;
      --panel2:#04100c;
      --red:#ff3b3b;
      --blue:#3aa6ff;
      --muted:#0a2a1d;
      --line:rgba(57,255,20,.22);
      --glow:0 0 14px rgba(57,255,20,.35);
      --glow2:0 0 22px rgba(57,255,20,.25);
      --mono:'Share Tech Mono', ui-monospace, Menlo, Consolas, monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--mono);
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(57,255,20,.15), transparent 55%),
        radial-gradient(900px 600px at 10% 30%, rgba(57,255,20,.08), transparent 60%),
        radial-gradient(900px 600px at 90% 60%, rgba(57,255,20,.06), transparent 60%),
        linear-gradient(180deg, #010504 0%, #010705 40%, #000 100%);
      color:var(--green);
      overflow-x:hidden;
    }

    /* Scanlines */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(0deg,
          rgba(255,255,255,.02) 0px,
          rgba(255,255,255,.02) 1px,
          rgba(0,0,0,.03) 2px,
          rgba(0,0,0,.03) 4px);
      mix-blend-mode:overlay;
      opacity:.35;
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background:rgba(0,0,0,.55);
      border-bottom:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:220px;
    }
    .logo{
      width:10px;height:34px;border-radius:2px;
      background:linear-gradient(180deg, rgba(57,255,20,1), rgba(57,255,20,.2));
      box-shadow:var(--glow);
    }
    .titlewrap{line-height:1.05}
    .title{
      font-size:16px;
      letter-spacing:.18em;
      text-transform:uppercase;
      text-shadow:var(--glow2);
    }
    .subtitle{
      font-size:12px;
      opacity:.72;
      letter-spacing:.09em;
    }

    .timerWrap{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(6,20,15,.65), rgba(3,10,8,.55));
      box-shadow:var(--glow2);
    }
    .timerLabel{
      font-size:11px;
      opacity:.78;
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .timer{
      font-size:18px;
      letter-spacing:.12em;
      text-shadow:var(--glow);
      min-width:108px;
      text-align:center;
    }
    .round-label{
      font-size:11px;
      opacity:.8;
      letter-spacing:.14em;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(6,20,15,.75), rgba(4,10,8,.65));
      color:var(--green);
      font-family:var(--mono);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:11px;
      box-shadow:var(--glow2);
      transition:transform .08s ease, filter .08s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.12)}
    .btn:active{transform:translateY(1px)}
    .btn.red{border-color:rgba(255,59,59,.35); color:#ffb1b1; box-shadow:0 0 18px rgba(255,59,59,.15)}
    .btn.blue{border-color:rgba(58,166,255,.35); color:#b7e0ff; box-shadow:0 0 18px rgba(58,166,255,.12)}
    .btn.subtle{opacity:.9}

    main{
      max-width:1200px;
      margin:0 auto;
      padding:18px 14px 46px;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
      .timerWrap{width:100%; justify-content:space-between}
      .actions{width:100%; justify-content:flex-start}
    }

    .card{
      position:relative;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(6,20,15,.70), rgba(2,10,7,.75));
      box-shadow:0 20px 60px rgba(0,0,0,.55);
    }

    .media{
      aspect-ratio:3/4;
      width:100%;
      display:block;
      object-fit:cover;
      background:linear-gradient(180deg, rgba(5,25,16,.45), rgba(0,0,0,.85));
      filter:saturate(1.02);
    }

    .overlay{
      position:absolute; inset:0;
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 35%, rgba(0,0,0,.62) 100%);
    }

    .meta{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .tag{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.45);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      box-shadow:var(--glow2);
      max-width:70%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .count{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.45);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      box-shadow:var(--glow2);
      white-space:nowrap;
    }

    .voteRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .voteRow .btn{flex:1 1 220px}

    .statusRow{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      opacity:.92;
      font-size:12px;
      letter-spacing:.08em;
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      box-shadow:var(--glow2);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--green); box-shadow:0 0 12px rgba(57,255,20,.55)}
    .dot.bad{background:#ff5757; box-shadow:0 0 12px rgba(255,87,87,.4)}
    .muted{opacity:.72}

    .modal{
      position:fixed; inset:0;
      z-index:50;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.82);
      padding:20px;
    }
    .modal.show{display:flex}
    .modalInner{
      width:min(980px, 95vw);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:rgba(0,0,0,.35);
      box-shadow:0 0 30px rgba(57,255,20,.15);
      position:relative;
    }
    .modalMedia{
      width:100%;
      height:min(84vh, 820px);
      object-fit:contain;
      display:block;
      background:black;
    }
    .modalHint{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:.84;
    }
    .kbd{padding:6px 8px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.45)}

    footer{
      max-width:1200px;margin:0 auto;
      padding:0 14px 22px;
      opacity:.7;
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    a{color:var(--green)}
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="titlewrap">
        <div class="title">Rage Space</div>
        <div class="subtitle">Matchup — 32 → 16 → 8 → 4 → 2</div>
      </div>
    </div>

    <div class="timerWrap">
      <div>
        <div class="timerLabel">Time remaining (this round)</div>
        <div class="timer" id="tRemain">04:48:00</div>
      </div>
      <div class="round-label" id="currentRound">Current round: —</div>
    </div>

    <div class="actions">
      <button class="btn subtle" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnAFK">AFK Auto-Vote</button>
      <button class="btn red" id="btnReport">Report</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card" id="cardLeft">
      <img class="media" id="imgLeft" alt="Left artwork"/>
      <div class="overlay"></div>
      <div class="meta">
        <div class="tag" id="tagLeft">Final slot 1</div>
        <div class="count" id="countLeft">0</div>
      </div>
    </section>

    <section class="card" id="cardRight">
      <img class="media" id="imgRight" alt="Right artwork"/>
      <div class="overlay"></div>
      <div class="meta">
        <div class="tag" id="tagRight">Final slot 2</div>
        <div class="count" id="countRight">0</div>
      </div>
    </section>
  </div>

  <div class="voteRow">
    <button class="btn red" id="voteLeft">Vote Left</button>
    <button class="btn blue" id="voteRight">Vote Right</button>
  </div>

  <div class="statusRow">
    <span class="pill"><span class="dot ok" id="dotAuth"></span>Auth <span class="muted" id="authText">…</span></span>
    <span class="pill"><span class="dot ok" id="dotState"></span>State <span class="muted" id="stateText">…</span></span>
    <span class="pill"><span class="dot ok" id="dotTimer"></span>Timer <span class="muted" id="timerText">…</span></span>
  </div>
</main>

<div class="modal" id="modal">
  <div class="modalInner">
    <div class="modalHint">
      <span class="kbd">Press A to fullscreen</span>
      <span class="kbd">Press B to close</span>
    </div>
    <img class="modalMedia" id="fullImg" alt="Fullscreen artwork"/>
  </div>
</div>

<footer>
  Use <b>A</b> to fullscreen the active piece. Use <b>B</b> to close.
</footer>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ====== YOUR SUPABASE CREDS ======
  const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // <-- keep your real anon key here

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== DOM ======
  const elRemain = document.getElementById("tRemain");
  const currentRoundEl = document.getElementById("currentRound");

  const imgLeft = document.getElementById("imgLeft");
  const imgRight = document.getElementById("imgRight");
  const tagLeft = document.getElementById("tagLeft");
  const tagRight = document.getElementById("tagRight");
  const countLeft = document.getElementById("countLeft");
  const countRight = document.getElementById("countRight");

  const voteLeftBtn = document.getElementById("voteLeft");
  const voteRightBtn = document.getElementById("voteRight");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnAFK = document.getElementById("btnAFK");

  const dotAuth = document.getElementById("dotAuth");
  const dotState = document.getElementById("dotState");
  const dotTimer = document.getElementById("dotTimer");
  const authText = document.getElementById("authText");
  const stateText = document.getElementById("stateText");
  const timerText = document.getElementById("timerText");

  const modal = document.getElementById("modal");
  const fullImg = document.getElementById("fullImg");

  // ====== STATE ======
  let state = {
    base_iso: null,
    ends_at: null,
    period_sec: 86400,
    seed_a_url: null,
    seed_b_url: null,
    seed_a_count: 0,
    seed_b_count: 0,
    meta_by_url: {}
  };

  // ===== TIMER (24h total, 4h48m rounds) =====
  const ROUND_SEC = 4*3600 + 48*60; // 17280
  let timerEndsAtMs = null;

  function _pad2(n){ return String(n).padStart(2,"0"); }
  function _fmtHMS(totalSec){
    totalSec = Math.max(0, Math.floor(totalSec));
    const h = Math.floor(totalSec/3600);
    const m = Math.floor((totalSec%3600)/60);
    const s = totalSec%60;
    return `${_pad2(h)}:${_pad2(m)}:${_pad2(s)}`;
  }
  function _roundLabel(secondsLeft){
    if (secondsLeft > 69120) return "R32";
    if (secondsLeft > 51840) return "R16";
    if (secondsLeft > 34560) return "QF";
    if (secondsLeft > 17280) return "SF";
    if (secondsLeft > 0)     return "Final";
    return "Deciding";
  }

  function tickTimer(){
    const endsAt = (state && (state.ends_at || state.endsAt)) || null;
    if (!endsAt) return;

    if (!timerEndsAtMs){
      timerEndsAtMs = new Date(endsAt).getTime();
      if (!Number.isFinite(timerEndsAtMs)) { timerEndsAtMs = null; return; }
    }

    const secondsLeft = Math.max(0, Math.floor((timerEndsAtMs - Date.now())/1000));

    // show time remaining within current 4h48m segment
    let phaseLeft = secondsLeft % ROUND_SEC;
    if (secondsLeft > 0 && phaseLeft === 0) phaseLeft = ROUND_SEC;

    if (elRemain) elRemain.textContent = _fmtHMS(phaseLeft);
    if (currentRoundEl) currentRoundEl.textContent = `Current round: ${_roundLabel(secondsLeft)}`;

    if (dotTimer) dotTimer.className = "dot ok";
    if (timerText) timerText.textContent = "synced";
  }

  async function loadTimerFromDB(){
    try{
      const { data, error } = await supabase
        .from("cycles_v2")
        .select("ends_at, period_sec")
        .order("ends_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error || !data?.ends_at) {
        if (dotTimer) dotTimer.className = "dot bad";
        if (timerText) timerText.textContent = error ? "db error" : "no ends_at";
        return;
      }

      state.ends_at = data.ends_at;
      state.period_sec = data.period_sec ?? state.period_sec;

      timerEndsAtMs = null;
      tickTimer();
    }catch(e){
      if (dotTimer) dotTimer.className = "dot bad";
      if (timerText) timerText.textContent = "timer exception";
    }
  }

  // start timer loops
  setInterval(tickTimer, 1000);
  setInterval(loadTimerFromDB, 30000);
  loadTimerFromDB();
  tickTimer();

  // ====== HELPERS ======
  function setAuth(ok, msg){
    dotAuth.className = "dot " + (ok ? "ok" : "bad");
    authText.textContent = msg;
  }
  function setStateStatus(ok, msg){
    dotState.className = "dot " + (ok ? "ok" : "bad");
    stateText.textContent = msg;
  }

  function safeSetImg(el, url){
    if (!el) return;
    if (!url || typeof url !== "string"){
      el.removeAttribute("src");
      return;
    }
    el.src = url;
  }

  function pickActivePair(){
    // minimal “final view” pair; your edge function / DB should keep these updated
    const leftUrl = state.seed_a_url;
    const rightUrl = state.seed_b_url;

    safeSetImg(imgLeft, leftUrl);
    safeSetImg(imgRight, rightUrl);

    tagLeft.textContent = "Active top";
    tagRight.textContent = "Active bottom";

    countLeft.textContent = String(state.seed_a_count ?? 0);
    countRight.textContent = String(state.seed_b_count ?? 0);
  }

  // ====== EDGE STATE PULL (optional) ======
  const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

  async function fetchState(force=false){
    try{
      // Only attempt if function exists; failure here shouldn't block timer.
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData?.session?.access_token || null;

      const res = await fetch(`${FUNCTION_URL}?_=${Date.now()}`, {
        method:"GET",
        headers: token
          ? { "Authorization": `Bearer ${token}`, "apikey": SUPABASE_ANON_KEY }
          : { "apikey": SUPABASE_ANON_KEY }
      });

      if (!res.ok){
        setStateStatus(false, `edge ${res.status}`);
        return;
      }

      const s = await res.json();
      if (s && typeof s === "object"){
        Object.assign(state, s);

        // normalize common variants
        if (!state.ends_at && s.endsAt) state.ends_at = s.endsAt;
        if (!state.base_iso && (s.baseIso || s.baseISO)) state.base_iso = s.baseIso || s.baseISO;

        // resync timer if ends_at changed
        timerEndsAtMs = null;
        tickTimer();

        pickActivePair();
        setStateStatus(true, "ok");
      }else{
        setStateStatus(false, "bad json");
      }
    }catch(e){
      setStateStatus(false, "edge failed");
    }
  }

  // ====== AUTH BOOT ======
  async function boot(){
    const { data } = await supabase.auth.getUser();
    if (data?.user){
      setAuth(true, data.user.email || "signed in");
    }else{
      setAuth(false, "not signed in");
    }

    // Pull DB timer immediately regardless
    await loadTimerFromDB();

    // Try edge state (won't block)
    fetchState(true);

    // Also refresh state every 30s
    setInterval(() => fetchState(false), 30000);
  }

  // ====== UI EVENTS ======
  btnRefresh.addEventListener("click", () => {
    loadTimerFromDB();
    fetchState(true);
  });

  btnAFK.addEventListener("click", async () => {
    try{
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData?.session?.access_token || null;
      if (!token){
        alert("Sign in first.");
        return;
      }

      const activeUrl = state.seed_a_url; // pick one; your old logic can be restored later
      const res = await fetch(`${FUNCTION_URL}`, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization": `Bearer ${token}`,
          "apikey": SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ mode:"auto_vote", image_url: activeUrl })
      });

      const j = await res.json().catch(()=> ({}));
      if (!res.ok){
        alert(j?.error || `AFK failed (${res.status})`);
        return;
      }
      alert("AFK vote locked in.");
    }catch(e){
      alert("AFK failed.");
    }
  });

  voteLeftBtn.addEventListener("click", () => alert("Vote wiring is still in your old logic; timer first."));
  voteRightBtn.addEventListener("click", () => alert("Vote wiring is still in your old logic; timer first."));

  // Fullscreen modal (tap/click)
  imgLeft.addEventListener("click", () => {
    if (!imgLeft.src) return;
    fullImg.src = imgLeft.src;
    modal.classList.add("show");
  });
  imgRight.addEventListener("click", () => {
    if (!imgRight.src) return;
    fullImg.src = imgRight.src;
    modal.classList.add("show");
  });

  // Keyboard controls (A fullscreen active, B close)
  document.addEventListener("keydown", (e) => {
    const k = (e.key || "").toLowerCase();
    if (k === "b"){
      modal.classList.remove("show");
    }
    if (k === "a"){
      // if modal open, keep open; otherwise open left by default
      if (!modal.classList.contains("show")){
        if (imgLeft?.src){
          fullImg.src = imgLeft.src;
          modal.classList.add("show");
        }
      }
    }
  });
  modal.addEventListener("click", () => modal.classList.remove("show"));

  boot();
</script>

</body>
</html>