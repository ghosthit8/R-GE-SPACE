<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RageSpace â€” Matchup</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root { --bg:#050706; --panel:#0a0e0b; --text:#e8ffe8; --muted:#b4ffb4; --line:#182118; --green:#00ff75; --red:#ff3b3b; --blue:#4aa3ff; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width:960px; margin:0 auto; padding:16px 12px 100px; }
    h1 { margin:0 0 10px; font-size:24px; letter-spacing:.5px; }
    .grid { display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width:800px){ .grid { grid-template-columns:1fr 1fr; } }
    .card { background:linear-gradient(180deg,#08100a,#0a0e0b); border:1px solid var(--line); border-radius:18px; box-shadow:0 2px 14px rgba(0,0,0,.45); overflow:hidden; }
    .img { height:280px; background:#0b0b0b; }
    .img.red { background:#ff0000; }
    .img.blue { background:#0060ff; }
    .meta { padding:10px 12px; display:flex; align-items:center; justify-content:space-between; border-top:1px solid var(--line); }
    .title { font-weight:800; }
    .count { color:var(--muted); opacity:.85; }
    .btn {
      appearance:none; border:1px solid var(--line); background:#0b120d; color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:0 0 18px #002a12 inset, 0 0 0 1px #0b150f;
    }
    .btn.red { box-shadow:0 0 18px #260000 inset, 0 0 0 1px #200; }
    .btn.blue { box-shadow:0 0 18px #001a33 inset, 0 0 0 1px #001a33; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .bar { margin:12px 0 8px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .phase { padding:6px 10px; border:1px solid var(--line); border-radius:12px; background:#0b120d; }
    .toast { position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#0b120d; border:1px solid var(--line); padding:12px 16px; border-radius:14px; color:var(--text); box-shadow:0 16px 50px rgba(0,0,0,.55); display:none; z-index:50; }
    .toast.show { display:block; }
    .debugWrap { position:fixed; right:14px; bottom:92px; width:min(640px, 92vw); z-index:40; }
    .debugPane { display:none; background:#062506; border:1px solid #154015; border-radius:16px; padding:10px; color:#caffca; box-shadow:0 8px 40px rgba(0,0,0,.6); max-height:50vh; overflow:auto; }
    .dbgBtns { display:flex; gap:10px; margin-bottom:10px; }
    .mini { position:fixed; right:14px; bottom:24px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Vote the Winner</h1>

    <div class="bar">
      <div id="phaseBadge" class="phase">phase: â€”</div>
      <div id="timerBadge" class="phase">00s</div>
      <div id="authBadge" class="phase">auth: â€”</div>
      <button id="submitBtn" class="btn" disabled>Submit Vote</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="img red"></div>
        <div class="meta">
          <div>
            <div class="title">Entry â€” RED</div>
            <div class="count"><span id="redCount">0</span> votes</div>
          </div>
          <button id="redBtn" class="btn red">Vote Red</button>
        </div>
      </div>

      <div class="card">
        <div class="img blue"></div>
        <div class="meta">
          <div>
            <div class="title">Entry â€” BLUE</div>
            <div class="count"><span id="blueCount">0</span> votes</div>
          </div>
          <button id="blueBtn" class="btn blue">Vote Blue</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <div class="debugWrap">
    <div class="debugPane" id="debugPane">
      <div class="dbgBtns">
        <button class="btn" id="dbgRefresh">Refresh Stats</button>
        <button class="btn" id="dbgInsert">Test Insert</button>
        <button class="btn" id="dbgClear">Clear</button>
      </div>
      <pre id="debugLog" style="margin:0; font-size:12px; white-space:pre-wrap;"></pre>
    </div>
    <button id="dbgToggle" class="btn mini">ðŸ”Ž Debug</button>
  </div>

<script>
/* ------------ CONFIG ------------ */
const SUPABASE_URL  = window.ENV_SUPABASE_URL  || localStorage.getItem('SUPABASE_URL')  || '<YOUR_SUPABASE_URL>';
const SUPABASE_ANON = window.ENV_SUPABASE_ANON || localStorage.getItem('SUPABASE_ANON') || '<YOUR_SUPABASE_ANON_KEY>';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* Tables/columns used:
   - public.phase_state   (single row): { phase_end_at timestamptz, paused boolean }
   - public.phase_votes   (phase_key timestamptz, user_id uuid, vote text)  UNIQUE (phase_key, user_id)
   - public.winners       (phase_key, color, name, decided_at, decided_by, image_url, red_count, blue_count)
*/

/* ------------ ELEMENTS ------------ */
const redBtn = document.getElementById('redBtn');
const blueBtn = document.getElementById('blueBtn');
const submitBtn = document.getElementById('submitBtn');
const redCountEl = document.getElementById('redCount');
const blueCountEl = document.getElementById('blueCount');
const phaseBadge = document.getElementById('phaseBadge');
const timerBadge = document.getElementById('timerBadge');
const authBadge = document.getElementById('authBadge');
const toastEl = document.getElementById('toast');

/* debug */
const dbgToggle = document.getElementById('dbgToggle');
const dbgPane = document.getElementById('debugPane');
const dbgLog = document.getElementById('debugLog');
const dbgRefresh = document.getElementById('dbgRefresh');
const dbgInsert = document.getElementById('dbgInsert');
const dbgClear = document.getElementById('dbgClear');

function log(...a){ const t = new Date().toLocaleTimeString(); dbgLog.textContent = `[${t}] ${a.join(' ')}\n` + dbgLog.textContent; }
function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 2200); }

/* ------------ AUTH ------------ */
let session = null;
let chosen = null;           // 'red' | 'blue'
let currentPhaseKey = null;  // ISO string (timestamptz)
let timerTick = null;

async function initAuth(){
  const { data:{ session: s } } = await supabase.auth.getSession();
  session = s;
  renderAuth();
  supabase.auth.onAuthStateChange((_e, sess) => { session = sess; renderAuth(); updateSubmitBtn(); });
}
function renderAuth(){
  authBadge.textContent = `auth: ${session? 'ok' : 'â€”'}`;
}
function updateSubmitBtn(){
  submitBtn.disabled = !(session && chosen && currentPhaseKey);
}

/* ------------ PHASE / TIMER ------------ */
async function fetchState(){
  const { data, error } = await supabase.from('phase_state').select('phase_end_at, paused').limit(1).single();
  if(error){ log('fetchState error', error.message); return { remainingSec:20, paused:false, phase_end_at:null }; }
  const end = data?.phase_end_at ? new Date(data.phase_end_at) : null;
  const now = new Date();
  const remainingSec = end ? Math.max(0, Math.floor((end - now) / 1000)) : 20;
  return { remainingSec, paused: !!data?.paused, phase_end_at: end ? end.toISOString() : null };
}

function toIso(k){ return (typeof k === 'string') ? k : new Date(k).toISOString(); }

async function tick(){
  const st = await fetchState();
  currentPhaseKey = st.phase_end_at; // use the exact end time as the key (matches your DB)
  phaseBadge.textContent = `phase: ${currentPhaseKey ? currentPhaseKey.slice(0,19).replace('T',' ') : 'â€”'}`;
  timerBadge.textContent = `${String(st.remainingSec).padStart(2,'0')}s${st.paused?' â¸':''}`;

  await refreshCounts();
  if(st.remainingSec === 0 && currentPhaseKey){
    // phase just ended: ask backend to decide winner (edge/SQL); front-end only displays result
    // (If you expose an RPC, call it here; otherwise DB-side job will handle it.)
    await pollWinnerForKey(currentPhaseKey);
  }
}

async function startTimer(){
  if(timerTick) clearInterval(timerTick);
  await tick();
  timerTick = setInterval(tick, 1000);
}

/* ------------ COUNTS / VOTES ------------ */
async function refreshCounts(){
  if(!currentPhaseKey){ redCountEl.textContent='0'; blueCountEl.textContent='0'; return; }
  const phaseKey = toIso(currentPhaseKey);
  // group counts for this phase
  const { data, error } = await supabase
    .from('phase_votes')
    .select('vote, count:vote(count)')
    .eq('phase_key', phaseKey)
    .group('vote');
  if(error){ log('counts err', error.message); return; }
  const red = (data?.find(r => r.vote==='red')?.count?.[0]?.count) ?? 0;
  const blue= (data?.find(r => r.vote==='blue')?.count?.[0]?.count) ?? 0;
  redCountEl.textContent = red; blueCountEl.textContent = blue;
  log('counts ok', JSON.stringify({red, blue}));
}

async function castVote(side){
  if(!session){ toast('Please sign in first'); return; }
  if(!currentPhaseKey){ toast('Phase not ready'); return; }
  chosen = side;
  updateSubmitBtn();
  toast(`Selected ${side.toUpperCase()}`);
}

async function submitVote(){
  try{
    const user_id = session.user.id;
    const payload = { phase_key: toIso(currentPhaseKey), user_id, vote: chosen };
    const { error } = await supabase.from('phase_votes').upsert(payload, { onConflict: 'phase_key,user_id' });
    if(error) throw error;
    toast('Vote submitted');
    await refreshCounts();
  }catch(e){
    log('VOTE ERROR', e.message||e);
    toast('Vote failed');
  }
}

/* ------------ WINNER DISPLAY ------------ */
function showWinnerBanner(color){
  const word = (color||'').toUpperCase();
  toast(`${word} wins`);
}

async function pollWinnerForKey(key){
  try{
    const { data, error } = await supabase
      .from('winners')
      .select('color, decided_by')
      .eq('phase_key', toIso(key))
      .limit(1);
    if(error) throw error;
    const row = data?.[0];
    const c = (row?.color||'').toLowerCase();
    if (c==='red' || c==='blue') showWinnerBanner(c);
    else if ((row?.decided_by||'').toLowerCase()==='tie') toast('Tie â€” no winner');
  }catch(e){ /* quiet */ }
}

/* ------------ DEBUG ------------ */
dbgToggle.onclick = () => { dbgPane.style.display = (dbgPane.style.display==='block'?'none':'block'); };
dbgRefresh.onclick = async () => { await refreshCounts(); const s = await fetchState(); log('fetchState ok\n' + JSON.stringify(s, null, 2)); };
dbgInsert.onclick = async () => {
  if(!session || !currentPhaseKey){ log('test insert blocked'); return; }
  const { error } = await supabase.from('phase_votes').upsert({
    phase_key: toIso(currentPhaseKey),
    user_id: session.user.id,
    vote: 'red'
  }, { onConflict: 'phase_key,user_id' });
  log(error ? ('test insert error ' + error.message) : 'test insert ok');
};
dbgClear.onclick = () => { dbgLog.textContent=''; };

/* ------------ WIRE UI ------------ */
redBtn.onclick = () => castVote('red');
blueBtn.onclick = () => castVote('blue');
submitBtn.onclick = submitVote;

/* ------------ BOOT ------------ */
initAuth().then(startTimer);
</script>
</body>
</html>