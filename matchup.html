<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rage Space — Matchup</title>

<link rel="stylesheet" href="style.css"/>

<style>
body {
  background:#0b0f13;
  color:#e5e7eb;
  font-family:system-ui,Segoe UI,Roboto;
  margin:0;
}
.wrap { max-width:700px; margin:auto; padding:16px 12px 96px; }

.timer {
  font-size:32px;
  padding:8px 14px;
  border:1px solid #20242a;
  border-radius:12px;
  background:#0f1318;
}

.card {
  margin-top:12px;
  border:1px solid #20242a;
  border-radius:16px;
  overflow:hidden;
  background:#0f1318;
}
.imgBox { aspect-ratio:3/4; background:#111; }
.imgBox img { width:100%; height:100%; object-fit:cover; }

.bar {
  display:flex;
  justify-content:space-between;
  padding:10px 12px;
  align-items:center;
}
.vote {
  padding:10px 14px;
  border-radius:12px;
  background:#131920;
  border:1px solid #39ff14;
  color:#39ff14;
  cursor:pointer;
}
.vote:disabled { opacity:.4; cursor:default; }

.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin:10px 0;
}
.pill {
  padding:8px 12px;
  border-radius:999px;
  border:1px solid #20242a;
  background:#0f1318;
  font-size:14px;
}
.btn {
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(57,255,20,.5);
  background:#0f1318;
  color:#39ff14;
  cursor:pointer;
}
.btn:disabled { opacity:.4; cursor:default; }

.thumbs {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-top:18px;
}

.thumb {
  position:relative;
  border-radius:14px;
  overflow:hidden;
  cursor:pointer;
  background:#0f1318;
  border:1px solid rgba(57,255,20,.35);
  box-shadow:
    0 0 8px rgba(57,255,20,.15),
    inset 0 0 0 1px rgba(57,255,20,.15);
  transition:box-shadow .2s ease, transform .15s ease;
}
.thumb:hover {
  transform:translateY(-1px);
  box-shadow:
    0 0 14px rgba(57,255,20,.45),
    0 0 32px rgba(57,255,20,.25),
    inset 0 0 0 1px rgba(57,255,20,.4);
}
.thumb.active {
  box-shadow:
    0 0 18px rgba(57,255,20,.9),
    0 0 48px rgba(57,255,20,.55),
    inset 0 0 0 2px rgba(57,255,20,.9);
}

.thumb-img {
  position:relative;
  width:100%;
  aspect-ratio:3/4;
  background:#0b0f13;
}
.thumb-img img {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}
.thumb-img img.left {
  clip-path:polygon(0% 0%, 100% 0%, 0% 100%);
}
.thumb-img img.right {
  clip-path:polygon(100% 0%, 100% 100%, 0% 100%);
}

.small { font-size:12px; opacity:.8; }
.warn { color:#ffcc66; }
.ok { color:#39ff14; }
</style>
</head>

<body>
<div class="wrap">

<h1>ART BATTLE. Faction I.</h1>

<div class="timer">—</div>

<div class="topbar">
  <div class="pill" id="roundLabel">Loading…</div>
  <div style="display:flex; gap:8px; align-items:center;">
    <div class="pill" id="userLabel">Not signed in</div>
    <button class="btn" id="btnSignIn">Sign in</button>
    <button class="btn" id="btnSignOut" disabled>Sign out</button>
  </div>
</div>

<div class="small" id="statusLine"></div>

<div class="card">
  <div class="imgBox">
    <img id="imgLeft">
  </div>
  <div class="bar">
    <span>Top</span>
    <span id="countLeft">0</span>
    <button class="vote" id="voteLeft" disabled>Vote</button>
  </div>
</div>

<div class="card">
  <div class="imgBox">
    <img id="imgRight">
  </div>
  <div class="bar">
    <span>Bottom</span>
    <span id="countRight">0</span>
    <button class="vote" id="voteRight" disabled>Vote</button>
  </div>
</div>

<div class="thumbs" id="thumbs"></div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* =========================
   SUPABASE (YOUR PROJECT)
========================= */
const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   DOM
========================= */
const imgLeft = document.getElementById("imgLeft");
const imgRight = document.getElementById("imgRight");
const countLeft = document.getElementById("countLeft");
const countRight = document.getElementById("countRight");
const voteLeft = document.getElementById("voteLeft");
const voteRight = document.getElementById("voteRight");
const thumbsEl = document.getElementById("thumbs");
const roundLabel = document.getElementById("roundLabel");
const userLabel = document.getElementById("userLabel");
const statusLine = document.getElementById("statusLine");
const btnSignIn = document.getElementById("btnSignIn");
const btnSignOut = document.getElementById("btnSignOut");

/* =========================
   STATE
========================= */
let sessionUser = null;
let activeRound = 0;
let matches = [];
let activeMatchIndex = 0;
let hasVotedThisRound = false;

const ROUND_NAMES = ["Round of 32","Round of 16","Quarterfinals","Semifinals","Final"];

/* =========================
   AUTH
========================= */
function setStatus(msg, cls=""){
  statusLine.className = "small " + cls;
  statusLine.textContent = msg;
}

function updateAuthUI(){
  if (sessionUser){
    userLabel.textContent = sessionUser.email ?? "Signed in";
    btnSignIn.disabled = true;
    btnSignOut.disabled = false;
  } else {
    userLabel.textContent = "Not signed in";
    btnSignIn.disabled = false;
    btnSignOut.disabled = true;
  }
}

btnSignIn.onclick = async () => {
  const email = prompt("Email:");
  if (!email) return;
  const password = prompt("Password:");
  if (!password) return;

  setStatus("Signing in…");
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error){
    setStatus(error.message, "warn");
    return;
  }
  sessionUser = data.user;
  updateAuthUI();
  await refreshAll();
};

btnSignOut.onclick = async () => {
  await supabase.auth.signOut();
  sessionUser = null;
  updateAuthUI();
  await refreshAll();
};

/* =========================
   DATA
========================= */
async function detectActiveRound(){
  for (let r=0;r<5;r++){
    const { data } = await supabase
      .from("matches_v2")
      .select("*")
      .eq("round", r)
      .order("match_index");

    if (data?.some(m=>!m.winner_img)) return r;
  }
  return 4;
}

async function loadRound(r){
  const { data } = await supabase
    .from("matches_v2")
    .select("*")
    .eq("round", r)
    .order("match_index");
  return data ?? [];
}

async function loadCounts(matchId){
  const { data } = await supabase
    .from("round_votes_v2")
    .select("side")
    .eq("match_id", matchId);

  let l=0, r=0;
  data?.forEach(v=>v.side==="left"?l++:r++);
  return { l, r };
}

async function checkVoted(userId, round){
  if (!userId) return false;
  const { data } = await supabase
    .from("round_votes_v2")
    .select("id")
    .eq("user_id", userId)
    .eq("round", round)
    .limit(1);
  return data?.length>0;
}

/* =========================
   RENDER
========================= */
function render(){
  roundLabel.textContent = ROUND_NAMES[activeRound];
  const m = matches[activeMatchIndex];
  if (!m) return;

  imgLeft.src = m.left_img;
  imgRight.src = m.right_img;

  const canVote = sessionUser && !hasVotedThisRound && !m.winner_img;
  voteLeft.disabled = !canVote;
  voteRight.disabled = !canVote;

  renderThumbs();
}

function renderThumbs(){
  thumbsEl.innerHTML="";
  matches.forEach((m,i)=>{
    const t=document.createElement("div");
    t.className="thumb"+(i===activeMatchIndex?" active":"");
    t.innerHTML=`
      <div class="thumb-img">
        <img class="left" src="${m.left_img}">
        <img class="right" src="${m.right_img}">
      </div>`;
    t.onclick=async()=>{
      activeMatchIndex=i;
      await refreshCounts();
      render();
    };
    thumbsEl.appendChild(t);
  });
}

async function refreshCounts(){
  const m = matches[activeMatchIndex];
  if (!m) return;
  const c = await loadCounts(m.id);
  countLeft.textContent = c.l;
  countRight.textContent = c.r;
}

/* =========================
   VOTE
========================= */
async function vote(side){
  const m = matches[activeMatchIndex];
  if (!m || !sessionUser) return;

  if (hasVotedThisRound){
    setStatus("Already voted this round.", "warn");
    return;
  }

  const { error } = await supabase.from("round_votes_v2").insert({
    user_id: sessionUser.id,
    round: activeRound,
    match_id: m.id,
    side
  });

  if (error){
    setStatus(error.message, "warn");
    return;
  }

  hasVotedThisRound = true;
  setStatus("Vote submitted.", "ok");
  await refreshAll();
}

voteLeft.onclick=()=>vote("left");
voteRight.onclick=()=>vote("right");

/* =========================
   REFRESH
========================= */
async function refreshAll(){
  const { data } = await supabase.auth.getSession();
  sessionUser = data?.session?.user ?? null;
  updateAuthUI();

  activeRound = await detectActiveRound();
  matches = await loadRound(activeRound);
  activeMatchIndex = matches.findIndex(m=>!m.winner_img);
  if (activeMatchIndex<0) activeMatchIndex=0;

  hasVotedThisRound = await checkVoted(sessionUser?.id, activeRound);

  render();
  await refreshCounts();

  if (!sessionUser){
    setStatus("Sign in to vote (1 vote per round).");
  } else if (hasVotedThisRound){
    setStatus("You already voted this round.", "warn");
  } else {
    setStatus("You may vote once this round.", "ok");
  }
}

/* INIT */
await refreshAll();
</script>

</body>
</html>