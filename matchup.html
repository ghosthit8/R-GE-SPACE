<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space ‚Äî Matchup</title>
  <style>
    :root{
      --green:#39ff14; --green-bright:#7dff62; --bg:#000; --ink:#e5ffe5; --card:#0b0b0b; --border:#153b16;
      --muted:#8aff8a; --maxw:980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--green);font-family:system-ui,Arial,Helvetica,sans-serif;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--maxw);margin:16px auto 64px;padding:0 16px}
    header.wrap{padding-top:0}
    h1{margin:0 0 8px;letter-spacing:.06em}
    .scorebar{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px solid var(--border);padding:8px 12px;border-radius:12px;background:rgba(7,7,7,.6);flex-wrap:wrap}
    .btn{border:1px solid var(--green);color:var(--green);background:transparent;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{box-shadow:0 0 12px rgba(57,255,20,.18)}
    .tiny-timer{display:inline-flex;gap:8px;align-items:center;font-variant-numeric:tabular-nums;font-size:12px;color:var(--muted)}
    .tiny-clock{font-weight:700;border:1px solid var(--border);border-radius:8px;padding:2px 8px}
    .tiny-state{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .tile{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(7,7,7,.6);margin-top:16px}
    .art{aspect-ratio:4/3;width:100%}
    .art.red{background:repeating-linear-gradient(45deg,#3a0000 0,#3a0000 12px,#5a0000 12px,#5a0000 24px),#a60000}
    .art.blue{background:repeating-linear-gradient(45deg,#001c3a 0,#001c3a 12px,#00325a 12px,#00325a 24px),#0058a6}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-top:1px solid var(--border)}
    .btn.primary.selected{background:rgba(57,255,20,.22);color:var(--green-bright);box-shadow:0 0 18px rgba(125,255,98,.35),inset 0 0 12px rgba(57,255,20,.15)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:14px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0a0a0a;color:#e5ffe5;border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:none;box-shadow:0 0 18px rgba(57,255,20,.2);z-index:9999}
    /* Debug */
    .debug{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .err{color:#ff6b6b}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="wrap">
    <h1>R<span style="font-variant:all-small-caps">‚í∂</span>GE SPACE ‚Äî MATCHUP</h1>
    <div class="scorebar">
      <div class="tiny-timer">
        <span>Decision in</span>
        <span id="tinyClock" class="tiny-clock">‚Äî</span>
        <span id="tinyState" class="tiny-state">LIVE</span>
      </div>
      <div class="debug">
        <span class="chip" id="phaseKey">phase: ‚Äî</span>
        <button id="btnPause" class="btn">‚è∏Ô∏è Pause</button>
        <button id="btnForce" class="btn">üèÅ Force Decide</button>
        <a class="btn" href="winners.html" target="_blank" rel="noopener">üèÅ Winners</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="tile">
      <div class="art red"></div>
      <div class="meta">
        <span>Entry ‚Äî RED</span>
        <button class="btn primary" id="voteTop">Vote Red (Top)</button>
      </div>
    </div>

    <div class="tile">
      <div class="art blue"></div>
      <div class="meta">
        <span>Entry ‚Äî BLUE</span>
        <button class="btn primary" id="voteBottom">Vote Blue (Bottom)</button>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnSubmit" disabled>‚úÖ Submit Vote</button>
    </div>
  </main>

  <div id="toast" class="toast"></div>

<script>
/* ===== Supabase / Edge config ===== */
const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer`;

/* ===== UI refs ===== */
const tinyClock = document.getElementById('tinyClock');
const tinyState = document.getElementById('tinyState');
const chipPhase = document.getElementById('phaseKey');
const btnPause  = document.getElementById('btnPause');
const btnForce  = document.getElementById('btnForce');
const voteTop   = document.getElementById('voteTop');
const voteBottom= document.getElementById('voteBottom');
const btnSubmit = document.getElementById('btnSubmit');
const toastEl   = document.getElementById('toast');

/* ===== Local voting (UI only; server decides winners) ===== */
let chosen = null;
voteTop.onclick = ()=>{ chosen='A'; btnSubmit.disabled=false; voteTop.classList.add('selected'); voteBottom.classList.remove('selected'); showToast('Selected RED'); };
voteBottom.onclick = ()=>{ chosen='B'; btnSubmit.disabled=false; voteBottom.classList.add('selected'); voteTop.classList.remove('selected'); showToast('Selected BLUE'); };
btnSubmit.onclick = ()=>{ if(!chosen) return; btnSubmit.disabled=true; btnSubmit.textContent='üéâ Vote submitted!'; };

/* ===== Timer sync with Edge ===== */
let paused=false;
let serverPhaseEndISO=null;
let remainingSec=null;
let lastSyncAt=0;
let rafId=null;

function showToast(msg){
  toastEl.textContent = msg; toastEl.style.display='block';
  clearTimeout(showToast._t); toastEl._t=setTimeout(()=> toastEl.style.display='none', 1200);
}
function setTinyState(){
  tinyState.textContent = paused ? 'PAUSED' : 'LIVE';
  btnPause.textContent  = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
}
function setPhaseKeyLabel(){
  chipPhase.textContent = 'phase: ' + (serverPhaseEndISO || '‚Äî');
}

async function callEdge(method='GET', body=null){
  const res = await fetch(EDGE_URL,{
    method,
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${SUPABASE_ANON_KEY}`,
      'apikey': SUPABASE_ANON_KEY
    },
    body: body ? JSON.stringify(body) : null
  });
  const raw = await res.text();
  let j=null; try{ j = JSON.parse(raw); }catch{}
  if(!res.ok) throw new Error((j && j.error) || raw || 'edge error');
  return j?.state || j || {};
}
function normalize(st){ return {
  phase_end_at: st.phase_end_at ?? null,
  period_sec:   st.period_sec ?? 10,
  paused:       !!st.paused,
  remaining_sec: st.remaining_sec ?? null
};}

async function fetchState(){
  const s = normalize(await callEdge('GET'));
  serverPhaseEndISO = s.phase_end_at;
  paused = s.paused;
  remainingSec = s.remaining_sec;
  lastSyncAt = Date.now();
  setTinyState(); setPhaseKeyLabel();
}

function stop(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; }
async function start(){
  stop();
  const tick = async ()=>{
    if (paused){
      const n = Math.max(0, Math.ceil(Number(remainingSec ?? 0)));
      tinyClock.textContent = String(n);
    } else {
      const rem = Math.max(0, Date.parse(serverPhaseEndISO) - Date.now());
      tinyClock.textContent = String(Math.ceil(rem/1000));
      if (rem <= 0 || Date.now()-lastSyncAt > 5000) {
        try{ await fetchState(); } catch(e){ tinyClock.textContent='ERR'; tinyState.textContent='ERR'; }
      }
    }
    rafId = requestAnimationFrame(tick);
  };
  rafId = requestAnimationFrame(tick);
}

/* ===== Controls ===== */
btnPause.onclick = async ()=>{
  try{
    if (paused) await callEdge('POST',{action:'resume'});
    else        await callEdge('POST',{action:'pause'});
    await fetchState();
  }catch(e){ tinyState.textContent='ERR'; showToast('Pause/resume failed'); }
};
btnForce.onclick = async ()=>{
  try{
    await callEdge('POST',{force:true});
    await fetchState();
    showToast('Forced decision & rolled phase');
  }catch(e){ showToast('Force failed'); }
};

/* ===== Boot ===== */
(async ()=>{
  try{
    await fetchState();
    await start();
  }catch(e){
    tinyClock.textContent='ERR';
    tinyState.textContent='ERR';
  }
})();
</script>
</body>
</html>