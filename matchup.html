<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Matchup (8-up, 2-up view)</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#8b8b8b; --card:#0f1318; --border:#20242a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:32px; line-height:1; padding:8px 14px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .state { color:var(--muted); font-size:12px; }

    .card { margin-top:12px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--card); }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.55); color:var(--accent); border:1px solid var(--accent); border-radius:8px; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid var(--border); }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .btn, .vote, .linkbtn, .backbtn { appearance:none; border:1px solid #24303a; background:#131920; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }

    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card); cursor:pointer; }
    .thumb.disabled { opacity:.55; cursor:default; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }
    .thumb-img { width:100%; aspect-ratio:3/4; background:#0b0f13; display:grid; place-items:center; }
    .thumb-img img { width:100%; height:100%; object-fit:cover; }
    .thumb-label { padding:6px 8px 8px; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
    .thumb-count { font-variant-numeric: tabular-nums; font-weight:700; }
    .ghostBox { width:100%; height:100%; display:grid; place-items:center; color:#3b3b3b; font-weight:700; font-size:13px; letter-spacing:.08em; }

    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:#39ff14; }

    /* FINAL BOX */
    .final-card { margin-top:14px; }
    .final-inner { display:flex; gap:12px; flex-wrap:wrap; padding:12px; }
    .final-slot { flex:1 1 150px; background:#0b0f13; border:1px dashed var(--border); border-radius:10px; padding:8px; text-align:center; }
    .final-slot .label { display:block; margin-bottom:4px; }
    .final-slot .thumb-final { width:100%; aspect-ratio:3/4; background:#000; border-radius:8px; overflow:hidden; display:grid; place-items:center; }
    .final-slot .thumb-final img { width:100%; height:100%; object-fit:cover; }
    .final-footer { padding:0 12px 12px; font-size:12px; color:#9aa0a6; }

    .fullscreen-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:9999; }
    .fullscreen-overlay img { max-width:90%; max-height:90%; border-radius:8px; }
    .fullscreen-overlay button { position:absolute; top:20px; right:20px; background:#111; border:1px solid var(--accent); color:var(--accent); padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
    .debugbox { position:fixed; left:0; right:0; bottom:0; background:rgba(0,0,0,.75); color:#9ca3af; font-size:11px; padding:6px 10px; border-top:1px solid #111; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Rage Space — Matchup (8-up, 2-up view)</h1>

    <div class="header">
      <div class="row">
        <div class="timer" id="tRemain">90.0</div>
        <div class="state" id="tMeta">syncing…</div>
      </div>
      <div class="row">
        <button id="forceQueue" class="btn ghost">Pull Now</button>
        <button id="resetPair" class="btn ghost">Reset Pair</button>
        <a class="backbtn" href="menu.html">← Menu</a>
        <a class="linkbtn" href="winners.html">Winners</a>
      </div>
    </div>

    <!-- ACTIVE MATCH AREA -->
    <div class="card" id="activeTop">
      <div class="imgBox">
        <img id="imgActive1" alt="Active left">
        <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive1">Left</div>
        <div class="counts" id="countActive1">0</div>
        <button class="vote" id="btnActive1">Vote</button>
      </div>
    </div>

    <div class="card" id="activeBottom">
      <div class="imgBox">
        <img id="imgActive2" alt="Active right">
        <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive2">Right</div>
        <div class="counts" id="countActive2">0</div>
        <button class="vote" id="btnActive2">Vote</button>
      </div>
    </div>

    <!-- OTHER MATCHES -->
    <div class="thumbs-wrap">
      <div class="thumbs-title">Other matches</div>
      <div class="thumbs">
        <!-- Quarters -->
        <div class="thumb" id="thumbQ1"><div class="thumb-img"><img id="thumbQ1img" alt="Q1 A vs B"></div><div class="thumb-label"><span>Q1 A–B</span><span class="thumb-count" id="thumbQ1count">0-0</span></div></div>
        <div class="thumb" id="thumbQ2"><div class="thumb-img"><img id="thumbQ2img" alt="Q2 C vs D"></div><div class="thumb-label"><span>Q2 C–D</span><span class="thumb-count" id="thumbQ2count">0-0</span></div></div>
        <div class="thumb" id="thumbQ3"><div class="thumb-img"><img id="thumbQ3img" alt="Q3 E vs F"></div><div class="thumb-label"><span>Q3 E–F</span><span class="thumb-count" id="thumbQ3count">0-0</span></div></div>
        <div class="thumb" id="thumbQ4"><div class="thumb-img"><img id="thumbQ4img" alt="Q4 G vs H"></div><div class="thumb-label"><span>Q4 G–H</span><span class="thumb-count" id="thumbQ4count">0-0</span></div></div>

        <!-- Semis (always present; show ghost until 60s) -->
        <div class="thumb disabled" id="thumbS1">
          <div class="thumb-img"><div class="ghostBox" id="thumbS1ghost">SEM I</div><img id="thumbS1img" alt="S1" style="display:none"></div>
          <div class="thumb-label"><span>Semi 1</span><span class="thumb-count" id="thumbS1count">0-0</span></div>
        </div>
        <div class="thumb disabled" id="thumbS2">
          <div class="thumb-img"><div class="ghostBox" id="thumbS2ghost">SEM II</div><img id="thumbS2img" alt="S2" style="display:none"></div>
          <div class="thumb-label"><span>Semi 2</span><span class="thumb-count" id="thumbS2count">0-0</span></div>
        </div>

        <!-- Final -->
        <div class="thumb" id="thumbFinal"><div class="thumb-img"><img id="thumbFinalImg" alt="Final"></div><div class="thumb-label"><span>Final</span><span class="thumb-count" id="thumbFinalCount">0-0</span></div></div>
      </div>
    </div>

    <div class="winner" id="winnerText">Quarters running… locks at 60s; semis at 30s; final at 0s.</div>

    <!-- FINAL BOX -->
    <div class="card final-card" id="finalCard">
      <div class="bar">
        <div class="label">Final</div>
        <div style="font-size:12px;color:#a1a1a1;">Decides at 0s</div>
      </div>
      <div class="final-inner">
        <div class="final-slot">
          <span class="label" id="finalLeftLabel">Winner of Semi 1</span>
          <div class="thumb-final"><img id="finalImg1" alt="Final slot 1"></div>
        </div>
        <div class="final-slot">
          <span class="label" id="finalRightLabel">Winner of Semi 2</span>
          <div class="thumb-final"><img id="finalImg2" alt="Final slot 2"></div>
        </div>
      </div>
      <div class="final-footer" id="finalFooter">Waiting…</div>
    </div>

    <div class="hint">8 images → 4 quarters (decide at 60s) → 2 semis (decide at 30s) → Final (decide at 0s).</div>
  </div>

  <div class="fullscreen-overlay" id="overlay">
    <button id="closeFull">✕ Close</button>
    <img id="fullImg" src="">
  </div>

  <div class="debugbox" id="debugBox">debug: idle…</div>

  <script>
    // === config ===
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID) { RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now()); localStorage.setItem(RSID_KEY, RSID); }

    const elRemain = document.getElementById("tRemain");
    const elMeta   = document.getElementById("tMeta");
    const dbg      = document.getElementById("debugBox");
    const winnerText = document.getElementById("winnerText");

    const imgActive1 = document.getElementById("imgActive1");
    const imgActive2 = document.getElementById("imgActive2");
    const labelActive1 = document.getElementById("labelActive1");
    const labelActive2 = document.getElementById("labelActive2");
    const countActive1 = document.getElementById("countActive1");
    const countActive2 = document.getElementById("countActive2");
    const btnActive1 = document.getElementById("btnActive1");
    const btnActive2 = document.getElementById("btnActive2");

    const thumbs = {
      q1:   { box:document.getElementById("thumbQ1"),   img:document.getElementById("thumbQ1img"),   count:document.getElementById("thumbQ1count") },
      q2:   { box:document.getElementById("thumbQ2"),   img:document.getElementById("thumbQ2img"),   count:document.getElementById("thumbQ2count") },
      q3:   { box:document.getElementById("thumbQ3"),   img:document.getElementById("thumbQ3img"),   count:document.getElementById("thumbQ3count") },
      q4:   { box:document.getElementById("thumbQ4"),   img:document.getElementById("thumbQ4img"),   count:document.getElementById("thumbQ4count") },
      s1:   { box:document.getElementById("thumbS1"),   img:document.getElementById("thumbS1img"),   ghost:document.getElementById("thumbS1ghost"), count:document.getElementById("thumbS1count") },
      s2:   { box:document.getElementById("thumbS2"),   img:document.getElementById("thumbS2img"),   ghost:document.getElementById("thumbS2ghost"), count:document.getElementById("thumbS2count") },
      final:{ box:document.getElementById("thumbFinal"),img:document.getElementById("thumbFinalImg"),count:document.getElementById("thumbFinalCount") },
    };

    const finalImg1 = document.getElementById("finalImg1");
    const finalImg2 = document.getElementById("finalImg2");
    const finalLeftLabel  = document.getElementById("finalLeftLabel");
    const finalRightLabel = document.getElementById("finalRightLabel");
    const finalFooter = document.getElementById("finalFooter");

    const overlay  = document.getElementById("overlay");
    const fullImg  = document.getElementById("fullImg");
    const btnClose = document.getElementById("closeFull"); btnClose.onclick = () => overlay.style.display = 'none';

    const forceBtn = document.getElementById("forceQueue");
    const resetBtn = document.getElementById("resetPair");

    function openFull(which){
      const url = which==="active1" ? imgActive1.src : which==="active2" ? imgActive2.src : "";
      fullImg.src = url; overlay.style.display = 'flex';
    }

    function placeholder(letter){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960"><rect width="100%" height="100%" fill="#000"/><text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace" text-anchor="middle" dominant-baseline="middle">${letter}</text></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    // ---------- STATE ----------
    let state = {
      base_iso:null, ends_at:null, period_sec:90,
      seed_a_url:null, seed_b_url:null, seed_c_url:null, seed_d_url:null,
      seed_e_url:null, seed_f_url:null, seed_g_url:null, seed_h_url:null,
      seed_a_count:0, seed_b_count:0, seed_c_count:0, seed_d_count:0,
      seed_e_count:0, seed_f_count:0, seed_g_count:0, seed_h_count:0,
      mid1_done:false, mid2_done:false,
      // snapshots (may be present even before 60s)
      q1_a_url:null, q1_b_url:null, q1_a_count:0, q1_b_count:0,
      q2_c_url:null, q2_d_url:null, q2_c_count:0, q2_d_count:0,
      q3_e_url:null, q3_f_url:null, q3_e_count:0, q3_f_count:0,
      q4_g_url:null, q4_h_url:null, q4_g_count:0, q4_h_count:0,
      // semis/final
      semi_1_left_url:null, semi_1_right_url:null, semi_1_left_count:0, semi_1_right_count:0,
      semi_2_left_url:null, semi_2_right_url:null, semi_2_left_count:0, semi_2_right_count:0,
      mid_winner_1_url:null, mid_winner_2_url:null,
    };

    // ---------- VOTE MEMORY ----------
    const VOTE_MEMORY_KEY = "rs_vote_memory_v2";
    function readMem(baseIso){ try { return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")[baseIso]||{}; } catch { return {}; } }
    function writeMem(baseIso,key,val){ const all = (()=>{try{return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}");}catch{return {};}})(); all[baseIso]=Object.assign({},all[baseIso]||{}, {[key]:val}); localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all)); }
    function phaseKeyFor(tag){ return tag; }
    function pruneVoteMem(keep){ const all = (()=>{try{return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}");}catch{return {};}})(); for(const k of Object.keys(all)) if(k!==keep) delete all[k]; localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all)); }

    // which match is shown
    let activeMatch = "q1"; // q1,q2,q3,q4,s1,s2,final

    // click to switch
    thumbs.q1.box.addEventListener('click', ()=>{ activeMatch="q1"; renderActive(); });
    thumbs.q2.box.addEventListener('click', ()=>{ activeMatch="q2"; renderActive(); });
    thumbs.q3.box.addEventListener('click', ()=>{ activeMatch="q3"; renderActive(); });
    thumbs.q4.box.addEventListener('click', ()=>{ activeMatch="q4"; renderActive(); });
    thumbs.s1.box.addEventListener('click', ()=>{ if(state.mid1_done){ activeMatch="s1"; renderActive(); }});
    thumbs.s2.box.addEventListener('click', ()=>{ if(state.mid1_done){ activeMatch="s2"; renderActive(); }});
    thumbs.final.box.addEventListener('click', ()=>{ activeMatch="final"; renderActive(); });

    // vote
    async function vote(side){
      const baseIso = state.base_iso || "";
      const mem = readMem(baseIso);
      const key = phaseKeyFor(activeMatch);
      if (mem[key]) return;

      const up = {};
      if (activeMatch==="q1") up[side==="red"?"seed_a_count":"seed_b_count"] = (side==="red"?state.seed_a_count:state.seed_b_count)+1;
      else if (activeMatch==="q2") up[side==="red"?"seed_c_count":"seed_d_count"] = (side==="red"?state.seed_c_count:state.seed_d_count)+1;
      else if (activeMatch==="q3") up[side==="red"?"seed_e_count":"seed_f_count"] = (side==="red"?state.seed_e_count:state.seed_f_count)+1;
      else if (activeMatch==="q4") up[side==="red"?"seed_g_count":"seed_h_count"] = (side==="red"?state.seed_g_count:state.seed_h_count)+1;
      else if (activeMatch==="s1") up[side==="red"?"seed_a_count":"seed_b_count"] = (side==="red"?state.seed_a_count:state.seed_b_count)+1;
      else if (activeMatch==="s2") up[side==="red"?"seed_c_count":"seed_d_count"] = (side==="red"?state.seed_c_count:state.seed_d_count)+1;
      else if (activeMatch==="final") up[side==="red"?"seed_a_count":"seed_b_count"] = (side==="red"?state.seed_a_count:state.seed_b_count)+1;

      Object.assign(state, up);
      renderActive();

      try {
        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-rsid": RSID },
          body: JSON.stringify({ phase: activeMatch, side: side === "red" ? "left" : "right" })
        });
        if (!res.ok) { await fetchState(true); return; }
        const msg = await res.json().catch(()=> ({}));
        const s = (msg && typeof msg === "object" && "state" in msg) ? msg.state : msg;
        if (s && typeof s === "object") state = Object.assign(state, s);
        else await fetchState(true);
        writeMem(baseIso, key, side);
        renderActive();
      } catch {
        await fetchState(true);
      }
    }
    btnActive1.onclick = ()=> vote("red");
    btnActive2.onclick = ()=> vote("blue");

    // ---------- RENDER ----------
    function setThumb(th, leftUrl, rightUrl, leftCount, rightCount, labelFallback="?"){
      th.img.src = leftUrl || rightUrl || placeholder(labelFallback);
      th.count.textContent = (leftCount??0) + "-" + (rightCount??0);
    }
    function markActive(){
      const keys = ["q1","q2","q3","q4","s1","s2","final"];
      for (const k of keys) thumbs[k].box.classList.toggle("active", k===activeMatch);
    }

    function renderFinalBox(){
      finalImg1.src = state.mid_winner_1_url || placeholder("?");
      finalImg2.src = state.mid_winner_2_url || placeholder("?");
      finalLeftLabel.textContent  = "Winner of Semi 1";
      finalRightLabel.textContent = "Winner of Semi 2";
      if (state.mid2_done) finalFooter.textContent = "Final is live — decides at 0s.";
      else if (state.mid1_done) finalFooter.textContent = "Semis live — final soon.";
      else finalFooter.textContent = "Waiting for quarters…";
    }

    function pick(valA, valB){ return (valA!=null && valA!=="" ? valA : valB); }

    function renderThumbs(){
      // Quarters: prefer pre-hydrated snapshots when present; otherwise fall back to seed lanes.
      const q1L = pick(state.q1_a_url, state.seed_a_url);
      const q1R = pick(state.q1_b_url, state.seed_b_url);
      const q1LC = pick(state.q1_a_count, state.seed_a_count);
      const q1RC = pick(state.q1_b_count, state.seed_b_count);

      const q2L = pick(state.q2_c_url, state.seed_c_url);
      const q2R = pick(state.q2_d_url, state.seed_d_url);
      const q2LC = pick(state.q2_c_count, state.seed_c_count);
      const q2RC = pick(state.q2_d_count, state.seed_d_count);

      const q3L = pick(state.q3_e_url, state.seed_e_url);
      const q3R = pick(state.q3_f_url, state.seed_f_url);
      const q3LC = pick(state.q3_e_count, state.seed_e_count);
      const q3RC = pick(state.q3_f_count, state.seed_f_count);

      const q4L = pick(state.q4_g_url, state.seed_g_url);
      const q4R = pick(state.q4_h_url, state.seed_h_url);
      const q4LC = pick(state.q4_g_count, state.seed_g_count);
      const q4RC = pick(state.q4_h_count, state.seed_h_count);

      setThumb(thumbs.q1, q1L, q1R, q1LC, q1RC, "A");
      setThumb(thumbs.q2, q2L, q2R, q2LC, q2RC, "C");
      setThumb(thumbs.q3, q3L, q3R, q3LC, q3RC, "E");
      setThumb(thumbs.q4, q4L, q4R, q4LC, q4RC, "G");

      // Semis boxes
      if (!state.mid1_done) {
        thumbs.s1.img.style.display = "none";
        thumbs.s1.ghost.style.display = "grid";
        thumbs.s1.box.classList.add("disabled");
        thumbs.s1.count.textContent = "0-0";

        thumbs.s2.img.style.display = "none";
        thumbs.s2.ghost.style.display = "grid";
        thumbs.s2.box.classList.add("disabled");
        thumbs.s2.count.textContent = "0-0";
      } else {
        thumbs.s1.img.src = (state.semi_1_left_url || state.semi_1_right_url || placeholder("S1"));
        thumbs.s1.img.style.display = "block";
        thumbs.s1.ghost.style.display = "none";
        thumbs.s1.box.classList.remove("disabled");
        thumbs.s1.count.textContent = (state.seed_a_count ?? 0) + "-" + (state.seed_b_count ?? 0);

        thumbs.s2.img.src = (state.semi_2_left_url || state.semi_2_right_url || placeholder("S2"));
        thumbs.s2.img.style.display = "block";
        thumbs.s2.ghost.style.display = "none";
        thumbs.s2.box.classList.remove("disabled");
        thumbs.s2.count.textContent = (state.seed_c_count ?? 0) + "-" + (state.seed_d_count ?? 0);
      }

      // Final thumb
      if (!state.mid2_done) {
        thumbs.final.img.src = placeholder("F");
        thumbs.final.count.textContent = "0-0";
      } else {
        thumbs.final.img.src = state.mid_winner_1_url || state.mid_winner_2_url || placeholder("F");
        thumbs.final.count.textContent = (state.seed_a_count ?? 0) + "-" + (state.seed_b_count ?? 0);
      }

      markActive();
    }

    function renderActive(){
      renderThumbs();
      renderFinalBox();

      const mem = readMem(state.base_iso||"");
      const key = phaseKeyFor(activeMatch);

      let leftLabel = "Left", rightLabel = "Right";
      let leftImg = placeholder("?"), rightImg = placeholder("?");
      let leftCt = 0, rightCt = 0;

      if (activeMatch==="q1"){ leftLabel="Seed A"; rightLabel="Seed B";
        leftImg = pick(state.q1_a_url, state.seed_a_url) || placeholder("A");
        rightImg= pick(state.q1_b_url, state.seed_b_url) || placeholder("B");
        leftCt  = pick(state.q1_a_count, state.seed_a_count) ?? 0;
        rightCt = pick(state.q1_b_count, state.seed_b_count) ?? 0;
      }
      else if (activeMatch==="q2"){ leftLabel="Seed C"; rightLabel="Seed D";
        leftImg = pick(state.q2_c_url, state.seed_c_url) || placeholder("C");
        rightImg= pick(state.q2_d_url, state.seed_d_url) || placeholder("D");
        leftCt  = pick(state.q2_c_count, state.seed_c_count) ?? 0;
        rightCt = pick(state.q2_d_count, state.seed_d_count) ?? 0;
      }
      else if (activeMatch==="q3"){ leftLabel="Seed E"; rightLabel="Seed F";
        leftImg = pick(state.q3_e_url, state.seed_e_url) || placeholder("E");
        rightImg= pick(state.q3_f_url, state.seed_f_url) || placeholder("F");
        leftCt  = pick(state.q3_e_count, state.seed_e_count) ?? 0;
        rightCt = pick(state.q3_f_count, state.seed_f_count) ?? 0;
      }
      else if (activeMatch==="q4"){ leftLabel="Seed G"; rightLabel="Seed H";
        leftImg = pick(state.q4_g_url, state.seed_g_url) || placeholder("G");
        rightImg= pick(state.q4_h_url, state.seed_h_url) || placeholder("H");
        leftCt  = pick(state.q4_g_count, state.seed_g_count) ?? 0;
        rightCt = pick(state.q4_h_count, state.seed_h_count) ?? 0;
      }
      else if (activeMatch==="s1"){ leftLabel="Semi 1 — Left"; rightLabel="Semi 1 — Right";
        if (!state.mid1_done) { leftImg=rightImg=placeholder("?"); leftCt=rightCt=0; }
        else { leftImg = state.semi_1_left_url  || placeholder("?"); rightImg= state.semi_1_right_url || placeholder("?"); leftCt = state.seed_a_count ?? 0; rightCt = state.seed_b_count ?? 0; }
      }
      else if (activeMatch==="s2"){ leftLabel="Semi 2 — Left"; rightLabel="Semi 2 — Right";
        if (!state.mid1_done) { leftImg=rightImg=placeholder("?"); leftCt=rightCt=0; }
        else { leftImg = state.semi_2_left_url  || placeholder("?"); rightImg= state.semi_2_right_url || placeholder("?"); leftCt = state.seed_c_count ?? 0; rightCt = state.seed_d_count ?? 0; }
      }
      else { // final
        leftLabel="Final — Left"; rightLabel="Final — Right";
        if (!state.mid2_done) { leftImg=rightImg=placeholder("?"); leftCt=rightCt=0; }
        else { leftImg = state.mid_winner_1_url || placeholder("?"); rightImg= state.mid_winner_2_url || placeholder("?"); leftCt = state.seed_a_count ?? 0; rightCt = state.seed_b_count ?? 0; }
      }

      imgActive1.src = leftImg; imgActive2.src = rightImg;
      labelActive1.textContent = leftLabel; labelActive2.textContent = rightLabel;
      countActive1.textContent = leftCt; countActive2.textContent = rightCt;

      const picked = mem[key];
      let phaseLive = true;
      if (["s1","s2"].includes(activeMatch) && !state.mid1_done) phaseLive = false;
      if (activeMatch==="final" && !state.mid2_done) phaseLive = false;
      btnActive1.disabled = !!picked || !phaseLive;
      btnActive2.disabled = !!picked || !phaseLive;
      if (picked==="red")   labelActive1.textContent += " • you voted";
      if (picked==="blue")  labelActive2.textContent += " • you voted";
    }

    // ---------- NET ----------
    async function fetchState(force=false){
      try {
        const res = await fetch(FUNCTION_URL + (force ? "" : ""));
        const data = await res.json();
        const s = (data && typeof data === "object" && "state" in data) ? data.state : data;
        state = Object.assign(state, s || {});
        elMeta.textContent = `period=${state.period_sec||90}s • base=${state.base_iso||"--"}`;
        renderActive();
        dbg.textContent = "debug: ok " + new Date().toLocaleTimeString();
      } catch(e) {
        console.error(e);
        dbg.textContent = "debug: GET error → " + (e.message || JSON.stringify(e));
        renderActive();
      }
    }

    // ---------- TICK ----------
    let semiPhase1Synced=false, semiPhase2Synced=false, finalSynced=false, lastPhasePoll=0;
    let lastMid1=false, lastMid2=false;

    function tick(){
      if (!state?.ends_at) return requestAnimationFrame(tick);
      const ms = Math.max(0, new Date(state.ends_at).getTime() - Date.now());
      elRemain.textContent = (ms/1000).toFixed(1);

      const LOCK_Q_MS = 60_000, LOCK_S_MS = 30_000;

      if (state.mid1_done && !lastMid1) { activeMatch = "s1"; }
      if (state.mid2_done && !lastMid2) { activeMatch = "final"; }
      lastMid1 = state.mid1_done;
      lastMid2 = state.mid2_done;

      if (ms <= LOCK_Q_MS + 250 && !state.mid1_done) winnerText.textContent = 'Quarters just locked — semis live.';
      if (ms <= LOCK_S_MS + 250 && state.mid1_done && !state.mid2_done) winnerText.textContent = 'Semis just locked — final live.';

      const now = Date.now();
      if (ms <= LOCK_Q_MS && !state.mid1_done && (!semiPhase1Synced || now-lastPhasePoll>1500)) {
        semiPhase1Synced=true; lastPhasePoll=now; fetchState(true);
      }
      if (ms <= LOCK_S_MS && state.mid1_done && !state.mid2_done && (!semiPhase2Synced || now-lastPhasePoll>1500)) {
        semiPhase2Synced=true; lastPhasePoll=now; fetchState(true);
      }
      if (ms <= 0 && state.mid2_done && !finalSynced) {
        finalSynced=true; fetchState(true);
      }

      requestAnimationFrame(tick);
    }

    // controls
    forceBtn.addEventListener('click', ()=> fetchState(true));
    resetBtn.addEventListener('click', ()=> fetchState(true));

    // realtime hooks
    supabase.channel('cycles-v2-live')
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'cycles_v2' }, async ()=>{ await fetchState(true); })
      .subscribe();

    supabase.channel('matchup-sync')
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'art_queue', filter:'status=in.(locked,used)' }, async ()=>{ await fetchState(true); })
      .subscribe();

    // boot — hydrate quickly in case the function fills fields just after start
    fetchState(true).then(()=>{
      setTimeout(()=>fetchState(true), 600);
      setTimeout(()=>fetchState(true), 1500);
      tick();
    });
  </script>
</body>
</html>