<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî Matchup</title>
  <link rel="stylesheet" href="style.css?v=2" />
  <style>
    :root{
      --green:#39ff14; --red:#ff0033; --bg:#000; --ink:#e5ffe5;
      --card:#070707; --muted:#8aff8a; --border:#0f2510; --maxw: 960px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:#000; color:var(--green);
      font-family: ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .wrap{ max-width:var(--maxw); margin:16px auto 64px; padding:0 16px; }
    h1{ letter-spacing:.06em }
    .scorebar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      border:1px solid var(--border); padding:8px 12px; border-radius:10px; background:rgba(7,7,7,.6);
      box-shadow: 0 0 18px rgba(57,255,20,.08) inset;
    }
    .btn{ border:1px solid var(--green); color:var(--green); text-decoration:none; padding:8px 12px; border-radius:10px; display:inline-flex; align-items:center; gap:8px; background:transparent; cursor:pointer; }
    .btn.primary{ background:rgba(57,255,20,.08) }
    .btn:disabled{ opacity:.45; cursor:not-allowed }
    .grid{ margin-top:18px; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .tile{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(7,7,7,.6); }
    .art{
      aspect-ratio: 4/5;
      background: linear-gradient(45deg, rgba(57,255,20,.08), transparent 60%), #050505;
      display:block; width:100%; object-fit:cover;
    }
    .meta{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-top:1px solid var(--border);
    }
    .badge{ font-size:.9rem; color:var(--ink); opacity:.75; }
    .countdown{ margin-top:12px; text-align:center; font-variant-numeric:tabular-nums; }
    .vote-row{ margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:center; }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:24px; background:#0a0a0a; color:var(--ink);
      border:1px solid var(--border); border-radius:12px; padding:10px 14px; display:none;
      box-shadow: 0 0 18px rgba(57,255,20,.2);
      z-index:9999;
    }
    @media (max-width:760px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header class="wrap" style="padding-top:0">
    <h1>R<span class="anarchy">‚í∂</span>GE SPACE ‚Äî MATCHUP</h1>
  </header>

  <div class="wrap">
    <div class="scorebar">
      <div class="score">Your points: <span id="pts">0</span></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <span class="badge">Battle <span id="battleIndex">1</span>/<span id="battleTotal">1</span></span>
        <a class="btn" href="tournament-brackets.html">üèÅ Brackets</a>
        <a class="btn" href="menu.html">‚Üê Menu</a>
      </div>
    </div>

    <div class="countdown">
      Decision in: <span id="clock">00:00:00</span>
    </div>

    <div class="grid" id="grid">
      <!-- Left -->
      <div class="tile">
        <img id="leftArt" class="art" alt="Left entry" />
        <div class="meta">
          <span id="leftLabel">Entry ‚Äî LEFT</span>
          <button class="btn primary" id="voteLeft">Vote Left</button>
        </div>
      </div>

      <!-- Right -->
      <div class="tile">
        <img id="rightArt" class="art" alt="Right entry" />
        <div class="meta">
          <span id="rightLabel">Entry ‚Äî RIGHT</span>
          <button class="btn primary" id="voteRight">Vote Right</button>
        </div>
      </div>
    </div>

    <div class="vote-row">
      <button class="btn" id="submitBtn" disabled>‚úÖ Submit Vote</button>
      <button class="btn" id="skipBtn" title="Go to next battle">‚è≠ Next Battle</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    /************** CONFIG (your values) **************/
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const TOURNAMENT_ID = "682da23f-6e32-4782-8b8a-8e59527d6b58";
    const MAX_MATCHES = 8;

    /************** Supabase **************/
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /************** State & DOM **************/
    const ptsEl = document.getElementById('pts');
    const toast = document.getElementById('toast');
    const clock = document.getElementById('clock');
    const battleIndexEl = document.getElementById('battleIndex');
    const battleTotalEl = document.getElementById('battleTotal');

    const leftArt = document.getElementById('leftArt');
    const rightArt = document.getElementById('rightArt');
    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');

    const voteLeftBtn = document.getElementById('voteLeft');
    const voteRightBtn = document.getElementById('voteRight');
    const submitBtn = document.getElementById('submitBtn');
    const skipBtn = document.getElementById('skipBtn');

    let pts = parseInt(localStorage.getItem('rs_points') || '0', 10);
    ptsEl.textContent = pts;

    // per-device session id to enforce one vote / match
    const SESSION_KEY = 'rs_session_id';
    let sessionId = localStorage.getItem(SESSION_KEY);
    if (!sessionId){ sessionId = crypto.randomUUID(); localStorage.setItem(SESSION_KEY, sessionId); }

    // Deep link support (?battle=<match_id>)
    const urlParams = new URLSearchParams(location.search);
    const jumpTo = urlParams.get('battle');

    // data
    let BATTLES = [];
    let idx = 0;
    let chosen = null;
    let tickHandle = null;

    function lockVoteKey(battleId){ return `rs_vote_${battleId}`; }

    /************** Helpers **************/
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display='none', 1400);
    }
    function fmtClock(ms){
      if (ms <= 0) return '00:00:00';
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    function safeSrc(el, url){
      if (!url){ el.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; return false; }
      el.src = url; return true;
    }

    /************** Load battles from Supabase **************/
    async function loadBattles(){
      const { data, error } = await supabase
        .from('match_public')
        .select('*')
        .eq('tournament_id', TOURNAMENT_ID)
        .in('state', ['open','scheduled'])          // show open and upcoming
        .order('round_number', { ascending: true })
        .order('index_in_round', { ascending: true })
        .limit(MAX_MATCHES);

      if (error){ console.error(error); showToast('Failed to load matches.'); return; }

      BATTLES = (data || []).map(r => ({
        id: r.id,
        round: r.round_number,
        indexInRound: r.index_in_round,
        state: r.state,                               // 'open' | 'scheduled'
        start: r.start_time,
        end: r.end_time,
        left:  { id:r.a_id, label:r.a_name, img:r.a_image },
        right: { id:r.b_id, label:r.b_name, img:r.b_image },
      }));

      // Jump to specific battle if provided
      if (jumpTo){
        const found = BATTLES.findIndex(b => b.id === jumpTo);
        if (found >= 0) idx = found;
      }

      battleTotalEl.textContent = BATTLES.length || 0;

      if (!BATTLES.length){
        leftLabel.textContent = 'No matches available';
        rightLabel.textContent = 'Check back soon';
        voteLeftBtn.disabled = true; voteRightBtn.disabled = true; submitBtn.disabled = true;
        return;
      }
      render();
    }

    /************** Render a battle **************/
    function render(){
      const b = BATTLES[idx];
      battleIndexEl.textContent = (idx+1).toString();

      // art + labels (TBD supported)
      const hasL = safeSrc(leftArt,  b.left?.img);
      const hasR = safeSrc(rightArt, b.right?.img);
      leftLabel.textContent  = hasL ? b.left.label  : 'TBD';
      rightLabel.textContent = hasR ? b.right.label : 'TBD';

      // voting window + lock
      const now    = Date.now();
      const starts = new Date(b.start).getTime();
      const ends   = new Date(b.end).getTime();
      const inWindow = now >= starts && now < ends;
      const votable  = b.state === 'open' && inWindow && hasL && hasR;

      const locked = !!localStorage.getItem(lockVoteKey(b.id));
      chosen = null;
      submitBtn.disabled = true;
      voteLeftBtn.disabled  = !votable || locked;
      voteRightBtn.disabled = !votable || locked;

      if (locked) showToast('You already voted in this battle.');

      // countdown
      updateClock();
      clearInterval(tickHandle);
      tickHandle = setInterval(updateClock, 1000);
    }

    function updateClock(){
      const b = BATTLES[idx];
      const ms = new Date(b.end).getTime() - Date.now();
      clock.textContent = fmtClock(ms);
      if (ms <= 0){
        submitBtn.disabled = true;
        voteLeftBtn.disabled = true;
        voteRightBtn.disabled = true;
      }
    }

    /************** Voting **************/
    voteLeftBtn.addEventListener('click', ()=>{
      if (voteLeftBtn.disabled) return;
      chosen = 'A'; // left = slot A
      submitBtn.disabled = false;
      showToast('Selected LEFT');
    });
    voteRightBtn.addEventListener('click', ()=>{
      if (voteRightBtn.disabled) return;
      chosen = 'B'; // right = slot B
      submitBtn.disabled = false;
      showToast('Selected RIGHT');
    });

    submitBtn.addEventListener('click', async ()=>{
      const b = BATTLES[idx];
      if (!chosen) return;

      submitBtn.disabled = true;

      // Insert vote (RLS enforces 'open' window + one per session)
      const { error } = await supabase.from('votes').insert({
        match_id: b.id,
        slot: chosen,                 // 'A' | 'B'
        session_id: sessionId
      });

      if (error){
        console.error(error);
        showToast('Vote failed.');
        submitBtn.disabled = false;
        return;
      }

      // lock locally
      localStorage.setItem(lockVoteKey(b.id), chosen);

      // points (client-side gamification)
      pts += 10; ptsEl.textContent = pts;
      localStorage.setItem('rs_points', String(pts));

      showToast(`Vote submitted: ${chosen==='A'?'LEFT':'RIGHT'} (+10 pts)`);
      setTimeout(nextBattle, 600);
    });

    skipBtn.addEventListener('click', nextBattle);
    function nextBattle(){
      if (!BATTLES.length) return;
      idx = (idx + 1) % BATTLES.length;
      render();
    }

    // boot
    loadBattles();
  </script>
</body>
</html>