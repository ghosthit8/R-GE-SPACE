<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space — Matchup (32-up → 2-up)</title>
  <style>
    /* all your existing matchup CSS stays exactly the same */
  </style>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0f13; --accent:#39ff14; --muted:#8b8b8b; --card:#0f1318; --border:#20242a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:32px; line-height:1; padding:8px 14px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .state { color:var(--muted); font-size:12px; }

    .card { margin-top:12px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--card); }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.55); color:var(--accent); border:1px solid var(--accent); border-radius:8px; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid var(--border); }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    .btn, .vote, .linkbtn, .backbtn { appearance:none; border:1px solid #24303a; background:#131920; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; }
    .btn.ghost { color:#a0aec0; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }

    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card); cursor:pointer; }
    .thumb.disabled { opacity:.55; cursor:default; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }

    /* THUMB IMAGE: DIAGONAL SPLIT (BOTH COMPETITORS) */
    .thumb-img {
      position:relative;
      width:100%;
      aspect-ratio:3/4;
      background:#0b0f13;
      overflow:hidden;
    }
    .thumb-img img {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-img.diag img.half {
      position:absolute;
      inset:0;
    }
    .thumb-img.diag img.left {
      clip-path:polygon(0 0, 100% 0, 0 100%);
    }
    .thumb-img.diag img.right {
      clip-path:polygon(100% 0, 100% 100%, 0 100%);
    }
    /* subtle dividing line */
    .thumb-img.diag::before {
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:linear-gradient(135deg, rgba(0,0,0,0.75) 48%, rgba(57,255,20,0.7) 50%, rgba(0,0,0,0.75) 52%);
      mix-blend-mode:screen;
      opacity:0.5;
    }

    .thumb-label { padding:6px 8px 8px; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
    .thumb-count { font-variant-numeric: tabular-nums; font-weight:700; }
    .ghostBox { width:100%; height:100%; display:grid; place-items:center; color:#3b3b3b; font-weight:700; font-size:13px; letter-spacing:.08em; }

    .winner { margin-top:14px; padding:10px 12px; border:1px dashed #2a343f; border-radius:12px; color:#cbd5e1; font-size:14px; }
    .winner b { color:#39ff14; }

    .final-card { margin-top:14px; }
    .final-inner { display:flex; gap:12px; flex-wrap:wrap; padding:12px; }
    .final-slot { flex:1 1 150px; background:#0b0f13; border:1px dashed var(--border); border-radius:10px; padding:8px; text-align:center; }
    .final-slot .label { display:block; margin-bottom:4px; }
    .final-slot .thumb-final { width:100%; aspect-ratio:3/4; background:#000; border-radius:8px; overflow:hidden; display:grid; place-items:center; }
    .final-slot .thumb-final img { width:100%; height:100%; object-fit:cover; }
    .final-footer { padding:0 12px 12px; font-size:12px; color:#9aa0a6; }

    .fullscreen-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:9999; }
    .fullscreen-overlay img { max-width:90%; max-height:90%; border-radius:8px; }
    .fullscreen-overlay button { position:absolute; top:20px; right:20px; background:#111; border:1px solid var(--accent); color:var(--accent); padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }

    .hidden { display: none !important; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Rage Space — Matchup (32-up → 2-up)</h1>

    <div class="header">
      <div class="row">
        <div class="timer" id="tRemain">150.0</div>
      </div>
      <div class="row">
        <a class="backbtn" href="menu.html">← Menu</a>
        <a class="linkbtn" href="winners.html">Winners</a>
      </div>
    </div>

    <!-- ACTIVE MATCH -->
    <div class="card" id="activeTop">
      <div class="imgBox">
        <img id="imgActive1" alt="Active left">
        <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive1">Left</div>
        <div class="counts" id="countActive1">0</div>
        <button class="vote" id="btnActive1">Vote</button>
      </div>
    </div>

    <div class="card" id="activeBottom">
      <div class="imgBox">
        <img id="imgActive2" alt="Active right">
        <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive2">Right</div>
        <div class="counts" id="countActive2">0</div>
        <button class="vote" id="btnActive2">Vote</button>
      </div>
    </div>

    <!-- THUMBS -->
    <div class="thumbs-wrap">
      <div class="thumbs-title">Matches (tap to switch)</div>
      <div class="thumbs" id="thumbGrid"></div>
    </div>

    <div class="winner" id="winnerText">R32 locks at 120s → R16 at 90s → Quarters at 60s → Semis at 30s → Final at 0s.</div>

    <!-- FINAL BOX -->
    <div class="card final-card" id="finalCard">
      <div class="bar">
        <div class="label">Final</div>
        <div style="font-size:12px;color:#a1a1a1;">Decides at 0s</div>
      </div>
      <div class="final-inner">
        <div class="final-slot">
          <span class="label" id="finalLeftLabel">Winner of Semi 1</span>
          <div class="thumb-final"><img id="finalImg1" alt="Final slot 1"></div>
        </div>
        <div class="final-slot">
          <span class="label" id="finalRightLabel">Winner of Semi 2</span>
          <div class="thumb-final"><img id="finalImg2" alt="Final slot 2"></div>
        </div>
      </div>
      <div class="final-footer" id="finalFooter">Waiting…</div>
    </div>

    <div class="hint">32 images → 16 R32 matches (120s) → 8 R16 (90s) → 4 QF (60s) → 2 SF (30s) → Final (0s).</div>
  </div>

  <div class="fullscreen-overlay" id="overlay">
    <button id="closeFull">✕ Close</button>
    <img id="fullImg" src="">
  </div>

  <!-- NEW: champion overlay JS (injects cyberpunk overlay + confetti) -->
  <script src="js/champion-overlay.js"></script>

  <script>
    // === config ===
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID){ RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now()); localStorage.setItem(RSID_KEY, RSID); }

    const elRemain = document.getElementById("tRemain");
    const winnerText = document.getElementById("winnerText");

    const imgActive1 = document.getElementById("imgActive1");
    const imgActive2 = document.getElementById("imgActive2");
    const labelActive1 = document.getElementById("labelActive1");
    const labelActive2 = document.getElementById("labelActive2");
    const countActive1 = document.getElementById("countActive1");
    const countActive2 = document.getElementById("countActive2");
    const btnActive1 = document.getElementById("btnActive1");
    const btnActive2 = document.getElementById("btnActive2");

    const finalImg1 = document.getElementById("finalImg1");
    const finalImg2 = document.getElementById("finalImg2");
    const finalLeftLabel  = document.getElementById("finalLeftLabel");
    const finalRightLabel = document.getElementById("finalRightLabel");
    const finalFooter = document.getElementById("finalFooter");

    const overlay  = document.getElementById("overlay");
    const fullImg  = document.getElementById("fullImg");
    const btnClose = document.getElementById("closeFull"); btnClose.onclick = ()=> overlay.style.display='none';

    const grid = document.getElementById("thumbGrid");

    function openFull(which){
      const url = which==="active1" ? imgActive1.src : which==="active2" ? imgActive2.src : "";
      fullImg.src = url; overlay.style.display = 'flex';
    }
    function placeholder(letter){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960"><rect width="100%" height="100%" fill="#000"/><text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace" text-anchor="middle" dominant-baseline="middle">${letter}</text></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }
    function pick(a,b){ return (a!=null && a!=="") ? a : b; }

    // ---------- MATCH INDEX ----------
    // New R32 (rr1..rr16) — we map rrN → POST phase rN to match server
    const order = [
      {key:"rr1",  label:"R32 1",  left:"seed_a_url",  right:"seed_b_url",  lct:"seed_a_count",  rct:"seed_b_count"},
      {key:"rr2",  label:"R32 2",  left:"seed_c_url",  right:"seed_d_url",  lct:"seed_c_count",  rct:"seed_d_count"},
      {key:"rr3",  label:"R32 3",  left:"seed_e_url",  right:"seed_f_url",  lct:"seed_e_count",  rct:"seed_f_count"},
      {key:"rr4",  label:"R32 4",  left:"seed_g_url",  right:"seed_h_url",  lct:"seed_g_count",  rct:"seed_h_count"},
      {key:"rr5",  label:"R32 5",  left:"seed_i_url",  right:"seed_j_url",  lct:"seed_i_count",  rct:"seed_j_count"},
      {key:"rr6",  label:"R32 6",  left:"seed_k_url",  right:"seed_l_url",  lct:"seed_k_count",  rct:"seed_l_count"},
      {key:"rr7",  label:"R32 7",  left:"seed_m_url",  right:"seed_n_url",  lct:"seed_m_count",  rct:"seed_n_count"},
      {key:"rr8",  label:"R32 8",  left:"seed_o_url",  right:"seed_p_url",  lct:"seed_o_count",  rct:"seed_p_count"},
      {key:"rr9",  label:"R32 9",  left:"seed_q_url",  right:"seed_r_url",  lct:"seed_q_count",  rct:"seed_r_count"},
      {key:"rr10", label:"R32 10", left:"seed_s_url",  right:"seed_t_url",  lct:"seed_s_count",  rct:"seed_t_count"},
      {key:"rr11", label:"R32 11", left:"seed_u_url",  right:"seed_v_url",  lct:"seed_u_count",  rct:"seed_v_count"},
      {key:"rr12", label:"R32 12", left:"seed_w_url",  right:"seed_x_url",  lct:"seed_w_count",  rct:"seed_x_count"},
      {key:"rr13", label:"R32 13", left:"seed_y_url",  right:"seed_z_url",  lct:"seed_y_count",  rct:"seed_z_count"},
      {key:"rr14", label:"R32 14", left:"seed_aa_url", right:"seed_ab_url", lct:"seed_aa_count", rct:"seed_ab_count"},
      {key:"rr15", label:"R32 15", left:"seed_ac_url", right:"seed_ad_url", lct:"seed_ac_count", rct:"seed_ad_count"},
      {key:"rr16", label:"R32 16", left:"seed_ae_url", right:"seed_af_url", lct:"seed_ae_count", rct:"seed_af_count"},

      // Existing R16 (unchanged keys r1..r8)
      {key:"r1", label:"R16 A–B", left:"seed_a_url", right:"seed_b_url", lct:"seed_a_count", rct:"seed_b_count"},
      {key:"r2", label:"R16 C–D", left:"seed_c_url", right:"seed_d_url", lct:"seed_c_count", rct:"seed_d_count"},
      {key:"r3", label:"R16 E–F", left:"seed_e_url", right:"seed_f_url", lct:"seed_e_count", rct:"seed_f_count"},
      {key:"r4", label:"R16 G–H", left:"seed_g_url", right:"seed_h_url", lct:"seed_g_count", rct:"seed_h_count"},
      {key:"r5", label:"R16 I–J", left:"seed_i_url", right:"seed_j_url", lct:"seed_i_count", rct:"seed_j_count"},
      {key:"r6", label:"R16 K–L", left:"seed_k_url", right:"seed_l_url", lct:"seed_k_count", rct:"seed_l_count"},
      {key:"r7", label:"R16 M–N", left:"seed_m_url", right:"seed_n_url", lct:"seed_m_count", rct:"seed_n_count"},
      {key:"r8", label:"R16 O–P", left:"seed_o_url", right:"seed_p_url", lct:"seed_o_count", rct:"seed_p_count"},

      // Quarters, Semis, Final
      {key:"q1", label:"QF A–B", left:"q1_a_url", right:"q1_b_url", lct:"q1_a_count", rct:"q1_b_count", fbLeft:"seed_a_url", fbRight:"seed_b_url", fbLct:"seed_a_count", fbRct:"seed_b_count"},
      {key:"q2", label:"QF C–D", left:"q2_c_url", right:"q2_d_url", lct:"q2_c_count", rct:"q2_d_count", fbLeft:"seed_c_url", fbRight:"seed_d_url", fbLct:"seed_c_count", fbRct:"seed_d_count"},
      {key:"q3", label:"QF E–F", left:"q3_e_url", right:"q3_f_url", lct:"q3_e_count", rct:"q3_f_count", fbLeft:"seed_e_url", fbRight:"seed_f_url", fbLct:"seed_e_count", fbRct:"seed_f_count"},
      {key:"q4", label:"QF G–H", left:"q4_g_url", right:"q4_h_url", lct:"q4_g_count", rct:"q4_h_count", fbLeft:"seed_g_url", fbRight:"seed_h_url", fbLct:"seed_g_count", fbRct:"seed_h_count"},
      {key:"s1", label:"Semi 1", semi:true},
      {key:"s2", label:"Semi 2", semi:true},
      {key:"final", label:"Final"}
    ];

    // Build grid
    const thumbs = {};
    function makeThumb(item){
      const div = document.createElement("div");
      div.className = "thumb"; div.id = "thumb_"+item.key;
      div.innerHTML = `
        <div class="thumb-img diag">
          <img class="half left" id="imgL_${item.key}" alt="${item.label} left">
          <img class="half right" id="imgR_${item.key}" alt="${item.label} right">
        </div>
        <div class="thumb-label"><span>${item.label}</span><span class="thumb-count" id="cnt_${item.key}">0-0</span></div>
      `;
      div.addEventListener("click", ()=>{
        // R32 rows (rr*) are clickable only before r32_done
        if (item.key.startsWith("rr") && state.r32_done) return;
        if (item.key.startsWith("r") && !item.key.startsWith("rr") && !state.r32_done) return; // R16 locked until r32 done
        if (item.key.startsWith("q") && !state.r16_done) return;
        if (item.key.startsWith("s") && !state.mid1_done) return;
        if (item.key==="final" && !state.mid2_done) return;
        activeMatch = item.key; renderActive();
      });
      grid.appendChild(div);
      thumbs[item.key] = {
        box:div,
        imgL: div.querySelector("#imgL_"+item.key),
        imgR: div.querySelector("#imgR_"+item.key),
        count: div.querySelector("#cnt_"+item.key)
      };
    }
    order.forEach(makeThumb);

    // ---------- STATE ----------
    let state = {
      base_iso:null, ends_at:null, period_sec:150,

      // 32 seeds (urls + counts)
      seed_a_url:null, seed_b_url:null, seed_c_url:null, seed_d_url:null,
      seed_e_url:null, seed_f_url:null, seed_g_url:null, seed_h_url:null,
      seed_i_url:null, seed_j_url:null, seed_k_url:null, seed_l_url:null,
      seed_m_url:null, seed_n_url:null, seed_o_url:null, seed_p_url:null,
      seed_q_url:null, seed_r_url:null, seed_s_url:null, seed_t_url:null,
      seed_u_url:null, seed_v_url:null, seed_w_url:null, seed_x_url:null,
      seed_y_url:null, seed_z_url:null, seed_aa_url:null, seed_ab_url:null,
      seed_ac_url:null, seed_ad_url:null, seed_ae_url:null, seed_af_url:null,

      seed_a_count:0, seed_b_count:0, seed_c_count:0, seed_d_count:0,
      seed_e_count:0, seed_f_count:0, seed_g_count:0, seed_h_count:0,
      seed_i_count:0, seed_j_count:0, seed_k_count:0, seed_l_count:0,
      seed_m_count:0, seed_n_count:0, seed_o_count:0, seed_p_count:0,
      seed_q_count:0, seed_r_count:0, seed_s_count:0, seed_t_count:0,
      seed_u_count:0, seed_v_count:0, seed_w_count:0, seed_x_count:0,
      seed_y_count:0, seed_z_count:0, seed_aa_count:0, seed_ab_count:0,
      seed_ac_count:0, seed_ad_count:0, seed_ae_count:0, seed_af_count:0,

      r32_done:false, r16_done:false, mid1_done:false, mid2_done:false,

      q1_a_url:null, q1_b_url:null, q1_a_count:0, q1_b_count:0,
      q2_c_url:null, q2_d_url:null, q2_c_count:0, q2_d_count:0,
      q3_e_url:null, q3_f_url:null, q3_e_count:0, q3_f_count:0,
      q4_g_url:null, q4_h_url:null, q4_g_count:0, q4_h_count:0,

      semi_1_left_url:null, semi_1_right_url:null, semi_1_left_count:0, semi_1_right_count:0,
      semi_2_left_url:null, semi_2_right_url:null, semi_2_left_count:0, semi_2_right_count:0,

      mid_winner_1_url:null, mid_winner_2_url:null,
    };

    // vote memory
    const VOTE_MEMORY_KEY="rs_vote_memory_v3";
    function memRead(base){ try{ return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")[base]||{} }catch{return{}} }
    function memWrite(base,key,val){ const all=(()=>{try{return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")}catch{return{}}})(); all[base]=Object.assign({},all[base]||{}, {[key]:val}); localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all)); }
    function pruneMem(keep){ const all=(()=>{try{return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}")}catch{return{}}})(); for(const k of Object.keys(all)) if(k!==keep) delete all[k]; localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all)); }

    // start on R32 #1
    let activeMatch = "rr1";

    async function vote(color){
      const base = state.base_iso||"";
      const mem = memRead(base);
      const key = activeMatch;
      if (mem[key]) return;

      const red = color==="red";
      const inc = (k)=> state[k] = (state[k]||0)+1;

      // Map UI key → server phase:
      // rr1..rr16 → r1..r16 (R32); others pass through
      const serverPhase = activeMatch.startsWith("rr")
        ? ("r"+activeMatch.slice(2))
        : activeMatch;

      const post = { phase: serverPhase, side: red ? "left":"right" };

      // Local optimistic counters
      const map = {
        // R32
        rr1:["seed_a_count","seed_b_count"],   rr2:["seed_c_count","seed_d_count"],
        rr3:["seed_e_count","seed_f_count"],   rr4:["seed_g_count","seed_h_count"],
        rr5:["seed_i_count","seed_j_count"],   rr6:["seed_k_count","seed_l_count"],
        rr7:["seed_m_count","seed_n_count"],   rr8:["seed_o_count","seed_p_count"],
        rr9:["seed_q_count","seed_r_count"],   rr10:["seed_s_count","seed_t_count"],
        rr11:["seed_u_count","seed_v_count"],  rr12:["seed_w_count","seed_x_count"],
        rr13:["seed_y_count","seed_z_count"],  rr14:["seed_aa_count","seed_ab_count"],
        rr15:["seed_ac_count","seed_ad_count"],rr16:["seed_ae_count","seed_af_count"],

        // R16 → unchanged
        r1:["seed_a_count","seed_b_count"], r2:["seed_c_count","seed_d_count"],
        r3:["seed_e_count","seed_f_count"], r4:["seed_g_count","seed_h_count"],
        r5:["seed_i_count","seed_j_count"], r6:["seed_k_count","seed_l_count"],
        r7:["seed_m_count","seed_n_count"], r8:["seed_o_count","seed_p_count"],

        q1:["seed_a_count","seed_b_count"], q2:["seed_c_count","seed_d_count"],
        q3:["seed_e_count","seed_f_count"], q4:["seed_g_count","seed_h_count"],
        s1:["seed_a_count","seed_b_count"], s2:["seed_c_count","seed_d_count"],
        final:["seed_a_count","seed_b_count"]
      };
      const arr = map[activeMatch];
      if (arr){ inc(red?arr[0]:arr[1]); renderActive(); }

      try{
        const res = await fetch(FUNCTION_URL, { method:"POST", headers:{"Content-Type":"application/json","x-rsid":RSID}, body: JSON.stringify(post) });
        if (!res.ok){ await fetchState(true); return; }
        const s = await res.json().catch(()=> ({}));
        Object.assign(state, s||{});
        memWrite(base,key,color);
        renderActive();
      }catch{ await fetchState(true); }
    }
    btnActive1.onclick = ()=> vote("red");
    btnActive2.onclick = ()=> vote("blue");

    function setThumb(key,leftUrl,rightUrl,leftCt,rightCt,fallback){
      const th = thumbs[key]; if (!th) return;
      th.imgL.src = leftUrl || placeholder(fallback||"?");
      th.imgR.src = rightUrl || placeholder(fallback||"?");
      th.count.textContent = (leftCt??0) + "-" + (rightCt??0);
    }
    function markActive(){
      for (const k in thumbs) thumbs[k].box.classList.toggle("active", k===activeMatch);
    }

    function renderThumbs(){
      // R32
      setThumb("rr1",  state.seed_a_url,  state.seed_b_url,  state.seed_a_count,  state.seed_b_count, "A");
      setThumb("rr2",  state.seed_c_url,  state.seed_d_url,  state.seed_c_count,  state.seed_d_count, "C");
      setThumb("rr3",  state.seed_e_url,  state.seed_f_url,  state.seed_e_count,  state.seed_f_count, "E");
      setThumb("rr4",  state.seed_g_url,  state.seed_h_url,  state.seed_g_count,  state.seed_h_count, "G");
      setThumb("rr5",  state.seed_i_url,  state.seed_j_url,  state.seed_i_count,  state.seed_j_count, "I");
      setThumb("rr6",  state.seed_k_url,  state.seed_l_url,  state.seed_k_count,  state.seed_l_count, "K");
      setThumb("rr7",  state.seed_m_url,  state.seed_n_url,  state.seed_m_count,  state.seed_n_count, "M");
      setThumb("rr8",  state.seed_o_url,  state.seed_p_url,  state.seed_o_count,  state.seed_p_count, "O");
      setThumb("rr9",  state.seed_q_url,  state.seed_r_url,  state.seed_q_count,  state.seed_r_count, "Q");
      setThumb("rr10", state.seed_s_url,  state.seed_t_url,  state.seed_s_count,  state.seed_t_count, "S");
      setThumb("rr11", state.seed_u_url,  state.seed_v_url,  state.seed_u_count,  state.seed_v_count, "U");
      setThumb("rr12", state.seed_w_url,  state.seed_x_url,  state.seed_w_count,  state.seed_x_count, "W");
      setThumb("rr13", state.seed_y_url,  state.seed_z_url,  state.seed_y_count,  state.seed_z_count, "Y");
      setThumb("rr14", state.seed_aa_url, state.seed_ab_url, state.seed_aa_count, state.seed_ab_count, "AA");
      setThumb("rr15", state.seed_ac_url, state.seed_ad_url, state.seed_ac_count, state.seed_ad_count, "AC");
      setThumb("rr16", state.seed_ae_url, state.seed_af_url, state.seed_ae_count, state.seed_af_count, "AE");

      // Freeze R32 thumbnails after r32_done
      for (let i=1;i<=16;i++){
        const k = "rr"+i;
        thumbs[k].box.classList.toggle("disabled", !!state.r32_done);
      }

      // R16 (hidden until r32_done)
      setThumb("r1", state.seed_a_url, state.seed_b_url, state.seed_a_count, state.seed_b_count,"A");
      setThumb("r2", state.seed_c_url, state.seed_d_url, state.seed_c_count, state.seed_d_count,"C");
      setThumb("r3", state.seed_e_url, state.seed_f_url, state.seed_e_count, state.seed_f_count,"E");
      setThumb("r4", state.seed_g_url, state.seed_h_url, state.seed_g_count, state.seed_h_count,"G");
      setThumb("r5", state.seed_i_url, state.seed_j_url, state.seed_i_count, state.seed_j_count,"I");
      setThumb("r6", state.seed_k_url, state.seed_l_url, state.seed_k_count, state.seed_l_count,"K");
      setThumb("r7", state.seed_m_url, state.seed_n_url, state.seed_m_count, state.seed_n_count,"M");
      setThumb("r8", state.seed_o_url, state.seed_p_url, state.seed_o_count, state.seed_p_count,"O");

      for (let i=1;i<=8;i++){
        const k = "r"+i;
        thumbs[k].box.classList.toggle("hidden", !state.r32_done);
        thumbs[k].box.classList.toggle("disabled", !state.r32_done || !!state.r16_done);
      }

      // Quarters (prefer snapshots), hidden until r16_done
      const q = [
        ["q1","q1_a_url","q1_b_url","q1_a_count","q1_b_count","seed_a_url","seed_b_url","seed_a_count","seed_b_count","A"],
        ["q2","q2_c_url","q2_d_url","q2_c_count","q2_d_count","seed_c_url","seed_d_url","seed_c_count","seed_d_count","C"],
        ["q3","q3_e_url","q3_f_url","q3_e_count","q3_f_count","seed_e_url","seed_f_url","seed_e_count","seed_f_count","E"],
        ["q4","q4_g_url","q4_h_url","q4_g_count","q4_h_count","seed_g_url","seed_h_url","seed_g_count","seed_h_count","G"],
      ];
      for (const [k,lu,ru,lc,rc,flu,fru,flc,frc,fb] of q){
        const L = pick(state[lu], state[flu]);
        const R = pick(state[ru], state[fru]);
        const LC = pick(state[lc], state[flc]);
        const RC = pick(state[rc], state[frc]);
        setThumb(k, L, R, LC, RC, fb);
        thumbs[k].box.classList.toggle("disabled", !state.r16_done);
        thumbs[k].box.classList.toggle("hidden",   !state.r16_done);
      }

      // Semis
      if (!state.mid1_done){
        thumbs.s1.imgL.src = placeholder("S1");
        thumbs.s1.imgR.src = placeholder("S1");
        thumbs.s1.count.textContent = "0-0";
        thumbs.s1.box.classList.add("disabled"); thumbs.s1.box.classList.add("hidden");

        thumbs.s2.imgL.src = placeholder("S2");
        thumbs.s2.imgR.src = placeholder("S2");
        thumbs.s2.count.textContent = "0-0";
        thumbs.s2.box.classList.add("disabled"); thumbs.s2.box.classList.add("hidden");
      }else{
        thumbs.s1.imgL.src = state.semi_1_left_url  || placeholder("S1");
        thumbs.s1.imgR.src = state.semi_1_right_url || placeholder("S1");
        thumbs.s1.count.textContent = (state.seed_a_count||0) + "-" + (state.seed_b_count||0);
        thumbs.s1.box.classList.remove("disabled"); thumbs.s1.box.classList.remove("hidden");

        thumbs.s2.imgL.src = state.semi_2_left_url  || placeholder("S2");
        thumbs.s2.imgR.src = state.semi_2_right_url || placeholder("S2");
        thumbs.s2.count.textContent = (state.seed_c_count||0) + "-" + (state.seed_d_count||0);
        thumbs.s2.box.classList.remove("disabled"); thumbs.s2.box.classList.remove("hidden");
      }

      // Final
      if (!state.mid2_done){
        thumbs.final.imgL.src = placeholder("F");
        thumbs.final.imgR.src = placeholder("F");
        thumbs.final.count.textContent = "0-0";
        thumbs.final.box.classList.add("disabled"); thumbs.final.box.classList.add("hidden");
      }else{
        thumbs.final.imgL.src = state.mid_winner_1_url || placeholder("F");
        thumbs.final.imgR.src = state.mid_winner_2_url || placeholder("F");
        thumbs.final.count.textContent = (state.seed_a_count||0) + "-" + (state.seed_b_count||0);
        thumbs.final.box.classList.remove("disabled"); thumbs.final.box.classList.remove("hidden");
      }

      markActive();
    }

    function renderFinalBox(){
      finalImg1.src = state.mid_winner_1_url || placeholder("?");
      finalImg2.src = state.mid_winner_2_url || placeholder("?");
      if (state.mid2_done) finalFooter.textContent = "Final is live — decides at 0s.";
      else if (state.mid1_done) finalFooter.textContent = "Semis live — final soon.";
      else if (state.r16_done) finalFooter.textContent = "Quarters live — semis soon.";
      else if (state.r32_done) finalFooter.textContent = "R16 live — quarters at 60s.";
      else finalFooter.textContent = "R32 live — R16 at 90s.";
    }

    function renderActive(){
      renderThumbs();
      renderFinalBox();

      const base = state.base_iso||"";
      const mem = memRead(base);
      const picked = mem[activeMatch];

      let leftImg=placeholder("?"), rightImg=placeholder("?"), leftCt=0, rightCt=0, leftLabel="Left", rightLabel="Right";

      const find = order.find(o=>o.key===activeMatch);
      if (find && !find.semi && find.key!=="final"){
        const L = pick(state[find.left], state[find.fbLeft]);
        const R = pick(state[find.right], state[find.fbRight]);
        const LC = pick(state[find.lct], state[find.fbLct]);
        const RC = pick(state[find.rct], state[find.fbRct]);
        leftImg=L||placeholder("?"); rightImg=R||placeholder("?");
        leftCt=LC||0; rightCt=RC||0;
        leftLabel = find.label.split(" ")[0] + " — Left";
        rightLabel= find.label.split(" ")[0] + " — Right";
      } else if (activeMatch==="s1"){
        if (state.mid1_done){
          leftImg  = state.semi_1_left_url  || placeholder("?");
          rightImg = state.semi_1_right_url || placeholder("?");
          leftCt = state.seed_a_count||0; rightCt=state.seed_b_count||0;
        }
        leftLabel="Semi 1 — Left"; rightLabel="Semi 1 — Right";
      } else if (activeMatch==="s2"){
        if (state.mid1_done){
          leftImg  = state.semi_2_left_url  || placeholder("?");
          rightImg = state.semi_2_right_url || placeholder("?");
          leftCt = state.seed_c_count||0; rightCt=state.seed_d_count||0;
        }
        leftLabel="Semi 2 — Left"; rightLabel="Semi 2 — Right";
      } else {
        if (state.mid2_done){
          leftImg  = state.mid_winner_1_url || placeholder("?");
          rightImg = state.mid_winner_2_url || placeholder("?");
          leftCt = state.seed_a_count||0; rightCt=state.seed_b_count||0;
        }
        leftLabel="Final — Left"; rightLabel="Final — Right";
      }

      imgActive1.src = leftImg; imgActive2.src = rightImg;
      labelActive1.textContent = leftLabel; labelActive2.textContent = rightLabel;
      countActive1.textContent = leftCt; countActive2.textContent = rightCt;

      let phaseLive = true;
      if (activeMatch.startsWith("rr") && state.r32_done) phaseLive = false;            // R32 closed after lock
      if (activeMatch.startsWith("r") && !activeMatch.startsWith("rr") && !state.r32_done) phaseLive = false; // R16 locked until R32 done
      if (activeMatch.startsWith("q") && !state.r16_done) phaseLive = false;
      if (["s1","s2"].includes(activeMatch) && !state.mid1_done) phaseLive = false;
      if (activeMatch==="final" && !state.mid2_done) phaseLive = false;

      btnActive1.disabled = !!picked || !phaseLive;
      btnActive2.disabled = !!picked || !phaseLive;
      if (picked==="red")  labelActive1.textContent += " • you voted";
      if (picked==="blue") labelActive2.textContent += " • you voted";
    }

    // ---------- NET ----------
    async function fetchState(force=false){
      try{
        const res = await fetch(FUNCTION_URL + (force ? "" : ""));
        const data = await res.json();
        const s = (data && typeof data==="object" && "state" in data) ? data.state : data;
        state = Object.assign(state, s || {});

        // smooth active match progression
        if (!state.r32_done && !activeMatch.startsWith("rr")) activeMatch = "rr1";
        if (state.r32_done && !state.r16_done && (activeMatch.startsWith("rr") || activeMatch.startsWith("q") || activeMatch.startsWith("s") || activeMatch==="final")) activeMatch = "r1";
        if (state.r16_done && !state.mid1_done && activeMatch.startsWith("r")) activeMatch = "q1";
        if (state.mid1_done && !state.mid2_done && (activeMatch.startsWith("r")||activeMatch.startsWith("q"))) activeMatch="s1";
        if (state.mid2_done && activeMatch!=="final") activeMatch="final";

        renderActive();
      }catch(e){
        renderActive();
      }
    }

    // ---------- TICK + CHAMPION OVERLAY ----------
    let phaseSync = { r32:false, r16:false, q:false, s:false, f:false };
    let lastFlags={r32:false, r16:false, mid1:false, mid2:false};

    // guard so overlay shows once per cycle
    let championOverlayShown = false;

    function showChampionOverlayIfReady(){
      if (championOverlayShown) return;
      if (typeof window.openChampionOverlay !== "function") return;
      if (!state.mid2_done) return;

      const leftUrl  = state.mid_winner_1_url || null;
      const rightUrl = state.mid_winner_2_url || null;
      if (!leftUrl && !rightUrl) return;

      const leftCount  = state.seed_a_count ?? 0;
      const rightCount = state.seed_b_count ?? 0;

      let winnerUrl = leftUrl || rightUrl;
      let winnerLabel = labelActive1.textContent || "Champion";

      if (rightCount > leftCount) {
        winnerUrl = rightUrl || winnerUrl;
        winnerLabel = labelActive2.textContent || winnerLabel;
      }

      const cleanLabel = winnerLabel.split(" •")[0];

      window.openChampionOverlay(cleanLabel, winnerUrl);
      championOverlayShown = true;
    }

    function tick(){
      if (!state?.ends_at) return requestAnimationFrame(tick);
      const ms = Math.max(0, new Date(state.ends_at).getTime() - Date.now());
      elRemain.textContent = (ms/1000).toFixed(1);

      const R32_MS = 120_000, R16_MS = 90_000, Q_MS = 60_000, S_MS = 30_000;

      if (state.r32_done && !lastFlags.r32){ activeMatch="r1"; }
      if (state.r16_done && !lastFlags.r16){ activeMatch="q1"; }
      if (state.mid1_done && !lastFlags.mid1){ activeMatch="s1"; }
      if (state.mid2_done && !lastFlags.mid2){ activeMatch="final"; }

      lastFlags = { r32: !!state.r32_done, r16: !!state.r16_done, mid1: !!state.mid1_done, mid2: !!state.mid2_done };

      if (ms <= R32_MS + 250 && !state.r32_done) winnerText.textContent = 'R32 just locked — R16 live.';
      if (ms <= R16_MS + 250 && state.r32_done && !state.r16_done) winnerText.textContent = 'R16 just locked — quarters live.';
      if (ms <= Q_MS  + 250 && state.r16_done && !state.mid1_done) winnerText.textContent = 'Quarters just locked — semis live.';
      if (ms <= S_MS  + 250 && state.mid1_done && !state.mid2_done) winnerText.textContent = 'Semis just locked — final live.';

      if (ms <= R32_MS && !state.r32_done && !phaseSync.r32){ phaseSync.r32=true; fetchState(true); }
      if (ms <= R16_MS && state.r32_done && !state.r16_done && !phaseSync.r16){ phaseSync.r16=true; fetchState(true); }
      if (ms <= Q_MS  && state.r16_done && !state.mid1_done && !phaseSync.q){ phaseSync.q=true; fetchState(true); }
      if (ms <= S_MS  && state.mid1_done && !state.mid2_done && !phaseSync.s){ phaseSync.s=true; fetchState(true); }
      if (ms <= 0     && state.mid2_done && !phaseSync.f){ phaseSync.f=true; fetchState(true); }

      // when final hits 0 and pairing is ready, fire champion overlay once
      if (ms <= 0 && state.mid2_done && !championOverlayShown) {
        showChampionOverlayIfReady();
      }

      requestAnimationFrame(tick);
    }

    // realtime
    supabase.channel('cycles-v2-live')
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'cycles_v2' }, async ()=>{ await fetchState(true); })
      .subscribe();

    supabase.channel('matchup-sync')
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'art_queue', filter:'status=in.(locked,used)' }, async ()=>{ await fetchState(true); })
      .subscribe();

    // boot
    fetchState(true).then(()=>{
      setTimeout(()=>fetchState(true), 600);
      setTimeout(()=>fetchState(true), 1500);
      tick();
    });
  </script>
</body>
</html>