<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space ‚Äî Matchup</title>

  <!-- no-cache hints for GH Pages -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Preconnect + Supabase client -->
  <link rel="preconnect" href="https://tuqvpcevrhciursxrgav.supabase.co">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Main stylesheet -->
  <link rel="stylesheet" href="./css/matchup.css"/>

  <!-- Minimal safe fallback to avoid a flash while CSS loads -->
  <style>
    body{background:#000;color:#39ff14;margin:0;font-family:system-ui,Arial,Helvetica,sans-serif}
    .wrap{max-width:980px;margin:16px auto 64px;padding:0 16px}
    #bootLoader{position:fixed;inset:0;display:grid;place-items:center;background:#000}
    .boot-bar{width:76vw;max-width:640px;height:8px;background:#111;border:1px solid #0a0;box-shadow:0 0 10px #0a0 inset}
    .boot-fill{height:100%;width:0;background:#0f0;transition:width .1s linear}
    .boot-title{color:#0f0;margin-bottom:8px}
    .boot-sub{color:#8f8;margin-top:8px}
  </style>
</head>
<body>

  <!-- CYBERPUNK LOADING OVERLAY -->
  <div id="bootLoader" aria-live="polite">
    <div class="boot-title">Rage Space ‚Äî syncing‚Ä¶</div>
    <div class="boot-bar"><div class="boot-fill" id="bootFill"></div></div>
    <div class="boot-sub" id="bootMsg">initializing</div>
  </div>

  <div class="wrap">
    <div class="scorebar">
      <div class="tiny">
        <strong>Decision in</strong>
        <span id="clock" class="clock">Sync‚Ä¶</span>
        <span id="state" class="clock">‚Äî</span>
        <span id="phaseKey" class="clock">phase: ‚Äî</span>
        <span id="loginBadge" class="badge">checking auth‚Ä¶</span>
      </div>
      <div class="row">
        <button id="btnPause" class="btn">‚è∏Ô∏è Pause</button>
        <a class="btn" href="./winners.html">üèÅ Winners</a>
      </div>
    </div>

    <!-- Current Match tiles -->
    <div class="tile" id="tileA" data-color="red">
      <div class="artbox">
        <img id="imgA" class="art" alt="Entry Left"/>
        <button class="fsbtn" data-target="imgA" title="View fullscreen">‚õ∂</button>
      </div>
      <div class="caption" id="countA">0 votes</div>
      <div class="meta">
        <span id="labelA">Left</span>
        <button class="btn primary" id="voteA">Vote This</button>
      </div>
    </div>

    <div class="tile" id="tileB" data-color="blue">
      <div class="artbox">
        <img id="imgB" class="art" alt="Entry Right"/>
        <button class="fsbtn" data-target="imgB" title="View fullscreen">‚õ∂</button>
      </div>
      <div class="caption" id="countB">0 votes</div>
      <div class="meta">
        <span id="labelB">Right</span>
        <button class="btn primary" id="voteB">Vote This</button>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="submitBtn" disabled>‚úÖ Submit Vote</button>
    </div>

    <!-- Bracket list -->
    <section class="bracket" id="bracket">
      <div class="bracket-head">
        <div class="bracket-title">Bracket</div>
        <label class="switch">
          <input id="showDone" type="checkbox" />
          <span>Show finished rounds</span>
        </label>
      </div>
      <div id="brows"></div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <!-- FINAL OVERLAY -->
  <div id="overlay">
    <canvas id="confetti"></canvas>
    <div class="overlay-bg">
      <div class="scanlines-behind"></div>
      <div class="vignette"></div>
      <div class="overlay-stage">
        <div class="art-wrap">
          <img id="overlayArtImg" alt="Winning Art"/>
          <div class="scanline-frame">
            <div class="band top"></div>
            <div class="band bottom"></div>
            <div class="band left"></div>
            <div class="band right"></div>
          </div>
        </div>
      </div>
    </div>
    <button id="overlayClose" class="btn">‚úï</button>
    <div class="overlay-card" id="overlayCard">
      <h1 id="overlayTitle">CHAMPION</h1>
      <div class="sub typewriter-text" id="overlaySubtitle"></div>
      <div class="motto typewriter-text" id="overlayMotto"></div>
    </div>
  </div>

  <!-- Fullscreen overlay -->
  <div id="fsOverlay">
    <button id="fsClose">‚úï</button>
    <img id="fsImage" alt="Fullscreen Art"/>
  </div>

  <!-- Main app config first (matches your project) -->
  <script type="module">
    export const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    export const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    export const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer`;
  </script>

  <!-- Version tag to bust module caches -->
  <script>
    window.__APP_VER__ = "2025-10-16-04";
  </script>

  <!-- App entrypoint (order matters). Add ?v=VER for cache-bust -->
  <script type="module" src="./js/core.js?v=2025-10-16-04"></script>
  <script type="module" src="./js/services.js?v=2025-10-16-04"></script>
  <script type="module" src="./js/ui.js?v=2025-10-16-04"></script>
  <script type="module" src="./js/features/bracket.js?v=2025-10-16-04"></script>
  <script type="module" src="./js/features/overlay.js?v=2025-10-16-04"></script>
  <script type="module" src="./js/main.js?v=2025-10-16-04"></script>

  <!-- Optional: unregister any old service workers (harmless if none) -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.getRegistrations?.().then((regs) => {
        for (const r of regs) r.unregister();
      }).catch(() => {});
    }
  </script>

<!-- ================== RAGE DEBUGGER v2 ================== -->
<script>
(function () {
  // ---------- config ----------
  const MAX_LINES = 2000;                 // ring buffer size
  const EDGE_MATCH = /\/functions\/v1\/global-timer/;

  // ---------- ui ----------
  const wrap = document.createElement('div');
  wrap.id = 'dbg';
  wrap.style.cssText = `
    position: fixed; right: 0; bottom: 0; left: 0;
    background: rgba(0,0,0,.92); color:#9f9; font: 12px/1.4 monospace;
    z-index: 2147483647; max-height: 45vh; display:none; box-shadow:0 -2px 12px rgba(0,0,0,.6);
  `;

  const bar = document.createElement('div');
  bar.style.cssText = 'display:flex; align-items:center; gap:6px; padding:6px; position:sticky; top:0; background:#111;';
  bar.innerHTML = `
    <button id="dbgToggle" style="position:fixed; right:8px; bottom:8px; z-index:2147483646; background:#000; color:#0f0; border:1px solid #0f0; border-radius:6px; padding:6px 8px;">üêõ Debug</button>
    <span style="color:#6f6">Rage Debug</span>
    <label>Filter:
      <select id="dbgFilter">
        <option value="">All</option>
        <option>NET</option><option>EDGE</option><option>TIMER</option><option>CLOCK</option>
        <option>STAGE</option><option>UI</option><option>IMG</option><option>OBS</option>
        <option>ERR</option><option>WARN</option><option>LOG</option>
      </select>
    </label>
    <label><input id="dbgRecord" type="checkbox" checked> Record</label>
    <button id="dbgCopy">Copy</button>
    <button id="dbgDownload">Download</button>
    <button id="dbgClear">Clear</button>
  `;

  const list = document.createElement('div');
  list.style.cssText = 'padding:6px 8px; white-space:pre-wrap; overflow:auto; max-height:calc(45vh - 42px);';

  wrap.appendChild(bar); wrap.appendChild(list);
  document.body.appendChild(wrap);
  const btn = bar.querySelector('#dbgToggle');
  btn.onclick = () => wrap.style.display = (wrap.style.display === 'none' ? 'block' : 'none');

  const filterSel  = bar.querySelector('#dbgFilter');
  const recordChk  = bar.querySelector('#dbgRecord');
  bar.querySelector('#dbgClear').onclick = () => { buffer = []; render(); };
  bar.querySelector('#dbgCopy').onclick = () => navigator.clipboard.writeText(buffer.map(r => r.line).join("\n"));
  bar.querySelector('#dbgDownload').onclick = () => {
    const blob = new Blob([buffer.map(r => r.line).join("\n")], {type:'text/plain'});
    const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download: `rage_debug_${Date.now()}.log`});
    a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  };

  // ---------- ring buffer ----------
  let buffer = [];
  function push(kind, msg, extra) {
    if (!recordChk.checked) return;
    const ts = new Date().toLocaleTimeString();
    const line = `[${ts}] ${kind}: ${msg}`;
    buffer.push({kind, line, extra});
    if (buffer.length > MAX_LINES) buffer.shift();
    const f = filterSel.value;
    if (!f || f === kind) {
      const div = document.createElement('div');
      div.textContent = line;
      if (kind === 'ERR') div.style.color = '#f88';
      else if (kind === 'WARN') div.style.color = '#ff8';
      else if (kind === 'EDGE') div.style.color = '#8ff';
      else if (kind === 'NET') div.style.color = '#8cf';
      else if (kind === 'TIMER' || kind === 'CLOCK') div.style.color = '#6f6';
      list.appendChild(div);
      list.scrollTop = list.scrollHeight;
    }
  }
  function render() {
    list.innerHTML = '';
    const f = filterSel.value;
    for (const r of buffer) {
      if (f && f !== r.kind) continue;
      const div = document.createElement('div');
      div.textContent = r.line;
      if (r.kind === 'ERR') div.style.color = '#f88';
      else if (r.kind === 'WARN') div.style.color = '#ff8';
      else if (r.kind === 'EDGE') div.style.color = '#8ff';
      else if (r.kind === 'NET') div.style.color = '#8cf';
      else if (r.kind === 'TIMER' || r.kind === 'CLOCK') div.style.color = '#6f6';
      list.appendChild(div);
    }
    list.scrollTop = list.scrollHeight;
  }
  filterSel.onchange = render;

  // ---------- console hooks ----------
  const _log = console.log, _warn = console.warn, _err = console.error;
  console.log = (...a) => { try{push('LOG', a.map(String).join(' '));}catch{} _log.apply(console,a); };
  console.warn= (...a) => { try{push('WARN',a.map(String).join(' '));}catch{} _warn.apply(console,a);};
  console.error=(...a) => { try{push('ERR', a.map(String).join(' '));}catch{} _err.apply(console,a);};

  window.addEventListener('error', (e)=> push('ERR', `${e.message} @ ${e.filename}:${e.lineno}`));
  window.addEventListener('unhandledrejection', (e)=> push('ERR', (e.reason && e.reason.message) || String(e.reason)));

  // ---------- visibility (can affect clock) ----------
  document.addEventListener('visibilitychange', () => {
    push('OBS', `visibility: ${document.visibilityState}`);
  });

  // ---------- observe key UI fields (stage/phase/clock) ----------
  const q = (id) => document.getElementById(id);
  function observeText(id, kind) {
    const el = q(id); if (!el) return;
    let last = el.textContent;
    const mo = new MutationObserver(() => {
      if (el.textContent !== last) {
        last = el.textContent;
        push(kind, `${id} ‚Üí ${last}`);
      }
    });
    mo.observe(el, {childList:true, characterData:true, subtree:true});
  }
  observeText('phaseKey', 'STAGE');
  observeText('state', 'STAGE');

  // Special handling for the clock: also compute drift vs real time
  (function watchClock(){
    const el = q('clock'); if (!el) return;
    let last = el.textContent, lastAt = performance.now();
    const mo = new MutationObserver(() => {
      const now = performance.now();
      if (el.textContent !== last) {
        const dt = ((now - lastAt)/1000).toFixed(2);
        push('CLOCK', `clock ${last} ‚Üí ${el.textContent} (Œîdom ${dt}s)`);
        last = el.textContent; lastAt = now;
      }
    });
    mo.observe(el, {childList:true, characterData:true, subtree:true});
  })();

  // ---------- fetch tracer (network + edge) ----------
  const _fetch = window.fetch.bind(window);
  window.fetch = async function(url, opts = {}) {
    const start = performance.now();
    let method = (opts && opts.method) || 'GET';
    let tag = EDGE_MATCH.test(String(url)) ? 'EDGE' : 'NET';
    push(tag, `${method} ${url}`);
    try {
      const res = await _fetch(url, opts);
      const ms = (performance.now() - start).toFixed(0);
      push(tag, `${method} ${url} ‚Üí ${res.status} (${ms}ms)`);
      return res;
    } catch (e) {
      const ms = (performance.now() - start).toFixed(0);
      push(tag, `${method} ${url} ‚úñ ${e.name||'error'} (${ms}ms)`);
      throw e;
    }
  };

  // ---------- timer / rAF tracing ----------
  const _setInterval = window.setInterval, _clearInterval = window.clearInterval;
  const _setTimeout  = window.setTimeout,  _clearTimeout  = window.clearTimeout;
  const _raf = window.requestAnimationFrame, _caf = window.cancelAnimationFrame;

  const timers = new Map();
  window.setInterval = function(fn, ms, ...rest){
    const id = _setInterval(function(){ const t0=performance.now(); try{fn()}finally{push('TIMER',`interval ${id} tick in ${(performance.now()-t0).toFixed(1)}ms`)} }, ms, ...rest);
    timers.set(id, {type:'interval', ms}); push('TIMER', `interval ${id} set @ ${ms}ms`); return id;
  };
  window.clearInterval = function(id){ if(timers.has(id)) push('TIMER', `interval ${id} cleared`); return _clearInterval(id); };
  window.setTimeout  = function(fn, ms, ...rest){
    const id = _setTimeout(function(){ const t0=performance.now(); try{fn()}finally{push('TIMER',`timeout ${id} run in ${(performance.now()-t0).toFixed(1)}ms`)} }, ms, ...rest);
    timers.set(id, {type:'timeout', ms}); push('TIMER', `timeout ${id} set @ ${ms}ms`); return id;
  };
  window.clearTimeout = function(id){ if(timers.has(id)) push('TIMER', `timeout ${id} cleared`); return _clearTimeout(id); };
  window.requestAnimationFrame = function(fn){
    return _raf(function(t){ const t0=performance.now(); try{fn(t)}finally{push('TIMER',`rAF ${(performance.now()-t0).toFixed(1)}ms`)} });
  };
  window.cancelAnimationFrame = function(id){ _caf(id); };

  // ---------- image load tracing ----------
  function hookImg(img){
    if (!img || img.__dbgHooked) return;
    img.__dbgHooked = true;
    img.addEventListener('load',  ()=> push('IMG', `loaded ${img.id||''} ${img.src}`));
    img.addEventListener('error', ()=> push('IMG', `ERROR  ${img.id||''} ${img.src}`));
  }
  Array.from(document.images).forEach(hookImg);
  const imgObs = new MutationObserver((ms)=>{
    for (const m of ms) for (const n of m.addedNodes) {
      if (n.tagName === 'IMG') hookImg(n);
      else if (n.querySelectorAll) n.querySelectorAll('img').forEach(hookImg);
    }
  });
  imgObs.observe(document.documentElement, {childList:true, subtree:true});

  // ---------- bracket observer ----------
  const brows = document.getElementById('brows');
  if (brows) {
    const mo = new MutationObserver((ms)=>{
      let adds = 0, rems = 0;
      for (const m of ms) { adds += m.addedNodes.length; rems += m.removedNodes.length; }
      push('OBS', `bracket changed: +${adds} -${rems} (children=${brows.children.length})`);
    });
    mo.observe(brows, {childList:true, subtree:false});
  }

  // ---------- public helpers you can call manually ----------
  window.RageDebug = {
    log: (k, m) => push(k||'LOG', m||''),
    markStage: (stage, base) => push('STAGE', `mark stage=${stage} base=${base||''}`),
    markPaint: (slot, base) => push('UI', `paint slot=${slot} base=${base||''}`),
    markCounts: (slot, r, b) => push('UI', `counts slot=${slot} r=${r} b=${b}`),
  };

  // small banner on load
  push('LOG', 'Debugger ready');
})();
</script>
<!-- ================== /RAGE DEBUGGER v2 ================== -->
</body>
</html>