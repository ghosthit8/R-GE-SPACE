<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rage Space — Matchup (32-up → 2-up)</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0f13; --accent:#39ff14; --muted:#8b8b8b; --card:#0f1318; --border:#20242a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 96px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .timer { font-variant-numeric: tabular-nums; font-weight:700; font-size:26px; padding:8px 12px; border-radius:12px; background:radial-gradient(circle at 0 0,#122a1b,#050608); box-shadow:0 0 16px rgba(0,0,0,.8),0 0 40px rgba(57,255,20,.4); color:#39ff14; border:1px solid rgba(57,255,20,.28); }
    .state { color:var(--muted); font-size:12px; }

    .round-label { font-size:13px; color:var(--muted); }

    .card { margin-top:12px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--card); }
    .imgBox { position:relative; width:100%; aspect-ratio:3/4; background:#111; display:grid; place-items:center; }
    .imgBox img, .imgBox video { width:100%; height:100%; object-fit:cover; display:block; }
    .fullscreenBtn { position:absolute; top:8px; right:8px; background:rgba(0,0,0,.7); border-radius:999px; border:1px solid rgba(57,255,20,.7); color:#39ff14; font-size:14px; padding:4px 8px; cursor:pointer; font-weight:700; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; gap:8px; border-top:1px solid var(--border); }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#9ca3af; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }

    .btn,.linkbtn,.backbtn { border:1px solid rgba(148,163,184,.6); background:transparent; color:var(--fg); padding:7px 12px; border-radius:999px; font-size:13px; font-weight:600; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:4px; }
    .btn.ghost { color:#a0aec0; }
    button.vote { padding:10px 14px; }
    button.vote:disabled { opacity:.6; cursor:default; }

    /* NEW: previous/next match arrow buttons */
    .navArrow {
      border: 1px solid var(--accent);
      background: rgba(0,0,0,0.45);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 20px;
      font-weight: 700;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:36px;
    }
    .navArrow:disabled{
      opacity:0.4;
      cursor:default;
      border-color:rgba(148,163,184,0.5);
      color:rgba(148,163,184,0.9);
    }

    .piece-meta {
      padding:6px 12px 10px;
      border-top:1px solid var(--border);
      font-size:12px;
      color:#9ca3af;
      line-height:1.4;
    }
    .piece-meta a.artist-link {
      color:#39ff14;
      text-decoration:none;
    }
    .piece-meta a.artist-link:hover {
      text-decoration:underline;
    }
    .piece-meta.hidden { display:none; }

    .thumbs-wrap { margin-top:16px; }
    .thumbs-title { font-size:12px; opacity:.6; margin-bottom:6px; }
    .thumbs { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:12px; padding:4px; display:flex; flex-direction:column; gap:4px; background:var(--card); cursor:pointer; position:relative; }
    .thumb.disabled { opacity:.55; cursor:default; }
    .thumb.active { border-color:var(--accent); box-shadow:0 0 0 1px rgba(57,255,20,.3); }

    /* THUMB IMAGE: DIAGONAL SPLIT (BOTH COMPETITORS) */
    .thumb-img {
      position:relative;
      width:100%;
      aspect-ratio:3/4;
      background:#0b0f13;
      overflow:hidden;
    }
    .thumb-img img,
    .thumb-img video {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-img.diag img.half,
    .thumb-img.diag video.half {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      clip-path:polygon(0 0,100% 0,0 100%);
    }
    .thumb-img.diag img.half.right,
    .thumb-img.diag video.half.right {
      clip-path:polygon(100% 0,100% 100%,0 100%);
    }

    .thumb-label { display:flex; justify-content:space-between; font-size:11px; align-items:center; }
    .thumb-label span.left { opacity:.8; }
    .thumb-label span.right { font-variant-numeric: tabular-nums; }

    .video-badge {
      position:absolute;
      bottom:4px;
      right:4px;
      font-size:9px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#e5e7eb;
    }

    .phase-badge {
      position:absolute;
      top:4px;
      left:4px;
      font-size:10px;
      padding:2px 5px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#e5e7eb;
    }

    .fullscreen-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.94);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .fullscreen-inner {
      max-width:min(900px,96vw);
      max-height:96vh;
      position:relative;
    }
    .fullscreen-inner img,
    .fullscreen-inner video {
      max-width:100%;
      max-height:96vh;
      object-fit:contain;
      display:block;
    }
    .fullscreen-close {
      position:absolute;
      top:8px;
      right:8px;
      border-radius:999px;
      padding:3px 10px;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(148,163,184,.8);
      color:#e5e7eb;
      font-size:12px;
      cursor:pointer;
    }

    .glitch-title {
      position:relative;
      display:inline-block;
      font-size:22px;
      letter-spacing:2px;
      color:#39ff14;
      text-shadow:0 0 8px rgba(57,255,20,.7);
      text-transform:uppercase;
    }
    .glitch-title::before,
    .glitch-title::after {
      content:attr(data-text);
      position:absolute;
      top:0;
      left:0;
      mix-blend-mode:screen;
      opacity:.6;
      clip-path:polygon(0 0,100% 0,100% 45%,0 45%);
    }
    .glitch-title::before {
      transform:translateX(-1px);
      color:#00f2ff;
    }
    .glitch-title::after {
      transform:translateX(1px);
      color:#ff4bfb;
      clip-path:polygon(0 55%,100% 55%,100% 100%,0 100%);
    }

    #winnerText { margin-top:8px; font-size:13px; color:var(--muted); }

    #loadingOverlay {
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 20% 0,rgba(0,0,0,.9),#020617);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#39ff14;
      font-weight:700;
      letter-spacing:2px;
      z-index:9999;
    }

    .hidden { display:none!important; }
  </style>
</head>
<body>
<div id="loadingOverlay">LOADING TOURNAMENT…</div>
  <div class="wrap">
    <h1 class="glitch-title" data-text="ART BATTLE. Faction I.">ART BATTLE. Faction I.</h1>

    <div class="header">
      <div class="row">
        <!-- start a round at 4h48m = 17,280s -->
        <div class="timer" id="tRemain">04:48:00</div>
        <div class="round-label" id="currentRound">Current round: —</div>
      </div>
      <div class="row">
        <a class="backbtn" href="menu.html">← Menu</a>
        <a class="linkbtn" href="winners.html">Winners</a>
        <!-- NEW: Previous / Next battle arrows -->
        <button class="navArrow" id="prevMatch">⟨</button>
        <button class="navArrow" id="nextMatch">⟩</button>
      </div>
    </div>

    <div id="winnerText"></div>

    <!-- ACTIVE MATCH -->
    <div class="card" id="activeTop">
      <div class="imgBox">
        <img id="imgActive1" alt="Active top">
        <video id="vidActive1" class="hidden" muted playsinline loop controls></video>
        <button class="fullscreenBtn" onclick="openFull('active1')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive1">Top</div>
        <div class="counts" id="countActive1">0</div>
        <button class="vote" id="btnActive1">Vote</button>
      </div>
      <div class="piece-meta hidden" id="metaActive1"></div>
    </div>

    <div class="card" id="activeBottom">
      <div class="imgBox">
        <img id="imgActive2" alt="Active bottom">
        <video id="vidActive2" class="hidden" muted playsinline loop controls></video>
        <button class="fullscreenBtn" onclick="openFull('active2')">⤢</button>
      </div>
      <div class="bar">
        <div class="label" id="labelActive2">Bottom</div>
        <div class="counts" id="countActive2">0</div>
        <button class="vote" id="btnActive2">Vote</button>
      </div>
      <div class="piece-meta hidden" id="metaActive2"></div>
    </div>

    <!-- THUMBS -->
    <div class="thumbs-wrap">
      <div class="thumbs-title">Tap a battle to view &amp; vote</div>
      <div class="thumbs" id="thumbGrid"></div>
    </div>
  </div>

  <!-- fullscreen overlay -->
  <div class="fullscreen-overlay" id="fullOverlay">
    <div class="fullscreen-inner">
      <button class="fullscreen-close" onclick="closeFull()">Close ✕</button>
      <img id="fullImg" class="hidden" alt="Full piece">
      <video id="fullVideo" class="hidden" controls playsinline></video>
    </div>
  </div>

<script>
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXV...CI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

    const RSID_KEY = "rsid_v2";
    let RSID = localStorage.getItem(RSID_KEY);
    if (!RSID){
      RSID = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)+Date.now());
      localStorage.setItem(RSID_KEY, RSID);
    }

    const doc = document;
    const elRemain = doc.getElementById("tRemain");
    const winnerText = doc.getElementById("winnerText");

    const imgActive1 = doc.getElementById("imgActive1");
    const imgActive2 = doc.getElementById("imgActive2");
    const vidActive1 = doc.getElementById("vidActive1");
    const vidActive2 = doc.getElementById("vidActive2");

    const btnActive1 = doc.getElementById("btnActive1");
    const btnActive2 = doc.getElementById("btnActive2");

    const activeMeta1 = doc.getElementById("metaActive1");
    const activeMeta2 = doc.getElementById("metaActive2");

    const activeTop = doc.getElementById("activeTop");
    const activeBottom = doc.getElementById("activeBottom");

    const currentRoundEl = doc.getElementById("currentRound");

    const fullOverlay = doc.getElementById("fullOverlay");
    const fullImg = doc.getElementById("fullImg");
    const fullVideo = doc.getElementById("fullVideo");

    const thumbGrid = doc.getElementById("thumbGrid");

    const loadingEl = doc.getElementById("loadingOverlay");

    function hideLoading(){
      if (loadingEl) loadingEl.style.display = "none";
    }

    function isVideoUrl(url){
      if (!url) return false;
      return /\.(mp4|webm|mov|m4v)(\?|$)/i.test(url);
    }

    function openFull(which){
      const src = (which==="active1")
        ? (isVideoUrl(vidActive1.src) ? vidActive1.src : imgActive1.src)
        : (isVideoUrl(vidActive2.src) ? vidActive2.src : imgActive2.src);
      if (!src) return;
      const isVid = isVideoUrl(src);
      if (isVid){
        fullImg.classList.add("hidden");
        fullVideo.classList.remove("hidden");
        fullVideo.src = src;
        fullVideo.play().catch(()=>{});
      } else {
        fullVideo.classList.add("hidden");
        try {
          fullVideo.pause();
          fullVideo.removeAttribute("src");
          fullVideo.load();
        } catch(e){}
        fullImg.classList.remove("hidden");
        fullImg.src = src;
      }
      fullOverlay.style.display = "flex";
    }

    function closeFull(){
      fullOverlay.style.display = "none";
      try {
        fullVideo.pause();
        fullVideo.removeAttribute("src");
        fullVideo.load();
      } catch(e){}
    }

    function placeholder(letter){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="720" height="960">
        <rect width="100%" height="100%" fill="#000"/>
        <text x="50%" y="50%" fill="#39ff14" font-size="90" font-family="monospace"
          text-anchor="middle" dominant-baseline="middle">${letter}</text>
      </svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    let state = {
      base_iso:null,
      ends_at:null,
      r32_done:false,
      r16_done:false,
      mid1_done:false,
      qf_done:false,
      mid2_done:false,
      final_done:false,

      seed_a_url:null, seed_b_url:null, seed_c_url:null, seed_d_url:null,
      seed_e_url:null, seed_f_url:null, seed_g_url:null, seed_h_url:null,
      seed_i_url:null, seed_j_url:null, seed_k_url:null, seed_l_url:null,
      seed_m_url:null, seed_n_url:null, seed_o_url:null, seed_p_url:null,
      seed_q_url:null, seed_r_url:null, seed_s_url:null, seed_t_url:null,
      seed_u_url:null, seed_v_url:null, seed_w_url:null, seed_x_url:null,
      seed_y_url:null, seed_z_url:null, seed_aa_url:null, seed_ab_url:null,
      seed_ac_url:null, seed_ad_url:null, seed_ae_url:null, seed_af_url:null,

      seed_a_count:0, seed_b_count:0, seed_c_count:0, seed_d_count:0,
      seed_e_count:0, seed_f_count:0, seed_g_count:0, seed_h_count:0,
      seed_i_count:0, seed_j_count:0, seed_k_count:0, seed_l_count:0,
      seed_m_count:0, seed_n_count:0, seed_o_count:0, seed_p_count:0,
      seed_q_count:0, seed_r_count:0, seed_s_count:0, seed_t_count:0,
      seed_u_count:0, seed_v_count:0, seed_w_count:0, seed_x_count:0,
      seed_y_count:0, seed_z_count:0, seed_aa_count:0, seed_ab_count:0,
      seed_ac_count:0, seed_ad_count:0, seed_ae_count:0, seed_af_count:0,

      q1_a_url:null, q1_b_url:null, q2_c_url:null, q2_d_url:null,
      q3_e_url:null, q3_f_url:null, q4_g_url:null, q4_h_url:null,

      q1_a_count:0, q1_b_count:0, q2_c_count:0, q2_d_count:0,
      q3_e_count:0, q3_f_count:0, q4_g_count:0, q4_h_count:0,

      semi_1_left_url:null,  semi_1_right_url:null,
      semi_1_left_count:0,  semi_1_right_count:0,
      semi_2_left_url:null,  semi_2_right_url:null,
      semi_2_left_count:0,  semi_2_right_count:0,

      mid_winner_1_url:null, mid_winner_2_url:null,

      meta_by_url:{}
    };

    /* NEW: make vote memory per-user instead of per-browser */
    const VOTE_MEMORY_KEY = "rs_vote_memory_v4";
    let voteUserKey = "guest";

    async function initVoteUserKey(){
      try {
        const { data } = await supabase.auth.getUser();
        const user = data?.user;
        if (user) {
          voteUserKey = user.id || user.email || "user";
        } else {
          voteUserKey = "guest";
        }
      } catch(e) {
        voteUserKey = "guest";
      } finally {
        // once we know which user we are, re-render so vote buttons
        // reflect THIS account's votes (not whoever used the browser earlier)
        renderActive();
      }
    }

    function memRead(base){
      try{
        const all = JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}");
        const perUser = all[voteUserKey] || {};
        return perUser[base] || {};
      }catch{
        return {};
      }
    }
    function memWrite(base,key,val){
      const all = (()=>{ try { return JSON.parse(localStorage.getItem(VOTE_MEMORY_KEY)||"{}"); } catch { return {}; }})();
      const perUser = all[voteUserKey] || {};
      perUser[base] = Object.assign({}, perUser[base]||{}, { [key]: val });
      all[voteUserKey] = perUser;
      localStorage.setItem(VOTE_MEMORY_KEY, JSON.stringify(all));
    }

    const lastGoodThumb = {};

    function pauseOtherVideos(keep){
      const vs = document.querySelectorAll("video");
      vs.forEach(v=>{
        if (v!==keep){
          try{ v.pause(); }catch{}
        }
      });
    }

    fullVideo.addEventListener("play", ()=> pauseOtherVideos(fullVideo));

    const thumbs = {};

    const order = [
      {key:"rr1",  label:"R32 1",  left:"seed_a_url",  right:"seed_b_url",  lct:"seed_a_count",  rct:"seed_b_count"},
      {key:"rr2",  label:"R32 2",  left:"seed_c_url",  right:"seed_d_url",  lct:"seed_c_count",  rct:"seed_d_count"},
      {key:"rr3",  label:"R32 3",  left:"seed_e_url",  right:"seed_f_url",  lct:"seed_e_count",  rct:"seed_f_count"},
      {key:"rr4",  label:"R32 4",  left:"seed_g_url",  right:"seed_h_url",  lct:"seed_g_count",  rct:"seed_h_count"},
      {key:"rr5",  label:"R32 5",  left:"seed_i_url",  right:"seed_j_url",  lct:"seed_i_count",  rct:"seed_j_count"},
      {key:"rr6",  label:"R32 6",  left:"seed_k_url",  right:"seed_l_url",  lct:"seed_k_count",  rct:"seed_l_count"},
      {key:"rr7",  label:"R32 7",  left:"seed_m_url",  right:"seed_n_url",  lct:"seed_m_count",  rct:"seed_n_count"},
      {key:"rr8",  label:"R32 8",  left:"seed_o_url",  right:"seed_p_url",  lct:"seed_o_count",  rct:"seed_p_count"},
      {key:"rr9",  label:"R32 9",  left:"seed_q_url",  right:"seed_r_url",  lct:"seed_q_count",  rct:"seed_r_count"},
      {key:"rr10", label:"R32 10", left:"seed_s_url",  right:"seed_t_url",  lct:"seed_s_count",  rct:"seed_t_count"},
      {key:"rr11", label:"R32 11", left:"seed_u_url",  right:"seed_v_url",  lct:"seed_u_count",  rct:"seed_v_count"},
      {key:"rr12", label:"R32 12", left:"seed_w_url",  right:"seed_x_url",  lct:"seed_w_count",  rct:"seed_x_count"},
      {key:"rr13", label:"R32 13", left:"seed_y_url",  right:"seed_z_url",  lct:"seed_y_count",  rct:"seed_z_count"},
      {key:"rr14", label:"R32 14", left:"seed_aa_url", right:"seed_ab_url", lct:"seed_aa_count", rct:"seed_ab_count"},
      {key:"rr15", label:"R32 15", left:"seed_ac_url", right:"seed_ad_url", lct:"seed_ac_count", rct:"seed_ad_count"},
      {key:"rr16", label:"R32 16", left:"seed_ae_url", right:"seed_af_url", lct:"seed_ae_count", rct:"seed_af_count"},

      {key:"r1", label:"R16 A–B", left:"seed_a_url", right:"seed_b_url", lct:"seed_a_count", rct:"seed_b_count"},
      {key:"r2", label:"R16 C–D", left:"seed_c_url", right:"seed_d_url", lct:"seed_c_count", rct:"seed_d_count"},
      {key:"r3", label:"R16 E–F", left:"seed_e_url", right:"seed_f_url", lct:"seed_e_count", rct:"seed_f_count"},
      {key:"r4", label:"R16 G–H", left:"seed_g_url", right:"seed_h_url", lct:"seed_g_count", rct:"seed_h_count"},
      {key:"r5", label:"R16 I–J", left:"seed_i_url", right:"seed_j_url", lct:"seed_i_count", rct:"seed_j_count"},
      {key:"r6", label:"R16 K–L", left:"seed_k_url", right:"seed_l_url", lct:"seed_k_count", rct:"seed_l_count"},
      {key:"r7", label:"R16 M–N", left:"seed_m_url", right:"seed_n_url", lct:"seed_m_count", rct:"seed_n_count"},
      {key:"r8", label:"R16 O–P", left:"seed_o_url", right:"seed_p_url", lct:"seed_o_count", rct:"seed_p_count"},

      {key:"q1", label:"QF A–B", left:"q1_a_url", right:"q1_b_url", lct:"q1_a_count", rct:"q1_b_count", fbL:"A", fbR:"B", fbLct:"seed_a_count", fbRct:"seed_b_count"},
      {key:"q2", label:"QF C–D", left:"q2_c_url", right:"q2_d_url", lct:"q2_c_count", rct:"q2_d_count", fbL:"C", fbR:"D", fbLct:"seed_c_count", fbRct:"seed_d_count"},
      {key:"q3", label:"QF E–F", left:"q3_e_url", right:"q3_f_url", lct:"q3_e_count", rct:"q3_f_count", fbL:"E", fbR:"F", fbLct:"seed_e_count", fbRct:"seed_f_count"},
      {key:"q4", label:"QF G–H", left:"q4_g_url", right:"q4_h_url", lct:"q4_g_count", rct:"q4_h_count", fbL:"G", fbR:"H", fbLct:"seed_g_count", fbRct:"seed_h_count"},

      {key:"s1", label:"Semi 1", semi:true},
      {key:"s2", label:"Semi 2", semi:true},
      {key:"final", label:"Final"}
    ];

    const metaByUrlCache = ()=> state.meta_by_url || {};

    function escapeHtml(str){
      return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function makeThumb(item){
      const div = document.createElement("div");
      div.className = "thumb";
      div.id = "thumb_"+item.key;
      div.innerHTML = `
        <div class="thumb-img diag">
          <img class="half left"  id="imgL_${item.key}" alt="${item.label} top">
          <img class="half right" id="imgR_${item.key}" alt="${item.label} bottom">
          <video class="half left hidden"  id="vidL_${item.key}" muted playsinline preload="metadata"></video>
          <video class="half right hidden" id="vidR_${item.key}" muted playsinline preload="metadata"></video>
          <div class="video-badge hidden" id="badge_${item.key}">VIDEO</div>
        </div>
        <div class="thumb-label">
          <span>${item.label}</span>
          <span class="thumb-count" id="cnt_${item.key}">0-0</span>
        </div>
      `;
      const imgL = div.querySelector("#imgL_"+item.key);
      const imgR = div.querySelector("#imgR_"+item.key);
      const vidL = div.querySelector("#vidL_"+item.key);
      const vidR = div.querySelector("#vidR_"+item.key);
      const badge = div.querySelector("#badge_"+item.key);
      const cnt   = div.querySelector("#cnt_"+item.key);

      thumbs[item.key] = {
        box:div,
        imgL, imgR, vidL, vidR,
        badge,
        count:cnt
      };

      const hoverEnabled = window.matchMedia && window.matchMedia("(pointer:fine)").matches;
      if (hoverEnabled) {
        div.addEventListener("mouseenter", ()=>{
          [vidL,vidR].forEach(v=>{
            if (v && !v.classList.contains("hidden")){
              try { v.play().catch(()=>{}); } catch(e){}
            }
          });
        });
        div.addEventListener("mouseleave", ()=>{
          [vidL,vidR].forEach(v=>{
            if (v){
              try { v.pause(); } catch(e){}
            }
          });
        });
      }

      div.addEventListener("click", ()=>{
        if (!state) return;
        if (div.classList.contains("disabled")) return;

        if (item.key.startsWith("rr")) {
          if (state.r32_done) return;
        }
        if (item.key.startsWith("r") && !item.key.startsWith("rr")) {
          if (!state.r32_done || state.r16_done) return;
        }
        if (item.key.startsWith("q")) {
          if (!state.r16_done || state.mid1_done) return;
        }
        if (item.key.startsWith("s")) {
          if (!state.mid1_done || state.mid2_done) return;
        }
        if (item.key==="final" && !state.mid2_done) return;

        activeMatch = item.key;
        renderActive();
      });
      grid.appendChild(div);
    }

    const grid = thumbGrid;
    order.forEach(makeThumb);

    function setThumb(key,leftUrl,rightUrl,leftCt,rightCt,fallback){
      const th = thumbs[key]; if (!th) return;

      const leftKey = key + "_L";
      const rightKey = key + "_R";

      let lUrl = leftUrl;
      let rUrl = rightUrl;
      if (!lUrl && lastGoodThumb[leftKey]) lUrl = lastGoodThumb[leftKey];
      if (!rUrl && lastGoodThumb[rightKey]) rUrl = lastGoodThumb[rightKey];

      const leftIsVid = isVideoUrl(lUrl);
      const rightIsVid = isVideoUrl(rUrl);

      if (lUrl) lastGoodThumb[leftKey] = lUrl;
      if (rUrl) lastGoodThumb[rightKey] = rUrl;

      if (leftIsVid) {
        th.imgL.classList.add("hidden");
        th.vidL.classList.remove("hidden");
        th.vidL.src = lUrl + "#t=0.1";
        th.vidL.preload = "metadata";
        try { th.vidL.pause(); } catch(e){}
      } else {
        th.vidL.classList.add("hidden");
        th.imgL.classList.remove("hidden");
        th.imgL.src = lUrl || placeholder(fallback||"?");
      }

      if (rightIsVid) {
        th.imgR.classList.add("hidden");
        th.vidR.classList.remove("hidden");
        th.vidR.src = rUrl + "#t=0.1";
        th.vidR.preload = "metadata";
        try { th.vidR.pause(); } catch(e){}
      } else {
        th.vidR.classList.add("hidden");
        th.imgR.classList.remove("hidden");
        th.imgR.src = rUrl || placeholder(fallback||"?");
      }

      const lc = leftCt ?? 0;
      const rc = rightCt ?? 0;
      th.count.textContent = `${lc}-${rc}`;
    }

    function renderThumbs(){
      setThumb("rr1",  state.seed_a_url,  state.seed_b_url,  state.seed_a_count,  state.seed_b_count, "A");
      setThumb("rr2",  state.seed_c_url,  state.seed_d_url,  state.seed_c_count,  state.seed_d_count, "C");
      setThumb("rr3",  state.seed_e_url,  state.seed_f_url,  state.seed_e_count,  state.seed_f_count, "E");
      setThumb("rr4",  state.seed_g_url,  state.seed_h_url,  state.seed_g_count,  state.seed_h_count, "G");
      setThumb("rr5",  state.seed_i_url,  state.seed_j_url,  state.seed_i_count,  state.seed_j_count, "I");
      setThumb("rr6",  state.seed_k_url,  state.seed_l_url,  state.seed_k_count,  state.seed_l_count, "K");
      setThumb("rr7",  state.seed_m_url,  state.seed_n_url,  state.seed_m_count,  state.seed_n_count, "M");
      setThumb("rr8",  state.seed_o_url,  state.seed_p_url,  state.seed_o_count,  state.seed_p_count, "O");
      setThumb("rr9",  state.seed_q_url,  state.seed_r_url,  state.seed_q_count,  state.seed_r_count, "Q");
      setThumb("rr10", state.seed_s_url,  state.seed_t_url,  state.seed_s_count,  state.seed_t_count, "S");
      setThumb("rr11", state.seed_u_url,  state.seed_v_url,  state.seed_u_count,  state.seed_v_count, "U");
      setThumb("rr12", state.seed_w_url,  state.seed_x_url,  state.seed_w_count,  state.seed_x_count, "W");
      setThumb("rr13", state.seed_y_url,  state.seed_z_url,  state.seed_y_count,  state.seed_z_count, "Y");
      setThumb("rr14", state.seed_aa_url, state.seed_ab_url, state.seed_aa_count, state.seed_ab_count, "AA");
      setThumb("rr15", state.seed_ac_url, state.seed_ad_url, state.seed_ac_count, state.seed_ad_count, "AC");
      setThumb("rr16", state.seed_ae_url, state.seed_af_url, state.seed_ae_count, state.seed_af_count, "AE");

      for (let i=1;i<=16;i++){
        const k = "rr"+i;
        thumbs[k].box.classList.toggle("disabled", !!state.r32_done);
      }

      for (let i=1;i<=8;i++){
        const key = "r"+i;
        const disabled = !state.r32_done || !!state.r16_done;
        thumbs[key].box.classList.toggle("disabled", disabled);
      }

      setThumb("r1", state.seed_a_url, state.seed_b_url, state.seed_a_count, state.seed_b_count, "A");
      setThumb("r2", state.seed_c_url, state.seed_d_url, state.seed_c_count, state.seed_d_count, "C");
      setThumb("r3", state.seed_e_url, state.seed_f_url, state.seed_e_count, state.seed_f_count, "E");
      setThumb("r4", state.seed_g_url, state.seed_h_url, state.seed_g_count, state.seed_h_count, "G");
      setThumb("r5", state.seed_i_url, state.seed_j_url, state.seed_i_count, state.seed_j_count, "I");
      setThumb("r6", state.seed_k_url, state.seed_l_url, state.seed_k_count, state.seed_l_count, "K");
      setThumb("r7", state.seed_m_url, state.seed_n_url, state.seed_m_count, state.seed_n_count, "M");
      setThumb("r8", state.seed_o_url, state.seed_p_url, state.seed_o_count, state.seed_p_count, "O");

      setThumb("q1", state.q1_a_url || state.seed_a_url, state.q1_b_url || state.seed_b_url,
               state.q1_a_count ?? state.seed_a_count, state.q1_b_count ?? state.seed_b_count, "Q1");
      setThumb("q2", state.q2_c_url || state.seed_c_url, state.q2_d_url || state.seed_d_url,
               state.q2_c_count ?? state.seed_c_count, state.q2_d_count ?? state.seed_d_count, "Q2");
      setThumb("q3", state.q3_e_url || state.seed_e_url, state.q3_f_url || state.seed_f_url,
               state.q3_e_count ?? state.seed_e_count, state.q3_f_count ?? state.seed_f_count, "Q3");
      setThumb("q4", state.q4_g_url || state.seed_g_url, state.q4_h_url || state.seed_h_url,
               state.q4_g_count ?? state.seed_g_count, state.q4_h_count ?? state.seed_h_count, "Q4");

      for (const k of ["q1","q2","q3","q4"]){
        const disabled = !state.r16_done || !!state.mid1_done;
        thumbs[k].box.classList.toggle("disabled", disabled);
      }

      if (!state.mid1_done){
        if (thumbs.s1){
          thumbs.s1.imgL.src = placeholder("S1");
          thumbs.s1.imgR.src = placeholder("S1");
          thumbs.s1.count.textContent = "0-0";
          thumbs.s1.box.classList.add("disabled"); thumbs.s1.box.classList.add("hidden");
        }
        if (thumbs.s2){
          thumbs.s2.imgL.src = placeholder("S2");
          thumbs.s2.imgR.src = placeholder("S2");
          thumbs.s2.count.textContent = "0-0";
          thumbs.s2.box.classList.add("disabled"); thumbs.s2.box.classList.add("hidden");
        }
      }else{
        if (!thumbs.s1){
          const div1 = document.createElement("div");
          div1.className="thumb";
          div1.id="thumb_s1";
          div1.innerHTML = `
            <div class="thumb-img diag">
              <img class="half left"  id="imgL_s1" alt="Semi 1 left">
              <img class="half right" id="imgR_s1" alt="Semi 1 right">
              <video class="half left hidden"  id="vidL_s1" muted playsinline preload="metadata"></video>
              <video class="half right hidden" id="vidR_s1" muted playsinline preload="metadata"></video>
              <div class="video-badge hidden" id="badge_s1">VIDEO</div>
            </div>
            <div class="thumb-label">
              <span>Semi 1</span>
              <span class="thumb-count" id="cnt_s1">0-0</span>
            </div>
          `;
          const imgL = div1.querySelector("#imgL_s1");
          const imgR = div1.querySelector("#imgR_s1");
          const vidL = div1.querySelector("#vidL_s1");
          const vidR = div1.querySelector("#vidR_s1");
          const badge = div1.querySelector("#badge_s1");
          const cnt   = div1.querySelector("#cnt_s1");
          thumbs.s1 = { box:div1, imgL,imgR,vidL,vidR,badge,count:cnt };
          grid.appendChild(div1);
        }
        if (!thumbs.s2){
          const div2 = document.createElement("div");
          div2.className="thumb";
          div2.id="thumb_s2";
          div2.innerHTML = `
            <div class="thumb-img diag">
              <img class="half left"  id="imgL_s2" alt="Semi 2 left">
              <img class="half right" id="imgR_s2" alt="Semi 2 right">
              <video class="half left hidden"  id="vidL_s2" muted playsinline preload="metadata"></video>
              <video class="half right hidden" id="vidR_s2" muted playsinline preload="metadata"></video>
              <div class="video-badge hidden" id="badge_s2">VIDEO</div>
            </div>
            <div class="thumb-label">
              <span>Semi 2</span>
              <span class="thumb-count" id="cnt_s2">0-0</span>
            </div>
          `;
          const imgL2 = div2.querySelector("#imgL_s2");
          const imgR2 = div2.querySelector("#imgR_s2");
          const vidL2 = div2.querySelector("#vidL_s2");
          const vidR2 = div2.querySelector("#vidR_s2");
          const badge2 = div2.querySelector("#badge_s2");
          const cnt2   = div2.querySelector("#cnt_s2");
          thumbs.s2 = { box:div2, imgL:imgL2,imgR:imgR2,vidL:vidL2,vidR:vidR2,badge:badge2,count:cnt2 };
          grid.appendChild(div2);
        }

        setThumb("s1", state.semi_1_left_url, state.semi_1_right_url, state.semi_1_left_count, state.semi_1_right_count, "S1");
        setThumb("s2", state.semi_2_left_url, state.semi_2_right_url, state.semi_2_left_count, state.semi_2_right_count, "S2");

        thumbs.s1.box.classList.toggle("disabled", !!state.mid2_done);
        thumbs.s1.box.classList.remove("hidden");
        thumbs.s2.box.classList.toggle("disabled", !!state.mid2_done);
        thumbs.s2.box.classList.remove("hidden");
      }

      if (!state.mid2_done){
        if (!thumbs.final){
          const divF = document.createElement("div");
          divF.className="thumb";
          divF.id="thumb_final";
          divF.innerHTML = `
            <div class="thumb-img diag">
              <img class="half left"  id="imgL_final" alt="Final left">
              <img class="half right" id="imgR_final" alt="Final right">
              <video class="half left hidden"  id="vidL_final" muted playsinline preload="metadata"></video>
              <video class="half right hidden" id="vidR_final" muted playsinline preload="metadata"></video>
              <div class="video-badge hidden" id="badge_final">VIDEO</div>
            </div>
            <div class="thumb-label">
              <span>Final</span>
              <span class="thumb-count" id="cnt_final">0-0</span>
            </div>
          `;
          const imgLF = divF.querySelector("#imgL_final");
          const imgRF = divF.querySelector("#imgR_final");
          const vidLF = divF.querySelector("#vidL_final");
          const vidRF = divF.querySelector("#vidR_final");
          const badgeF = divF.querySelector("#badge_final");
          const cntF   = divF.querySelector("#cnt_final");
          thumbs.final = { box:divF, imgL:imgLF,imgR:imgRF,vidL:vidLF,vidR:vidRF,badge:badgeF,count:cntF };
          grid.appendChild(divF);
        }
        thumbs.final.imgL.src = placeholder("F");
        thumbs.final.imgR.src = placeholder("F");
        thumbs.final.count.textContent = "0-0";
        thumbs.final.box.classList.add("disabled");
        thumbs.final.box.classList.add("hidden");
      }else{
        if (!thumbs.final){
          const divF2 = document.createElement("div");
          divF2.className="thumb";
          divF2.id="thumb_final";
          divF2.innerHTML = `
            <div class="thumb-img diag">
              <img class="half left"  id="imgL_final" alt="Final left">
              <img class="half right" id="imgR_final" alt="Final right">
              <video class="half left hidden"  id="vidL_final" muted playsinline preload="metadata"></video>
              <video class="half right hidden" id="vidR_final" muted playsinline preload="metadata"></video>
              <div class="video-badge hidden" id="badge_final">VIDEO</div>
            </div>
            <div class="thumb-label">
              <span>Final</span>
              <span class="thumb-count" id="cnt_final">0-0</span>
            </div>
          `;
          const imgLF2 = divF2.querySelector("#imgL_final");
          const imgRF2 = divF2.querySelector("#imgR_final");
          const vidLF2 = divF2.querySelector("#vidL_final");
          const vidRF2 = divF2.querySelector("#vidR_final");
          const badgeF2 = divF2.querySelector("#badge_final");
          const cntF2   = divF2.querySelector("#cnt_final");
          thumbs.final = { box:divF2, imgL:imgLF2,imgR:imgRF2,vidL:vidLF2,vidR:vidRF2,badge:badgeF2,count:cntF2 };
          grid.appendChild(divF2);
        }
        setThumb("final", state.mid_winner_1_url, state.mid_winner_2_url, state.seed_a_count, state.seed_b_count, "F");
        thumbs.final.box.classList.remove("disabled");
        thumbs.final.box.classList.remove("hidden");
      }

      markActive();
    }

    let activeMatch = "rr1";

    async function vote(color){
      const base = state.base_iso || "";

      // Ensure we have a logged-in Supabase user so server can enforce
      // 1 vote per account (user_votes_v2 unique constraint).
      let userId = null;
      try {
        const { data } = await supabase.auth.getUser();
        const user = data?.user;
        userId = user?.id || null;
      } catch (e) {
        userId = null;
      }

      if (!userId) {
        alert("You need to be signed in to vote.");
        return;
      }

      const mem = memRead(base);
      const key = activeMatch;
      if (mem[key]) return;

      const red = color === "red";

      const serverPhase = activeMatch.startsWith("rr")
        ? ("r" + activeMatch.slice(2))
        : activeMatch;

      const post = {
        phase: serverPhase,
        side: red ? "left" : "right",
        user_id: userId,
        base_iso: base
      };

      const map = {
        rr1:["seed_a_count","seed_b_count"],   rr2:["seed_c_count","seed_d_count"],
        rr3:["seed_e_count","seed_f_count"],   rr4:["seed_g_count","seed_h_count"],
        rr5:["seed_i_count","seed_j_count"],   rr6:["seed_k_count","seed_l_count"],
        rr7:["seed_m_count","seed_n_count"],   rr8:["seed_o_count","seed_p_count"],
        rr9:["seed_q_count","seed_r_count"],   rr10:["seed_s_count","seed_t_count"],
        rr11:["seed_u_count","seed_v_count"],  rr12:["seed_w_count","seed_x_count"],
        rr13:["seed_y_count","seed_z_count"],  rr14:["seed_aa_count","seed_ab_count"],
        rr15:["seed_ac_count","seed_ad_count"],rr16:["seed_ae_count","seed_af_count"],

        r1:["seed_a_count","seed_b_count"], r2:["seed_c_count","seed_d_count"],
        r3:["seed_e_count","seed_f_count"], r4:["seed_g_count","seed_h_count"],
        r5:["seed_i_count","seed_j_count"], r6:["seed_k_count","seed_l_count"],
        r7:["seed_m_count","seed_n_count"], r8:["seed_o_count","seed_p_count"],

        q1:["seed_a_count","seed_b_count"], q2:["seed_c_count","seed_d_count"],
        q3:["seed_e_count","seed_f_count"], q4:["seed_g_count","seed_h_count"],
        s1:["seed_a_count","seed_b_count"], s2:["seed_c_count","seed_d_count"],
        final:["seed_a_count","seed_b_count"]
      };

      try{
        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-rsid": RSID
          },
          body: JSON.stringify(post)
        });

        let payload = {};
        try {
          payload = await res.json();
        } catch (e) {
          payload = {};
        }

        if (!res.ok){
          if (res.status === 409 && payload && payload.error === "already_voted") {
            memWrite(base, key, true);
            renderActive();
            alert("You already voted in this battle with this account.");
            return;
          }
          await fetchState(true);
          return;
        }

        const arr = map[activeMatch];
        if (arr){
          const inc = (k) => state[k] = (state[k] || 0) + 1;
          const targetKey = red ? arr[0] : arr[1];
          inc(targetKey);
          renderActive();
        }

        const s = (payload && typeof payload === "object" && "state" in payload)
          ? payload.state
          : payload;
        if (s && typeof s === "object") {
          Object.assign(state, s || {});
        }

        memWrite(base, key, color);
        renderActive();
      } catch {
        await fetchState(true);
      }
    }
    btnActive1.onclick = ()=> vote("red");
    btnActive2.onclick = ()=> vote("blue");

    const prevMatchBtn = document.getElementById("prevMatch");
    const nextMatchBtn = document.getElementById("nextMatch");

    function jumpMatch(delta){
      if (!state) return;
      const keys = order
        .map(o => o.key)
        .filter(k => thumbs[k] && !thumbs[k].box.classList.contains("disabled")
                          && !thumbs[k].box.classList.contains("hidden"));
      if (!keys.length) return;

      let idx = keys.indexOf(activeMatch);
      if (idx === -1) {
        idx = (delta > 0) ? 0 : (keys.length - 1);
      } else {
        idx += delta;
      }

      if (idx < 0 || idx >= keys.length) return;

      activeMatch = keys[idx];
      renderActive();
    }

    if (prevMatchBtn) prevMatchBtn.onclick = () => jumpMatch(-1);
    if (nextMatchBtn) nextMatchBtn.onclick = () => jumpMatch(1);

    function markActive(){
      Object.keys(thumbs).forEach(k=>{
        const box = thumbs[k].box;
        box.classList.toggle("active", k===activeMatch);
      });
    }

    function updateCurrentRoundLabel(){
      if (!currentRoundEl) return;
      if (!state) {
        currentRoundEl.textContent = "Current round: —";
        return;
      }
      let name;
      if (!state.r32_done) {
        name = "Round of 32";
      } else if (!state.r16_done) {
        name = "Round of 16";
      } else if (!state.mid1_done) {
        name = "Quarterfinals";
      } else if (!state.mid2_done) {
        name = "Semifinals";
      } else {
        name = "Final";
      }
      currentRoundEl.textContent = "Current round: " + name;
    }

    function renderActive(){
      if (!state) return;

      const base = state.base_iso || "";
      const mem = memRead(base);
      const metaByUrl = metaByUrlCache();

      const entry = order.find(o=>o.key===activeMatch) || order[0];
      if (!entry) return;

      const label = entry.label || "";

      function pieceMetaHtml(url, fallbackLabel){
        const meta = metaByUrl[url] || {};
        const t = meta.title ? String(meta.title) : "";
        const a = meta.artist ? String(meta.artist) : "";
        if (!t && !a) return fallbackLabel;
        let line = "";
        if (t) line += `"${escapeHtml(t)}"`;
        if (a){
          const safeA = escapeHtml(a);
          line += (line ? " · " : "") +
                  `<a href="profile.html?u=${safeA}" class="artist-link">@${safeA}</a>`;
        }
        return line || fallbackLabel;
      }

      function seedUrl(name){
        return state[name] || null;
      }
      function seedCount(name){
        return state[name] ?? 0;
      }

      let leftUrlKey  = entry.left;
      let rightUrlKey = entry.right;
      let leftCtKey   = entry.lct;
      let rightCtKey  = entry.rct;

      let leftUrl  = leftUrlKey  ? seedUrl(leftUrlKey)  : null;
      let rightUrl = rightUrlKey ? seedUrl(rightUrlKey) : null;
      let leftCt   = leftCtKey   ? seedCount(leftCtKey) : 0;
      let rightCt  = rightCtKey  ? seedCount(rightCtKey): 0;

      if (entry.key === "s1" && state.mid1_done){
        leftUrl  = state.semi_1_left_url;
        rightUrl = state.semi_1_right_url;
        leftCt   = state.semi_1_left_count;
        rightCt  = state.semi_1_right_count;
      }
      if (entry.key === "s2" && state.mid1_done){
        leftUrl  = state.semi_2_left_url;
        rightUrl = state.semi_2_right_url;
        leftCt   = state.semi_2_left_count;
        rightCt  = state.semi_2_right_count;
      }
      if (entry.key === "final" && state.mid2_done){
        leftUrl  = state.mid_winner_1_url;
        rightUrl = state.mid_winner_2_url;
        leftCt   = state.seed_a_count;
        rightCt  = state.seed_b_count;
      }

      const leftIsVid = isVideoUrl(leftUrl);
      const rightIsVid = isVideoUrl(rightUrl);

      if (leftIsVid){
        imgActive1.classList.add("hidden");
        vidActive1.classList.remove("hidden");
        vidActive1.src = leftUrl;
        vidActive1.play().catch(()=>{});
      } else {
        vidActive1.classList.add("hidden");
        try { vidActive1.pause(); } catch(e){}
        imgActive1.classList.remove("hidden");
        imgActive1.src = leftUrl || placeholder("A");
      }

      if (rightIsVid){
        imgActive2.classList.add("hidden");
        vidActive2.classList.remove("hidden");
        vidActive2.src = rightUrl;
        vidActive2.play().catch(()=>{});
      } else {
        vidActive2.classList.add("hidden");
        try { vidActive2.pause(); } catch(e){}
        imgActive2.classList.remove("hidden");
        imgActive2.src = rightUrl || placeholder("B");
      }

      doc.getElementById("countActive1").textContent = leftCt ?? 0;
      doc.getElementById("countActive2").textContent = rightCt ?? 0;

      const fallback1 = label + " — Left";
      const fallback2 = label + " — Right";

      const metaHtml1 = pieceMetaHtml(leftUrl,  fallback1);
      const metaHtml2 = pieceMetaHtml(rightUrl, fallback2);

      activeMeta1.innerHTML = metaHtml1;
      activeMeta2.innerHTML = metaHtml2;

      activeMeta1.classList.toggle("hidden", !metaHtml1);
      activeMeta2.classList.toggle("hidden", !metaHtml2);

      const baseMem = mem[activeMatch] || null;

      const phaseLive = (function(){
        if (activeMatch.startsWith("rr")) return !state.r32_done;
        if (activeMatch.startsWith("r") && !activeMatch.startsWith("rr")) return state.r32_done && !state.r16_done;
        if (activeMatch.startsWith("q")) return state.r16_done && !state.mid1_done;
        if (activeMatch.startsWith("s")) return state.mid1_done && !state.mid2_done;
        if (activeMatch==="final") return state.mid2_done && !state.final_done;
        return false;
      })();

      const picked = baseMem;

      btnActive1.disabled = !!picked || !phaseLive;
      btnActive2.disabled = !!picked || !phaseLive;

      (function updateArrows(){
        const prevBtn = document.getElementById("prevMatch");
        const nextBtn = document.getElementById("nextMatch");
        if (!prevBtn || !nextBtn) return;

        const keys = order
          .map(o => o.key)
          .filter(k => !thumbs[k].box.classList.contains("disabled")
                    && !thumbs[k].box.classList.contains("hidden"));

        const idx = keys.indexOf(activeMatch);

        prevBtn.disabled = (idx <= 0);
        nextBtn.disabled = (idx === -1 || idx >= keys.length - 1);
      })();

      markActive();
      updateCurrentRoundLabel();
    }

    async function fetchState(force=false){
      try{
        const res = await fetch(FUNCTION_URL);
        const data = await res.json();
        const s = (data && typeof data==="object" && "state" in data) ? data.state : data;
        state = Object.assign(state, s || {});

        if (!state.r32_done && !activeMatch.startsWith("rr")){
          activeMatch = "rr1";
        } else if (state.r32_done && !state.r16_done && !activeMatch.startsWith("r")){
          activeMatch = "r1";
        } else if (state.r16_done && !state.mid1_done && !activeMatch.startsWith("q")){
          activeMatch = "q1";
        } else if (state.mid1_done && !state.mid2_done && !activeMatch.startsWith("s")){
          activeMatch = "s1";
        } else if (state.mid2_done && !activeMatch.startsWith("final")){
          activeMatch = "final";
        }

        renderThumbs();
        renderActive();
      }catch(e){
        console.error("fetchState error", e);
      }
    }

    function tick(){
      if (!state?.ends_at){
        requestAnimationFrame(tick);
        return;
      }
      const ms = Math.max(0, new Date(state.ends_at).getTime() - Date.now());

      const SEG_MS = 17_280_000;
      let segMs = ms % SEG_MS;

      const totalSeconds = Math.floor(segMs / 1000);
      let hours   = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;

      const pad = (n)=> String(n).padStart(2,"0");
      elRemain.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

      requestAnimationFrame(tick);
    }

    async function init(){
      await initVoteUserKey().catch(()=>{});
      await fetchState(true);
      tick();
      if (state?.ends_at) hideLoading();
    }

    init().catch(()=>{});

    (function interceptLoading(){
      const originalFetchState = fetchState;
      fetchState = async function(force=false){
        const result = await originalFetchState(force);
        if (state?.ends_at) hideLoading();
        return result;
      };

      const originalTick = tick;
      tick = function(){
        if (state?.ends_at) hideLoading();
        originalTick();
      };
    })();
</script>
</body>
</html>