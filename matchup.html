<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Minimal Matchup (v2 outline)</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#8b8b8b; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif; }
    .wrap { max-width:700px; margin:0 auto; padding:16px 12px 28px; }
    h1 { margin:0 0 10px; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .row { display:flex; align-items:center; gap:10px; }
    .timer {
      font-variant-numeric: tabular-nums;
      font-weight:700; font-size:32px; line-height:1;
      padding:8px 14px; border:1px solid #20242a; border-radius:12px; background:#0f1318;
    }
    .state { color:var(--muted); font-size:12px; }
    .card {
      margin-top:12px; border:1px solid #20242a; border-radius:16px; overflow:hidden; background:#0f1318;
    }
    .imgBox { position:relative; width:100%; aspect-ratio: 3/4; background:#0b0d0f; display:grid; place-items:center; }
    .imgBox img { width:100%; height:100%; object-fit:cover; display:block; }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-top:1px solid #20242a; gap:8px; }
    .label { text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:12px; color:#a1a1a1; }
    .counts { font-variant-numeric: tabular-nums; font-weight:700; }
    button.vote {
      appearance:none; border:1px solid #24303a; background:#131920; color:var(--fg);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    button.vote:disabled { opacity:.6; cursor:default; }
    .hint { margin-top:10px; color:#9aa0a6; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Rage Space — Minimal Matchup (v2)</h1>
    <div class="row">
      <div class="timer" id="tRemain">20.0</div>
      <div class="state" id="tMeta">syncing…</div>
    </div>

    <!-- RED on top -->
    <div class="card" id="cardRed">
      <div class="imgBox"><img id="imgRed" alt="Red contender" /></div>
      <div class="bar">
        <div class="label">Red</div>
        <div class="counts" id="countRed">0</div>
        <button class="vote" id="btnRed">Vote Red</button>
      </div>
    </div>

    <!-- BLUE below -->
    <div class="card" id="cardBlue">
      <div class="imgBox"><img id="imgBlue" alt="Blue contender" /></div>
      <div class="bar">
        <div class="label">Blue</div>
        <div class="counts" id="countBlue">0</div>
        <button class="vote" id="btnBlue">Vote Blue</button>
      </div>
    </div>

    <div class="hint">Timer auto-loops every 20s. A winner is decided at 0 (random if tied).</div>
  </div>

  <script>
    // <<< CHANGE THIS AFTER YOU DEPLOY >>>
    const FUNCTION_URL = "https://YOUR-PROJECT.functions.supabase.co/global-timer-v2";

    const elRemain = document.getElementById('tRemain');
    const elMeta = document.getElementById('tMeta');
    const imgRed = document.getElementById('imgRed');
    const imgBlue = document.getElementById('imgBlue');
    const cRed = document.getElementById('countRed');
    const cBlue = document.getElementById('countBlue');
    const btnRed = document.getElementById('btnRed');
    const btnBlue = document.getElementById('btnBlue');

    let state = {
      ends_at: null,
      period_sec: 20,
      base_iso: null,
      red_url: '',
      blue_url: '',
      red_count: 0,
      blue_count: 0,
      remaining_ms: 0,
    };

    async function fetchState() {
      const res = await fetch(FUNCTION_URL, { method: 'GET' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'GET failed');

      state.ends_at = data.ends_at;
      state.period_sec = data.period_sec;
      state.base_iso = data.base_iso;
      state.red_url = data.red_url;
      state.blue_url = data.blue_url;
      state.red_count = data.red_count;
      state.blue_count = data.blue_count;
      state.remaining_ms = data.remaining_ms;

      imgRed.src = state.red_url;
      imgBlue.src = state.blue_url;
      cRed.textContent = state.red_count;
      cBlue.textContent = state.blue_count;

      elMeta.textContent = `cycle: ${state.base_iso} • period: ${state.period_sec}s`;
    }

    async function sendVote(color) {
      try {
        const res = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ color })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'vote failed');
        if (!data.ignored) {
          cRed.textContent = data.red_count;
          cBlue.textContent = data.blue_count;
        }
      } catch (e) {
        console.log('vote error', e);
      }
    }

    // UI
    btnRed.addEventListener('click', async () => {
      btnRed.disabled = btnBlue.disabled = true;
      await sendVote('red');
      setTimeout(() => { btnRed.disabled = btnBlue.disabled = false; }, 400);
    });
    btnBlue.addEventListener('click', async () => {
      btnRed.disabled = btnBlue.disabled = true;
      await sendVote('blue');
      setTimeout(() => { btnRed.disabled = btnBlue.disabled = false; }, 400);
    });

    // Timer render loop
    let rafId = 0;
    function tick() {
      const remain = new Date(state.ends_at).getTime() - Date.now();
      const clamped = Math.max(0, remain);
      elRemain.textContent = (clamped / 1000).toFixed(1);

      // when we cross 0, quickly resync to get the next images / reset counts
      if (remain <= -900) {
        // small debounce to let server roll forward
        fetchState().catch(console.error);
      }
      rafId = requestAnimationFrame(tick);
    }

    // Light polling to keep counts fresh every 1s
    setInterval(() => fetchState().catch(() => {}), 1000);

    // Boot
    (async () => {
      elMeta.textContent = 'syncing…';
      await fetchState();
      if (rafId) cancelAnimationFrame(rafId);
      tick();
    })();
  </script>
</body>
</html>