<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Supabase Global 10s Timer</title>
  <style>
    html,body { height:100%; margin:0; font-family:system-ui, Arial, sans-serif; background:#0b0b0b; color:#fff; }
    .wrap { height:100%; display:grid; place-items:center; gap:16px; }
    .clock { font-size: clamp(48px, 12vw, 160px); font-weight: 800; letter-spacing: 0.02em; }
    .row { display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; }
    button { background:#1f1f1f; color:#fff; border:1px solid #333; border-radius:10px; padding:8px 12px; cursor:pointer; }
    button:hover { background:#262626; }
    .muted { opacity:0.7; font-size:14px; }
    .error { color:#ff6b6b; }
    .tag { font-size:12px; padding:2px 6px; border:1px solid #444; border-radius:999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="clock" id="clock">—</div>
    <div class="row">
      <button id="refresh">Sync</button>
      <button id="force">Force next (test)</button>
      <button id="pauseToggle">Pause</button>
      <span class="muted" id="info"></span>
      <span class="tag" id="status">LIVE</span>
    </div>
  </div>

  <script>
    // Your deployed Edge Function endpoint:
    const EDGE_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer";

    let phaseEnd = null;   // ISO string from server
    let periodSec = 10;
    let paused = false;    // authoritative flag from server
    let rafId = null;
    let lastSyncAt = 0;
    let lastShown = '—';   // remember text while paused

    const clockEl  = document.getElementById('clock');
    const infoEl   = document.getElementById('info');
    const statusEl = document.getElementById('status');
    const btnSync  = document.getElementById('refresh');
    const btnForce = document.getElementById('force');
    const btnPause = document.getElementById('pauseToggle');

    async function callEdge(method = 'GET', body = null) {
      const res = await fetch(EDGE_URL, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : null
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || res.statusText);
      return json;
    }

    async function fetchState() {
      const json = await callEdge('GET');
      phaseEnd = json.state.phase_end_at;
      periodSec = json.state.period_sec;
      paused = !!json.state.paused;
      lastSyncAt = Date.now();

      // Update UI bits
      infoEl.textContent = `period=${periodSec}s  |  phase_end_at=${phaseEnd}  |  paused=${paused}`;
      statusEl.textContent = paused ? 'PAUSED' : 'LIVE';
      btnPause.textContent = paused ? 'Resume' : 'Pause';
    }

    function tick() {
      if (!phaseEnd) {
        clockEl.textContent = '…';
        rafId = requestAnimationFrame(tick);
        return;
      }

      if (paused) {
        // Freeze the display while globally paused
        if (lastShown !== null) clockEl.textContent = lastShown;
        statusEl.textContent = 'PAUSED';
        rafId = requestAnimationFrame(tick);
        return;
      } else {
        statusEl.textContent = 'LIVE';
      }

      const endMs = Date.parse(phaseEnd);
      const remMs = Math.max(0, endMs - Date.now());
      const secs = Math.ceil(remMs / 1000);
      clockEl.textContent = lastShown = String(secs);

      // When it hits zero, re-sync authoritative state (server will roll forward if needed)
      if (remMs <= 0) {
        fetchState().catch(err => {
          console.error(err);
          clockEl.textContent = 'ERR';
          infoEl.textContent = err.message;
          infoEl.classList.add('error');
        });
      }

      // Passive resync every 5s to fix drift/tab sleep
      if (Date.now() - lastSyncAt > 5000) {
        fetchState().catch(console.warn);
      }

      rafId = requestAnimationFrame(tick);
    }

    // Button handlers
    btnSync.addEventListener('click', () =>
      fetchState().catch(err => alert(err.message))
    );

    btnForce.addEventListener('click', async () => {
      try {
        // Force next works even if paused (server overrides)
        const json = await callEdge('POST', { force: true });
        phaseEnd = json.state.phase_end_at;
        periodSec = json.state.period_sec;
        paused = !!json.state.paused;
        infoEl.textContent = `period=${periodSec}s  |  phase_end_at=${phaseEnd}  |  paused=${paused}`;
      } catch (e) {
        alert(e.message);
      }
    });

    btnPause.addEventListener('click', async () => {
      try {
        // Toggle global pause on the server
        const wantPause = !paused;
        const json = await callEdge('POST', { pause: wantPause });
        phaseEnd = json.state.phase_end_at;   // server may have rolled/bumped
        periodSec = json.state.period_sec;
        paused = !!json.state.paused;

        // If just paused, freeze what’s shown now
        if (paused) lastShown = clockEl.textContent;

        btnPause.textContent = paused ? 'Resume' : 'Pause';
        statusEl.textContent = paused ? 'PAUSED' : 'LIVE';
        infoEl.textContent = `period=${periodSec}s  |  phase_end_at=${phaseEnd}  |  paused=${paused}`;
      } catch (e) {
        alert(e.message);
      }
    });

    // Boot
    fetchState()
      .then(() => tick())
      .catch((e) => {
        clockEl.textContent = 'ERR';
        infoEl.textContent = e.message;
        infoEl.classList.add('error');
        console.error(e);
      });
  </script>
</body>
</html>