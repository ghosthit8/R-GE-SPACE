<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space ‚Äî Matchup (Auto-Decide Every 10s)</title>
  <style>
    :root{
      --green:#39ff14; --green-bright:#7dff62; --red:#ff0033; --bg:#000; --ink:#e5ffe5; --card:#070707; --border:#0f2510;
      --muted:#8aff8a; --maxw:980px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--green);
      font-family: ui-sans-serif,system-ui,Arial,Helvetica,sans-serif; -webkit-font-smoothing:antialiased;
    }

    .wrap{ max-width:var(--maxw); margin:16px auto 64px; padding:0 16px; }
    header.wrap{ padding-top:0 }
    h1{ letter-spacing:.06em; margin:0 0 8px }

    .scorebar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      border:1px solid var(--border); padding:8px 12px; border-radius:10px;
      background:rgba(7,7,7,.6); box-shadow:0 0 18px rgba(57,255,20,.08) inset;
      flex-wrap: wrap;
    }
    .badge{ font-size:.9rem; color:var(--ink); opacity:.78 }
    .tag{ font-size:.8rem; padding:3px 10px; border:1px solid var(--border); border-radius:999px; opacity:.9 }
    .btn{
      border:1px solid var(--green); color:var(--green); text-decoration:none; padding:8px 12px;
      border-radius:10px; display:inline-flex; align-items:center; gap:8px; background:transparent; cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease, background-color .15s ease, color .15s ease, border-color .15s ease, filter .15s ease;
    }
    .btn.primary{ background:rgba(57,255,20,.08) }
    .btn:hover:not(:disabled){ transform: translateY(-1px); box-shadow:0 0 14px rgba(57,255,20,.18) }
    .btn:active:not(:disabled){ transform: translateY(0) scale(.99) }
    .btn:disabled{ opacity:.45; cursor:not-allowed }

    .btn.primary.selected{
      background:rgba(57,255,20,.22);
      color:var(--green-bright);
      border-color: var(--green-bright);
      box-shadow: 0 0 22px rgba(125,255,98,.35), inset 0 0 18px rgba(57,255,20,.15);
      filter: saturate(120%);
      animation: pulse-green .9s ease-out 1;
    }
    @keyframes pulse-green{
      0%{ box-shadow: 0 0 0 rgba(125,255,98,0) }
      40%{ box-shadow: 0 0 26px rgba(125,255,98,.45), inset 0 0 22px rgba(57,255,20,.25) }
      100%{ box-shadow: 0 0 22px rgba(125,255,98,.35), inset 0 0 18px rgba(57,255,20,.15) }
    }

    .tiny-timer{ display:inline-flex; align-items:center; gap:8px; font-variant-numeric:tabular-nums;
      font-size:12px; color:var(--muted); opacity:.95 }
    .tiny-clock{ font-size:13px; font-weight:700; padding:2px 8px; border:1px solid var(--border); border-radius:8px;
      text-shadow:0 0 6px rgba(57,255,20,.35) }
    .paused{ opacity:.65 }

    .stack{ margin-top:16px; display:grid; grid-template-columns:1fr; gap:16px }
    .tile{
      border:1px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(7,7,7,.6); position:relative;
      transition: box-shadow .2s ease, transform .18s ease;
    }
    .tile.chosen{ outline:2px solid var(--green);
      box-shadow:0 0 18px rgba(57,255,20,.35) inset, 0 0 14px rgba(57,255,20,.25); animation: throb 1.2s ease-in-out infinite }
    @keyframes throb{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.01)} }
    .art{ aspect-ratio:4/3; width:100%; display:block }
    .art.red{ background:repeating-linear-gradient(45deg,#3a0000 0,#3a0000 12px,#5a0000 12px,#5a0000 24px),#a60000 }
    .art.blue{ background:repeating-linear-gradient(45deg,#001c3a 0,#001c3a 12px,#00325a 12px,#00325a 24px),#0058a6 }

    .meta{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 12px; border-top:1px solid var(--border) }
    .label{ color:var(--ink); opacity:.8 }
    .vote-row{ margin-top:16px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap }

    .counts{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:10px; font-variant-numeric:tabular-nums }
    .count-chip{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:var(--ink); opacity:.9 }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#0a0a0a; color:#e5ffe5;
      border:1px solid var(--border); border-radius:12px; padding:10px 14px; display:none; box-shadow:0 0 18px rgba(57,255,20,.2); z-index:9999 }

    .winner-ribbon{ position:absolute; top:10px; left:10px; background:#0a0a0a; border:1px solid var(--border);
      border-radius:10px; padding:6px 10px; color:var(--ink); font-weight:700; display:none; box-shadow:0 0 18px rgba(57,255,20,.25) }
    .tile.win .winner-ribbon{ display:block }

    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:9998 }
  </style>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="wrap">
    <h1>R<span class="anarchy">‚í∂</span>GE SPACE ‚Äî MATCHUP</h1>
    <div class="badge">Stacked demo ¬∑ Red vs Blue ¬∑ winner decided every 10s</div>
  </header>

  <div class="wrap">
    <div class="scorebar">
      <div class="tiny-timer">
        <span>Decision in</span>
        <span id="tinyClock" class="tiny-clock">‚Äî</span>
        <span id="tinyState" class="tag">LIVE</span>
      </div>

      <div class="badge">Round <span id="roundNum">1</span>, Match <span id="battleIndex">1</span>/<span id="battleTotal">1</span></div>

      <div class="badge counts">
        <span class="count-chip">Red votes: <b id="countRed">0</b></span>
        <span class="count-chip">Blue votes: <b id="countBlue">0</b></span>
      </div>

      <button class="btn" id="pauseBtn" title="Pause or resume global timer">‚èØÔ∏è Pause</button>
    </div>

    <div class="stack" id="stack">
      <div class="tile" id="topTile">
        <div class="winner-ribbon">üèÜ Winner</div>
        <div class="art red" id="topArt" aria-label="Top entry ‚Äî RED"></div>
        <div class="meta">
          <span class="label" id="topLabel">Entry ‚Äî RED</span>
          <button class="btn primary" id="voteTop">Vote Red (Top)</button>
        </div>
      </div>

      <div class="tile" id="bottomTile">
        <div class="winner-ribbon">üèÜ Winner</div>
        <div class="art blue" id="bottomArt" aria-label="Bottom entry ‚Äî BLUE"></div>
        <div class="meta">
          <span class="label" id="bottomLabel">Entry ‚Äî BLUE</span>
          <button class="btn primary" id="voteBottom">Vote Blue (Bottom)</button>
        </div>
      </div>
    </div>

    <div class="vote-row">
      <button class="btn" id="submitBtn" disabled>‚úÖ Submit Vote</button>
      <!-- now both point to winners.html -->
      <a class="btn" href="winners.html" target="_blank" rel="noopener">üèÅ Winners</a>
      <a class="btn" href="winners.html" target="_blank" rel="noopener">üìù Test Log</a>
    </div>
  </div>

  <canvas id="confetti"></canvas>
  <div id="toast" class="toast"></div>

  <script>
    /* ========= Supabase ========= */
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= Edge timer ========= */
    const EDGE_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer";

    let serverPhaseEndISO = null;
    let periodSec = 10;
    let paused = false;
    let remainingSec = null;
    let lastSyncAt = 0;
    let rafId = null;
    let decidedForPhaseKey = null;

    const tinyClock = document.getElementById('tinyClock');
    const tinyState = document.getElementById('tinyState');
    const pauseBtn  = document.getElementById('pauseBtn');

    function setTinyState() {
      tinyState.textContent = paused ? "PAUSED" : "LIVE";
      pauseBtn.textContent  = paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
      tinyClock.classList.toggle('paused', paused);
    }
    function showTinyError(msg){ tinyClock.textContent='ERR'; console.error(msg); }
    async function callEdge(method='GET', body=null){
      const res = await fetch(EDGE_URL,{ method, headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null });
      const json = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(json?.error||res.statusText);
      return json;
    }
    async function fetchState(){
      const json = await callEdge('GET');
      const s = json.state;
      const newPhaseISO = s.phase_end_at ?? null;
      const phaseChanged = !!serverPhaseEndISO && newPhaseISO && newPhaseISO !== serverPhaseEndISO;

      serverPhaseEndISO = newPhaseISO;
      periodSec   = s.period_sec ?? 10;
      paused      = !!s.paused;
      remainingSec= s.remaining_sec ?? null;
      lastSyncAt  = Date.now();
      setTinyState();

      if (phaseChanged) beginNewRound();
      return s;
    }
    function stopTiny(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; }
    async function startTiny(){
      stopTiny();
      const draw = async () => {
        try{
          if (paused){
            const n = Math.max(0, Math.ceil(Number(remainingSec ?? 0)));
            tinyClock.textContent = String(n);
          } else {
            const endMs = Date.parse(serverPhaseEndISO);
            const remMs = Math.max(0, endMs - Date.now());
            const secs  = Math.ceil(remMs/1000);
            tinyClock.textContent = String(secs);

            if (remMs <= 0){
              if (serverPhaseEndISO && decidedForPhaseKey !== serverPhaseEndISO){
                decidedForPhaseKey = serverPhaseEndISO;
                decideWinnerNow();
              }
              const s = await fetchState();
              if (s.paused) tinyClock.textContent = String(Math.max(0, Math.ceil(Number(s.remaining_sec ?? 0))));
            } else if (Date.now() - lastSyncAt > 5000){
              const s = await fetchState();
              if (s.paused) tinyClock.textContent = String(Math.max(0, Math.ceil(Number(s.remaining_sec ?? 0))));
            }
          }
        }catch(e){ showTinyError(e.message); return; }
        rafId = requestAnimationFrame(draw);
      };
      rafId = requestAnimationFrame(draw);
    }
    pauseBtn.addEventListener('click', async ()=>{
      try{
        if (paused) await callEdge('POST',{action:'resume'}); else await callEdge('POST',{action:'pause'});
        await fetchState();
      }catch(e){ showTinyError(e.message); }
    });

    const roundNumEl = document.getElementById('roundNum');
    const battleIndexEl = document.getElementById('battleIndex');
    const battleTotalEl = document.getElementById('battleTotal');
    const topTile = document.getElementById('topTile');
    const bottomTile = document.getElementById('bottomTile');
    const voteTopBtn = document.getElementById('voteTop');
    const voteBottomBtn = document.getElementById('voteBottom');
    const submitBtn = document.getElementById('submitBtn');
    const toastEl = document.getElementById('toast');
    const countRedEl = document.getElementById('countRed');
    const countBlueEl= document.getElementById('countBlue');

    const BATTLES = [{
      id:'SIM_1',
      round:1, indexInRound:1, total:1,
      A:{ id:'RED',  name:'RED',  color:'red' },
      B:{ id:'BLUE', name:'BLUE', color:'blue' }
    }];

    let idx = 0;
    let chosen = null;
    let submitted = false;
    let votesA = 0;
    let votesB = 0;

    const lockKey = (id)=> `rs_vote_${id}`;
    const winnersKey = 'rs_winners_v1';

    function showToast(msg){
      toastEl.textContent = msg; toastEl.style.display='block';
      clearTimeout(showToast._t); showToast._t=setTimeout(()=> toastEl.style.display='none',1400);
    }
    function setButtonHighlight(){
      voteTopBtn.classList.toggle('selected', chosen==='A');
      voteBottomBtn.classList.toggle('selected', chosen==='B');
      topTile.classList.toggle('chosen', chosen==='A');
      bottomTile.classList.toggle('chosen', chosen==='B');
    }
    function updateCountsUI(){
      countRedEl.textContent = String(votesA);
      countBlueEl.textContent= String(votesB);
    }
    function clearWinnerUI(){ topTile.classList.remove('win'); bottomTile.classList.remove('win'); }
    function markWinnerUI(who){ if(who==='A') topTile.classList.add('win'); if(who==='B') bottomTile.classList.add('win'); }
    function readWinners(){ try{ return JSON.parse(localStorage.getItem(winnersKey)||'[]') }catch{ return [] } }
    function pushWinner(w){ const arr=readWinners(); arr.unshift(w); localStorage.setItem(winnersKey, JSON.stringify(arr.slice(0,500))); }

    function render(){
      const b = BATTLES[idx];
      roundNumEl.textContent = b.round;
      battleIndexEl.textContent = b.indexInRound;
      battleTotalEl.textContent = b.total;

      chosen=null; submitted=false;
      submitBtn.disabled=true; submitBtn.textContent='‚úÖ Submit Vote';
      setButtonHighlight(); clearWinnerUI();

      votesA=0; votesB=0; updateCountsUI();
      localStorage.removeItem(lockKey(b.id));
      voteTopBtn.disabled=false; voteBottomBtn.disabled=false;
    }

    voteTopBtn.addEventListener('click', ()=>{
      if (voteTopBtn.disabled) return;
      chosen='A'; submitBtn.disabled=false; setButtonHighlight(); showToast('Selected: RED');
    });
    voteBottomBtn.addEventListener('click', ()=>{
      if (voteBottomBtn.disabled) return;
      chosen='B'; submitBtn.disabled=false; setButtonHighlight(); showToast('Selected: BLUE');
    });

    submitBtn.addEventListener('click', ()=>{
      const b = BATTLES[idx];
      if(!chosen || submitted) return;
      if (chosen==='A') votesA+=1; else votesB+=1;
      updateCountsUI();
      submitted=true; localStorage.setItem(lockKey(b.id), chosen);
      submitBtn.textContent='üéâ Vote submitted!'; submitBtn.disabled=true;
      voteTopBtn.disabled=true; voteBottomBtn.disabled=true;
      confettiBurst(); showToast(`Vote submitted: ${chosen==='A'?'RED':'BLUE'}`);
    });

    async function decideWinnerNow(){
      let who=null;
      if (votesA>votesB) who='A'; else if (votesB>votesA) who='B'; else who=Math.random()<0.5?'A':'B';
      markWinnerUI(who);
      const b=BATTLES[idx]; const picked=(who==='A')?b.A:b.B;

      // 1) Keep local for backward-compat
      pushWinner({ ts:Date.now(), id:picked.id, name:picked.name, color:picked.color });

      // 2) Insert into Supabase (dedupe by phase_key if your SQL has a UNIQUE constraint)
      try{
        await supabase.from('winners').insert({
          decided_at: new Date().toISOString(),
          color: picked.color,
          name: picked.name,
          phase_key: serverPhaseEndISO || null,     // 10s phase identifier
          round_num: b.round,
          meta: { battle_id: b.id }
        });
      }catch(e){
        console.error('Supabase insert error:', e);
      }

      confettiBurst();

      // Optional: ping other tabs that still rely on localStorage listeners
      localStorage.setItem('rs_winners_ping_v1', String(Date.now()));
    }

    function beginNewRound(){ render(); }

    function confettiBurst(){
      const canvas=document.getElementById('confetti');
      const ctx=canvas.getContext('2d');
      const DPR=Math.max(1,window.devicePixelRatio||1);
      function resize(){ canvas.width=Math.floor(window.innerWidth*DPR); canvas.height=Math.floor(window.innerHeight*DPR); }
      resize();
      let particles=[]; const N=120;
      for(let i=0;i<N;i++){
        particles.push({ x:canvas.width/2+(Math.random()-0.5)*canvas.width*0.2, y:canvas.height*0.3+(Math.random()-0.5)*canvas.height*0.1,
          vx:(Math.random()-0.5)*6*DPR, vy:(Math.random()*-4-2)*DPR, g:0.25*DPR, a:1, r:Math.random()*3*DPR+2*DPR, life:900+Math.random()*400 });
      }
      const start=performance.now();
      (function tick(){
        const t=performance.now(); const dt=(t-(tick._last||t))/16.67; tick._last=t;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach(p=>{ p.vx*=0.99; p.vy+=p.g; p.x+=p.vx*dt; p.y+=p.vy*dt; p.a*=0.986;
          ctx.globalAlpha=Math.max(0,p.a); ctx.fillStyle=(Math.random()<0.5)?'#39ff14':'#7dff62';
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha=1;
        particles=particles.filter(p=>p.a>0.04 && p.y<canvas.height+40*DPR);
        if (t-start<1200 && particles.length) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height);
      })();
      window.addEventListener('resize', resize, { once:true });
    }

    (async ()=>{ 
      try{ 
        await fetchState();
        beginNewRound();
        await startTiny();
      } catch(e){ showTinyError(e.message); } 
    })();
  </script>
</body>
</html>