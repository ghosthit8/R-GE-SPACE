<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rage Space ‚Äî Matchup</title>

  <!-- Optional: these are injected by JS if missing -->
  <meta name="supabase-url" content="https://tuqvpcevrhciursxrgav.supabase.co" />
  <meta name="supabase-anon-key" content="" />

  <style>
    :root { --bg:#000; --fg:#d4ffd9; --muted:#79a07f; --line:#0f3; --accent:#39ff14; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .wrap{max-width:980px;margin:16px auto;padding:12px}
    .hud{border:1px solid var(--line);border-radius:14px;padding:14px;background:#060606}
    .hud .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{padding:4px 10px;border:1px solid var(--line);border-radius:999px;color:var(--fg);font-size:12px}
    .chip .k{opacity:.7;margin-right:6px}
    .btn{padding:8px 12px;border:1px solid var(--line);background:#050; color:var(--fg); border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn[data-variant="warn"]{background:#1a1a00}
    .btn[data-variant="danger"]{background:#330}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px dashed var(--line);border-radius:16px;padding:12px;min-height:300px;background:#050505;position:relative}
    .title{color:var(--accent);font-weight:700;margin:0 0 6px}
    .votes{position:absolute;left:0;right:0;bottom:10px;text-align:center;color:var(--muted)}
    .imgwrap{display:block;overflow:hidden;border-radius:10px;border:1px solid #113}
    .imgwrap img{display:block;width:100%;height:300px;object-fit:cover;background:#0b0b0b}

    /* Loader overlay */
    #bootLoader{position:fixed;inset:0;display:grid;place-items:center;background:#000;z-index:9999}
    #bootLoader .inner{text-align:center}
    #bootLoader h1{letter-spacing:.25em;color:var(--accent);font-weight:800;font-size:14px;margin:0 0 16px}
    #bootLoader .bar{height:10px;border-radius:20px;background:#032;border:1px solid #0a2;width:min(720px,86vw);margin:0 auto}
    #bootLoader .bar::after{content:"";display:block;height:100%;width:64%;background:var(--accent);border-radius:20px}
    #boot-status{margin-top:16px;color:#8cff9b;font-size:12px}

    /* Tiny toast (optional) */
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#081; color:#eaffea; border:1px solid var(--line); padding:8px 12px;border-radius:999px;opacity:0;pointer-events:none;transition:opacity .2s}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <!-- Boot overlay (hidden by JS once ready) -->
  <div id="bootLoader">
    <div class="inner">
      <h1>RAGE SPACE ‚Äî SYNCING‚Ä¶</h1>
      <div class="bar"></div>
      <div id="boot-status">starting‚Ä¶</div>
    </div>
  </div>

  <div id="toast"></div>

  <div class="wrap">
    <!-- HUD -->
    <div class="hud">
      <div class="row" style="margin-bottom:10px">
        <span class="chip"><span class="k">Decision in</span><strong id="decisionIn" data-decision-in>--:--</strong></span>
        <span class="chip"><span class="k">Sync</span><strong id="syncLabel" data-sync-label>Syncing‚Ä¶</strong></span>
        <span class="chip"><span class="k">phase:</span><strong id="phaseLabel" data-phase-label>‚Äî</strong></span>
      </div>
      <div class="row">
        <button class="btn" id="btnForceDecide">‚ö° Force decide</button>
        <button class="btn" id="btnReset30">üîÅ Reset 30s</button>
        <button class="btn" id="btnPauseResume" data-state="run">‚è∏Ô∏è Pause</button>
        <a class="btn" href="./winners.html">üèÅ Winners</a>
      </div>
    </div>

    <!-- Entries -->
    <div class="grid">
      <div class="card" id="entry-left" data-entry="left">
        <div class="title" data-title>Entry Left</div>
        <a class="imgwrap" href="javascript:void(0)"><img loading="lazy" alt="" /></a>
        <div class="votes" data-votes>0 votes</div>
        <div style="margin-top:8px"><button class="btn">Vote This</button></div>
      </div>

      <div class="card" id="entry-right" data-entry="right">
        <div class="title" data-title>Entry Right</div>
        <a class="imgwrap" href="javascript:void(0)"><img loading="lazy" alt="" /></a>
        <div class="votes" data-votes>0 votes</div>
      </div>
    </div>
  </div>

  <!-- Your robust timer + controls script (ES5 safe) -->
  <script src="./js/main.v3.js?v=2025-10-21-03"></script>

  <!-- Minimal renderer so the HUD & cards update when the timer sync returns -->
  <script>
    window.applyBaseAndPeriod = function (state) {
      try {
        console.log('[applyBaseAndPeriod] state:', state);
        var phase = (state && (state.phase || state.phase_key)) || '‚Äî';
        var endAt = state && (state.phase_end_at || state.ends_at || null);
        var remain = Number(state && state.remaining_sec);
        if (!isFinite(remain) || remain <= 0) {
          var endMs = Date.parse(endAt || 0);
          remain = endMs ? Math.max(0, Math.ceil((endMs - Date.now())/1000)) : 0;
        }
        var phaseEl = document.getElementById('phaseLabel');
        var decideEl = document.getElementById('decisionIn');
        var syncEl = document.getElementById('syncLabel');
        if (phaseEl) phaseEl.textContent = String(phase);
        if (syncEl) syncEl.textContent = 'Synced';
        if (decideEl) decideEl.textContent = new Date(remain*1000).toISOString().substr(14,5);
        ensureEntryCard('left');
        ensureEntryCard('right');
      } catch (e) {
        console.warn('applyBaseAndPeriod failed:', e);
      }
    };

    function ensureEntryCard(side){
      var root = document.querySelector('[data-entry="'+side+'"]') || document.getElementById('entry-'+side);
      if (!root) return;
      var img = root.querySelector('img');
      var title = root.querySelector('[data-title]');
      var votes = root.querySelector('[data-votes]');
      if (img && !img.src) {
        img.alt = 'Placeholder';
        img.src = 'https://placehold.co/800x600/0b0b0b/39ff14?text=Rage+Space';
      }
      if (title && !title.textContent.trim()) title.textContent = 'Entry ' + (side==='left' ? 'Left' : 'Right');
      if (votes && !votes.textContent.trim()) votes.textContent = '0 votes';
    }

    // Smooth client-side countdown between server syncs
    (function tickDecision(){
      var el = document.getElementById('decisionIn');
      if (el){
        var parts = (el.textContent || '00:00').split(':');
        var mm = parseInt(parts[0]||'0',10), ss = parseInt(parts[1]||'0',10);
        if (isFinite(mm) && isFinite(ss)){
          var t = mm*60 + ss; if (t>0) t -= 1;
          el.textContent = new Date(Math.max(0,t)*1000).toISOString().substr(14,5);
        }
      }
      setTimeout(tickDecision, 1000);
    })();
  </script>
</body>
</html>