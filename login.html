<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî Login</title>

  <!-- IMPORTANT: relative path for GitHub Pages -->
  <link rel="stylesheet" href="./style.css?v=2" />

  <style>
    .hidden { display:none !important; }

    /* üî• Make the green Sign In button text black */
    .btn.primary {
      color: #000 !important;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <a class="back-btn" href="./index.html">‚Üê Back to Home</a>

    <h1>RAGE SPACE ‚Äî LOGIN</h1>

    <section class="card" id="signin-card">
      <h3>Sign in</h3>

      <input id="identifier" type="text" placeholder="username or email" />
      <input id="password" type="password" placeholder="password" />

      <div class="topbar" style="justify-content:flex-start; gap:8px">
        <button id="signin" class="btn primary">Sign in</button>
        <button id="forgot" class="btn">Forgot password?</button>
      </div>

      <div id="status" class="muted">Not logged in.</div>
      <div id="err" class="error"></div>

      <p class="muted">
        Need an account?
        <a class="link" href="./signup.html">Go to Sign up</a>
      </p>
    </section>

    <section class="card hidden" id="reset-card">
      <h3>Set a new password</h3>
      <input id="newpass" type="password" placeholder="new password" />
      <input id="newpass2" type="password" placeholder="confirm new password" />
      <button id="setpass" class="btn primary">Update password</button>
      <div id="reset-status" class="muted"></div>
      <div id="reset-err" class="error"></div>
    </section>
  </main>

  <script type="module">
    /* =========================================================
       Robust Supabase loader with CDN fallbacks
       ========================================================= */
    async function loadSupabase() {
      const esmCDNs = [
        "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm",
        "https://esm.sh/@supabase/supabase-js@2"
      ];

      for (const url of esmCDNs) {
        try {
          const mod = await import(url);
          if (mod?.createClient) return mod.createClient;
        } catch (e) {
          console.warn("Supabase ESM failed:", url, e);
        }
      }

      // Final fallback: UMD
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js";
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });

      if (window.supabase?.createClient) {
        return window.supabase.createClient;
      }

      throw new Error("All Supabase CDNs failed");
    }

    let createClient;
    try {
      createClient = await loadSupabase();
    } catch (e) {
      document.getElementById("err").textContent =
        "Couldn't load Supabase. Network / Private DNS / adblock is blocking CDNs.";
      console.error(e);
      throw e;
    }

    /* =========================================================
       Supabase config (YOUR KEYS)
       ========================================================= */
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    /* =========================================================
       Auto-redirect if already logged in
       ========================================================= */
    {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        location.replace("./index.html");
        throw new Error("Already logged in");
      }
    }

    /* =========================================================
       Helpers
       ========================================================= */
    const el = (id) => document.getElementById(id);
    const status = el("status");
    const err = el("err");
    const signinBtn = el("signin");

    const looksLikeEmail = (v) =>
      /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

    const showErr = (m = "") => {
      err.textContent = m;
      if (m) console.error(m);
    };

    const showStatus = (m = "") => {
      status.textContent = m;
    };

    /* =========================================================
       Username ‚Üí email resolver (RPC)
       ========================================================= */
    async function resolveEmail(identifier) {
      if (looksLikeEmail(identifier)) return identifier;

      const { data, error } = await supabase.rpc(
        "email_for_username",
        { uname: identifier }
      );

      if (error || !data) {
        showErr("Username not found. Try your email.");
        return null;
      }
      return data;
    }

    /* =========================================================
       Sign-in
       ========================================================= */
    async function handleSignin(ev) {
      ev?.preventDefault?.();
      showErr("");

      const id = el("identifier").value.trim();
      const password = el("password").value;

      if (!id || !password) {
        showErr("Enter your username/email and password.");
        return;
      }

      signinBtn.disabled = true;
      showStatus("Signing in‚Ä¶");

      try {
        const email = await resolveEmail(id);
        if (!email) return;

        const { error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          showErr(error.message);
          showStatus("Not logged in.");
          return;
        }

        showStatus("Logged in. Redirecting‚Ä¶");
        setTimeout(() => location.href = "./index.html", 600);
      } finally {
        signinBtn.disabled = false;
      }
    }

    /* =========================================================
       Password reset
       ========================================================= */
    async function handleForgot() {
      showErr("");

      const id = el("identifier").value.trim();
      if (!id) return showErr("Enter username or email first.");

      const email = await resolveEmail(id);
      if (!email) return;

      const redirectTo = new URL("./login.html", location.href).toString();
      const { error } =
        await supabase.auth.resetPasswordForEmail(email, { redirectTo });

      if (error) showErr(error.message);
      else showStatus("Reset email sent.");
    }

    /* =========================================================
       Events
       ========================================================= */
    el("signin").addEventListener("click", handleSignin);
    el("forgot").addEventListener("click", handleForgot);

    ["identifier", "password"].forEach((id) =>
      el(id).addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSignin(e);
      })
    );
  </script>
</body>
</html>