<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space — Sign up</title>
  <link rel="stylesheet" href="style.css?v=2" />
</head>
<body>
  <main class="wrap">
    <a class="back-btn" href="./index.html">← Back to Home</a>
    <h1>RAGE SPACE — SIGN UP</h1>

    <section class="card">
      <h3>Create your account</h3>

      <label for="dob">Date of birth (18+ only)</label>
      <input id="dob" type="date" placeholder="YYYY-MM-DD" />

      <label class="muted" style="display:flex;align-items:center;gap:8px" for="attest">
        <input id="attest" type="checkbox" />
        I confirm I am 18+ and agree to the Terms.
      </label>

      <input id="username" type="text" placeholder="choose a username (required)" />
      <div id="username-msg" class="muted"></div>

      <input id="email" type="email" placeholder="email@example.com" />
      <input id="password" type="password" placeholder="password" />

      <button id="signup" class="btn primary">Sign up</button>

      <div id="status" class="muted">Not signed up yet.</div>
      <div id="err" class="error"></div>

      <p class="muted">Already have an account? <a class="link" href="./login.html">Go to Login</a></p>
    </section>
  </main>

  <script type="module">
    const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm")
      .catch((e) => { document.getElementById("err").textContent = "Couldn't load Supabase."; throw e; });

    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const el = (id) => document.getElementById(id);
    const status = el("status"), err = el("err"), btn = el("signup");
    const usernameInput = el("username"), usernameMsg = el("username-msg");

    const showErr = (m="") => { err.textContent = m; if (m) console.error(m); if (m) showStatus(""); };
    const showStatus = (m="") => { status.textContent = m; };
    const looksLikeEmail = (e) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
    const validUsername = (u) => /^[a-zA-Z0-9_]{3,20}$/.test(u);

    // tiny timeout guard so no promise can hang the UI silently
    const withTimeout = (p, ms, label="request") =>
      Promise.race([
        p,
        new Promise((_, r) => setTimeout(() => r(new Error(label+" timed out")), ms))
      ]);

    function calcAge(dobStr){
      if (!dobStr) return 0;
      const t=new Date(), d=new Date(dobStr);
      let a=t.getFullYear()-d.getFullYear();
      const m=t.getMonth()-d.getMonth();
      if (m<0 || (m===0 && t.getDate()<d.getDate())) a--;
      return a;
    }

    // Debounced availability check (best-effort; non-blocking if RPC missing)
    let usernameTimer;
    usernameInput.addEventListener("input", () => {
      clearTimeout(usernameTimer);
      usernameMsg.textContent = "";
      const u = usernameInput.value.trim();
      if (!validUsername(u)) {
        usernameMsg.textContent = "3–20 letters, numbers, or underscores.";
        usernameMsg.className = "error";
        return;
      }
      usernameTimer = setTimeout(async () => {
        try {
          const { data, error } = await supabase.rpc('username_available', { uname: u });
          if (error) { usernameMsg.textContent = ""; return; }
          if (data) { usernameMsg.textContent = "✔ Username available"; usernameMsg.className = "ok"; }
          else { usernameMsg.textContent = "❌ Username already taken"; usernameMsg.className = "error"; }
        } catch { /* ignore */ }
      }, 350);
    });

    async function safeUsernameAvailable(u){
      try {
        const { data, error } = await withTimeout(
          supabase.rpc('username_available', { uname: u }),
          8000,
          "username check"
        );
        if (error) return null;      // null => unknown, don't block signup
        return !!data;               // true/false => available or not
      } catch { return null; }
    }

    async function handleSignup(){
      showErr("");
      const dob = el("dob").value;
      const attest = el("attest").checked;
      const username = usernameInput.value.trim();
      const email = el("email").value.trim();
      const password = el("password").value;

      if (calcAge(dob) < 18 || !attest) return showErr("You must be 18+ and check the box to continue.");
      if (!validUsername(username)) return showErr("Username: 3–20 chars, letters/numbers/_ only.");
      if (!email || !password) return showErr("Email and password are required.");
      if (!looksLikeEmail(email)) return showErr("Please enter a valid email.");

      btn.disabled = true;
      showStatus("Creating your account…");

      try {
        // quick availability re-check (non-fatal if RPC is missing)
        const available = await safeUsernameAvailable(username);
        if (available === false) { showErr("That username is taken. Pick another."); btn.disabled=false; return; }

        // create auth user (store username/dob in metadata too)
        const { data, error } = await withTimeout(
          supabase.auth.signUp({ email, password, options: { data: { username, dob } } }),
          15000,
          "sign up"
        );
        if (error) {
          if (/already registered/i.test(error.message)) {
            showErr("That email already has an account. Try logging in or resetting your password.");
          } else {
            showErr(error.message || "Sign up failed.");
          }
          return;
        }

        // Try to sign in (if confirm-email ON, this will fail with a helpful message)
        let session = data.session;
        if (!session) {
          const { error: loginErr } = await withTimeout(
            supabase.auth.signInWithPassword({ email, password }),
            12000,
            "sign in"
          );
          if (loginErr) {
            if (/confirm/i.test(loginErr.message)) {
              showStatus("Almost done — check your email to confirm, then log in.");
              showErr("");            // clear error box
              btn.disabled = false;
              return;
            }
            showErr(loginErr.message || "Could not log in after sign-up.");
            btn.disabled = false;
            return;
          }
          // allow storage to persist
          await new Promise(r => setTimeout(r, 200));
        }

        // Poll for session (mobile storage can lag)
        let sess = (await supabase.auth.getSession()).data.session;
        for (let i=0; i<5 && !sess; i++) {
          await new Promise(r => setTimeout(r, 200));
          sess = (await supabase.auth.getSession()).data.session;
        }
        if (!sess) {
          showStatus("");
          showErr("Account created. Please log in.");
          btn.disabled = false;
          return;
        }

        // Insert mapping (requires your RLS policy)
        const user = (await supabase.auth.getUser()).data.user;
        if (user) {
          const { error: mapErr } = await withTimeout(
            supabase.from("usernames").upsert(
              { user_id: user.id, username, email },
              { onConflict: "user_id" }
            ),
            12000,
            "username map"
          );
          if (mapErr) {
            if (String(mapErr.message).match(/duplicate|unique|conflict/i)) {
              showErr("That username is already taken. Pick another.");
              btn.disabled = false;
              return;
            }
            // non-fatal: log and continue
            console.warn("username map upsert error", mapErr);
          }
        }

        showStatus("Signed up & logged in. Redirecting…");
        el("password").value = "";
        setTimeout(() => { location.href = "./menu.html"; }, 600);

      } catch (e) {
        console.error(e);
        showStatus("");
        showErr(e.message || "Unexpected error.");
      } finally {
        // If we didn’t redirect, re-enable the button
        if (!/menu\.html$/.test(location.href)) btn.disabled = false;
      }
    }

    async function showLoggedInNoticeIfAny() {
      const { data: { session} } = await supabase.auth.getSession();
      if (!session) return;

      status.innerHTML = `You’re already logged in as <strong>${session.user.user_metadata?.username || session.user.email}</strong>.`;
      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.marginTop = "8px";
      actions.innerHTML = `
        <a class="btn" href="./menu.html">Continue to Menu</a>
        <button id="logOutHere" class="btn">Sign out</button>
      `;
      status.after(actions);
      document.getElementById("logOutHere").onclick = async () => {
        await supabase.auth.signOut();
        location.reload();
      };
    }
    showLoggedInNoticeIfAny();

    btn.addEventListener("click", handleSignup);
    ["username","email","password","dob"].forEach(id => {
      el(id).addEventListener("keydown", (ev) => { if (ev.key === "Enter") handleSignup(); });
    });
  </script>
</body>
</html>