<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî DM</title>
  <meta name="color-scheme" content="dark" />
  <link rel="stylesheet" href="./css.html" />
  <style>
    :root{ --green:#39ff14; --bg:#000; --border:#151515; --ink:#e5ffe5; }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--green);
      font-family:ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased;
      position:relative; overflow-x:hidden;
    }
    /* scanlines fallback */
    body::before{
      content:""; position:fixed; inset:0;
      background:repeating-linear-gradient(to bottom, rgba(57,255,20,.1) 0px, rgba(57,255,20,.1) 2px, transparent 5px);
      pointer-events:none; z-index:1; animation:scan 7s linear infinite;
    }
    @keyframes scan{ from{background-position:0 0} to{background-position:0 100vh} }

    .topbar,.chat,.typing-row,.composer,.err{ position:relative; z-index:2; }
    .topbar{
      position:sticky; top:0; display:flex; align-items:center; gap:.6rem;
      padding:.6rem 1rem; border-bottom:1px solid var(--border);
      background:#000c; backdrop-filter:blur(6px);
    }
    .chip{ border:1px solid var(--border); padding:.25rem .6rem; border-radius:999px; }
    .tiny-pfp{ width:26px; height:26px; border-radius:8px; overflow:hidden; border:1px solid var(--green); background:#111; }
    .tiny-pfp img{ width:100%; height:100%; object-fit:cover; display:block; }
    .otherName{ font-weight:800; letter-spacing:.2px; }
    .whoami{ margin-left:auto; opacity:.7; font-size:.85rem; }

    .chat{ height:calc(100vh - 152px); overflow-y:auto; padding:1rem; display:flex; flex-direction:column; }
    .msg{ margin:.25rem 0; padding:.6rem .75rem; border-radius:12px; max-width:78%; line-height:1.25; word-wrap:break-word; background:#0f0f0f; color:var(--ink); }
    .me{ align-self:flex-end; border:1px solid #1d401d; }
    .them{ align-self:flex-start; background:#171717; border:1px solid #222; }
    .ts{ opacity:.55; font-size:.72rem; margin-top:.25rem; }
    .empty{ opacity:.6; text-align:center; margin-top:20vh; }

    .typing-row{ padding:0 1rem .25rem; min-height:1.25rem; }
    #typing-indicator{ opacity:.8; font-size:.85rem; display:none; }

    .composer{
      position:sticky; bottom:0; display:flex; gap:.5rem; padding:.6rem;
      border-top:1px solid var(--border); background:#000;
    }
    input{
      flex:1; background:#000; color:var(--green); border:1px solid #2a2a2a; border-radius:10px; padding:.7rem .8rem;
    }
    button{
      background:var(--green); color:#000; font-weight:800; border:none; border-radius:10px; padding:0 1rem;
    }
    .err{
      position:fixed; left:50%; transform:translateX(-50%); bottom:76px;
      background:#170000; color:#ff9b9b; border:1px solid #330;
      padding:.5rem .75rem; border-radius:8px; display:none; max-width:92%;
    }
    .disabled{ opacity:.5; pointer-events:none }
  </style>
</head>
<body>

  <div class="topbar">
    <a class="chip" href="inbox.html">‚Üê Inbox</a>
    <div class="tiny-pfp" id="otherPfp" style="display:none;"></div>
    <span class="otherName" id="otherName" style="display:none;"></span>
    <span class="whoami" id="whoami"></span>
  </div>

  <div class="chat" id="chat">
    <div class="empty" id="empty">No messages yet. Say hi üëã</div>
  </div>

  <div class="typing-row">
    <div id="typing-indicator"></div>
  </div>

  <form class="composer" id="composer" autocomplete="off">
    <input id="msgInput" placeholder="Say something‚Ä¶" />
    <button id="sendBtn" type="submit">Send</button>
  </form>

  <div id="err" class="err"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /************ Supabase ************/
    const sb = supabase.createClient(
      "https://tuqvpcevrhciursxrgav.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"
    );

    /************ Thread id ************/
    const sp = new URLSearchParams(location.search);
    const threadId = sp.get('thread') || sp.get('dm'); // support both
    if(!threadId){ alert('Missing thread id'); location.href='inbox.html'; }

    /************ Unread marker (seen by inbox) ************/
    const lastReadKey = `dm_last_read_${threadId}`;
    const markRead = () => localStorage.setItem(lastReadKey, Date.now());

    /************ DOM ************/
    const chatEl = document.getElementById('chat');
    const emptyEl = document.getElementById('empty');
    const whoamiEl = document.getElementById('whoami');
    const otherNameEl = document.getElementById('otherName');
    const otherPfpEl = document.getElementById('otherPfp');
    const formEl = document.getElementById('composer');
    const inputEl = document.getElementById('msgInput');
    const errEl = document.getElementById('err');

    const rendered = new Set();
    let me = null;

    /************ Helpers ************/
    const showErr = (m)=>{
      errEl.textContent = m;
      errEl.style.display = 'block';
      clearTimeout(showErr._t);
      showErr._t = setTimeout(()=> errEl.style.display='none', 2200);
    };
    const ts = iso => {
      try{ const d = new Date(iso);
        return d.toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
      }catch{ return ''; }
    };
    const nameFromProfile = (p)=>{
      if(!p) return '@user';
      if(p.display_name?.trim()) return p.display_name.trim();
      if(p.username?.trim()) return '@'+p.username.trim();
      return '@user-' + (p.id||'').slice(0,6);
    };

    function bubble(m){
      if (m.id && rendered.has(m.id)) return;
      if (emptyEl && emptyEl.parentNode) emptyEl.remove();

      const mine = m.sender === me.id;
      const row = document.createElement('div');
      row.className = 'msg ' + (mine ? 'me' : 'them');
      row.innerHTML = `
        <div>${(m.body||'').replace(/</g,'&lt;')}</div>
        <div class="ts">${ts(m.created_at)}</div>
      `;
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      if(m.id) rendered.add(m.id);

      // we just saw it ‚Üí mark read
      markRead();
    }

    async function loadHeader(meId){
      // dm_threads: (a,b) are participant uuids
      const { data: th } = await sb.from('dm_threads').select('id,a,b').eq('id', threadId).maybeSingle();
      if(!th) return; // silent if not found
      const otherId = (th.a === meId) ? th.b : th.a;
      const { data: prof } = await sb.from('profiles').select('id,display_name,username,avatar_url').eq('id', otherId).maybeSingle();
      if(!prof) return;
      otherNameEl.textContent = nameFromProfile(prof);
      otherNameEl.style.display = 'inline';
      if(prof.avatar_url){
        otherPfpEl.innerHTML = `<img src="${prof.avatar_url}" alt="">`;
        otherPfpEl.style.display = 'block';
      }
    }

    async function loadMessages(){
      const { data, error } = await sb
        .from('dm_messages')
        .select('id,body,created_at,sender')
        .eq('thread_id', threadId)
        .order('created_at', { ascending:true });
      if(error){ console.error(error); showErr('Load failed'); return; }

      chatEl.innerHTML = '';
      if(!data || data.length===0){
        chatEl.appendChild(emptyEl);
      }else{
        for(const m of data) bubble(m);
      }
      markRead();
    }

    function setupRealtime(){
      sb
       .channel('dm_'+threadId)
       .on('postgres_changes',
          { event:'INSERT', schema:'public', table:'dm_messages', filter:`thread_id=eq.${threadId}` },
          payload => bubble(payload.new)
       )
       .subscribe();
    }

    async function send(body){
      if(!body.trim()) return;
      const { error } = await sb
        .from('dm_messages')
        .insert({ thread_id: threadId, sender: me.id, body: body.trim() });
      if(error){ console.error(error); showErr('Send failed'); }
      // markRead() happens in bubble() when our INSERT comes back via realtime fetch or reload
    }

    /************ Boot ************/
    (async function boot(){
      const { data: { session } } = await sb.auth.getSession();
      if(!session){ location.href='./login.html'; return; }
      me = session.user;
      whoamiEl.textContent = `‚Ä¢ you are @${(me.email||'').split('@')[0]}`;

      await loadHeader(me.id);
      await loadMessages();
      setupRealtime();

      // keep read when focusing/returning
      window.addEventListener('focus', markRead);
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') markRead(); });
      markRead();
    })();

    /************ Composer ************/
    formEl.addEventListener('submit', e=>{
      e.preventDefault();
      const text = inputEl.value;
      inputEl.value = '';
      send(text);
    });
  </script>
</body>
</html>