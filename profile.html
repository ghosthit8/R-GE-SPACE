<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî Profile</title>
  <meta name="color-scheme" content="dark" />
  <link rel="stylesheet" href="./style.css" />

  <style>
    :root{
      --green:#39ff14; --red:#ff0033; --bg:#000; --ink:#e5ffe5; --muted:#8aff8a;
      --card:#070707; --border:#103010;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:#000; color:var(--green);
      font-family:ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* Hide any legacy .toast so it can‚Äôt cover the page */
    .toast{ display:none !important; }

    /* ======== page-wide background image layer (click-through) ======== */
    .profile-bg{ position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
    .profile-bg img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      filter:none; pointer-events:none;
    }
    .bg-camera{
      position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom));
      width:44px; height:44px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      border:2px solid var(--green); background:var(--green); color:#000; cursor:pointer;
      box-shadow:0 0 18px rgba(57,255,20,.6); z-index:9999; pointer-events:auto;
    }
    .bg-camera:hover{ background:#000; color:var(--green) }
    .profile-scope{ position:relative; z-index:2; } /* ensure above scanlines */

    /* ===================== Scoped shields ===================== */
    .profile-scope .avatar,
    .profile-scope .avatar > img{ border-radius:16px !important; }
    .profile-scope .avatar > img{ display:block; width:100%; height:100%; object-fit:cover; }

    .profile-scope button::before,
    .profile-scope button::after,
    .profile-scope .back-chip::before,
    .profile-scope .back-chip::after{ content:none !important; display:none !important; }

    .profile-scope .banner{ position:relative !important; }
    .profile-scope .avatar-wrap{ position:absolute !important; }

    .profile-scope .avatar-camera,
    .profile-scope .banner-camera{
      position:absolute !important; left:auto !important; top:auto !important;
      transform:none !important; z-index:6 !important; color:#000 !important;
    }
    .profile-scope .banner-camera{ right:14px !important; bottom:14px !important; }
    .profile-scope .avatar-camera{ right:-6px !important; bottom:-6px !important; }

    .profile-scope .avatar-camera svg,
    .profile-scope .banner-camera svg,
    .bg-camera svg{
      display:block !important; width:22px; height:22px; color:#000 !important;
      fill:currentColor !important; stroke:none !important; opacity:1 !important;
      filter:none !important; z-index:2;
    }
    .profile-scope .avatar-camera svg path,
    .profile-scope .banner-camera svg path,
    .bg-camera svg path{ fill:currentColor !important; stroke:none !important; }

    .profile-scope .cam-glyph,
    .bg-camera .cam-glyph{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:18px; line-height:1; color:#000 !important; opacity:1 !important;
      filter:none !important; z-index:3; pointer-events:none;
    }
    .profile-scope .avatar-camera:hover .cam-glyph,
    .profile-scope .banner-camera:hover .cam-glyph,
    .bg-camera:hover .cam-glyph{ color:var(--green) !important; }

    /* ===================== Page styles ===================== */
    .banner{
      position:relative; height:260px; overflow:visible;
      border-bottom:1px solid var(--border);
      background:radial-gradient(900px 600px at 70% -10%, rgba(57,255,20,0.08), transparent 60%), #050505;
    }
    .banner img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
    .banner::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,0) 35%, rgba(0,0,0,.70) 100%);
      z-index:1; pointer-events:none;
    }
    .back-chip{
      position:absolute; z-index:5; top:14px; left:14px;
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
      color:var(--green); border:1.5px solid var(--green); background:rgba(0,0,0,.55);
      backdrop-filter: blur(4px); box-shadow:0 0 14px rgba(57,255,20,.35);
    }

    .banner-camera{
      width:44px; height:44px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      border:2px solid var(--green); background:var(--green); color:#000; cursor:pointer;
      box-shadow:0 0 18px rgba(57,255,20,.6);
    }
    .banner-camera:hover{ background:#000; color:var(--green) }
    .icon{ width:22px; height:22px; display:block }

    .avatar-wrap{
      z-index:5; left:20px; bottom:-120px;
      display:flex; flex-direction:column; align-items:center; gap:14px;
    }
    .avatar{
      display:flex; justify-content:center; align-items:center;
      width:180px; height:180px; border-radius:16px;
      border:5px solid var(--green);
      background:#0a0a0a;
      box-shadow:0 0 25px rgba(57,255,20,.75);
      color:var(--green); font-weight:900; font-size:40px;
      text-shadow:0 0 8px rgba(255,0,51,.6);
      overflow:hidden; user-select:none;
    }
    .avatar.is-blank{
      background:
        radial-gradient(45% 45% at 50% 35%, rgba(57,255,20,.22), transparent 60%),
        #0a0a0a;
    }

    .avatar-camera{
      width:44px; height:44px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      border:2px solid var(--green); background:var(--green); color:#000; cursor:pointer;
      box-shadow:0 0 18px rgba(57,255,20,.6);
    }
    .avatar-camera:hover{ background:#000; color:var(--green) }

    .edit-pill{
      font-size:15px; font-weight:800; letter-spacing:.2px;
      padding:12px 20px; border-radius:24px;
      border:2px solid var(--green); color:#000; background:var(--green);
      box-shadow:0 0 22px rgba(57,255,20,.7); cursor:pointer;
      position:relative; top:45px; text-decoration:none;
      display:inline-block;
    }
    .edit-pill:hover{ background:#000; color:var(--green) }

    .info-block{ max-width:940px; margin:205px auto 0; padding:0 16px; }
    .line{ margin:6px 0; font-size:16px; color:var(--ink) }
    .label{ color:var(--green); font-weight:700; margin-right:6px }

    .wrap{ max-width:940px; margin:18px auto 28px; padding:0 16px; }
    section.card{
      background:linear-gradient(180deg,#090909,#050505);
      border:1px solid var(--green); border-radius:16px; padding:16px;
      box-shadow:0 0 20px rgba(57,255,20,.12);
    }
    section.card + section.card{ margin-top:16px }
    h3{ margin:0 0 10px; font-size:18px; text-shadow:0 0 10px var(--red) }
    p, .text{ color:var(--ink) }

    .btn{
      border:2px solid var(--green); color:var(--green); background:transparent;
      padding:10px 16px; border-radius:12px; font-weight:800; cursor:pointer;
      box-shadow:0 0 16px rgba(57,255,20,.35);
    }
    .btn.red{ border-color:var(--red); color:var(--red) }

    .song-section{ margin:8px 0 16px }
    .song-section h3{ margin:0 0 8px; font-size:18px; text-shadow:0 0 10px var(--red) }

    @media (max-width:560px){
      .info-block{ margin-top:220px; }
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- ===== page background with camera ===== -->
  <div class="profile-bg">
    <img id="bgPreview" alt="">
  </div>
  <button id="bgCameraBtn" class="bg-camera" title="Change background" aria-label="Change background">
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3zm3 5a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
    </svg>
    <span class="cam-glyph" aria-hidden="true">üì∑</span>
  </button>
  <input id="bgQuickFile" type="file" accept="image/*" style="display:none" />

  <div class="profile-scope">

    <!-- ===== Banner ===== -->
    <header class="banner">
      <img id="bannerPreview" alt="">
      <a class="back-chip" href="./index.html">‚Üê Home</a>

      <button id="bannerCameraBtn" class="banner-camera" title="Change banner" aria-label="Change banner">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3zm3 5a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
        </svg>
        <span class="cam-glyph" aria-hidden="true">üì∑</span>
      </button>
      <input id="bannerQuickFile" type="file" accept="image/*" style="display:none" />

      <div class="avatar-wrap">
        <div id="avatarPreview" class="avatar is-blank">PFP</div>

        <button id="avatarCameraBtn" class="avatar-camera" title="Change profile photo" aria-label="Change profile photo">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3zm3 5a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
          </svg>
          <span class="cam-glyph" aria-hidden="true">üì∑</span>
        </button>
        <input id="avatarQuickFile" type="file" accept="image/*" style="display:none" />

        <!-- Edit Profile button -->
        <a href="#" class="edit-pill" id="editProfileLink">Edit Profile</a>
      </div>
    </header>

    <!-- ===== Identity lines ===== -->
    <div class="info-block">
      <div class="line"><span class="label">Pronouns:</span><span id="pronounsText"></span></div>
      <div class="line"><span class="label">Astrology:</span>
        <span id="sunText"></span> ‚òâ /
        <span id="moonText"></span> ‚òΩ /
        <span id="risingText"></span> ‚Üë
      </div>
      <div class="line"><span class="label">Love language:</span><span id="loveLangText"></span></div>
    </div>

    <main class="wrap">
      <div class="song-section">
        <h3>Theme Song</h3>
        <!-- Dynamic mount: YouTube embed OR audio element -->
        <div id="songMount"></div>
      </div>

      <section class="card">
        <h3>Message to the Void</h3>
        <p id="voidMsgText" class="text"></p>
      </section>

      <section class="card">
        <h3>Funny Story</h3>
        <p id="funnyStoryText" class="text"></p>
      </section>

      <section class="card">
        <h3>Skills</h3>
        <p id="skillsText" class="text"></p>
      </section>
    </main>

  </div><!-- /profile-scope -->

  <script>
    // --- Buckets ---
    const AVATAR_BUCKET = 'avatars';
    const BANNER_BUCKET = 'banners';
    const SONG_BUCKET   = 'songs';
    const BG_BUCKET     = 'banners'; // reuse for background

    const sb = supabase.createClient(
      "https://tuqvpcevrhciursxrgav.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"
    );

    // Display refs
    const pronounsText = document.getElementById("pronounsText");
    const sunText = document.getElementById("sunText");
    const moonText = document.getElementById("moonText");
    const risingText = document.getElementById("risingText");
    const loveLangText = document.getElementById("loveLangText");
    const skillsText = document.getElementById("skillsText");
    const voidMsgText = document.getElementById("voidMsgText");
    const funnyStoryText = document.getElementById("funnyStoryText");
    const avatarPreview = document.getElementById("avatarPreview");
    const bannerPreview = document.getElementById("bannerPreview") || document.querySelector(".banner img");
    const bgPreview = document.getElementById("bgPreview");
    const editProfileLink = document.getElementById('editProfileLink');

    const bannerCameraBtn = document.getElementById('bannerCameraBtn');
    const bannerQuickFile = document.getElementById('bannerQuickFile');
    const avatarCameraBtn = document.getElementById('avatarCameraBtn');
    const avatarQuickFile = document.getElementById('avatarQuickFile');
    const bgCameraBtn = document.getElementById('bgCameraBtn');
    const bgQuickFile = document.getElementById('bgQuickFile');

    const songMount = document.getElementById('songMount');

    let userId = null;
    let avatarUrl = null;
    let bannerUrl = null;
    let bgUrl = null;

    /* ---------- Local cache ---------- */
    const LS_KEY = "profile_cache_v1";
    function cacheSet(partial){
      const prev = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      localStorage.setItem(LS_KEY, JSON.stringify({ ...prev, ...partial }));
    }
    function cacheGet(){
      try { return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); } catch { return {}; }
    }

    function fileName(prefix, file){
      const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
      return `${prefix}/${crypto.randomUUID()}.${ext}`;
    }

    async function ensureProfileRow() {
      const { error } = await sb.from('profiles')
        .upsert({ id: userId, updated_at: new Date().toISOString() }, { onConflict: 'id' });
      if (error) console.error('ensureProfileRow:', error);
    }

    function setAvatarPlaceholder(){
      if(!avatarPreview) return;
      avatarPreview.classList.add('is-blank');
      avatarPreview.innerHTML = 'PFP';
    }
    function setAvatar(url){
      if(!avatarPreview) return;
      avatarPreview.classList.remove('is-blank');
      avatarPreview.innerHTML = `<img src="${url}" alt="Profile photo">`;
    }

    async function uploadToBucket(bucket, file){
      const path = fileName(userId, file);
      const { error } = await sb.storage.from(bucket).upload(path, file, { upsert:false });
      if(error) throw error;
      const { data } = sb.storage.from(bucket).getPublicUrl(path);
      return data.publicUrl;
    }

    // ===== Theme Song helpers =====
    function isYouTubeUrl(u){ return /youtu\.?be|youtube\.com/i.test(u||''); }
    function mountYouTube(mountEl, embedUrl){
      mountEl.innerHTML = `
        <div style="position:relative; border:1px solid var(--green); border-radius:12px; overflow:hidden; box-shadow:0 0 16px rgba(57,255,20,.25);">
          <iframe
            src="${embedUrl}"
            style="width:100%; aspect-ratio:16/9; display:block; border:0"
            title="Theme Song"
            allow="autoplay; encrypted-media; picture-in-picture"
            allowfullscreen
          ></iframe>
          <div style="position:absolute; left:8px; bottom:8px; background:rgba(0,0,0,.6); color:var(--ink); padding:6px 10px; border:1px solid var(--green); border-radius:8px; font-weight:800;">
            Autoplay is muted ‚Äî tap the video to unmute.
          </div>
        </div>`;
    }
    function mountAudio(mountEl, src){
      mountEl.innerHTML = `<audio controls autoplay muted style="width:100%; outline:none; background:transparent"></audio>`;
      const el = mountEl.querySelector('audio');
      el.src = src;
      el.muted = true;
      el.play().catch(()=>{});
    }

    async function loadProfile(){
      // Instant paint from local cache
      const cached = cacheGet();
      cached.avatar_url ? setAvatar(cached.avatar_url) : setAvatarPlaceholder();
      if (cached.banner_url && bannerPreview) bannerPreview.src = cached.banner_url;
      if (cached.bg_url && bgPreview)         bgPreview.src = cached.bg_url;

      // Fetch from DB
      const { data, error } = await sb.from("profiles").select("*").eq("id", userId).maybeSingle();
      if(error){ console.error(error); return; }
      if(!data){
        setAvatarPlaceholder();
        if (bannerPreview) bannerPreview.removeAttribute('src');
        if (bgPreview) bgPreview.removeAttribute('src');
        return;
      }

      if (pronounsText)  pronounsText.textContent = data.pronouns || "";
      if (sunText)       sunText.textContent      = data.sun || "";
      if (moonText)      moonText.textContent     = data.moon || "";
      if (risingText)    risingText.textContent   = data.rising || "";
      if (loveLangText)  loveLangText.textContent = data.love_language || "";
      if (skillsText)    skillsText.textContent   = (data.skills || []).join(", ");
      if (voidMsgText)   voidMsgText.textContent  = data.void_message || "";
      if (funnyStoryText)funnyStoryText.textContent = data.funny_story || "";

      // Theme Song: YouTube (embed) OR audio file
      if (songMount){
        songMount.innerHTML = "";
        const url = data.song_url || null;
        if (url){
          if (isYouTubeUrl(url)){
            mountYouTube(songMount, url);
          } else {
            mountAudio(songMount, url);
          }
        }
      }

      if(data.avatar_url){ avatarUrl = data.avatar_url; setAvatar(avatarUrl); cacheSet({ avatar_url: avatarUrl }); }
      else { setAvatarPlaceholder(); }

      if(data.banner_url && bannerPreview){ bannerUrl = data.banner_url; bannerPreview.src = bannerUrl; cacheSet({ banner_url: bannerUrl }); }
      if(data.bg_url && bgPreview){ bgUrl = data.bg_url; bgPreview.src = bgUrl; cacheSet({ bg_url: bgUrl }); }
    }

    /* ========= Camera quick uploads ========= */
    if(bannerCameraBtn && bannerQuickFile){
      bannerCameraBtn.addEventListener('click', ()=> bannerQuickFile.click());
      bannerQuickFile.addEventListener('change', async ()=>{
        if(!bannerQuickFile.files[0]) return;
        try{
          const url = await uploadToBucket(BANNER_BUCKET, bannerQuickFile.files[0]);
          bannerUrl = url; if (bannerPreview) bannerPreview.src = url; cacheSet({ banner_url: url });
          await sb.from('profiles').upsert({ id:userId, banner_url: url, updated_at: new Date().toISOString() }, { onConflict:'id' });
        }catch(e){ console.error(e); alert('Banner upload failed'); }
        finally{ bannerQuickFile.value = ""; }
      });
    }

    if(avatarCameraBtn && avatarQuickFile){
      avatarCameraBtn.addEventListener('click', ()=> avatarQuickFile.click());
      avatarQuickFile.addEventListener('change', async ()=>{
        if(!avatarQuickFile.files[0]) return;
        try{
          const url = await uploadToBucket(AVATAR_BUCKET, avatarQuickFile.files[0]);
          avatarUrl = url; setAvatar(url); cacheSet({ avatar_url: url });
          await sb.from('profiles').upsert({ id:userId, avatar_url: url, updated_at: new Date().toISOString() }, { onConflict:'id' });
        }catch(e){ console.error(e); alert('Avatar upload failed'); }
        finally{ avatarQuickFile.value = ""; }
      });
    }

    if(bgCameraBtn && bgQuickFile){
      bgCameraBtn.addEventListener('click', ()=> bgQuickFile.click());
      bgQuickFile.addEventListener('change', async ()=>{
        const file = bgQuickFile.files[0];
        if(!file) return;
        try{
          if (bgPreview) bgPreview.src = URL.createObjectURL(file); // instant local preview
          const url = await uploadToBucket(BG_BUCKET, file); // upload to bucket
          if (bgPreview) bgPreview.src = url; bgUrl = url; cacheSet({ bg_url: url });
          await sb.from('profiles').upsert(
            { id:userId, bg_url: url, updated_at: new Date().toISOString() },
            { onConflict:'id' }
          );
        }catch(e){ console.error(e); alert('Background upload failed'); }
        finally{ bgQuickFile.value = ""; }
      });
    }

    /* ========= Edit button wiring ========= */
    function isLocalProtocol(){
      return location.protocol === 'file:' || location.protocol === 'content:';
    }
    function wireEditProfileLink(){
      if(!editProfileLink) return;
      let href = 'editprofile.html';
      if(!isLocalProtocol()){
        const url = new URL(href, location.href);
        url.searchParams.set('return','profile.html');
        url.searchParams.set('v', Date.now().toString());
        href = url.toString();
      }
      editProfileLink.href = href;
    }

    /* ========= Tiny toast & cleanup ========= */
    function showToast(msg){
      const d = document.createElement('div');
      d.textContent = msg || 'Saved!';
      Object.assign(d.style, {
        position:'fixed', top:'12px', right:'12px', zIndex:'99999',
        padding:'6px 10px', border:'2px solid var(--green)', borderRadius:'8px',
        background:'#050905', color:'var(--ink)', fontWeight:'800',
        fontSize:'0.9rem', whiteSpace:'nowrap', boxShadow:'0 0 12px rgba(57,255,20,.35)',
        pointerEvents:'none'
      });
      document.body.appendChild(d);
      setTimeout(()=> d.remove(), 2500);
    }
    function showToastIfSaved(){
      const p = new URLSearchParams(location.search);
      if(p.get('saved') === '1'){
        showToast('Saved!');
        if(history.replaceState){
          p.delete('saved');
          const clean = location.pathname + (p.toString()?('?'+p.toString()):'') + location.hash;
          history.replaceState(null, '', clean);
        }
      }
    }

    // Boot
    document.addEventListener("DOMContentLoaded", async ()=>{
      try{
        const { data:{ session } } = await sb.auth.getSession();
        if(!session){ location.href="./login.html"; return; }
        userId = session.user.id;
        await ensureProfileRow();
        await loadProfile();
        wireEditProfileLink();
        showToastIfSaved();
      }catch(e){
        console.error('Boot error:', e);
      }
    });
  </script>
</body>
</html>