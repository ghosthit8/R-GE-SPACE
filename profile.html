<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî Profile</title>
  <meta name="color-scheme" content="dark" />
  <link rel="stylesheet" href="./style.css" />

  <style>
    :root{
      --green:#39ff14; --red:#ff0033; --bg:#000; --ink:#e5ffe5; --muted:#8aff8a;
      --card:#070707; --border:#103010;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:#000; color:var(--green);
      font-family:ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* Hide any legacy .toast so it can‚Äôt cover the page */
    .toast{ display:none !important; }

    /* ===== page-wide background image layer (click-through) ===== */
    .profile-bg{ position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
    .profile-bg img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      filter:none; pointer-events:none;
    }
    .bg-camera{
      position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom));
      width:44px; height:44px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      border:2px solid var(--green); background:var(--green); color:#000; cursor:pointer;
      box-shadow:0 0 18px rgba(57,255,20,.6); z-index:9999; pointer-events:auto;
    }
    .bg-camera:hover{ background:#000; color:var(--green) }
    .profile-scope{ position:relative; z-index:2; } /* ensure above scanlines */

    /* ===================== Scoped shields ===================== */
    .profile-scope .avatar,
    .profile-scope .avatar > img{ border-radius:16px !important; }
    .profile-scope .avatar > img{ display:block; width:100%; height:100%; object-fit:cover; }

    .profile-scope button::before,
    .profile-scope button::after,
    .profile-scope .back-chip::before,
    .profile-scope .back-chip::after{ content:none !important; display:none !important; }

    .profile-scope .banner{ position:relative !important; }
    .profile-scope .avatar-wrap{ position:absolute !important; }

    .profile-scope .avatar-camera,
    .profile-scope .banner-camera{
      position:absolute !important; left:auto !important; top:auto !important;
      transform:none !important; z-index:6 !important; color:#000 !important;
      width:44px; height:44px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      border:2px solid var(--green); background:var(--green); box-shadow:0 0 18px rgba(57,255,20,.6);
    }
    .profile-scope .banner-camera{ right:14px !important; bottom:14px !important; }
    .profile-scope .avatar-camera{ right:-6px !important; bottom:-6px !important; }

    .profile-scope .avatar-camera svg,
    .profile-scope .banner-camera svg,
    .bg-camera svg{
      display:block !important; width:22px; height:22px; color:#000 !important;
    }

    .profile-scope .cam-glyph,
    .bg-camera .cam-glyph{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:18px; line-height:1; color:#000 !important; opacity:1 !important;
      filter:none !important; z-index:3; pointer-events:none;
    }
    .profile-scope .avatar-camera:hover .cam-glyph,
    .profile-scope .banner-camera:hover .cam-glyph,
    .bg-camera:hover .cam-glyph{ color:var(--green) !important; }

    /* ===================== Page styles ===================== */
    .banner{
      position:relative; height:260px; overflow:visible;
      border-bottom:1px solid var(--border);
      background:radial-gradient(900px 600px at 70% -10%, rgba(57,255,20,0.08), transparent 60%), #050505;
    }
    .banner img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
    .banner::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,0) 35%, rgba(0,0,0,.70) 100%);
      z-index:1; pointer-events:none;
    }
    .back-chip{
      position:absolute; z-index:5; top:14px; left:14px;
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
      color:var(--green); border:1.5px solid var(--green); background:rgba(0,0,0,.55);
      backdrop-filter: blur(4px); box-shadow:0 0 14px rgba(57,255,20,.35);
    }

    .top-right{
      position:absolute; top:14px; right:14px; z-index:6; display:flex; gap:8px;
    }
    .chip{
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
      color:#000; background:var(--green); border:1.5px solid var(--green);
      box-shadow:0 0 14px rgba(57,255,20,.35);
    }
    .chip.ghost{ background:rgba(0,0,0,.55); color:var(--green); }

    .avatar-wrap{
      z-index:5; left:20px; bottom:-120px;
      display:flex; flex-direction:column; align-items:center; gap:14px;
    }
    .avatar{
      display:flex; justify-content:center; align-items:center;
      width:180px; height:180px; border-radius:16px;
      border:5px solid var(--green);
      background:#0a0a0a;
      box-shadow:0 0 25px rgba(57,255,20,.75);
      color:var(--green); font-weight:900; font-size:40px;
      text-shadow:0 0 8px rgba(255,0,51,.6);
      overflow:hidden; user-select:none;
    }
    .avatar.is-blank{
      background:
        radial-gradient(45% 45% at 50% 35%, rgba(57,255,20,.22), transparent 60%),
        #0a0a0a;
    }

    .edit-pill{
      font-size:15px; font-weight:800; letter-spacing:.2px;
      padding:12px 20px; border-radius:24px;
      border:2px solid var(--green); color:#000; background:var(--green);
      box-shadow:0 0 22px rgba(57,255,20,.7); cursor:pointer;
      position:relative; top:45px; text-decoration:none;
      display:inline-block;
    }
    .edit-pill:hover{ background:#000; color:var(--green) }

    .info-block{ max-width:940px; margin:205px auto 0; padding:0 16px; }
    .line{ margin:6px 0; font-size:16px; color:var(--ink) }
    .label{ color:var(--green); font-weight:700; margin-right:6px }

    .wrap{ max-width:940px; margin:18px auto 28px; padding:0 16px; }
    section.card{
      background:linear-gradient(180deg,#090909,#050505);
      border:1px solid var(--green); border-radius:16px; padding:16px;
      box-shadow:0 0 20px rgba(57,255,20,.12);
    }
    section.card + section.card{ margin-top:16px }
    h3{ margin:0 0 10px; font-size:18px; text-shadow:0 0 10px var(--red) }
    p, .text{ color:var(--ink) }

    .song-section{ margin:8px 0 16px }
    .song-section h3{ margin:0 0 8px; font-size:18px; text-shadow:0 0 10px var(--red) }
    .song-section audio{ width:100%; border:none; outline:none; background:transparent; box-shadow:none }

    /* --- NEW: About / Links layout --- */
    .about-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    .title-row{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .display-name{ font-size:24px; font-weight:900; letter-spacing:.5px; margin:0; }
    .handle{ color:#b9ffb9; opacity:.9; font-size:14px; }
    .kv{ display:grid; grid-template-columns:120px 1fr; gap:8px; }
    .kv .k{ color:#9dff9d; opacity:.85; font-size:12px; }
    .kv .v{ color:var(--ink); }
    .links{ display:flex; flex-wrap:wrap; gap:8px; }
    .links a{ display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border:1px solid var(--green); border-radius:999px; background:#010301; font-size:12px; color:var(--ink); text-decoration:none; }
    .links a:hover{ text-decoration:underline; }
    .meta{ color:#a2ffa2; opacity:.8; font-size:12px; margin-top:6px; }
    .empty{ color:#a2ffa2; opacity:.6; font-style:italic; }
    @media (max-width:560px){
      .info-block{ margin-top:220px; }
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- ===== page background with camera ===== -->
  <div class="profile-bg">
    <img id="bgPreview" alt="">
  </div>
  <button id="bgCameraBtn" class="bg-camera" title="Change background" aria-label="Change background">
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3zm3 5a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
    </svg>
    <span class="cam-glyph" aria-hidden="true">üì∑</span>
  </button>
  <input id="bgQuickFile" type="file" accept="image/*" style="display:none" />

  <div class="profile-scope">

    <!-- ===== Banner ===== -->
    <header class="banner">
      <img id="bannerPreview" alt="">
      <a class="back-chip" href="./menu.html">‚Üê Menu</a>

      <!-- Top-right area: Messages (only when logged in) -->
      <div class="top-right">
        <a id="inboxBtn" class="chip" href="./inbox.html" style="display:none">
          Messages
          <span id="inboxBadge" style="display:none;margin-left:6px;padding:2px 6px;border-radius:10px;background:#000;border:1px solid currentColor;font-size:12px;line-height:1;">0</span>
        </a>
      </div>

      <button id="bannerCameraBtn" class="banner-camera" title="Change banner" aria-label="Change banner">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3zm3 5a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
        </svg>
        <span class="cam-glyph" aria-hidden="true">üì∑</span>
      </button>
      <input id="bannerQuickFile" type="file" accept="image/*" style="display:none" />

      <div class="avatar-wrap">
        <div id="avatarPreview" class="avatar is-blank">PFP</div>

        <button id="avatarCameraBtn" class="avatar-camera" title="Change profile photo" aria-label="Change profile photo">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 4l1.5-2h3L15 4h3a3 3 0 013 3v10a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3zm3 5a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
          </svg>
          <span class="cam-glyph" aria-hidden="true">üì∑</span>
        </button>
        <input id="avatarQuickFile" type="file" accept="image/*" style="display:none" />

        <!-- Edit / DM buttons -->
        <a href="#" class="edit-pill" id="editProfileLink">Edit Profile</a>
        <a href="#" class="edit-pill" id="dmButton" style="display:none">Message privately</a>
      </div>
    </header>

    <!-- ===== Identity lines ===== -->
    <div class="info-block">
      <div class="line"><span class="label">Pronouns:</span><span id="pronounsText"></span></div>
      <div class="line"><span class="label">Astrology:</span>
        <span id="sunText"></span> ‚òâ /
        <span id="moonText"></span> ‚òΩ /
        <span id="risingText"></span> ‚Üë
      </div>
      <div class="line"><span class="label">Love language:</span><span id="loveLangText"></span></div>
    </div>

    <main class="wrap">

      <!-- ===== About (NEW) ===== -->
      <section class="card" id="aboutCard">
        <div class="about-grid">
          <div class="title-row">
            <h3 class="display-name" id="displayName">Loading‚Ä¶</h3>
            <span class="handle" id="handleText"></span>
          </div>
          <div class="kv">
            <div class="k">City</div><div class="v" id="cityText" class="empty">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Bio</div><div class="v" id="bioText" class="empty">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Links</div>
            <div class="v">
              <div class="links" id="linksWrap"></div>
              <div id="noLinks" class="empty">No links yet.</div>
            </div>
          </div>
          <div class="meta" id="metaRow"></div>
        </div>
      </section>

      <!-- ===== Theme Song ===== -->
      <div class="song-section">
        <h3>Theme Song</h3>
        <audio id="songPlayer" controls preload="none" style="display:none"></audio>
        <div id="ytWrap" style="display:none">
          <div id="ytPlayer" style="width:100%; aspect-ratio:16/9;"></div>
        </div>
      </div>

      <section class="card">
        <h3>Message to the Void</h3>
        <p id="voidMsgText" class="text"></p>
      </section>

      <section class="card">
        <h3>Funny Story</h3>
        <p id="funnyStoryText" class="text"></p>
      </section>

      <section class="card">
        <h3>Skills</h3>
        <p id="skillsText" class="text"></p>
      </section>
    </main>

  </div><!-- /profile-scope -->

  <script>
    // --- Buckets ---
    const AVATAR_BUCKET = 'avatars';
    const BANNER_BUCKET = 'banners';
    const BG_BUCKET     = 'backgrounds'; // dedicated backgrounds bucket

    const sb = supabase.createClient(
      "https://tuqvpcevrhciursxrgav.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"
    );

    // --------- helpers ---------
    const bust = (url, ver=Date.now()) => url ? (url + (url.includes('?') ? '&' : '?') + 'v=' + ver) : url;

    // per-user cache (used only when viewing OWN profile)
    let CACHE_UID = null;
    const cache = {
      key(uid){ return `profile_cache_${uid}`; },
      set(uid, partial){
        if(!uid) return;
        const k = this.key(uid);
        const prev = JSON.parse(localStorage.getItem(k) || "{}");
        localStorage.setItem(k, JSON.stringify({ ...prev, ...partial }));
      },
      get(uid){
        if(!uid) return {};
        try { return JSON.parse(localStorage.getItem(this.key(uid)) || "{}"); }
        catch { return {}; }
      },
      clear(uid){ if(uid) localStorage.removeItem(this.key(uid)); }
    };

    // Display refs
    const pronounsText = document.getElementById("pronounsText");
    const sunText = document.getElementById("sunText");
    const moonText = document.getElementById("moonText");
    const risingText = document.getElementById("risingText");
    const loveLangText = document.getElementById("loveLangText");
    const skillsText = document.getElementById("skillsText");
    const voidMsgText = document.getElementById("voidMsgText");
    const funnyStoryText = document.getElementById("funnyStoryText");
    const avatarPreview = document.getElementById("avatarPreview");
    const bannerPreview = document.getElementById("bannerPreview") || document.querySelector(".banner img");
    const bgPreview = document.getElementById("bgPreview");
    const editProfileLink = document.getElementById('editProfileLink');

    const bannerCameraBtn = document.getElementById('bannerCameraBtn');
    const bannerQuickFile = document.getElementById('bannerQuickFile');
    const avatarCameraBtn = document.getElementById('avatarCameraBtn');
    const avatarQuickFile = document.getElementById('avatarQuickFile');
    const bgCameraBtn = document.getElementById('bgCameraBtn');
    const bgQuickFile = document.getElementById('bgQuickFile');

    // New UI bits
    const inboxBtn   = document.getElementById('inboxBtn');
    const inboxBadge = document.getElementById('inboxBadge');
    const dmButton   = document.getElementById('dmButton');

    // Song refs
    const songPlayer = document.getElementById('songPlayer');
    const ytWrap = document.getElementById('ytWrap');

    // About refs
    const displayNameEl = document.getElementById('displayName');
    const handleText = document.getElementById('handleText');
    const cityText = document.getElementById('cityText');
    const bioText = document.getElementById('bioText');
    const linksWrap = document.getElementById('linksWrap');
    const noLinks = document.getElementById('noLinks');
    const metaRow = document.getElementById('metaRow');

    // Auth + routing
    let me = null;        // current session user (or null)
    let target = null;    // profile we‚Äôre viewing
    let viewingOwn = false;

    let ytPlayer = null;
    let ytVideoId = null;

    function fileName(prefix, file){
      const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
      return `${prefix}/${crypto.randomUUID()}.${ext}`;
    }

    async function ensureProfileRow(userId) {
      const { error } = await sb.from('profiles')
        .upsert({ id: userId, updated_at: new Date().toISOString() }, { onConflict: 'id' });
      if (error) console.error('ensureProfileRow:', error);
    }

    function setAvatarPlaceholder(){
      if(!avatarPreview) return;
      avatarPreview.classList.add('is-blank');
      avatarPreview.innerHTML = 'PFP';
    }
    function setAvatar(url){
      if(!avatarPreview) return;
      avatarPreview.classList.remove('is-blank');
      avatarPreview.innerHTML = `<img src="${url}" alt="Profile photo">`;
    }

    async function uploadToBucket(bucket, file){
      const path = fileName(target.id, file); // use viewed/owner id (only enabled when viewingOwn)
      const { error } = await sb.storage.from(bucket).upload(path, file, { upsert:false });
      if(error) throw error;
      const { data } = sb.storage.from(bucket).getPublicUrl(path);
      return data.publicUrl; // raw public URL (no bust)
    }

    /* ========= YouTube helpers ========= */
    function isYouTubeUrl(u){ return /youtu\.?be|youtube\.com/i.test(u||''); }
    function isYouTubeId(s){ return /^[A-Za-z0-9_-]{11}$/.test(s||''); }
    function extractYouTubeIdStrict(input) {
      if (!input) return null;
      const s = String(input).trim();

      if (isYouTubeId(s)) return s; // already an ID

      try {
        const u = new URL(s, location.href);
        if (/\byoutu\.be$/i.test(u.hostname)) {
          const id = u.pathname.split('/').filter(Boolean)[0];
          if (isYouTubeId(id)) return id;
        }
        if (/\byoutube\.com$/i.test(u.hostname)) {
          const v = u.searchParams.get('v');
          if (isYouTubeId(v)) return v;
          const parts = u.pathname.split('/').filter(Boolean);
          if (parts.length >= 2 && ['embed','shorts','live'].includes(parts[0])) {
            const id = parts[1];
            if (isYouTubeId(id)) return id;
          }
        }
      } catch {}

      const m = s.match(/([A-Za-z0-9_-]{11})(?![A-Za-z0-9_-])/);
      return m ? m[1] : null;
    }

    function makeOrUpdateYTPlayer(){
      if(!ytVideoId) return;

      if(songPlayer){ songPlayer.pause(); songPlayer.style.display = 'none'; }
      if(ytWrap){ ytWrap.style.display = 'block'; }

      if(ytPlayer){
        try { ytPlayer.loadVideoById(ytVideoId); ytPlayer.mute(); return; } catch {}
      }

      ytPlayer = new YT.Player('ytPlayer', {
        videoId: ytVideoId,
        playerVars: { autoplay: 1, mute: 1, playsinline: 1, rel: 0, modestbranding: 1, controls: 1 },
        events: {
          onReady: ()=>{
            const unmuteOnce = ()=>{
              try{ if(ytPlayer && ytPlayer.isMuted()) ytPlayer.unMute(); }catch{}
              document.removeEventListener('click', unmuteOnce, true);
              document.removeEventListener('touchstart', unmuteOnce, true);
            };
            document.addEventListener('click', unmuteOnce, true);
            document.addEventListener('touchstart', unmuteOnce, true);
          }
        }
      });
    }

    /* ========= Quick upload cameras ========= */
    function wireUploads(){
      const enabled = viewingOwn;

      // Banner
      if(bannerCameraBtn && bannerQuickFile){
        bannerCameraBtn.style.display = enabled ? '' : 'none';
        if(enabled){
          bannerCameraBtn.onclick = ()=> bannerQuickFile.click();
          bannerQuickFile.onchange = async ()=>{
            if(!bannerQuickFile.files[0]) return;
            try{
              const raw = await uploadToBucket(BANNER_BUCKET, bannerQuickFile.files[0]);
              const ver = Date.now();
              if (bannerPreview) bannerPreview.src = bust(raw, ver);           // show busted
              if (CACHE_UID) cache.set(CACHE_UID, { banner_url: bust(raw,ver) }); // cache busted
              await sb.from('profiles').upsert({ id:target.id, banner_url: raw, updated_at: new Date().toISOString() }, { onConflict:'id' });
            }catch(e){ console.error(e); alert('Banner upload failed'); }
            finally{ bannerQuickFile.value = ""; }
          };
        } else {
          bannerCameraBtn.onclick = null;
          bannerQuickFile.onchange = null;
        }
      }

      // Avatar
      if(avatarCameraBtn && avatarQuickFile){
        avatarCameraBtn.style.display = enabled ? '' : 'none';
        if(enabled){
          avatarCameraBtn.onclick = ()=> avatarQuickFile.click();
          avatarQuickFile.onchange = async ()=>{
            if(!avatarQuickFile.files[0]) return;
            try{
              const raw = await uploadToBucket(AVATAR_BUCKET, avatarQuickFile.files[0]);
              const ver = Date.now();
              setAvatar(bust(raw, ver));                           // show busted
              if (CACHE_UID) cache.set(CACHE_UID, { avatar_url: bust(raw,ver) });
              await sb.from('profiles').upsert({ id:target.id, avatar_url: raw, updated_at: new Date().toISOString() }, { onConflict:'id' });
            }catch(e){ console.error(e); alert('Avatar upload failed'); }
            finally{ avatarQuickFile.value = ""; }
          };
        } else {
          avatarCameraBtn.onclick = null;
          avatarQuickFile.onchange = null;
        }
      }

      // Page BG
      if(bgCameraBtn && bgQuickFile){
        bgCameraBtn.style.display = enabled ? '' : 'none';
        if(enabled){
          bgCameraBtn.onclick = ()=> bgQuickFile.click();
          bgQuickFile.onchange = async ()=>{
            const file = bgQuickFile.files[0];
            if(!file) return;
            try{
              if (bgPreview) bgPreview.src = URL.createObjectURL(file); // instant local preview
              const raw = await uploadToBucket(BG_BUCKET, file);
              const ver = Date.now();
              if (bgPreview) bgPreview.src = bust(raw, ver);
              if (CACHE_UID) cache.set(CACHE_UID, { bg_url: bust(raw,ver) });
              await sb.from('profiles').upsert(
                { id:target.id, bg_url: raw, updated_at: new Date().toISOString() },
                { onConflict:'id' }
              );
            }catch(e){ console.error(e); alert('Background upload failed'); }
            finally{ bgQuickFile.value = ""; }
          };
        } else {
          bgCameraBtn.onclick = null;
          bgQuickFile.onchange = null;
        }
      }
    }

    /* ========= Edit link ========= */
    function isLocalProtocol(){
      return location.protocol === 'file:' || location.protocol === 'content:';
    }
    function wireEditProfileLink(){
      if(!editProfileLink) return;
      if(!viewingOwn){
        editProfileLink.style.display = 'none';
        return;
      }
      let href = 'editprofile.html';
      if(!isLocalProtocol()){
        const url = new URL(href, location.href);
        url.searchParams.set('return','profile.html');
        url.searchParams.set('v', Date.now().toString());
        href = url.toString();
      }
      editProfileLink.href = href;
    }

    /* ========= Tiny toast ========= */
    function showToast(msg){
      const d = document.createElement('div');
      d.textContent = msg || 'Saved!';
      Object.assign(d.style, {
        position:'fixed', top:'12px', right:'12px', zIndex:'99999',
        padding:'6px 10px', border:'2px solid var(--green)', borderRadius:'8px',
        background:'#050905', color:'var(--ink)', fontWeight:'800',
        fontSize:'0.9rem', whiteSpace:'nowrap', boxShadow:'0 0 12px rgba(57,255,20,.35)',
        pointerEvents:'none'
      });
      document.body.appendChild(d);
      setTimeout(()=> d.remove(), 2500);
    }
    function showToastIfSaved(){
      const p = new URLSearchParams(location.search);
      if(p.get('saved') === '1'){
        showToast('Saved!');
        if(history.replaceState){
          p.delete('saved');
          const clean = location.pathname + (p.toString()?('?'+p.toString()):'') + location.hash;
          history.replaceState(null, '', clean);
        }
      }
    }

    /* ========= Load a profile ========= */
    function setAbout(profile){
      const name = profile.display_name || profile.full_name || profile.username || 'Unnamed User';
      displayNameEl.textContent = name;
      handleText.textContent = profile.username ? ('@' + profile.username) : ('id:' + profile.id.slice(0,6));
      cityText.textContent = profile.city || '‚Äî';
      bioText.textContent = profile.bio || '‚Äî';
      if (bioText.textContent === '‚Äî') bioText.classList.add('empty');

      const links = [];
      if (profile.website)   links.push({ label:'Website', href: profile.website.startsWith('http') ? profile.website : ('https://' + profile.website) });
      if (profile.instagram) links.push({ label:'Instagram', href:`https://instagram.com/${String(profile.instagram).replace(/^@/,'')}` });
      if (profile.tiktok)    links.push({ label:'TikTok', href:`https://tiktok.com/@${String(profile.tiktok).replace(/^@/,'')}` });
      if (profile.youtube)   links.push({ label:'YouTube', href: profile.youtube.startsWith('http') ? profile.youtube : `https://youtube.com/${profile.youtube}` });

      linksWrap.innerHTML = links.map(l=>`<a target="_blank" rel="noopener noreferrer" href="${l.href}">üîó ${l.label}</a>`).join('');
      noLinks.style.display = links.length ? 'none' : '';

      const created = profile.created_at ? new Date(profile.created_at) : null;
      const updated = profile.updated_at ? new Date(profile.updated_at) : null;
      metaRow.textContent =
        (created ? `Joined ${created.toLocaleDateString()}` : '') +
        (updated ? ` ‚Ä¢ Updated ${updated.toLocaleDateString()}` : '');
    }

    async function loadProfileBy(idOrUsername, useCache=false){
      // Paint from per-user cache ONLY when viewing own profile
      if (useCache && CACHE_UID) {
        const cached = cache.get(CACHE_UID);
        if (cached.avatar_url) setAvatar(cached.avatar_url); else setAvatarPlaceholder();
        if (cached.banner_url && bannerPreview) bannerPreview.src = cached.banner_url;
        if (cached.bg_url && bgPreview)         bgPreview.src     = cached.bg_url;
      } else {
        // for other users, never show last user's cached media
        setAvatarPlaceholder();
        if (bannerPreview) bannerPreview.removeAttribute('src');
        if (bgPreview) bgPreview.removeAttribute('src');
      }

      // Fetch from DB (by id or username)
      let q = sb.from("profiles").select("*").limit(1);
      if (idOrUsername.kind === 'id') q = q.eq("id", idOrUsername.value);
      else                             q = q.ilike("username", idOrUsername.value);
      const { data, error } = await q.maybeSingle();
      if(error || !data){
        console.error(error||'Profile not found');
        displayNameEl.textContent = 'Profile not found';
        handleText.textContent = '';
        cityText.textContent = '‚Äî';
        bioText.textContent = '‚Äî'; bioText.classList.add('empty');
        linksWrap.innerHTML = ''; noLinks.style.display = '';
        metaRow.textContent = '';
        return null;
      }

      // Identity / About
      pronounsText.textContent = data.pronouns || '';
      sunText.textContent      = data.sun || '';
      moonText.textContent     = data.moon || '';
      risingText.textContent   = data.rising || '';
      loveLangText.textContent = data.love_language || '';
      skillsText.textContent   = Array.isArray(data.skills) ? data.skills.join(", ") : (data.skills || '');
      voidMsgText.textContent  = data.void_message || '';
      funnyStoryText.textContent = data.funny_story || '';
      setAbout(data);

      // Theme song (YT or file)
      const s = data.song_url || null;
      let asId = null;
      if (isYouTubeId(s)) asId = s;
      else if (isYouTubeUrl(s)) asId = extractYouTubeIdStrict(s);

      if (asId) {
        ytVideoId = asId;
        if (ytWrap) ytWrap.style.display = 'block';
        if (songPlayer) { songPlayer.pause(); songPlayer.style.display = 'none'; }
        if (window.YT && window.YT.Player) makeOrUpdateYTPlayer();
      } else if (s) {
        if (songPlayer) { songPlayer.src = s; songPlayer.style.display = 'block'; }
        if (ytWrap) ytWrap.style.display = 'none';
      } else {
        if (songPlayer) { songPlayer.removeAttribute('src'); songPlayer.style.display = 'none'; }
        if (ytWrap) ytWrap.style.display = 'none';
      }

      // Media (use updated_at as a stable version stamp)
      const ver = data.updated_at ? new Date(data.updated_at).getTime() : Date.now();

      if(data.avatar_url){ setAvatar(bust(data.avatar_url, ver)); if (useCache && CACHE_UID) cache.set(CACHE_UID, { avatar_url: bust(data.avatar_url, ver) }); }
      else setAvatarPlaceholder();

      if(data.banner_url && bannerPreview){ bannerPreview.src = bust(data.banner_url, ver); if (useCache && CACHE_UID) cache.set(CACHE_UID, { banner_url: bust(data.banner_url, ver) }); }
      if(data.bg_url && bgPreview){ bgPreview.src = bust(data.bg_url, ver); if (useCache && CACHE_UID) cache.set(CACHE_UID, { bg_url: bust(data.bg_url, ver) }); }

      return data;
    }

    /* ========= DM helper ========= */
    async function openOrCreateDM(otherId){
      if(!me){ location.href = './login.html'; return; }
      const a = me.id;
      const b = otherId;
      const least = a < b ? a : b;
      const greatest = a < b ? b : a;

      let { data: thread } = await sb
        .from('dm_threads')
        .select('id,a,b')
        .or(`and(a.eq.${least},b.eq.${greatest}),and(a.eq.${greatest},b.eq.${least})`)
        .maybeSingle();

      if(!thread){
        const { data: created, error: insertErr } = await sb
          .from('dm_threads')
          .insert({ a, b })
          .select('id')
          .single();
        if(insertErr){ alert('Could not start DM'); return; }
        thread = created;
      }
      location.href = `./dm.html?thread=${thread.id}`;
    }

    /* ========= Unread-ish badge (optional lightweight) ========= */
    async function updateInboxBadge(){
      if(!me || !inboxBadge) return;
      const { data: threads } = await sb
        .from('dm_threads')
        .select('id,a,b,created_at')
        .order('created_at', { ascending:false });

      if(!threads || threads.length===0){
        inboxBadge.style.display='none';
        return;
      }

      let count = 0;
      for(const t of threads){
        const { data: last } = await sb
          .from('dm_messages')
          .select('sender,created_at')
          .eq('thread_id', t.id)
          .order('created_at', { ascending:false })
          .limit(1)
          .maybeSingle();
        if(last && last.sender !== me.id) count++;
      }
      if(count>0){ inboxBadge.textContent = count; inboxBadge.style.display=''; }
      else { inboxBadge.style.display='none'; }
    }

    /* ========= Boot ========= */
    document.addEventListener("DOMContentLoaded", async ()=>{
      try{
        // Session (may be null)
        const { data:{ session } } = await sb.auth.getSession();
        me = session?.user || null;

        // Routing
        const qs = new URLSearchParams(location.search);
        const qUsername = (qs.get('u')||'').trim();
        const qUid = (qs.get('uid')||'').trim();

        let selector, useCache=false;
        if(!qUsername && !qUid){
          // Viewing ME (requires login)
          if(!me){ location.href="./login.html"; return; }
          viewingOwn = true;
          CACHE_UID = me.id;               // cache keyed by my uid
          selector = { kind:'id', value: me.id };
          useCache = true;                 // only for self
        } else {
          // Viewing someone else (or possibly self via link)
          selector = qUid ? { kind:'id', value:qUid } : { kind:'username', value:qUsername };
          viewingOwn = !!(me && qUid && me.id === qUid); // refined after fetch if username path
          CACHE_UID = viewingOwn ? me.id : null;         // only cache self
          useCache = viewingOwn;
        }

        target = await loadProfileBy(selector, useCache);
        if(!target){
          if (viewingOwn && me){ await ensureProfileRow(me.id); target = { id: me.id }; }
          else { alert('Profile not found'); return; }
        }
        // If user came by username, update viewingOwn once we know target.id
        if(me && target && target.id) viewingOwn = (me.id === target.id);
        if(!viewingOwn) CACHE_UID = null;

        // Inbox button only if logged in
        if(inboxBtn) inboxBtn.style.display = me ? '' : 'none';

        // Toggle edit vs DM
        wireEditProfileLink();
        wireUploads();
        if(dmButton){
          dmButton.style.display = viewingOwn ? 'none' : '';
          dmButton.onclick = (e)=>{ e.preventDefault(); openOrCreateDM(target.id); };
        }

        // Ensure row for self (so uploads have a row)
        if(viewingOwn && me) await ensureProfileRow(me.id);

        // Badge + toast handling
        if(me) updateInboxBadge().catch(console.error);
        showToastIfSaved();
      }catch(e){
        console.error('Boot error:', e);
      }
    });
  </script>

  <!-- Load YouTube IFrame API once; it will call onYouTubeIframeAPIReady() globally -->
  <script>
    (function(){
      const s=document.createElement('script');
      s.src="https://www.youtube.com/iframe_api";
      document.head.appendChild(s);
    })();
    function onYouTubeIframeAPIReady(){
      if(typeof makeOrUpdateYTPlayer==='function') makeOrUpdateYTPlayer();
    }
  </script>
</body>
</html>