<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space — Edit Profile</title>
  <meta name="color-scheme" content="dark" />
  <link rel="stylesheet" href="./style.css" />

  <style>
    :root{
      --green:#39ff14; --red:#ff0033; --bg:#000; --ink:#e5ffe5; --muted:#8aff8a;
      --card:#070707; --border:#103010;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:#000; color:var(--green);
      font-family:ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{ max-width:940px; margin:24px auto 64px; padding:0 16px; }
    .back-chip{
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:800; font-size:13px;
      color:var(--green); border:1.5px solid var(--green); background:rgba(0,0,0,.55);
      backdrop-filter: blur(4px); box-shadow:0 0 14px rgba(57,255,20,.35);
    }
    h1{
      margin:18px 0 16px; font-size:28px; letter-spacing:.02em;
      text-shadow:0 0 10px var(--red);
    }
    .card{
      background:linear-gradient(180deg,#0a0a0a,#050505);
      border:1px solid var(--green); border-radius:16px; padding:16px;
      box-shadow:0 0 20px rgba(57,255,20,.12);
    }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    .grid-3{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }
    .row{ display:grid; gap:10px; }
    label{ font-size:13px; font-weight:800; color:var(--muted); }
    input[type="text"], select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1.5px solid var(--border);
      background:#050505; color:var(--ink); outline:none;
      box-shadow: inset 0 0 10px rgba(57,255,20,.08);
    }
    textarea{ min-height:110px; resize:vertical; }
    small.hint{ color:var(--muted); opacity:0.9 }

    .btn{
      border:2px solid var(--green); color:#000; background:var(--green);
      padding:12px 18px; border-radius:14px; font-weight:900; cursor:pointer;
      box-shadow:0 0 16px rgba(57,255,20,.55);
    }
    .btn.ghost{ background:transparent; color:var(--green) }
    .btn.red{ border-color:var(--red); color:var(--red); background:transparent; box-shadow:0 0 16px rgba(255,0,51,.35); }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .song-box{
      display:flex; flex-direction:column; gap:10px;
      padding:12px; border:1px dashed var(--border); border-radius:12px; background:#080808;
    }
    .song-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    audio{ width:100%; }

    @media (max-width:720px){
      .grid{ grid-template-columns: 1fr; }
      .grid-3{ grid-template-columns: 1fr; }
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <main class="wrap">
    <a id="backLink" class="back-chip" href="./profile.html">← Back</a>
    <h1>EDIT YOUR PROFILE</h1>

    <form id="editForm" class="card" autocomplete="off">
      <div class="grid">
        <div class="row">
          <label for="pronouns">Pronouns</label>
          <input id="pronouns" type="text" placeholder="they/them, she/her, he/him, etc." />
        </div>
        <div class="row">
          <label for="loveLang">Love language</label>
          <select id="loveLang">
            <option value="">— choose —</option>
            <option>Words of affirmation</option>
            <option>Quality time</option>
            <option>Acts of service</option>
            <option>Gifts</option>
            <option>Physical touch</option>
          </select>
        </div>
      </div>

      <div class="grid-3" style="margin-top:12px">
        <div class="row">
          <label for="sun">Sun</label>
          <input id="sun" type="text" placeholder="Aries, Taurus, etc." />
        </div>
        <div class="row">
          <label for="moon">Moon</label>
          <input id="moon" type="text" placeholder="Sagittarius, Scorpio, etc." />
        </div>
        <div class="row">
          <label for="rising">Rising</label>
          <input id="rising" type="text" placeholder="Leo, Pisces, etc." />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <label for="skills">Skills <small class="hint">(comma-separated; will save as an array)</small></label>
        <input id="skills" type="text" placeholder="dancing, taxidermy, guns, hacking ..." />
      </div>

      <div class="row" style="margin-top:12px">
        <label for="voidMsg">Message to the Void</label>
        <textarea id="voidMsg" placeholder="Speak into the abyss..."></textarea>
      </div>

      <div class="row" style="margin-top:12px">
        <label for="funnyStory">Funny Story</label>
        <textarea id="funnyStory" placeholder="Tell us a chaotic legend..."></textarea>
      </div>

      <div class="row" style="margin-top:16px">
        <label>Theme Song</label>
        <div class="song-box">
          <div class="song-row">
            <input id="songFile" type="file" accept="audio/*" />
            <button id="uploadSongBtn" type="button" class="btn">Upload / Replace</button>
            <button id="removeSongBtn" type="button" class="btn red">Remove</button>
            <small class="hint">Accepted: audio files. Upload stores to Supabase Storage.</small>
          </div>
          <audio id="songPreview" controls preload="none"></audio>
        </div>
      </div>

      <div class="actions" style="margin-top:18px">
        <button id="saveBtn" type="submit" class="btn">Save Changes</button>
        <a class="btn ghost" id="cancelLink" href="./profile.html">Cancel</a>
        <small id="status" class="hint" style="margin-left:6px"></small>
      </div>
    </form>
  </main>

  <script>
    // ---- Config ----
    const SONG_BUCKET = 'songs';
    const sb = supabase.createClient(
      "https://tuqvpcevrhciursxrgav.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"
    );

    // ---- Elements ----
    const backLink = document.getElementById('backLink');
    const cancelLink = document.getElementById('cancelLink');
    const form = document.getElementById('editForm');
    const statusEl = document.getElementById('status');

    const pronounsEl = document.getElementById('pronouns');
    const sunEl = document.getElementById('sun');
    const moonEl = document.getElementById('moon');
    const risingEl = document.getElementById('rising');
    const loveLangEl = document.getElementById('loveLang');
    const skillsEl = document.getElementById('skills');
    const voidMsgEl = document.getElementById('voidMsg');
    const funnyStoryEl = document.getElementById('funnyStory');

    const songFileEl = document.getElementById('songFile');
    const uploadSongBtn = document.getElementById('uploadSongBtn');
    const removeSongBtn = document.getElementById('removeSongBtn');
    const songPreview = document.getElementById('songPreview');

    // ---- State ----
    let userId = null;
    let songUrl = null;

    // ---- Utils ----
    function isLocal(){ return location.protocol === 'file:' || location.protocol === 'content:'; }
    function say(msg, bad=false){ statusEl.textContent = msg||''; statusEl.style.color = bad ? 'var(--red)' : 'var(--muted)'; }
    function fileName(prefix, file){
      const ext = (file?.name?.split('.').pop() || 'bin').toLowerCase();
      return `${prefix}/${crypto.randomUUID()}.${ext}`;
    }
    function skillsToString(arr){ return Array.isArray(arr) ? arr.join(', ') : ''; }
    function stringToSkills(str){
      return (str||'').split(',').map(s=>s.trim()).filter(Boolean);
    }

    // ===== Same-folder return/redirect (GitHub Pages safe) =====
    // Example: /F/editprofile.html -> DIR="/F/" -> DEFAULT_TARGET="/F/profile.html"
    const DIR = location.pathname.replace(/[^/]*$/, '');  // strip filename, keep trailing slash
    const DEFAULT_TARGET = DIR + 'profile.html';

    function safePath(urlLike){
      try{
        const u = new URL(urlLike || '', location.href);
        if (u.origin !== location.origin) throw 0;

        // If the caller passed exactly "profile.html" or "./profile.html", the browser
        // resolves it to the same folder automatically. We just return the resolved path.
        // If they passed a folder path (ends with "/"), force "profile.html" inside it.
        let path = u.pathname;
        if (path.endsWith('/')) path += 'profile.html';

        // If it doesn't look like a file (no "/name.ext"), fall back to same-folder target.
        if (!/\/[^/]+\.[^/]+$/.test(path)) path = DEFAULT_TARGET;

        return path + u.search + u.hash;
      }catch{
        return DEFAULT_TARGET;
      }
    }

    const params = new URLSearchParams(location.search);
    const safeReturn = safePath(params.get('return') || 'profile.html');

    backLink.href = safeReturn;
    cancelLink.href = safeReturn;

    function afterSaveRedirect(){
      const u = new URL(safeReturn, location.href);
      u.searchParams.set('saved','1');
      location.href = u.toString();
    }
    // ===========================================================

    // ---- Data I/O ----
    async function ensureProfileRow() {
      const { error } = await sb.from('profiles')
        .upsert({ id: userId, updated_at: new Date().toISOString() }, { onConflict:'id' });
      if (error) console.error('ensureProfileRow:', error);
    }

    async function loadProfile(){
      say('Loading...');
      const { data, error } = await sb.from('profiles').select('*').eq('id', userId).maybeSingle();
      if(error){ console.error(error); say('Failed to load', true); return; }
      if(!data){ say(''); return; }

      pronounsEl.value = data.pronouns || '';
      sunEl.value = data.sun || '';
      moonEl.value = data.moon || '';
      risingEl.value = data.rising || '';
      loveLangEl.value = data.love_language || '';
      skillsEl.value = skillsToString(data.skills);
      voidMsgEl.value = data.void_message || '';
      funnyStoryEl.value = data.funny_story || '';
      songUrl = data.song_url || null;
      if(songUrl){ songPreview.src = songUrl; } else { songPreview.removeAttribute('src'); }
      say('');
    }

    async function uploadSong(){
      const file = songFileEl.files?.[0];
      if(!file){ say('Choose an audio file first', true); return; }
      say('Uploading song...');
      try{
        const path = fileName(userId, file);
        const { error: upErr } = await sb.storage.from(SONG_BUCKET).upload(path, file, { upsert:false });
        if(upErr) throw upErr;
        const { data } = sb.storage.from(SONG_BUCKET).getPublicUrl(path);
        songUrl = data.publicUrl;
        songPreview.src = songUrl;
        say('Song uploaded. Remember to Save Changes.');
      }catch(e){
        console.error(e);
        say('Upload failed', true);
      }finally{
        songFileEl.value = '';
      }
    }

    function removeSong(){
      songUrl = null;
      songPreview.removeAttribute('src');
      say('Song cleared. Remember to Save Changes.');
    }

    // ---- Events ----
    uploadSongBtn.addEventListener('click', uploadSong);
    removeSongBtn.addEventListener('click', removeSong);

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      say('Saving...');

      const payload = {
        id: userId,
        pronouns: pronounsEl.value.trim(),
        sun: sunEl.value.trim(),
        moon: moonEl.value.trim(),
        rising: risingEl.value.trim(),
        love_language: loveLangEl.value || null,
        skills: stringToSkills(skillsEl.value),
        void_message: voidMsgEl.value.trim(),
        funny_story: funnyStoryEl.value.trim(),
        song_url: songUrl || null,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb.from('profiles').upsert(payload, { onConflict:'id' });
      if(error){ console.error(error); say('Save failed', true); return; }
      say('Saved!');

      if (isLocal()){
        const u = new URL(safeReturn, location.href);
        u.hash = (u.hash ? u.hash + '&' : '#') + 'saved=1';
        location.href = u.toString();
      } else {
        afterSaveRedirect();
      }
    });

    // ---- Boot ----
    document.addEventListener('DOMContentLoaded', async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      if(!session){ location.href="./login.html"; return; }
      userId = session.user.id;
      await ensureProfileRow();
      await loadProfile();
    });
  </script>
</body>
</html>