<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Rage Space ‚Äî Submit</title>
<link rel="preconnect" href="https://tuqvpcevrhciursxrgav.supabase.co">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#39ff14; --green2:#7dff62; --ink:#e5e5e5;
  --bg:#000; --card:#090909; --border:#153b16; --muted:#8aff8a;
  --maxw:860px;
}
*{box-sizing: border-box}
html,body{height:100%}
body{
  margin:0; background: radial-gradient(120% 120% at 50% 0%, rgba(0,255,120,.08), rgba(0,0,0,.96) 60%), #000;
  color:var(--green); font-family: system-ui, Arial, Helvetica, sans-serif;
}
.wrap{max-width:var(--maxw); margin:28px auto 80px; padding:0 16px}
.hdr{
  display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  border:1px solid var(--border); border-radius:14px; background:rgba(7,7,7,.55); padding:12px 14px;
}
.h1{letter-spacing:2px; text-transform:uppercase; font-size:18px; font-weight:800}
.badge{border:1px solid var(--border); border-radius:8px; padding:2px 8px}
.btn{
  border:1px solid var(--green); color:var(--green); background:transparent;
  border-radius:12px; padding:10px 14px; cursor:pointer; text-decoration:none; display:inline-flex; gap:8px; align-items:center;
}
.btn:hover{box-shadow:0 0 14px rgba(57,255,20,.22)}
.btn.big{font-size:18px; padding:16px 18px}
.btn.ghost{opacity:.9}
.btn[disabled]{opacity:.45; cursor:not-allowed; box-shadow:none}

.card{border:1px solid var(--border); border-radius:16px; background:rgba(9,9,9,.6); padding:16px}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.small{font-size:12px; color:var(--muted)}
.mono{font-family: ui-monospace, "SF Mono", Menlo, Consolas, monospace}
.center{display:flex; justify-content:center; align-items:center; gap:12px}

hr.sep{border:0; border-top:1px dashed var(--border); margin:16px 0}

/* Minimal uploader */
#pickZone{
  display:grid; gap:12px; justify-items:center; text-align:center;
  padding:24px; border:1px dashed var(--border); border-radius:16px; background:rgba(0,0,0,.35);
}
#fileName{font-size:12px; color:var(--muted)}
.input{width:100%; border:1px solid var(--border); border-radius:10px; background:#0b0b0b; color:var(--ink); padding:10px 12px; font-size:14px}
.hidden{display:none !important}

/* Queue grid */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(120px,1fr));
  gap:12px;
}
.thumb{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:rgba(0,0,0,.35)}
.thumb img{width:100%; height:100%; object-fit:cover; aspect-ratio:1/1; display:block}
.thumb .idx{position:absolute; top:6px; left:6px; font-size:12px; background:rgba(0,0,0,.6); border:1px solid var(--border); border-radius:8px; padding:2px 6px}

/* Toast */
.toast{
  position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px;
  background:#071c07; color:var(--green); border:1px solid var(--border);
  border-radius:12px; padding:10px 14px; display:none; z-index:50; box-shadow:0 0 18px rgba(57,255,20,.18);
}
.toast.show{display:block}

/* Timer row */
.timer{
  display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  border:1px solid var(--border); border-radius:12px; background:rgba(7,7,7,.55); padding:10px 12px;
}
.clock{font-weight:800; border:1px solid var(--border); border-radius:8px; padding:2px 8px; min-width:52px; text-align:center}
.stage{border:1px solid var(--border); border-radius:8px; padding:2px 8px}
</style>

  <!-- === QUEUE BUCKET CONFIG (non-destructive addition) === -->
  <script>
  // Queue bucket support: after upload we mirror the image into the
  // `matchup-queue` bucket via the `enqueue-image` Edge Function.
  // Nothing below removes your DB-based flow ‚Äî this only adds the copy step.
  (function(){
    const SUPABASE_URL_Q = "https://tuqvpcevrhciursxrgav.supabase.co";
    const EDGE_ENQUEUE = `${SUPABASE_URL_Q}/functions/v1/enqueue-image`;
    const QUEUE_BUCKET = "matchup-queue";

    // extract bucket + path from a standard Supabase public URL
    window._parseStoragePublicUrl = function(url){
      try{
        const m = url.match(/\/storage\/v1\/object\/public\/(.+?)\/(.+)$/);
        if(!m) return null;
        return { bucket: m[1], path: m[2] };
      }catch(e){ return null; }
    };

    // expose enqueue helper for other scripts in this page
    window._enqueueToQueueBucket = async function(publicUrl){
      const info = window._parseStoragePublicUrl(publicUrl);
      if(!info){ console.log("[QUEUE] skip enqueue (not a supabase public URL)"); return { skipped:true }; }
      const body = {
        source_bucket: info.bucket,
        source_path: info.path,
        queue_bucket: QUEUE_BUCKET,
        target_path: info.path
      };
      try{
        const res = await fetch(EDGE_ENQUEUE, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(body)
        });
        const json = await res.json().catch(()=>({}));
        if(!res.ok){ console.warn("[QUEUE] enqueue failed", json); return { ok:false, error: json?.error || "enqueue failed" }; }
        console.log("[QUEUE] mirrored to", json.queue_bucket, json.queue_path);
        return { ok:true, ...json };
      }catch(err){
        console.warn("[QUEUE] enqueue exception", err);
        return { ok:false, error: String(err) };
      }
    };
  })();
  </script>

</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="row">
        <div class="h1">Submit Art</div>
        <span id="authBadge" class="badge">checking auth‚Ä¶</span>
      </div>
      <a class="btn ghost" href="./menu.html">‚Üê Menu</a>
    </div>

    <!-- Minimal uploader -->
    <div class="card" style="margin-top:16px">
      <div id="pickZone">
        <button id="btnPick" class="btn big">‚¨ÜÔ∏è Upload or Paste Art</button>
        <div id="fileName" class="small">jpg / png / webp ‚Äî 10MB max</div>
        <input id="fileInput" type="file" accept="image/*" class="hidden">
        <input id="urlInput" type="url" class="input hidden" placeholder="https://image.example/your-art.jpg">
        <div class="small mono" id="previewHint"></div>
      </div>

      <hr class="sep">

      <label class="row small" style="align-items:flex-start">
        <input id="consent" type="checkbox">
        <span>I am 18+, no sexual minors, no Nazi BS.</span>
      </label>

      <div class="center" style="margin-top:10px">
        <button id="btnSubmit" class="btn">‚úÖ Submit</button>
        <span id="submitMsg" class="small"></span>
      </div>
    </div>

    <!-- Live tournament status -->
    <div class="card" style="margin-top:16px">
      <div class="timer">
        <div class="row">
          <span>üïí Tournament Clock</span>
          <span id="clock" class="clock">‚Äî</span>
        </div>
        <div class="row">
          <span>üè∑Ô∏è Current Round</span>
          <span id="stage" class="stage">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Queue -->
    <div class="card" style="margin-top:16px">
      <div class="row" style="justify-content:space-between">
        <strong>üìú In the Queue</strong>
        <span class="small">Oldest first ‚Üí next in</span>
      </div>
      <div id="queue" class="grid" style="margin-top:12px"></div>
      <div id="queueEmpty" class="small" style="margin-top:6px; display:none">No items in queue.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ---------- Supabase + constants ---------- */
const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer`;
const BUCKET = 'art-uploads';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- Elements ---------- */
const authBadge = document.getElementById('authBadge');
const toastEl = document.getElementById('toast');

const btnPick = document.getElementById('btnPick');
const fileInput = document.getElementById('fileInput');
const urlInput = document.getElementById('urlInput');
const fileName = document.getElementById('fileName');
const previewHint = document.getElementById('previewHint');

const consent = document.getElementById('consent');
const btnSubmit = document.getElementById('btnSubmit');
const submitMsg = document.getElementById('submitMsg');

const queueGrid = document.getElementById('queue');
const queueEmpty = document.getElementById('queueEmpty');

const clockEl = document.getElementById('clock');
const stageEl = document.getElementById('stage');

/* ---------- Utils ---------- */
const iso = (d)=> new Date(d).toISOString().replace(/\.\d{3}Z$/,'Z');
function toast(msg, ms=1600){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),ms); }
function bytesToMB(n){ return (n/(1024*1024)).toFixed(2); }

/* ---------- Auth badge ---------- */
async function uid(){
  const { data:{session} } = await supabase.auth.getSession();
  return session?.user?.id || null;
}
function paintAuth(id){
  if (id){ authBadge.textContent='logged in'; authBadge.style.color=varGreen(); }
  else   { authBadge.textContent='not logged in'; authBadge.style.color='#ff6b6b'; authBadge.style.borderColor='#3b1616'; }
}
const varGreen = ()=> getComputedStyle(document.documentElement).getPropertyValue('--green') || '#39ff14';

/* ---------- Pick flow (file or URL) ---------- */
let picked = { file:null, url:'' };

btnPick.addEventListener('click', ()=>{
  // simple chooser: if file already chosen, let them paste URL; else prompt file first
  if (!picked.file && !picked.url){
    fileInput.click();
  } else {
    urlInput.classList.toggle('hidden');
    if (!urlInput.classList.contains('hidden')) urlInput.focus();
  }
});

fileInput.addEventListener('change', ()=>{
  const f = fileInput.files?.[0];
  if (!f) return;
  if (!f.type.startsWith('image/')){ toast('File must be an image'); fileInput.value=''; return; }
  if (f.size > 10*1024*1024){ toast('Max 10MB'); fileInput.value=''; return; }
  picked.file = f; picked.url = '';
  urlInput.value = ''; urlInput.classList.add('hidden');
  fileName.textContent = `${f.name} ‚Äî ${bytesToMB(f.size)} MB`;
  previewHint.textContent = 'Ready to upload';
});

urlInput.addEventListener('input', ()=>{
  picked.url = urlInput.value.trim();
  if (picked.url) { picked.file = null; fileInput.value=''; fileName.textContent = 'Using pasted URL'; previewHint.textContent = picked.url; }
  else { previewHint.textContent=''; }
});

/* ---------- Upload helper ---------- */
async function uploadToStorage(uid, file){
  const today = new Date();
  const yyyy = today.getUTCFullYear();
  const mm = String(today.getUTCMonth()+1).padStart(2,'0');
  const dd = String(today.getUTCDate()).padStart(2,'0');
  const safe = file.name.replace(/[^a-zA-Z0-9._-]/g,'_');
  const path = `${uid}/${yyyy}/${mm}/${dd}/${crypto.randomUUID()}-${safe}`;

  const { error:upErr } = await supabase.storage.from(BUCKET).upload(path, file, {
    contentType: file.type || 'application/octet-stream', cacheControl: '3600', upsert: false
  });
  if (upErr) throw upErr;

  const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
  if (!data?.publicUrl) throw new Error('No public URL returned');
  return data.publicUrl;
}

/* ---------- Submit ---------- */
btnSubmit.addEventListener('click', async ()=>{
  submitMsg.textContent='';
  const id = await uid();
  if (!id) return toast('Log in to submit');

  if (!consent.checked) return toast('Please consent to the rules');

  let finalUrl = picked.url;
  try{
    if (picked.file){
      toast('Uploading‚Ä¶');
      finalUrl = await uploadToStorage(id, picked.file);
    }
    if (!finalUrl) return toast('Pick a file or paste a URL');

    const { error } = await supabase.from('art_queue').insert({
      image_url: finalUrl, status: 'pending'
    });
    if (error) throw error;

    picked = {file:null, url:''};
    fileInput.value=''; urlInput.value=''; urlInput.classList.add('hidden');
    fileName.textContent = 'jpg / png / webp ‚Äî 10MB max';
    previewHint.textContent = '';
    consent.checked = false;

    toast('‚úÖ Art queued for next round');
    submitMsg.textContent = 'Art queued for next round.';
  }catch(e){
    console.error(e);
    toast(e?.message || 'Submit failed');
    submitMsg.textContent = 'Submit failed.';
  }
});

/* ---------- Queue render ---------- */
async function renderQueue(){
  try{
    const { data, error } = await supabase
      .from('art_queue')
      .select('id,image_url,created_at')
      .eq('status','pending')
      .order('created_at', { ascending: true });
    if (error) throw error;

    if (!data || !data.length){
      queueGrid.innerHTML = '';
      queueEmpty.style.display = 'block';
      return;
    }
    queueEmpty.style.display = 'none';
    queueGrid.innerHTML = data.map((r,i)=>`
      <div class="thumb" title="${r.image_url}">
        <span class="idx">#${i+1}</span>
        <img src="${r.image_url}" alt="queued art ${i+1}"/>
      </div>
    `).join('');
  }catch(e){
    console.error(e);
    queueGrid.innerHTML = '<div class="small">Failed to load queue.</div>';
  }
}

// realtime updates
supabase.channel('queue-live')
  .on('postgres_changes', { event:'*', schema:'public', table:'art_queue' }, renderQueue)
  .subscribe();

/* ---------- Tournament clock + stage ---------- */
// same source as matchup: call edge function to get {phase_end_at, remaining_sec, period_sec, paused}
async function callEdge(){
  const res = await fetch(EDGE_URL, {
    method:'GET',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${SUPABASE_ANON_KEY}`, 'apikey':SUPABASE_ANON_KEY }
  });
  const raw = await res.text();
  let j=null; try{ j=JSON.parse(raw); }catch{}
  if (!res.ok) throw new Error((j&&j.error)||raw||'edge error');
  return j?.state || j || {};
}
const normalize = (s)=>({phase_end_at:s.phase_end_at??null, period_sec:s.period_sec??20, paused:!!s.paused, remaining_sec:(typeof s.remaining_sec==='number')?s.remaining_sec:null});

let paused=false, serverPhaseEndISO=null, periodSec=20, remainingSec=null, lastSyncAt=0;
let currentPhaseKey=null, prevPhaseKey=null, currentStage='r32';

function baseAtOffset(n){
  if (!currentPhaseKey) return null;
  const t = Date.parse(currentPhaseKey) - Math.max(0,n)*periodSec*1000;
  return iso(t);
}
function stageLevel(st){ return st==='r32'?1 : st==='r16'?2 : st==='qf'?3 : st==='sf'?4 : 5; }

/* stage detection (mirrors matchup‚Äôs winners checks) */
async function detectStage(){
  if (!currentPhaseKey || !prevPhaseKey) return {stage:'r32'};

  const prev = prevPhaseKey;
  const keys = {
    r32: Array.from({length:16},(_,i)=>`${prev}::r32_${i+1}`),
    r16: Array.from({length:8}, (_,i)=>`${prev}::r16_${i+1}`),
    qf : [`${prev}::qf1`,`${prev}::qf2`,`${prev}::qf3`,`${prev}::qf4`],
    sf : [`${prev}::sf1`,`${prev}::sf2`],
    final: [`${prev}::final`]
  };

  const { data: r32W } = await supabase.from('winners').select('phase_key').in('phase_key', keys.r32);
  if ((r32W||[]).length<16) return {stage:'r32'};

  const { data: r16W } = await supabase.from('winners').select('phase_key').in('phase_key', keys.r16);
  if ((r16W||[]).length<8)  return {stage:'r16'};

  const { data: qfW } = await supabase.from('winners').select('phase_key').in('phase_key', keys.qf);
  if ((qfW||[]).length<4)   return {stage:'qf'};

  const { data: sfW } = await supabase.from('winners').select('phase_key').in('phase_key', keys.sf);
  if ((sfW||[]).length<2)   return {stage:'sf'};

  return {stage:'final'};
}

async function syncState(){
  const s = normalize(await callEdge());
  serverPhaseEndISO = s.phase_end_at;
  paused = s.paused;
  remainingSec = s.remaining_sec;
  periodSec = s.period_sec ?? 20;
  lastSyncAt = Date.now();

  currentPhaseKey = serverPhaseEndISO ? iso(serverPhaseEndISO) : null;
  prevPhaseKey = currentPhaseKey && periodSec ? iso(Date.parse(currentPhaseKey) - periodSec*1000) : null;

  const { stage } = await detectStage();
  currentStage = stage;
  stageEl.textContent = stage.toUpperCase();
}

let raf=null;
function loop(){
  if (paused){
    const sec = (typeof remainingSec==='number') ? Math.max(0, Math.ceil(remainingSec)) : 0;
    clockEl.textContent = String(sec);
    if (Date.now()-lastSyncAt>5000) syncState().catch(()=>{});
  } else {
    const rem = serverPhaseEndISO ? Math.max(0, Date.parse(serverPhaseEndISO) - Date.now()) : 0;
    clockEl.textContent = String(Math.ceil(rem/1000));
    if (rem<=0 || Date.now()-lastSyncAt>5000) syncState().catch(()=>{});
  }
  raf = requestAnimationFrame(loop);
}

/* ---------- Boot ---------- */
(async()=>{
  paintAuth(await uid());
  supabase.auth.onAuthStateChange((_e, session)=> paintAuth(session?.user?.id || null));
  await Promise.all([renderQueue(), syncState()]);
  loop();
})();
</script>
</body>
</html>