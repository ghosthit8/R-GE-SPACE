<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Rage Space ‚Äî Submit</title>
<link rel="preconnect" href="https://tuqvpcevrhciursxrgav.supabase.co">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#39ff14; --green2:#7dff62; --ink:#e5e5e5;
  --bg:#000; --card:#090909; --border:#153b16; --muted:#8aff8a;
  --maxw:860px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 900px at 50% -10%,rgba(57,255,20,.08),transparent 60%), #000;
  color:var(--ink); font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,ui-sans-serif;
}
.wrap{max-width:var(--maxw); margin:0 auto; padding:18px 14px 80px}
h1{margin:0 0 12px; font-size:24px; letter-spacing:.6px}
.header{display:flex; align-items:center; justify-content:space-between; gap:10px}
.badge{border:1px solid var(--border); padding:6px 10px; border-radius:12px; color:var(--ink)}
.badge strong{color:var(--green2)}
a{color:var(--green2); text-decoration:none}
a:hover{text-decoration:underline}
p{margin:0 0 10px}
small{font-size:12px; color:var(--muted)}

.btn{
  appearance:none; border-radius:999px; border:1px solid var(--border); background:linear-gradient(135deg,#102310,#050505);
  color:var(--ink); padding:8px 14px; font:13px system-ui,ui-sans-serif; cursor:pointer;
  display:inline-flex; align-items:center; gap:6px; text-decoration:none;
  box-shadow:0 0 18px rgba(0,0,0,.8);
}
.btn.primary{
  border-color:#39ff14; background:radial-gradient(120% 140% at 20% 0%,rgba(57,255,20,.18),#050505);
}
.btn.small{padding:5px 10px; font-size:12px}
.btn span.icon{font-size:15px; line-height:0}
.btn[disabled]{opacity:.45; cursor:not-allowed; box-shadow:none}
.input{width:100%; border:1px solid var(--border); border-radius:999px; background:#0b0b0b; color:var(--ink); padding:10px 12px; font-size:14px}
.hidden{display:none !important}

.card{border:1px solid var(--border); border-radius:18px; background:rgba(9,9,9,.6); padding:16px}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.small{font-size:12px; color:var(--muted)}
.mono{font-family:ui-monospace,"SF Mono",Menlo,Consolas,monospace}
.center{display:flex; justify-content:center; align-items:center; gap:12px}

hr.sep{border:0; border-top:1px dashed var(--border); margin:16px 0}

/* Queue grid */
.grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px}
.thumb{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#ff3aa0; min-height:120px}
.thumb img,.thumb video{display:block; width:100%; height:100%; object-fit:cover}
.thumb .idx{
  position:absolute; top:6px; left:6px; font:700 12px/1 ui-monospace,monospace; color:#c9c9c9;
  background:rgba(0,0,0,.55); padding:4px 6px; border-radius:10px; border:1px solid rgba(57,255,20,.35)
}

/* Timer card */
.timer .row{justify-content:space-between}
.clock{
  display:inline-flex; min-width:36px; height:26px; align-items:center; justify-content:center;
  border:1px solid var(--border); border-radius:10px; padding:0 10px;
}

.toast{
  position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
  background:rgba(0,0,0,.85); color:var(--ink); border:1px solid var(--border); padding:10px 12px; border-radius:12px;
  opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
}
.toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

/* Drop zone */
.drop{
  border:1px dashed var(--border); border-radius:14px; padding:14px; text-align:center;
  background:rgba(57,255,20,.03);
}
.drop.drag{background:rgba(57,255,20,.08)}
.preview{
  margin-top:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.preview img,.preview video{max-height:120px; border-radius:10px; border:1px solid var(--border)}
.authRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div>
      <h1>Submit to the Machine</h1>
      <p class="small">Drop an image or video into the global queue. The Machine decides who gets fed to the bracket.</p>
    </div>
    <div class="badge">
      <div class="small">Signed in as</div>
      <div class="mono" id="authUser">‚Ä¶</div>
    </div>
  </header>

  <section class="card timer" style="margin-top:14px">
    <div class="row">
      <div>
        <div class="small">Next tournament in</div>
        <div class="row" style="margin-top:4px">
          <span class="clock mono" id="clock">‚Ä¶</span>
        </div>
      </div>
      <div class="center">
        <a class="btn small" href="matchup.html"><span class="icon">‚ö°</span>View matchup</a>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <h2 style="margin:0 0 8px; font-size:18px">Upload / Link</h2>
    <p class="small" style="margin-bottom:10px">
      Max <span class="mono">200MB</span>. Images or short videos work best.
    </p>

    <div class="drop" id="dropZone">
      <p style="margin-bottom:6px">Drop a file here, or</p>
      <button class="btn small" id="fileBtn" type="button"><span class="icon">üìÅ</span><span>Choose file</span></button>
      <input id="fileInput" type="file" accept="image/*,video/*" class="hidden"/>
      <p class="small" style="margin-top:6px">or paste a direct URL:</p>
      <input id="urlInput" class="input" type="url" placeholder="https://example.com/your-art.jpg" />
      <div class="preview" id="preview"></div>
    </div>

    <hr class="sep"/>

    <div class="row" style="justify-content:space-between">
      <div class="small">This will add your piece to the <span class="mono">art_queue</span>.</div>
      <button class="btn primary" id="submitBtn" type="button">
        <span class="icon">‚¨ÜÔ∏è</span><span>Submit to queue</span>
      </button>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <div class="row" style="justify-content:space-between; margin-bottom:8px">
      <div class="row">
        <h2 style="margin:0; font-size:18px">Pending Queue</h2>
        <span class="small" id="queueCount">(0)</span>
      </div>
      <button class="btn small" id="refreshBtn" type="button"><span class="icon">üîÅ</span><span>Refresh</span></button>
    </div>
    <div id="queueEmpty" class="small">No pending items. The Machine is hungry.</div>
    <div id="queueGrid" class="grid"></div>
  </section>

  <section style="margin-top:18px; display:flex; justify-content:space-between; align-items:center; gap:8px">
    <div class="authRow">
      <button class="btn small" id="signOutBtn" type="button"><span class="icon">üö™</span><span>Sign out</span></button>
      <small>Session controlled by Supabase Auth.</small>
    </div>
    <div>
      <a class="btn ghost" href="./menu.html">‚Üê Menu</a>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
const SUPABASE_URL = 'https://tuqvpcevrhciursxrgav.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y';

// bump to 200MB client cap
const MAX_MB = 200; // client-side cap
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- Elements ---------- */
const authUserEl = document.getElementById('authUser');
const signOutBtn = document.getElementById('signOutBtn');
const clockEl = document.getElementById('clock');

const fileBtn = document.getElementById('fileBtn');
const fileInput = document.getElementById('fileInput');
const urlInput = document.getElementById('urlInput');
const dropZone = document.getElementById('dropZone');
const preview = document.getElementById('preview');

const submitBtn = document.getElementById('submitBtn');
const refreshBtn = document.getElementById('refreshBtn');

const queueGrid = document.getElementById('queueGrid');
const queueEmpty = document.getElementById('queueEmpty');
const queueCount = document.getElementById('queueCount');

const toastEl = document.getElementById('toast');

/* ---------- Helpers ---------- */
function toast(msg, ms=2600){
  if (!toastEl) return;
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), ms);
}

function log(...args){ console.log('[SUBMIT]', ...args); }

async function uid(){
  const { data } = await supabase.auth.getUser();
  return data?.user?.id || null;
}

function paintAuth(userId){
  if (!authUserEl) return;
  authUserEl.textContent = userId ? String(userId).slice(0,8)+'‚Ä¶' : 'Not signed in';
}

/* ---------- Auth handling ---------- */
signOutBtn?.addEventListener('click', async ()=>{
  await supabase.auth.signOut();
  location.href = 'index.html';
});

/* ---------- Clock sync (reads from cycles_v2) ---------- */
async function syncState(){
  try{
    const { data, error } = await supabase
      .from('cycles_v2')
      .select('id, seconds_remaining')
      .eq('is_active', true)
      .order('created_at',{ascending:false})
      .limit(1)
      .maybeSingle();
    if (error) throw error;
    const secs = data?.seconds_remaining ?? null;
    if (secs == null){
      clockEl.textContent = '‚Äî';
    }else{
      clockEl.textContent = Math.max(0, Math.floor(secs));
    }
  }catch(e){
    console.error('[CLOCK] sync failed', e);
    clockEl.textContent = '‚Äî';
  }
}

/* ---------- Clock tick (front-end) ---------- */
let lastTick = Date.now();
function tick(){
  const now = Date.now();
  const dt = (now - lastTick)/1000;
  lastTick = now;
  const raw = parseInt(clockEl.textContent, 10);
  if (!Number.isNaN(raw)){
    const next = Math.max(0, raw - dt);
    const before = clockEl.textContent;
    const rounded = Math.floor(next);
    clockEl.textContent = String(rounded);
    if (before !== clockEl.textContent){
      console.log(`[6:13:49 PM] CLOCK: clock ${before} ‚Üí ${clockEl.textContent}`);
    }
  }
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* ---------- File picking & preview ---------- */
let picked = {file:null, url:''};

fileBtn?.addEventListener('click', ()=> fileInput?.click());
fileInput?.addEventListener('change', ()=>{
  const f = fileInput.files?.[0];
  if (!f) return;
  picked.file = f;
  picked.url = '';
  urlInput.value = '';
  renderPreview();
});

urlInput?.addEventListener('input', ()=>{
  picked.url = urlInput.value.trim();
  if (picked.url) picked.file = null;
  renderPreview();
});

['dragenter','dragover'].forEach(ev=>{
  dropZone?.addEventListener(ev, e=>{
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add('drag');
  });
});
['dragleave','drop'].forEach(ev=>{
  dropZone?.addEventListener(ev, e=>{
    e.preventDefault();
    e.stopPropagation();
    if (ev === 'drop'){
      const f = e.dataTransfer?.files?.[0];
      if (f){
        picked.file = f;
        picked.url = '';
        urlInput.value = '';
        renderPreview();
      }
    }
    dropZone.classList.remove('drag');
  });
});

function renderPreview(){
  if (!preview) return;
  preview.innerHTML = '';
  if (picked.file){
    const url = URL.createObjectURL(picked.file);
    const isVideo = picked.file.type.startsWith('video/');
    if (isVideo){
      const v = document.createElement('video');
      v.src = url;
      v.muted = true;
      v.playsInline = true;
      v.autoplay = true;
      v.loop = true;
      preview.appendChild(v);
    }else{
      const img = document.createElement('img');
      img.src = url;
      preview.appendChild(img);
    }
  }else if (picked.url){
    const isVideo = /\.(mp4|webm|mov)(\?|$)/i.test(picked.url);
    if (isVideo){
      const v = document.createElement('video');
      v.src = picked.url;
      v.muted = true;
      v.playsInline = true;
      v.autoplay = true;
      v.loop = true;
      preview.appendChild(v);
    }else{
      const img = document.createElement('img');
      img.src = picked.url;
      preview.appendChild(img);
    }
  }
}

/* ---------- Storage upload ---------- */
async function uploadToStorage(id, file){
  const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
  const path = `${id}.${ext}`;
  const { data, error } = await supabase.storage
    .from('art-uploads')
    .upload(path, file, {
      cacheControl: '3600',
      upsert: false
    });
  if (error) throw error;
  const { data:pub } = supabase.storage.from('art-uploads').getPublicUrl(data.path);
  return pub?.publicUrl ?? null;
}

/* ---------- Submit ---------- */
submitBtn?.addEventListener('click', async ()=>{
  try{
    submitBtn.disabled = true;
    const userId = await uid();
    if (!userId){
      toast('Sign in first');
      return;
    }

    let finalUrl = '';
    const id = crypto.randomUUID();

    if (picked.url){
      finalUrl = picked.url;
    }else if (picked.file){
      if (picked.file.size > MAX_MB*1024*1024) {
        return toast(`Max ${MAX_MB}MB`);
      }
      toast('Uploading‚Ä¶');
      finalUrl = await uploadToStorage(id, picked.file);
    }
    if (!finalUrl) return toast('Pick a file or paste a URL');

    // **SIMPLE, SAFE PAYLOAD** ‚Äî only use columns we know exist
    const payload = {
      image_url: finalUrl,
      status: 'pending'
    };

    const { error } = await supabase.from('art_queue').insert(payload);
    if (error) {
      console.error('[SUBMIT] insert error', error);
      throw error;
    }

    picked = {file:null, url:''};
    fileInput.value=''; urlInput.value=''; urlInput.classList.add('hidden');
    preview.innerHTML = '';
    toast('Submitted to queue');
    renderQueue().catch(()=>{});
  }catch(e){
    console.error(e);
    toast('Submit failed');
  }finally{
    submitBtn.disabled = false;
  }
});

/* ---------- Queue rendering ---------- */
async function renderQueue(){
  try{
    const { data, error } = await supabase
      .from('art_queue')
      .select('id,image_url,created_at')
      .eq('status','pending')
      .order('created_at', { ascending: true });
    if (error) throw error;

    if (!data || !data.length){
      queueGrid.innerHTML = '';
      queueEmpty.style.display = 'block';
      if (queueCount) queueCount.textContent = '(0)';
      return;
    }
    queueEmpty.style.display = 'none';
    if (queueCount) queueCount.textContent = `(${data.length})`;

    queueGrid.innerHTML = data.map((r,i)=>{
      const url = r.image_url || '';
      const isVideo = /\.(mp4|webm|mov)(\?|$)/i.test(url);
      const media = isVideo
        ? `<video src="${url}#t=0.1" muted playsinline loop></video>`
        : `<img src="${url}" alt="queued art ${i+1}"/>`;
      return `
      <div class="thumb" data-id="${r.id}" title="${url}">
        <span class="idx">#${i+1}</span>
        ${media}
      </div>
      `;
    }).join('');

    // Attach debug handlers for images only
    queueGrid.querySelectorAll('img').forEach(img=>{
      img.addEventListener('load', ()=> log('IMG: loaded  ', img.src));
      img.addEventListener('error', ()=> {
        console.warn('IMG: error   ', img.src);
        const host = img.closest('[data-id], .thumb, .item');
        if (host) {
          host.remove();
          const count = queueGrid.children.length;
          if (queueCount) queueCount.textContent = `(${count})`;
          if (count === 0) queueEmpty.style.display = 'block';
          console.warn('[QUEUE] removed 404 image tile');
        }
      });
    });
  }catch(e){
    console.error(e);
    toast('Queue failed to load');
  }
}

/* ---------- Realtime queue watch ---------- */
const queueChannel = supabase.channel('queue-watch')
  // NOTE: only listening for INSERT now, so we don't insta-delete tiles on locked/used
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'art_queue' }, (payload) => {
    const row = payload.new;
    if (row?.status !== 'pending') return;
    const div = document.createElement('div');
    div.className = 'thumb';
    div.dataset.id = row.id;
    const url = row.image_url || '';
    div.title = url;
    const isVideo = /\.(mp4|webm|mov)(\?|$)/i.test(url);
    const media = isVideo
      ? `<video src="${url}#t=0.1" muted playsinline loop></video>`
      : `<img src="${url}" alt="queued art"/>`;
    div.innerHTML = `<span class="idx">#?</span>${media}`;
    const img = div.querySelector('img');
    if (img) {
      img.addEventListener('load', ()=> log('IMG: loaded  ', img.src));
      img.addEventListener('error', ()=> {
        console.warn('IMG: error   ', img.src);
        const host = img.closest('[data-id], .thumb, .item');
        if (host) {
          host.remove();
          const count = queueGrid.children.length;
          if (queueCount) queueCount.textContent = `(${count})`;
          if (count === 0) queueEmpty.style.display = 'block';
          console.warn('[QUEUE] removed 404 image tile');
        }
      });
    }
    if (queueGrid.children.length === 0) {
      queueEmpty.style.display = 'none';
      queueGrid.appendChild(div);
    } else {
      queueGrid.appendChild(div);
    }
    const count = queueGrid.children.length;
    if (queueCount) queueCount.textContent = `(${count})`;
  })
  .subscribe();

// Clean up
window.addEventListener('beforeunload', ()=> { try { supabase.removeChannel(queueChannel); } catch {} });

/* ---------- Round start watch (for queue refresh) ---------- */
let __lastClock = null;
function __watchRoundStart() {
  const n = parseInt(clockEl.textContent, 10);
  if (!isNaN(n)) {
    if (__lastClock !== null && __lastClock <= 1 && n > __lastClock) {
      console.log('[QUEUE] round start detected ‚Äî refreshing queue');
      renderQueue().catch(()=>{});
    }
    __lastClock = n;
  }
  requestAnimationFrame(__watchRoundStart);
}
__watchRoundStart();

/* ---------- Boot ---------- */
(async()=>{
  paintAuth(await uid());
  supabase.auth.onAuthStateChange((_e, session)=> paintAuth(session?.user?.id || null));
  await syncState();
  await renderQueue();
})();

refreshBtn?.addEventListener('click', ()=> renderQueue().catch(()=>{}));
</script>
<script src="js/auth-guard.js" type="module"></script>

</body>
</html>