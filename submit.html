<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Rage Space — Submit Art</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg:#020a02;
  --bg2:#040d04;
  --accent:#39ff14;
  --accent-soft:rgba(57,255,20,0.14);
  --accent-soft-2:rgba(57,255,20,0.06);
  --accent-strong:rgba(57,255,20,0.35);
  --danger:#ff0033;
  --danger-soft:rgba(255,0,51,0.15);
  --text:#e5ffe5;
  --text-soft:#9eea9e;
  --border:#184818;
  --border-strong:#42ff42;
  --shadow:0 0 18px rgba(0,0,0,0.9);
  --radius-lg:18px;
  --radius-md:12px;
  --radius-sm:8px;
  --scanline:linear-gradient(
    to bottom,
    rgba(0,0,0,0.35) 0px,
    rgba(0,0,0,0.35) 1px,
    rgba(0,255,90,0.03) 2px,
    rgba(0,0,0,0.35) 3px,
    rgba(0,0,0,0.35) 4px
  );
  --glow-soft:0 0 22px rgba(57,255,20,0.22);
  --glow-strong:0 0 32px rgba(57,255,20,0.52);
  --font-main:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,sans-serif;
  --font-mono:"IBM Plex Mono","JetBrains Mono","SF Mono",ui-monospace,Menlo,monospace;
}
*,
*::before,
*::after{
  box-sizing:border-box;
}
html,body{
  margin:0;
  padding:0;
  background:#000;
  color:var(--text);
  font-family:var(--font-main);
}
body{
  min-height:100vh;
  background:
    radial-gradient(circle at top,rgba(57,255,20,0.18),transparent 60%),
    radial-gradient(circle at bottom,rgba(0,0,0,0.9),#000),
    var(--bg);
  color:var(--text);
}
.app-shell{
  max-width:960px;
  margin:0 auto;
  padding:16px 14px 32px;
}
.header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:18px;
}
.page-title{
  font-size:28px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:var(--accent);
  text-shadow:0 0 12px rgba(57,255,20,0.7);
}
.header-actions{
  display:flex;
  align-items:center;
  gap:8px;
}
.badge-pill{
  border-radius:999px;
  border:1px solid var(--border);
  padding:5px 11px;
  font-size:11px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:radial-gradient(circle at top,rgba(57,255,20,0.18),rgba(5,22,5,0.7));
  box-shadow:var(--glow-soft);
}
.badge-dot{
  width:7px;
  height:7px;
  border-radius:999px;
  background:var(--accent);
  box-shadow:0 0 10px rgba(57,255,20,1);
}
.btn-ghost{
  border-radius:999px;
  border:1px solid var(--border);
  padding:5px 13px;
  font-size:12px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:linear-gradient(120deg,rgba(8,28,8,0.9),rgba(2,8,2,0.95));
  color:var(--text-soft);
  cursor:pointer;
  box-shadow:var(--shadow);
}
.btn-ghost .caret{
  font-size:13px;
}
.btn-ghost:active{
  transform:translateY(1px);
  box-shadow:none;
}
.main-card{
  border-radius:var(--radius-lg);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  background:
    linear-gradient(145deg,rgba(3,14,3,0.98),rgba(7,28,7,0.98)),
    var(--scanline);
  padding:18px 16px 16px;
  position:relative;
  overflow:hidden;
}
.main-card::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:repeating-linear-gradient(
    to bottom,
    rgba(57,255,20,0.06) 0px,
    rgba(57,255,20,0.02) 1px,
    transparent 2px,
    transparent 3px
  );
  mix-blend-mode:soft-light;
  opacity:0.7;
  pointer-events:none;
}
.main-card-inner{
  position:relative;
  z-index:1;
}
.section-title{
  font-size:15px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:var(--text-soft);
  margin-bottom:8px;
}
.section-subtitle{
  font-size:13px;
  color:var(--text-soft);
  opacity:0.8;
  margin-bottom:14px;
}
.upload-shell{
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  padding:12px 12px 14px;
  background:radial-gradient(circle at top left,rgba(57,255,20,0.12),rgba(3,14,3,0.96));
  box-shadow:0 0 0 1px rgba(57,255,20,0.05);
  position:relative;
}
.upload-shell::before{
  content:"QUEUE INJECTION PORT";
  position:absolute;
  top:7px;
  right:12px;
  font-size:9px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:rgba(158,234,158,0.45);
}
.pick-zone{
  border-radius:var(--radius-md);
  border:1px dashed var(--border-strong);
  padding:15px 12px;
  text-align:center;
  background:radial-gradient(circle at top,rgba(57,255,20,0.06),rgba(4,15,4,0.95));
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.pick-zone:hover{
  border-style:solid;
  box-shadow:var(--glow-soft);
}
.pick-icon{
  font-size:22px;
}
.pick-label{
  font-size:16px;
  text-transform:uppercase;
  letter-spacing:0.14em;
}
.pick-sub{
  font-size:12px;
  color:var(--text-soft);
}
.pick-sub strong{
  color:var(--accent);
}
.hidden-input{
  display:none;
}
.preview{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:6px;
}
.preview img, .preview video{max-height:120px; border-radius:10px; border:1px solid var(--border)}
.preview img{
  box-shadow:0 0 0 1px rgba(57,255,20,0.24);
}
.preview video{
  box-shadow:0 0 0 1px rgba(57,255,20,0.24);
  width:100%;
  max-width:100%;
  background:#000;
}
.preview .small{
  font-size:11px;
  color:var(--text-soft);
  opacity:0.9;
}
.mono{
  font-family:var(--font-mono);
}
.form-grid{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-top:18px;
}
.field-block{
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  padding:11px 11px 9px;
  background:radial-gradient(circle at top,rgba(57,255,20,0.05),rgba(3,12,3,0.98));
}
.field-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:var(--text-soft);
  margin-bottom:4px;
}
.help-text{
  font-size:11px;
  color:var(--text-soft);
  opacity:0.85;
  margin-top:3px;
}
.input,
.textarea{
  width:100%;
  border-radius:10px;
  border:1px solid var(--border);
  padding:8px 10px;
  font-size:14px;
  font-family:var(--font-main);
  background:linear-gradient(135deg,rgba(5,14,5,0.9),rgba(2,8,2,0.96));
  color:var(--text);
  outline:none;
  box-shadow:0 0 0 1px rgba(57,255,20,0.07);
}
.input:focus,
.textarea:focus{
  border-color:var(--border-strong);
  box-shadow:var(--glow-soft);
}
.textarea{
  min-height:72px;
  resize:vertical;
}
.checkbox-row{
  display:flex;
  align-items:flex-start;
  gap:8px;
  margin-top:10px;
}
.checkbox-row input[type="checkbox"]{
  width:18px;
  height:18px;
  border-radius:4px;
  border:1px solid var(--border);
  accent-color:var(--accent);
}
.checkbox-row label{
  font-size:12px;
  color:var(--text-soft);
}
.btn-primary{
  margin-top:16px;
  width:100%;
  border-radius:999px;
  padding:10px 16px;
  border:1px solid rgba(57,255,20,0.7);
  background:radial-gradient(circle at top,rgba(57,255,20,0.35),rgba(1,10,1,0.9));
  color:#021002;
  font-weight:600;
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:0.18em;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  cursor:pointer;
  box-shadow:var(--glow-strong);
}
.btn-primary[disabled]{
  opacity:0.5;
  cursor:default;
  box-shadow:none;
}
.btn-primary .icon{
  font-size:16px;
}
.submit-status{
  margin-top:6px;
  font-size:11px;
  color:var(--text-soft);
}
.submit-status.error{
  color:var(--danger);
}
.meta-row{
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.meta-item{
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  padding:8px 10px 7px;
  background:linear-gradient(135deg,rgba(2,8,2,0.96),rgba(4,12,4,0.98));
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.meta-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:var(--text-soft);
}
.meta-value{
  font-size:13px;
  font-family:var(--font-mono);
  color:var(--accent);
}
.meta-pill{
  border-radius:999px;
  border:1px solid var(--border);
  padding:4px 9px;
  font-size:10px;
  letter-spacing:0.16em;
  text-transform:uppercase;
  color:var(--text-soft);
  background:linear-gradient(120deg,rgba(5,18,5,0.96),rgba(3,10,3,0.96));
}
.footer-row{
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.footer-link-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.footer-link{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.14em;
  color:var(--accent);
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.footer-link .chevron{
  font-size:14px;
}
.footer-clock{
  border-radius:999px;
  border:1px solid var(--border);
  padding:6px 10px;
  font-size:12px;
  display:inline-flex;
  align-items:center;
  gap:7px;
  background:linear-gradient(120deg,rgba(5,18,5,0.96),rgba(3,8,3,0.96));
}
.footer-clock-label{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.18em;
  color:var(--text-soft);
}
.footer-clock-value{
  font-family:var(--font-mono);
  font-size:13px;
  color:var(--accent);
}
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  max-width:440px;
  width:calc(100% - 32px);
  border-radius:999px;
  border:1px solid var(--border-strong);
  padding:9px 14px;
  background:radial-gradient(circle at top,rgba(57,255,20,0.32),rgba(3,10,3,0.98));
  color:var(--text);
  font-size:12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  box-shadow:var(--glow-soft);
  pointer-events:none;
  opacity:0;
  transition:opacity 0.18s ease-out, transform 0.18s ease-out;
}
.toast.visible{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
.toast.hidden-internal{
  opacity:0;
}
.toast-message{
  font-family:var(--font-mono);
}
.toast-tag{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:var(--bg);
  background:var(--accent);
  padding:2px 6px;
  border-radius:999px;
}
.inline-badge{
  border-radius:999px;
  border:1px solid var(--border);
  padding:2px 6px;
  font-size:10px;
  letter-spacing:0.16em;
  text-transform:uppercase;
  color:var(--text-soft);
}
.queue-section{
  margin-top:16px;
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  padding:9px 10px 8px;
  background:linear-gradient(135deg,rgba(4,10,4,0.98),rgba(3,8,3,0.98));
}
.queue-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.queue-title{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.18em;
  color:var(--text-soft);
}
.queue-pill{
  border-radius:999px;
  border:1px solid var(--border);
  padding:2px 7px;
  font-size:11px;
  font-family:var(--font-mono);
  color:var(--accent);
}
.queue-body{
  margin-top:7px;
  font-size:11px;
  color:var(--text-soft);
}
.queue-empty{
  opacity:0.7;
}
.hidden{
  display:none !important;
}
@media (min-width:720px){
  .form-grid{
    flex-direction:row;
  }
  .form-grid > .field-block{
    flex:1;
  }
}
</style>
</head>
<body>
<div class="app-shell">
  <header class="header-row">
    <div class="page-title">Submit Art</div>
    <div class="header-actions">
      <div class="badge-pill" id="authStatus">
        <span class="badge-dot"></span>
        <span id="authLabel">checking auth…</span>
      </div>
      <button class="btn-ghost" id="btnMenu">
        <span>← Menu</span>
        <span class="caret">▾</span>
      </button>
    </div>
  </header>

  <main class="main-card">
    <div class="main-card-inner">
      <div class="section-title">Upload or Paste Art</div>
      <div class="section-subtitle">Drop your piece into the machine. It will enter the next available tournament queue.</div>

      <section class="upload-shell">
        <label class="pick-zone" id="pickZone">
          <div class="pick-icon">⬆️</div>
          <div class="pick-label">Upload or Paste Art</div>
          <div class="pick-sub" id="fileName">image or video — 100MB max. Tip: drag & drop or paste (Ctrl/⌘+V)</div>
          <input id="fileInput" class="hidden-input" type="file" accept="image/*,video/*">
        </label>

        <div class="preview">
          <img id="imgPreview" alt="" class="hidden">
          <video id="videoPreview" class="hidden" playsinline controls></video>
          <div class="small mono" id="previewHint"></div>
        </div>

        <div class="field-block" style="margin-top:10px;">
          <div class="field-label">Or remote URL (images & videos)</div>
          <input id="urlInput" class="input" placeholder="https://image.example/your-art.jpg" autocomplete="off">
          <div class="help-text mono">Paste a direct link to the file. Data-hoarding encouraged; hot-linking is not.</div>
        </div>
      </section>

      <section class="form-grid">
        <div class="field-block">
          <div class="field-label">Optional details</div>
          <label class="field-label" style="margin-top:4px;">Piece title</label>
          <input id="titleInput" class="input" placeholder="Untitled rage object">
          <label class="field-label" style="margin-top:10px;">Description</label>
          <textarea id="descInput" class="textarea" placeholder="What is this piece devouring?"></textarea>
          <div class="help-text">These show up on the winners page and future profile views. Keep it weird, keep it yours.</div>
        </div>

        <div class="field-block">
          <div class="field-label">Content rules</div>
          <div class="help-text">Rage Space is 18+ and aggressively anti-fascist.</div>
          <div class="checkbox-row">
            <input id="chkConsent" type="checkbox">
            <label for="chkConsent">
              I am 18+, and this piece contains <strong>no sexualized minors, no real-death gore, no doxxing, and no Nazi / organized hate propaganda.</strong>
            </label>
          </div>
          <div class="help-text" style="margin-top:6px;">
            Violations get hard-banned + permanent art exile. Don’t test the machine.
          </div>
        </div>
      </section>

      <button class="btn-primary" id="btnSubmit">
        <span class="icon">✅</span>
        <span>Submit</span>
      </button>
      <div class="submit-status" id="submitStatus"></div>

      <section class="meta-row">
        <div class="meta-item">
          <div>
            <div class="meta-label">Tournament Clock</div>
            <div class="meta-value" id="clockLabel">--</div>
          </div>
          <div class="meta-pill">Next bracket cutover</div>
        </div>

        <div class="meta-item">
          <div>
            <div class="meta-label">Queue Status</div>
            <div class="meta-value" id="queueStatus">checking…</div>
          </div>
          <div class="meta-pill">Art waiting to battle</div>
        </div>
      </section>

      <section class="queue-section">
        <div class="queue-header">
          <div class="queue-title">In the Queue</div>
          <div class="queue-pill" id="queueCount">(0)</div>
        </div>
        <div class="queue-body">
          <div class="queue-empty" id="queueEmpty">Your piece will appear here once it’s fully uploaded and accepted.</div>
          <div id="queueList"></div>
        </div>
      </section>

      <section class="footer-row">
        <div class="footer-link-row">
          <a href="matchup.html" class="footer-link">
            <span class="chevron">⟶</span>
            <span>Watch the current tournament</span>
          </a>
          <div class="footer-clock">
            <span class="footer-clock-label">Until next tournament</span>
            <span class="footer-clock-value" id="footerClock">--</span>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<div class="toast" id="toast">
  <div class="toast-message" id="toastMsg"></div>
  <div class="toast-tag">submit.art</div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>
<script>
const SUPABASE_URL = 'https://tuqvpcevrhciursxrgav.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbRJQxe8y0UcRSBv_3_1VKC4xwJHxgXGN_RJQ6XURp4';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const MAX_MB = 100;
const MAX_BYTES = MAX_MB * 1024 * 1024;

const BUCKET = 'art-uploads';
const QUEUE_TABLE = 'art_queue';
const TIMER_ENDPOINT = `${SUPABASE_URL}/functions/v1/global-timer-v2`;

function q(id){ return document.getElementById(id); }

const pickZone = q('pickZone');
const fileInput = q('fileInput');
const urlInput = q('urlInput');
const fileName = q('fileName');
const imgPreview = q('imgPreview');
const videoPreview = q('videoPreview');
const previewHint = q('previewHint');
const chkConsent = q('chkConsent');
const btnSubmit = q('btnSubmit');
const submitStatus = q('submitStatus');
const clockLabel = q('clockLabel');
const footerClock = q('footerClock');
const queueStatus = q('queueStatus');
const queueCount = q('queueCount');
const queueEmpty = q('queueEmpty');
const queueList = q('queueList');
const toastEl = q('toast');
const toastMsg = q('toastMsg');
const authStatus = q('authStatus');
const authLabel = q('authLabel');
const btnMenu = q('btnMenu');
const titleInput = q('titleInput');
const descInput = q('descInput');

let toastTimeout = null;
let picked = { file:null, url:'' };
let clockState = { remaining_sec:null, period_sec:null };
let isSubmitting = false;

function log(...args){
  try{
    const stamp = new Date().toLocaleTimeString();
    console.log(`[${stamp}] SUBMIT:`, ...args);
  }catch{}
}

function showToast(msg){
  toastMsg.textContent = msg;
  toastEl.classList.add('visible');
  if (toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{
    toastEl.classList.remove('visible');
  }, 3200);
}
const toast = showToast;

function bytesToMB(bytes){
  return Math.round((bytes/1024/1024)*10)/10;
}

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function setPreview(src, kind='image'){
  if (!imgPreview && !videoPreview) return;
  if (!src){
    if (imgPreview){ imgPreview.removeAttribute('src'); hide(imgPreview); }
    if (videoPreview){
      try{ videoPreview.pause(); }catch(e){}
      videoPreview.removeAttribute('src');
      try{ videoPreview.load(); }catch(e){}
      hide(videoPreview);
    }
    return;
  }
  if (kind === 'video'){
    if (imgPreview) hide(imgPreview);
    if (videoPreview){ videoPreview.src = src; show(videoPreview); }
  } else {
    if (videoPreview){
      try{ videoPreview.pause(); }catch(e){}
      hide(videoPreview);
    }
    if (imgPreview){ imgPreview.src = src; show(imgPreview); }
  }
}

function setSubmitMsg(msg, isError=false){
  submitStatus.textContent = msg||'';
  submitStatus.classList.toggle('error', !!isError);
}

/* ---------- Auth + nav ---------- */
btnMenu.addEventListener('click', ()=>{
  window.location.href = 'index.html';
});

async function currentUser(){
  const { data:{ user }, error } = await supabase.auth.getUser();
  if (error) log('auth getUser error', error);
  return user||null;
}

async function currentUsername(userId){
  if (!userId) return null;
  const { data, error } = await supabase
    .from('profiles')
    .select('username')
    .eq('id', userId)
    .maybeSingle();
  if (error){ log('profiles lookup error', error); return null; }
  return data?.username || null;
}

async function initAuth(){
  try{
    const user = await currentUser();
    if (user){
      authLabel.textContent = 'logged in';
      authStatus.querySelector('.badge-dot').style.background = 'var(--accent)';
    } else {
      authLabel.textContent = 'guest — log in';
      authStatus.querySelector('.badge-dot').style.background = 'var(--danger)';
    }
  }catch(e){
    authLabel.textContent = 'auth error';
  }
}
initAuth();

/* ---------- File picking / URL / preview ---------- */

pickZone.addEventListener('click', (e)=>{
  if (e.target === urlInput) return;
  fileInput.click();
});

fileInput.addEventListener('change', ()=>{
  const f = fileInput.files?.[0];
  if (!f) return;
  const isImage = f.type.startsWith('image/');
  const isVideo = f.type.startsWith('video/');
  if (!isImage && !isVideo){
    toast('File must be an image or video');
    fileInput.value='';
    return;
  }
  if (f.size > MAX_BYTES){
    toast(`Max ${MAX_MB}MB`);
    fileInput.value='';
    return;
  }
  picked.file = f; picked.url = '';
  urlInput.value = ''; urlInput.classList.add('hidden');
  fileName.textContent = `${f.name} — ${bytesToMB(f.size)} MB`;
  const kind = isVideo ? 'video' : 'image';
  setPreview(URL.createObjectURL(f), kind);
  previewHint.textContent = isVideo ? 'Ready to upload (video)' : 'Ready to upload';
});

['dragenter','dragover'].forEach(ev=>{
  pickZone.addEventListener(ev, (e)=>{
    e.preventDefault();
    pickZone.style.borderStyle = 'solid';
  });
});
['dragleave','drop'].forEach(ev=>{
  pickZone.addEventListener(ev, (e)=>{
    e.preventDefault();
    pickZone.style.borderStyle = 'dashed';
  });
});
pickZone.addEventListener('drop', (e)=>{
  const f = e.dataTransfer?.files?.[0];
  if (!f) return;
  const isImage = f.type.startsWith('image/');
  const isVideo = f.type.startsWith('video/');
  if (!isImage && !isVideo) return toast('File must be an image or video');
  if (f.size > MAX_BYTES) return toast(`Max ${MAX_MB}MB`);
  picked.file = f; picked.url='';
  fileInput.value=''; urlInput.value=''; urlInput.classList.add('hidden');
  const kind = isVideo ? 'video' : 'image';
  fileName.textContent = `${f.name} — ${bytesToMB(f.size)} MB`;
  setPreview(URL.createObjectURL(f), kind);
  previewHint.textContent = isVideo ? 'Ready to upload (dropped video)' : 'Ready to upload (dropped image)';
});

urlInput.addEventListener('input', ()=>{
  const v = urlInput.value.trim();
  if (v){
    picked.url = v;
    picked.file = null;
    fileInput.value = '';
    fileName.textContent = 'Using remote URL';
    const isVid = /\.(mp4|webm|mov|m4v|ogg)(\?\S*)?$/i.test(v);
    const isImg = /\.(png|jpe?g|webp|gif)(\?\S*)?$/i.test(v);
    if (isVid || isImg){
      setPreview(v, isVid?'video':'image');
      previewHint.textContent = v;
    } else {
      setPreview(null);
      previewHint.textContent = 'URL set (no preview)';
    }
  } else {
    picked.url='';
    fileName.textContent = 'image or video — 100MB max. Tip: drag & drop or paste (Ctrl/⌘+V)';
    setPreview(null);
    previewHint.textContent='';
  }
});

window.addEventListener('paste', (e)=>{
  try{
    const items = e.clipboardData?.items || [];
    for (const it of items){
      if (it.kind === 'file'){
        const f = it.getAsFile();
        if (f){
          const isImage = f.type.startsWith('image/');
          const isVideo = f.type.startsWith('video/');
          if (!isImage && !isVideo) continue;
          if (f.size > MAX_BYTES) { toast(`Max ${MAX_MB}MB`); return; }
          picked.file = f; picked.url='';
          fileInput.value=''; urlInput.value=''; urlInput.classList.add('hidden');
          const kind = isVideo ? 'video' : 'image';
          fileName.textContent = `${f.name||'pasted-file'} — ${bytesToMB(f.size)} MB`;
          setPreview(URL.createObjectURL(f), kind);
          previewHint.textContent = isVideo ? 'Ready to upload (pasted video)' : 'Ready to upload (pasted image)';
          return;
        }
      } else if (it.kind === 'string'){
        it.getAsString((txt)=>{
          const s = (txt||'').trim();
          const isImg = /^https?:\/\/\S+\.(png|jpe?g|webp|gif)(\?\S*)?$/i.test(s);
          const isVid = /^https?:\/\/\S+\.(mp4|webm|mov|m4v|ogg)(\?\S*)?$/i.test(s);
          if (isImg || isVid){
            picked.url = s; picked.file = null;
            urlInput.value = s; urlInput.classList.remove('hidden');
            fileInput.value = '';
            fileName.textContent = 'Using pasted URL';
            setPreview(s, isVid ? 'video' : 'image');
            previewHint.textContent = s;
          }
        });
      }
    }
  }catch{}
});

/* ---------- Upload helper ---------- */
async function uploadToStorage(userId, file){
  const d=new Date();
  const path = `${userId}/${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${crypto.randomUUID()}-${file.name}`;
  log('Uploading to bucket', path, 'sizeMB=', bytesToMB(file.size));
  const { data, error } = await supabase.storage
    .from(BUCKET)
    .upload(path, file, {
      cacheControl: '3600',
      upsert: false
    });
  if (error) throw error;
  const { data:pub, error:pubErr } = supabase
    .storage
    .from(BUCKET)
    .getPublicUrl(data.path);
  if (pubErr) throw pubErr;
  log('Upload complete path=', data.path, 'publicUrl=', pub.publicUrl);
  return pub.publicUrl;
}

/* ---------- Queue + clock ---------- */

async function refreshQueue(){
  try{
    queueStatus.textContent = 'loading…';
    const { data, error } = await supabase
      .from(QUEUE_TABLE)
      .select('id,image_url,created_at,status')
      .order('created_at',{ascending:true})
      .limit(20);
    if (error) throw error;
    const pending = (data||[]).filter(r=>r.status==='pending');
    queueCount.textContent = `(${pending.length})`;
    if (pending.length === 0){
      queueEmpty.classList.remove('hidden');
      queueList.innerHTML = '';
      queueStatus.textContent = 'empty — your piece goes straight in';
    } else {
      queueEmpty.classList.add('hidden');
      queueList.innerHTML = pending.map(row=>{
        const d = new Date(row.created_at);
        return `<div class="mono" style="margin-top:2px;">• ${d.toLocaleTimeString()} — queued item</div>`;
      }).join('');
      queueStatus.textContent = `${pending.length} pending`;
    }
  }catch(e){
    log('queue load error', e);
    queueStatus.textContent = 'error loading queue';
  }
}

async function refreshClock(){
  try{
    const res = await fetch(TIMER_ENDPOINT,{method:'GET'});
    if (!res.ok) throw new Error('timer fetch failed');
    const raw = await res.json();
    log('[CLOCK] raw', raw);
    const remaining = raw?.normalized?.remaining_sec ?? raw?.remaining_sec;
    const period = raw?.normalized?.period_sec ?? raw?.period_sec;
    clockState.remaining_sec = typeof remaining === 'number' ? remaining : null;
    clockState.period_sec = typeof period === 'number' ? period : null;
    updateClockLabels();
  }catch(e){
    log('timer error', e);
    clockLabel.textContent = '--';
    footerClock.textContent = '--';
  }
}

function formatSeconds(sec){
  if (sec == null || isNaN(sec)) return '--';
  const s = Math.max(0,Math.floor(sec));
  const m = Math.floor(s/60);
  const r = s%60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

function updateClockLabels(){
  const txt = formatSeconds(clockState.remaining_sec);
  clockLabel.textContent = txt;
  footerClock.textContent = txt;
}

setInterval(()=>{
  if (clockState.remaining_sec == null) return;
  clockState.remaining_sec = Math.max(0,clockState.remaining_sec-1);
  updateClockLabels();
},1000);

refreshClock();
refreshQueue();
setInterval(refreshClock,20000);
setInterval(refreshQueue,20000);

/* ---------- Submit handler ---------- */

btnSubmit.addEventListener('click', async ()=>{
  if (isSubmitting) return;
  setSubmitMsg('');
  const consentOk = chkConsent.checked;
  if (!consentOk){
    toast('You must confirm the content rules.');
    setSubmitMsg('Check the content rules box to continue.', true);
    return;
  }

  const user = await currentUser();
  if (!user){
    toast('Log in to submit art.');
    setSubmitMsg('Log in via index page, then return here.', true);
    return;
  }

  const username = await currentUsername(user.id);
  if (!username){
    toast('Set a username first (profile page).');
    setSubmitMsg('Missing username. Visit profile page, then come back.', true);
    return;
  }

  if (!picked.file && !picked.url){
    toast('Pick a file or paste a URL first.');
    setSubmitMsg('No art selected yet.', true);
    return;
  }

  let fileUrl = picked.url || '';
  try{
    isSubmitting = true;
    btnSubmit.disabled = true;
    btnSubmit.textContent = 'Submitting…';
    setSubmitMsg('Uploading to the machine…');

    if (picked.file){
      if (picked.file.size > MAX_BYTES){
        throw new Error(`File is too large. Max ${MAX_MB}MB.`);
      }
      fileUrl = await uploadToStorage(user.id, picked.file);
    }

    if (!fileUrl){
      throw new Error('No file URL resolved.');
    }

    const title = titleInput.value.trim() || null;
    const description = descInput.value.trim() || null;

    const { error:insertError } = await supabase
      .from(QUEUE_TABLE)
      .insert({
        image_url: fileUrl,
        status: 'pending',
        submitted_by: user.id,
        submitted_username: username,
        piece_title: title,
        piece_description: description
      });

    if (insertError) throw insertError;

    toast('Submitted to queue. Glory to the machine.');
    setSubmitMsg('Submitted successfully. Your piece is waiting in the queue.');
    picked.file = null;
    picked.url = '';
    fileInput.value = '';
    urlInput.value = '';
    urlInput.classList.remove('hidden');
    fileName.textContent = 'image or video — 100MB max. Tip: drag & drop or paste (Ctrl/⌘+V)';
    setPreview(null);
    previewHint.textContent = '';
    chkConsent.checked = false;
    titleInput.value = '';
    descInput.value = '';

    refreshQueue();
  }catch(e){
    console.error('submit error', e);
    const msg = e?.message || 'Submit failed.';
    toast(msg);
    setSubmitMsg(`Submit failed: ${msg}`, true);
  }finally{
    isSubmitting = false;
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'Submit';
  }
});
</script>
</body>
</html>