<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit ‚Äî Rage Space</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #050505;
      color: #f1f1f1;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    .page {
      width: 100%;
      max-width: 900px;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 16px;
      background: radial-gradient(circle at top, #151515 0%, #050505 50%, #000 100%);
      box-shadow: 0 0 20px rgba(0, 255, 128, 0.1);
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
      color: #39ff14;
      letter-spacing: 1px;
      text-shadow: 0 0 6px rgba(57, 255, 20, 0.7);
      text-align: center;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #bbbbbb;
      text-align: center;
      margin-bottom: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 720px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.75);
      padding: 14px;
      border: 1px solid #222;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0, 255, 120, 0.04),
        rgba(0, 255, 120, 0.04) 1px,
        transparent 1px,
        transparent 3px
      );
      opacity: 0.4;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .section-title {
      font-size: 1rem;
      color: #eeeeee;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title span {
      font-size: 0.75rem;
      color: #888;
      font-weight: 400;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #dddddd;
    }

    .field small {
      display: block;
      font-size: 0.75rem;
      color: #888;
      margin-top: 2px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #050505;
      color: #f1f1f1;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    textarea:focus {
      border-color: #39ff14;
      box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 220px;
    }

    .file-drop {
      border-radius: 10px;
      border: 1px dashed #444;
      background: rgba(5, 5, 5, 0.9);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      justify-content: center;
      align-items: stretch;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease,
        background 0.2s ease;
      min-height: 90px;
    }

    .file-drop.drag-over {
      border-color: #39ff14;
      box-shadow: 0 0 12px rgba(57, 255, 20, 0.5);
      background: rgba(10, 20, 10, 0.95);
    }

    .file-drop-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .file-drop-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .file-drop-title {
      font-size: 0.9rem;
      color: #ffffff;
      font-weight: 500;
    }

    .file-drop-sub {
      font-size: 0.8rem;
      color: #aaaaaa;
    }

    .file-name {
      font-size: 0.8rem;
      color: #cccccc;
      margin-top: 4px;
      word-break: break-all;
    }

    .btn-line {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid #333;
      background: radial-gradient(circle at top left, #222 0%, #050505 60%);
      color: #f1f1f1;
      padding: 7px 12px;
      min-width: 70px;
      text-align: center;
      font-size: 0.8rem;
      cursor: pointer;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        transform 0.1s ease, background 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn span.icon {
      font-size: 0.9rem;
    }

    .btn-primary {
      border-color: #39ff14;
      box-shadow: 0 0 7px rgba(57, 255, 20, 0.4);
    }

    .btn-primary:hover {
      box-shadow: 0 0 11px rgba(57, 255, 20, 0.7);
      transform: translateY(-1px);
    }

    .btn-secondary {
      border-color: #666;
      color: #ddd;
    }

    .btn-secondary:hover {
      border-color: #888;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.18);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0px) scale(0.98);
      box-shadow: none;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .status-line {
      font-size: 0.8rem;
      color: #999;
      margin-top: 6px;
      min-height: 18px;
    }

    .status-line span.good {
      color: #39ff14;
    }

    .status-line span.bad {
      color: #ff3333;
    }

    .status-line span.warn {
      color: #ffcc33;
    }

    .timer-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .timer-value {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 2.2rem;
      line-height: 1.2;
      color: #39ff14;
      text-shadow: 0 0 10px rgba(57, 255, 20, 0.7);
      letter-spacing: 2px;
    }

    .timer-label {
      font-size: 0.8rem;
      color: #aaaaaa;
    }

    .phase-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #eeeeee;
    }

    .phase-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #39ff14;
      box-shadow: 0 0 6px rgba(57, 255, 20, 0.7);
    }

    .phase-sub {
      font-size: 0.75rem;
      color: #888;
      margin-top: 2px;
    }

    .helper {
      font-size: 0.75rem;
      color: #888;
      margin-top: 6px;
      line-height: 1.4;
    }

    .helper strong {
      color: #dddddd;
      font-weight: 500;
    }

    .divider {
      height: 1px;
      background: linear-gradient(
        to right,
        transparent,
        rgba(255, 255, 255, 0.18),
        transparent
      );
      margin: 10px 0;
    }

    .preview-area {
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #222;
      background: #020202;
      padding: 8px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .preview-area::before {
      content: "";
      pointer-events: none;
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at center,
        rgba(57, 255, 20, 0.15),
        transparent 60%
      );
      opacity: 0.5;
      mix-blend-mode: screen;
    }

    .preview-inner {
      position: relative;
      z-index: 1;
      max-height: 320px;
      max-width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-inner img,
    .preview-inner video {
      max-width: 100%;
      max-height: 320px;
      border-radius: 8px;
      border: 1px solid #333;
      display: block;
    }

    .preview-placeholder {
      font-size: 0.85rem;
      color: #666;
      text-align: center;
      padding: 20px 10px;
    }

    .preview-meta {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #999;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }

    .preview-meta span {
      white-space: nowrap;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: #111;
      color: #f1f1f1;
      padding: 10px 14px;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 1px solid #39ff14;
      box-shadow: 0 0 10px rgba(57, 255, 20, 0.6);
      z-index: 2000;
      max-width: 95%;
      text-align: center;
      pointer-events: none;
    }

    a {
      color: #39ff14;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .nav-top {
      font-size: 0.8rem;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .nav-top a.left-link {
      color: #999;
    }

    .nav-top span.right {
      color: #666;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="nav-top">
      <a href="index.html" class="left-link">&larr; Back to Matchup</a>
      <span class="right">Rage Space &mdash; Art Queue Submission</span>
    </div>

    <h1>Submit to the Queue</h1>
    <div class="subtitle">
      Drop your piece into the machine. When the next tournament spins up, it may be chosen to devour the bracket.
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-inner">
          <div class="section-title">
            <span>1. Your Piece</span>
            <span>Required</span>
          </div>

          <div class="field" style="margin-top:6px;">
            <label for="pieceTitle">Piece title (optional)</label>
            <input
              id="pieceTitle"
              type="text"
              placeholder="Glitch Blossom // Neon Ruins..."
              autocomplete="off"
            />
            <small>Shown on the winners page if your art reaches glory.</small>
          </div>

          <div class="field">
            <label for="pieceDesc">Piece description (optional)</label>
            <textarea
              id="pieceDesc"
              placeholder="Short lore, process notes, or whatever the machine should know..."
            ></textarea>
            <small>Kept fairly short is best. Shown alongside the winner.</small>
          </div>

          <div class="divider"></div>

          <label style="font-size:0.85rem; color:#ddd; margin-bottom:4px; display:block;"
            >Upload or paste image</label
          >

          <div id="dropZone" class="file-drop">
            <div class="file-drop-row">
              <div class="file-drop-main">
                <div class="file-drop-title">
                  <span>Choose or Paste</span>
                </div>
                <div class="file-drop-sub">
                  jpg / png / webp &mdash; 50MB max &mdash; images only
                </div>
                <div id="fileName" class="file-name">
                  No file selected yet.
                </div>
              </div>
              <div class="btn-line">
                <button id="btnPick" class="btn btn-secondary" type="button">
                  <span class="icon">üìÅ</span>
                  <span>Pick file</span>
                </button>
              </div>
            </div>

            <div class="status-line" id="pasteStatus">
              Paste an image from your clipboard or pick a file.
            </div>
          </div>

          <input
            id="fileInput"
            type="file"
            accept="image/*"
            style="display:none;"
          />

          <div class="helper">
            <strong>Tips:</strong> Use clear, high-res art. The machine will resize and optimize for the tournament wall.
          </div>

          <div class="divider"></div>

          <div class="section-title" style="margin-top:4px;">
            <span>2. Submit</span>
            <span>Status</span>
          </div>

          <div class="btn-line" style="margin-top:4px;">
            <button id="btnSubmit" class="btn btn-primary" type="button">
              <span class="icon">üöÄ</span>
              <span>Submit to Queue</span>
            </button>
          </div>

          <div class="status-line" id="submitStatus">
            Waiting for your art.
          </div>

          <div class="helper">
            You can close this page after a successful submit. Your piece will stay in the queue until the machine pulls it into a bracket.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-inner">
          <div class="section-title">
            <span>Bracket Timer</span>
            <span>Global</span>
          </div>

          <div class="timer-panel">
            <div class="timer-value" id="timerDisplay">--:--</div>
            <div class="timer-label" id="timerLabel">
              Loading global tournament timer...
            </div>
            <div class="phase-badge">
              <span class="phase-dot"></span>
              <span id="phaseName">Phase: --</span>
            </div>
            <div class="phase-sub" id="phaseSub">
              Next global update from the edge function will appear here.
            </div>

            <div class="divider"></div>

            <div class="section-title">
              <span>Preview</span>
              <span>What you&apos;re sending</span>
            </div>

            <div class="preview-area">
              <div class="preview-inner" id="previewInner">
                <div class="preview-placeholder">
                  Your image preview will appear here once selected or pasted.
                </div>
              </div>
            </div>

            <div class="preview-meta" id="previewMeta">
              <span>Type: --</span>
              <span>Size: --</span>
            </div>

            <div class="helper">
              The timer above is the same one powering <a href="index.html">Matchup</a>.
              Submissions use the current user you are logged in as.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const btnPick = document.getElementById("btnPick");
    const btnSubmit = document.getElementById("btnSubmit");
    const fileNameEl = document.getElementById("fileName");
    const pasteStatus = document.getElementById("pasteStatus");
    const submitStatus = document.getElementById("submitStatus");
    const previewInner = document.getElementById("previewInner");
    const previewMeta = document.getElementById("previewMeta");

    const timerDisplay = document.getElementById("timerDisplay");
    const timerLabel = document.getElementById("timerLabel");
    const phaseName = document.getElementById("phaseName");
    const phaseSub = document.getElementById("phaseSub");

    const titleInput = document.getElementById("pieceTitle");
    const descInput = document.getElementById("pieceDesc");

    let pickedFile = null;
    let isSubmitting = false;

    const MAX_MB = 50;

    const log = (...args) => {
      const now = new Date();
      const stamp = now.toLocaleTimeString();
      console.log(`[${stamp}] SUBMIT:`, ...args);
    };

    function showToast(message) {
      const existing = document.querySelector(".toast");
      if (existing) existing.remove();
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = message;
      document.body.appendChild(t);
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transition = "opacity 0.3s ease";
        setTimeout(() => t.remove(), 300);
      }, 2200);
    }

    function renderPreview(file) {
      previewInner.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.style.maxWidth = "100%";
      wrap.style.maxHeight = "320px";
      wrap.style.display = "flex";
      wrap.style.alignItems = "center";
      wrap.style.justifyContent = "center";

      const isImage = file && file.type && file.type.startsWith("image/");
      if (!file) {
        const placeholder = document.createElement("div");
        placeholder.className = "preview-placeholder";
        placeholder.textContent =
          "Your image preview will appear here once selected or pasted.";
        previewInner.appendChild(placeholder);
        previewMeta.innerHTML = "<span>Type: --</span><span>Size: --</span>";
        return;
      }

      const el = document.createElement(isImage ? "img" : "video");
      el.style.display = "block";
      el.style.borderRadius = "8px";
      el.style.border = "1px solid #333";
      el.style.maxHeight = "320px";
      el.style.maxWidth = "100%";

      const url = URL.createObjectURL(file);
      el.src = url;
      if (!isImage) {
        el.controls = true;
      }

      wrap.appendChild(el);
      previewInner.appendChild(wrap);

      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      const type = file.type || "unknown";
      previewMeta.innerHTML = `<span>Type: ${type}</span><span>Size: ${sizeMB} MB</span>`;
    }

    function setPickedFile(file) {
      pickedFile = file;
      if (!file) {
        fileNameEl.textContent = "No file selected yet.";
        pasteStatus.innerHTML =
          'Paste an image from your clipboard or pick a file.';
        pasteStatus.className = "status-line";
        renderPreview(null);
        return;
      }

      const sizeMB = file.size / (1024 * 1024);
      const name = file.name || "clipboard-image";
      fileNameEl.textContent = `${name} (${sizeMB.toFixed(2)} MB)`;

      if (sizeMB > MAX_MB) {
        pasteStatus.innerHTML =
          `<span class="bad">File is too large. Max ${MAX_MB}MB.</span>`;
      } else {
        pasteStatus.innerHTML = `<span class="good">Ready to submit.</span>`;
      }

      renderPreview(file);
    }

    btnPick.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type || !f.type.startsWith("image/")) {
        showToast("Images only: jpg / png / webp.");
        pasteStatus.innerHTML =
          '<span class="bad">Invalid file type. Images only.</span>';
        fileInput.value = "";
        return;
      }
      if (f.size > MAX_MB * 1024 * 1024) {
        showToast(`File is too large. Max ${MAX_MB}MB.`);
        pasteStatus.innerHTML =
          `<span class="bad">File exceeds ${MAX_MB}MB limit.</span>`;
        fileInput.value = "";
        return;
      }
      setPickedFile(f);
    });

    dropZone.addEventListener("dragenter", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add("drag-over");
    });
    dropZone.addEventListener("dragleave", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove("drag-over");
    });
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove("drag-over");
      const dt = e.dataTransfer;
      if (!dt || !dt.files || !dt.files.length) return;
      const f = dt.files[0];
      if (!f.type || !f.type.startsWith("image/")) {
        showToast("Images only: jpg / png / webp.");
        pasteStatus.innerHTML =
          '<span class="bad">Invalid file type. Images only.</span>';
        return;
      }
      if (f.size > MAX_MB * 1024 * 1024) {
        showToast(`File is too large. Max ${MAX_MB}MB.`);
        pasteStatus.innerHTML =
          `<span class="bad">File exceeds ${MAX_MB}MB limit.</span>`;
        return;
      }
      setPickedFile(f);
    });

    document.addEventListener("paste", async (e) => {
      try {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items || !items.length) return;

        let imageItem = null;
        for (const it of items) {
          if (it.type && it.type.startsWith("image/")) {
            imageItem = it;
            break;
          }
        }
        if (!imageItem) {
          pasteStatus.innerHTML =
            '<span class="warn">Clipboard has no image. (Max 50MB.)</span>';
          return;
        }
        const blob = imageItem.getAsFile();
        if (!blob) {
          pasteStatus.innerHTML =
            '<span class="bad">Could not read clipboard image.</span>';
          return;
        }
        if (!blob.type || !blob.type.startsWith("image/")) {
          pasteStatus.innerHTML =
            '<span class="bad">Clipboard item is not an image.</span>';
          return;
        }
        if (blob.size > MAX_MB * 1024 * 1024) {
          pasteStatus.innerHTML =
            `<span class="bad">Clipboard image exceeds ${MAX_MB}MB limit.</span>`;
          showToast(`Clipboard image is too large. Max ${MAX_MB}MB.`);
          return;
        }
        const ext =
          blob.type === "image/png"
            ? ".png"
            : blob.type === "image/webp"
            ? ".webp"
            : ".jpg";
        const f = new File([blob], "clipboard-image" + ext, {
          type: blob.type || "image/png",
        });
        setPickedFile(f);
      } catch (err) {
        console.error("Paste handler error", err);
        pasteStatus.innerHTML =
          '<span class="bad">Error reading clipboard image.</span>';
      }
    });

    let timeState = {
      remainingSec: null,
      paused: false,
      label: "Loading...",
      debugPhase: null,
    };

    async function fetchTimerState() {
      try {
        const now = new Date();
        log("Fetching timer state from edge...");
        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/global-timer-v2`,
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          }
        );

        log(
          "EDGE: GET global-timer-v2 ‚Üí",
          res.status,
          `(~${now.toLocaleTimeString()})`
        );

        const data = await res.json();
        const endIso = data.phase_end_at;
        const periodSec = data.period_sec || 150;
        const paused = !!data.paused;
        const phaseDebug = data.phase_debug || data.phase || "unknown";

        let remainingSec = null;
        if (endIso) {
          const end = new Date(endIso);
          const diffMs = end.getTime() - Date.now();
          remainingSec = Math.max(0, Math.round(diffMs / 1000));
        }

        timeState.remainingSec = remainingSec;
        timeState.paused = paused;
        timeState.debugPhase = phaseDebug;

        if (paused) {
          timeState.label = "Timer paused ‚Äî bracket is frozen.";
        } else if (remainingSec != null) {
          timeState.label = "Time left in current global phase.";
        } else {
          timeState.label = "Timer active ‚Äî waiting for next update.";
        }

        updateTimerDisplay();
      } catch (err) {
        console.error("Error fetching timer state", err);
        timerLabel.textContent =
          "Failed to contact timer. Submissions still use your logged-in account.";
      }
    }

    function updateTimerDisplay() {
      const { remainingSec, paused, label, debugPhase } = timeState;
      if (remainingSec == null) {
        timerDisplay.textContent = "--:--";
      } else {
        const m = Math.floor(remainingSec / 60)
          .toString()
          .padStart(2, "0");
        const s = Math.floor(remainingSec % 60)
          .toString()
          .padStart(2, "0");
        timerDisplay.textContent = `${m}:${s}`;
      }

      timerLabel.textContent = paused
        ? "Timer paused ‚Äî bracket is frozen."
        : label;

      phaseName.textContent = `Phase: ${debugPhase || "--"}`;

      if (debugPhase === "r32") {
        phaseSub.textContent =
          "Round of 32 chaos. Your piece might be pulled from the queue soon.";
      } else if (debugPhase === "r16") {
        phaseSub.textContent =
          "Round of 16. Machine is narrowing the field.";
      } else if (debugPhase === "qf") {
        phaseSub.textContent = "Quarterfinals. Only killers left.";
      } else if (debugPhase === "sf") {
        phaseSub.textContent = "Semifinals. Almost to the throne.";
      } else if (debugPhase === "final") {
        phaseSub.textContent =
          "Final clash. Glory to whoever survives.";
      } else {
        phaseSub.textContent =
          "Edge function cycles phases automatically ‚Äî all clients share this same clock.";
      }
    }

    function tickTimer() {
      if (timeState.remainingSec != null && !timeState.paused) {
        timeState.remainingSec = Math.max(
          0,
          timeState.remainingSec - 1
        );
      }
      updateTimerDisplay();
    }

    fetchTimerState();
    setInterval(fetchTimerState, 15000);
    setInterval(tickTimer, 1000);

    async function uploadFileToBucket(file, userId) {
      const bucket = "art-uploads";
      const ext =
        file.name && file.name.includes(".")
          ? file.name.split(".").pop()
          : "jpg";
      const safeId = userId || "anon";
      const uniqueName = `${safeId}_${Date.now()}_${Math.random()
        .toString(36)
        .slice(2)}.${ext}`;
      const path = uniqueName;

      log("Uploading file to bucket path:", path);

      const { error: uploadErr } = await supabase.storage
        .from(bucket)
        .upload(path, file, {
          cacheControl: "3600",
          upsert: false,
          contentType: file.type || "image/jpeg",
        });

      if (uploadErr) {
        console.error("UPLOAD ERROR", uploadErr);
        throw new Error(uploadErr.message || "Upload failed");
      }

      const {
        data: { publicUrl },
      } = supabase.storage.from(bucket).getPublicUrl(path);

      if (!publicUrl) {
        throw new Error("Could not generate public URL for upload.");
      }

      log("Upload success, public URL:", publicUrl);
      return publicUrl;
    }

    async function getCurrentUserProfile() {
      try {
        const { data: authData, error: authErr } =
          await supabase.auth.getUser();
        if (authErr) {
          console.error("AUTH getUser error", authErr);
          return { userId: null, username: null };
        }
        const user = authData && authData.user;
        if (!user) {
          return { userId: null, username: null };
        }

        const userId = user.id;
        let username = null;

        const { data: profile, error: profileErr } = await supabase
          .from("profiles")
          .select("username")
          .eq("id", userId)
          .maybeSingle();

        if (profileErr) {
          console.error("profiles lookup error", profileErr);
        } else if (profile && profile.username) {
          username = profile.username;
        }

        return { userId, username };
      } catch (err) {
        console.error("getCurrentUserProfile error", err);
        return { userId: null, username: null };
      }
    }

    async function handleSubmit() {
      if (isSubmitting) return;
      if (!pickedFile) {
        showToast("Pick or paste an image first.");
        submitStatus.innerHTML =
          '<span class="bad">No file selected.</span>';
        return;
      }

      const sizeMB = pickedFile.size / (1024 * 1024);
      if (sizeMB > MAX_MB) {
        showToast(`File is too large. Max ${MAX_MB}MB.`);
        submitStatus.innerHTML =
          `<span class="bad">File exceeds ${MAX_MB}MB limit.</span>`;
        return;
      }

      isSubmitting = true;
      btnSubmit.disabled = true;
      btnSubmit.textContent = "Submitting...";
      submitStatus.innerHTML =
        '<span class="warn">Uploading and enqueueing your art...</span>';

      try {
        const { userId, username } = await getCurrentUserProfile();
        if (!userId) {
          throw new Error(
            "No logged-in user. Please log in, then try again."
          );
        }

        const artistName = username || "Unknown";

        const finalUrl = await uploadFileToBucket(pickedFile, userId);

        const pieceName =
          (titleInput && titleInput.value
            ? titleInput.value
            : ""
          ).trim();
        const pieceDesc =
          (descInput && descInput.value ? descInput.value : "")
            .trim();

        const payload = {
          image_url: finalUrl,
          status: "pending",
          created_at: new Date().toISOString(),
          artist_name: artistName || null,
          title: pieceName || null,
          description: pieceDesc || null,
        };

        log("Inserting into art_queue:", payload);

        const { error: insertErr } = await supabase
          .from("art_queue")
          .insert(payload);

        if (insertErr) {
          console.error("art_queue insert error", insertErr);
          throw new Error(
            insertErr.message || "Could not add to art queue."
          );
        }

        submitStatus.innerHTML =
          '<span class="good">Submitted! Your art is now in the queue.</span>';
        showToast("Submitted. Glory to the machine.");

        pickedFile = null;
        renderPreview(null);
        fileNameEl.textContent = "No file selected yet.";
        pasteStatus.innerHTML =
          'Paste an image from your clipboard or pick a file.';
        if (fileInput) fileInput.value = "";
        if (titleInput) titleInput.value = "";
        if (descInput) descInput.value = "";
      } catch (e) {
        console.error("Submit error", e);
        showToast("Submit failed. Check console for details.");
        submitStatus.innerHTML = `<span class="bad">Error: ${
          e.message || "Submit failed."
        }</span>`;
      } finally {
        isSubmitting = false;
        btnSubmit.disabled = false;
        btnSubmit.textContent = "Submit to Queue";
      }
    }

    btnSubmit.addEventListener("click", () => {
      handleSubmit();
    });

    window.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "enter") {
        handleSubmit();
      }
    });

    log("Submit page initialized.");
  </script>
</body>
</html>