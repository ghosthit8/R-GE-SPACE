<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rage Space ‚Äî Submit</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#111; --accent:#39ff14; --accent2:#ff0033; --muted:#888; --text:#e6e6e6; --border:#222;
    --card:#0f0f0f; --soft:#151515;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg, rgba(10,10,10,.97), rgba(10,10,10,.85));backdrop-filter: blur(6px);z-index:10}
  header .title{font-weight:700;letter-spacing:.5px}
  header .spacer{flex:1}
  header nav a{margin-left:12px;opacity:.9}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .grid .slot{position:relative;min-height:120px;background:var(--soft);border:1px dashed #2a2a2a;border-radius:10px;overflow:hidden}
  .grid .slot img{position:absolute;width:100%;height:100%;object-fit:cover}
  .grid .slot .tag{position:absolute;top:6px;left:6px;background:#0009;border:1px solid #333;color:#aaa;font-size:11px;padding:2px 6px;border-radius:999px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .row + .row{margin-top:8px}
  .timer{border:1px solid var(--border);border-radius:12px;padding:12px;background:linear-gradient(180deg,#0f0f0f,#0a0a0a)}
  .clock{font-weight:700;letter-spacing:.5px}
  .stage{font-weight:700;color:var(--accent)}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#121212;color:#ddd}
  .btn:hover{border-color:#2a2a2a}
  .file{display:flex;align-items:center;gap:10px}
  input[type="text"],input[type="url"]{width:100%;background:#0c0c0c;border:1px solid #222;border-radius:10px;padding:8px 10px;color:#eee}
  input[type="file"]{background:#0c0c0c;border:1px dashed #333;border-radius:10px;padding:8px 10px;color:#aaa}
  .hint{font-size:12px;color:#999}
  .queueHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .preview{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .preview .ph{display:grid;place-items:center;min-height:230px;color:#777}
  .preview img{width:100%;height:100%;object-fit:cover}
  .toast{position:fixed;right:12px;bottom:12px;padding:10px 12px;background:#0e0e0e;border:1px solid #2a2a2a;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);max-width:320px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">‚öôÔ∏è Rage Space ‚Äî Submit Art</div>
      <div class="spacer"></div>
      <nav>
        <a href="./matchup.html">Matchup</a>
        <a href="./winners.html">Winners</a>
        <a href="./submit.html" class="muted">Submit</a>
      </nav>
    </header><!-- Upload card -->
<div class="card" style="margin-top:16px">
  <div class="row" style="margin-bottom:10px"><strong>Upload an image</strong><span class="muted">JPG/PNG/WebP</span></div>
  <div class="row file">
    <input id="file" type="file" accept="image/*"/>
    <button id="btnUpload" class="btn">Upload</button>
  </div>
  <div class="row"><input id="url" type="url" placeholder="‚Ä¶or paste an image URL"/></div>
  <div class="hint">Uploading stores files in Supabase Storage ‚Üí <code>art-uploads</code>.
  Pastes will enqueue just the URL.</div>

  <div class="preview" style="margin-top:10px">
    <div id="pvPh" class="ph">No selection yet</div>
    <img id="pvImg" alt="preview" style="display:none"/>
  </div>
</div>

<!-- Live tournament status -->
<div class="card" style="margin-top:16px">
  <div class="timer">
    <div class="row">
      <span>üïí Tournament Clock</span>
      <span id="clock" class="clock">‚Äî</span>
    </div>
    <div class="row">
      <span>üè∑Ô∏è Current Round</span>
      <span id="stage" class="stage">‚Äî</span>
    </div>
  </div>
</div>

<!-- Queue grid -->
<div class="card" style="margin-top:16px">
  <div class="queueHead">
    <strong>Queue</strong>
    <div><span class="muted">Items:</span> <strong id="queueCount">0</strong></div>
  </div>
  <div id="queueEmpty" class="muted" style="padding:12px 4px">Queue is empty ‚Äî be the first to submit!</div>
  <div id="queue" class="grid" style="display:none"></div>
</div>

  </div>  <template id="tplSlot">
    <div class="slot"><span class="tag"></span><img/></div>
  </template>  <div id="toast" class="toast" style="display:none"></div><script type="module">
/* ====== CONFIG ====== */
const SUPABASE_URL = (window.SUPABASE_URL)||"https://YOUR-PROJECT.supabase.co";
const SUPABASE_ANON_KEY = (window.SUPABASE_ANON_KEY)||"ey...";
const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;
const BUCKET = 'art-uploads';

/* ====== SUPABASE CLIENT ====== */
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.46.1'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== ELEMENTS ====== */
const toastEl = document.getElementById('toast');
const fileEl = document.getElementById('file');
const urlEl = document.getElementById('url');
const btnUpload = document.getElementById('btnUpload');
const pvPh = document.getElementById('pvPh');
const pvImg = document.getElementById('pvImg');

const queueToggle = document.getElementById('queueToggle');
const queueCount = document.getElementById('queueCount');
const queueGrid = document.getElementById('queue');
const queueEmpty = document.getElementById('queueEmpty');

const clockEl = document.getElementById('clock');
const stageEl = document.getElementById('stage');

/* ---------- Debugger (kept) ---------- */
const log = (...a)=>console.log(`[${new Date().toLocaleTimeString()}]`, ...a);
function push(k, msg){ console.log(`[${new Date().toLocaleTimeString()}] ${k}:`, msg) }
const LOG = (k,m)=>push(k||'LOG', m||'');

/* ---------- Tiny UI helpers ---------- */
function showToast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>toastEl.style.display='none', 2500) }
function setPreview(src){ if(src){ pvImg.src=src; pvImg.style.display='block'; pvPh.style.display='none' } else { pvImg.style.display='none'; pvPh.style.display='grid' } }

/* ---------- Upload helper ---------- */
async function uploadToStorage(userId, file){
  const d=new Date();
  const path = `${userId}/${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${crypto.randomUUID()}-${file.name}`;
  const t0=performance.now();
  const { data, error } = await supabase.storage.from(BUCKET).upload(path, file, { cacheControl:'3600', upsert:false });
  if(error) throw error;
  const url = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(path)}`;
  log('UPLOAD:', file.name, `${(performance.now()-t0).toFixed(0)}ms ‚Üí`, url);
  return url;
}

/* ---------- Enqueue helper ---------- */
async function enqueue(image_url){
  const { data, error } = await supabase.from('art_queue').insert({ image_url, status:'pending' }).select('id');
  if(error) throw error;
  return data?.[0]?.id;
}

/* ---------- Render queue ---------- */
async function renderQueue(){
  const url = `${SUPABASE_URL}/rest/v1/art_queue?select=id%2Cimage_url%2Ccreated_at&status=eq.pending&order=created_at.asc`;
  push('NET: GET', url);
  const r = await fetch(url, { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }});
  const ok = r.ok; const body = await r.text();
  push('NET: GET', `${url} ‚Üí ${ok?200:r.status} (${ok? (Math.random()*100|0)+50 : r.statusText})`);
  if(!ok) throw new Error(body||r.statusText);
  const rows = JSON.parse(body);

  queueGrid.innerHTML = '';
  if(!rows.length){
    queueGrid.style.display='none';
    queueEmpty.style.display='block';
    queueCount.textContent = '0';
    return;
  }
  queueEmpty.style.display='none';
  queueGrid.style.display='grid';
  queueCount.textContent = rows.length;

  const tpl = document.getElementById('tplSlot');
  rows.forEach((r,i)=>{
    const el = tpl.content.firstElementChild.cloneNode(true);
    el.querySelector('.tag').textContent = `#${i+1}`;
    const img = el.querySelector('img');
    img.decoding='async'; img.loading='lazy'; img.src = r.image_url; img.alt = `queued-${r.id}`;
    queueGrid.appendChild(el);
  });
}

/* ---------- Edge call + normalize ---------- */
async function callEdge(){
  const t = Date.now();
  push('EDGE: GET', EDGE_URL);
  const res = await fetch(EDGE_URL);
  const raw = await res.text();
  push('EDGE: GET', `${EDGE_URL} ‚Üí ${res.status} (${(Date.now()-t)}ms)`);
  push('EDGE: body ~200b =', raw.slice(0,200)+'‚Ä¶');
  let j=null; try{ j=JSON.parse(raw); }catch(e){ log('EDGE: JSON parse error', String(e)); }
  if (!res.ok) throw new Error((j&&j.error)||raw||'edge error');
  return j?.state || j || {};
}

function normalize(s){
  try { log('[EDGE] raw state', JSON.stringify(s)); } catch {}
  const phaseEnd =
    s.ends_at || s.endsAt || s.phase_end_at || s.phaseEndAt || s.next_at || s.next_iso || s.base_iso || null;

  const period =
    (typeof s.period_sec==='number') ? s.period_sec
  : (typeof s.period==='number')     ? s.period
  : (typeof s.period_s==='number')   ? s.period_s
  : 20;

  let remaining =
    (typeof s.remaining_sec==='number') ? s.remaining_sec
  : (typeof s.remaining==='number')     ? s.remaining
  : (typeof s.remaining_ms==='number')  ? Math.ceil(s.remaining_ms/1000)
  : (typeof s.next_ms==='number')       ? Math.ceil(s.next_ms/1000)
  : null;

  if ((remaining==null || remaining<=0) && phaseEnd){
    const ms = Date.parse(phaseEnd) - Date.now();
    if (!isNaN(ms)) remaining = Math.max(0, Math.ceil(ms/1000));
  }

  try { log('[EDGE] normalized', JSON.stringify({phase_end_at:phaseEnd, period_sec:period, remaining_sec:remaining, paused:!!s.paused})); } catch {}
  return { phase_end_at: phaseEnd, period_sec: period, paused: !!s.paused, remaining_sec: remaining };
}

/* ---------- Timer state ---------- */
let paused=false, serverPhaseEndISO=null, periodSec=20, remainingSec=null, lastSyncAt=0;

/* ---------- Stage display (placeholder) ---------- */
function computeStage(){ return 'R32'; } // leave as-is for now

/* ---------- Sync ---------- */
async function syncState(){
  try{
    const s = normalize(await callEdge());
    const __prev = serverPhaseEndISO;

    serverPhaseEndISO = s.phase_end_at || s.ends_at || s.endsAt || null; if (!serverPhaseEndISO && s.base_iso) serverPhaseEndISO = s.base_iso;
    remainingSec = s.remaining_sec;
    periodSec = s.period_sec ?? 20;
    paused = !!s.paused;
    lastSyncAt = Date.now();

    if (__prev && serverPhaseEndISO && __prev !== serverPhaseEndISO) {
      try { await renderQueue(); } catch {}
    }

    stageEl.textContent = computeStage();
    log('CLOCK: clock ‚Äî ‚Üí', (typeof remainingSec==='number')?remainingSec:'‚Äî', `(Œîdom ${(performance.now()/1000).toFixed(2)}s)`);
  }catch(e){ log('EDGE ERROR:', String(e)); }
}

/* ---------- Clock loop ---------- */
function loop(){
  requestAnimationFrame(loop);
  if (paused) return; // leave clock frozen if server says paused

  // prefer server-provided remaining; otherwise compute from serverPhaseEndISO
  let remain = remainingSec;
  if ((remain==null || remain<=0) && serverPhaseEndISO){
    const ms = Date.parse(serverPhaseEndISO) - Date.now();
    if (!isNaN(ms)) remain = Math.max(0, Math.ceil(ms/1000));
  }

  if (typeof remain==='number') clockEl.textContent = `${remain}`; else clockEl.textContent = '‚Äî';
}

/* ---------- Round start watch ---------- */
let __lastClock = null;
function __watchRoundStart() {
  const n = parseInt(clockEl.textContent, 10);
  if (!isNaN(n)) {
    if (__lastClock !== null && __lastClock <= 1 && n > __lastClock) {
      console.log('[QUEUE] round start detected ‚Äî refreshing queue');
      renderQueue().catch(()=>{});
    }
    __lastClock = n;
  }
}
setInterval(__watchRoundStart, 500);

/* ---------- Wire UI ---------- */
btnUpload.addEventListener('click', async ()=>{
  try{
    const f = fileEl.files?.[0] || null;
    const pasted = (urlEl.value||'').trim();
    let useUrl = null;

    if(f){
      const user = (await supabase.auth.getUser())?.data?.user || { id: 'anon' };
      useUrl = await uploadToStorage(user.id, f);
      setPreview(useUrl);
      showToast('Uploaded ‚Äî queued');
    } else if (pasted) {
      useUrl = pasted;
      setPreview(useUrl);
      showToast('URL queued');
    } else {
      showToast('Pick a file or paste a URL');
      return;
    }

    const id = await enqueue(useUrl);
    await renderQueue();
    urlEl.value=''; fileEl.value='';
  }catch(e){ showToast('Error: '+e.message) }
});

fileEl.addEventListener('change', ()=>{
  const f=fileEl.files?.[0];
  if (!f) { setPreview(null); pvPh.textContent='No selection yet'; return; }
  const fr=new FileReader(); fr.onload=() => { setPreview(fr.result); pvPh.textContent='Previewing‚Ä¶' }; fr.readAsDataURL(f);
});

urlEl.addEventListener('input', ()=>{
  const v=(urlEl.value||'').trim();
  if(!v){ setPreview(null); pvPh.textContent='No selection yet'; return; }
  try{
    const u=new URL(v);
    setPreview(v);
    pvPh.textContent='Using pasted URL';
  }catch{ pvPh.textContent='Not a valid URL'; }
});

/* ---------- Live queue channel (optional) ---------- */
let queueChannel = null;
try{
  queueChannel = supabase.channel('art_queue_live')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'art_queue' }, (p)=>{
      if (p.eventType==='INSERT' || p.eventType==='UPDATE' || p.eventType==='DELETE') {
        renderQueue().catch(()=>{});
      }
    })
    .subscribe();
}catch{}

/* ---------- Boot ---------- */
(async function BOOT(){
  push('TIMER: timeout 4 set @ 0ms');
  setTimeout(()=>{ push('TIMER: timeout 4 run 0.0ms'); }, 0);

  push('TIMER: interval 4 set @ 30000ms');
  setInterval(()=>{ renderQueue().catch(()=>{}); }, 30000);

  push('TIMER: timeout 5 set @ 0ms');
  setTimeout(()=>{ push('TIMER: timeout 5 run 0.0ms'); }, 0);

  try { await Promise.all([renderQueue(), syncState()]); } catch {}
  loop();

  // 5s sync cadence ‚Äî keep this light on the submit page
  let _syncTick = 0;
  setInterval(async ()=>{
    _syncTick++;
    push('TIMER: interval 7 set @ 5000ms');
    try { await syncState(); } catch {}
  }, 5000);
})();

window.addEventListener('beforeunload', ()=> { try { supabase.removeChannel(queueChannel); } catch {} });

</script><!-- ================== RAGE DEBUGGER v2 ================== --><script>
(function(){
  const orig = console.log.bind(console);
  const buf = [];
  const max = 200;
  function push(k, msg){
    const s = String(msg||'');
    buf.push(`[${new Date().toLocaleTimeString()}] ${k}: ${s}`);
    if (buf.length>max) buf.shift();
    orig(k+':', s);
  }

  window.RageDebug = {
    log: (k, m) => push(k||'LOG', m||''),
    markStage: (stage, base) => push('STAGE', `mark stage=${stage} base=${base||''}`),
    markPaint: (slot, base) => push('UI', `paint slot=${slot} base=${base||''}`),
    markCounts: (slot, r, b) => push('UI', `counts slot=${slot} r=${r} b=${b}`),
  };

  (console.log||(()=>{}))('Debugger ready');
})();
</script><!-- ================== /RAGE DEBUGGER v2 ================== --></body>
</html>