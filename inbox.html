<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rage Space — Inbox</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --green:#39ff14; --ink:#e5ffe5; --card:#0a0a0a; --border:#103010; --red:#ff0033;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:#000; color:var(--green);
      font-family:ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    header{
      position:sticky; top:0; z-index:10;
      background:rgba(0,0,0,.7); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border);
      padding:12px 16px; display:flex; align-items:center; gap:10px;
    }
    a.back{
      color:var(--green); text-decoration:none; border:1px solid var(--green);
      padding:6px 10px; border-radius:999px; font-weight:700; line-height:1;
    }
    a.back:hover{ background:rgba(57,255,20,.08); }

    .wrap{ max-width:940px; margin:0 auto; padding:16px; }

    .thread{
      position:relative;
      display:flex; gap:12px; padding:14px;
      background:linear-gradient(180deg,#0a0a0a,#050505);
      border:1px solid var(--border);
      border-radius:12px; margin:10px 0;
      text-decoration:none; color:var(--ink); align-items:center;
      transition:outline-color .15s ease, transform .15s ease;
    }
    .thread:hover{ outline:2px solid var(--green); transform:translateY(-1px); }

    .pfp{
      width:48px; height:48px; border-radius:12px; background:#111;
      border:2px solid var(--green); overflow:hidden; flex:0 0 auto;
    }
    .pfp img{ width:100%; height:100%; object-fit:cover; display:block; }

    .meta{ display:flex; flex-direction:column; min-width:0 }
    .name{
      color:var(--green); font-weight:800; font-size:15px;
      letter-spacing:.2px; margin-bottom:2px;
    }
    .last{
      color:var(--ink); opacity:.85; white-space:nowrap; overflow:hidden;
      text-overflow:ellipsis; max-width:100%;
      font-size:13px;
    }

    /* Unread indicator: red flicker + subtle red border/halo */
    .thread.unread{
      border-color: rgba(255,0,51,.6);
      box-shadow:
        0 0 12px rgba(255,0,51,.25),
        inset 0 0 8px rgba(255,0,51,.12);
      animation: flicker-red 2.2s infinite ease-in-out;
    }

    /* Little red dot badge in the corner when unread */
    .thread.unread::after{
      content:'';
      position:absolute; right:10px; top:10px;
      width:10px; height:10px; border-radius:999px;
      background:var(--red);
      box-shadow: 0 0 10px rgba(255,0,51,.9), 0 0 20px rgba(255,0,51,.6);
    }

    @keyframes flicker-red{
      0%   { box-shadow: 0 0 10px rgba(255,0,51,.18), inset 0 0 6px rgba(255,0,51,.08); }
      7%   { box-shadow: 0 0 18px rgba(255,0,51,.36), inset 0 0 10px rgba(255,0,51,.14); }
      13%  { box-shadow: 0 0 8px  rgba(255,0,51,.12), inset 0 0 4px  rgba(255,0,51,.06); }
      22%  { box-shadow: 0 0 20px rgba(255,0,51,.42), inset 0 0 12px rgba(255,0,51,.16); }
      37%  { box-shadow: 0 0 9px  rgba(255,0,51,.15), inset 0 0 5px  rgba(255,0,51,.07); }
      55%  { box-shadow: 0 0 22px rgba(255,0,51,.45), inset 0 0 13px rgba(255,0,51,.17); }
      72%  { box-shadow: 0 0 11px rgba(255,0,51,.2),  inset 0 0 7px  rgba(255,0,51,.09); }
      100% { box-shadow: 0 0 10px rgba(255,0,51,.18), inset 0 0 6px rgba(255,0,51,.08); }
    }

    @media (prefers-reduced-motion: reduce){
      .thread.unread{ animation:none; }
    }

    .empty{ color:var(--ink); opacity:.7; text-align:center; padding:40px 0; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <!-- Back to profile -->
    <a class="back" href="./profile.html">← Back</a>
    <h1 style="margin:0;font-size:18px;letter-spacing:.5px;">Direct Messages</h1>
  </header>

  <main class="wrap">
    <div id="list"></div>
    <div id="empty" class="empty" style="display:none;">
      No conversations yet. Find a profile and hit <b>Message privately</b>.
    </div>
  </main>

  <script>
    const sb = supabase.createClient(
      "https://tuqvpcevrhciursxrgav.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"
    );

    const list = document.getElementById('list');
    const empty = document.getElementById('empty');
    let me = null;

    function threadRow(other, thread, lastMsg, isUnread){
      const a = document.createElement('a');
      a.href = `./dm.html?thread=${thread.id}`;
      a.className = 'thread' + (isUnread ? ' unread' : '');
      a.innerHTML = `
        <div class="pfp">${other?.avatar_url ? `<img src="${other.avatar_url}" alt="">` : ''}</div>
        <div class="meta">
          <div class="name">${other?.display_name || ('@'+(other?.username||'user'))}</div>
          <div class="last">${lastMsg?.body ? lastMsg.body : 'No messages yet'}</div>
        </div>
      `;
      return a;
    }

    async function loadInbox(){
      list.innerHTML = '';
      const { data: { session } } = await sb.auth.getSession();
      if(!session){ location.href = './login.html'; return; }
      me = session.user;

      // 1) fetch my threads (RLS limits to mine)
      const { data: threads, error } = await sb
        .from('dm_threads')
        .select('id,a,b,created_at')
        .order('created_at', { ascending:false });

      if(error){
        console.error(error);
        empty.textContent = 'Error loading conversations.';
        empty.style.display = '';
        return;
      }

      if(!threads || threads.length===0){
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      // 2) fetch other participants' profiles in one go
      const otherIds = threads.map(t => t.a === me.id ? t.b : t.a);
      const uniqIds = [...new Set(otherIds)];
      const { data: others, error: othersErr } = await sb
        .from('profiles')
        .select('id,username,display_name,avatar_url')
        .in('id', uniqIds);

      if(othersErr){ console.error(othersErr); }

      const byId = Object.fromEntries((others||[]).map(u => [u.id, u]));

      // 3) for each thread, get last message and compute "unread"
      for(const t of threads){
        const otherId = t.a === me.id ? t.b : t.a;
        const other = byId[otherId];

        const { data: last, error: lastErr } = await sb
          .from('dm_messages')
          .select('id,body,created_at,sender')
          .eq('thread_id', t.id)
          .order('created_at', { ascending:false })
          .limit(1)
          .maybeSingle();

        if(lastErr){ console.error(lastErr); }

        // Local unread heuristic:
        // Unread if (last exists) AND (last was sent by them) AND (it's newer than our locally stored last-read)
        const lastReadKey = `dm_last_read_${t.id}`;
        const lastRead = Number(localStorage.getItem(lastReadKey) || 0);
        const lastTime = last?.created_at ? new Date(last.created_at).getTime() : 0;
        const isUnread = !!(last && last.sender !== me.id && lastTime > lastRead);

        list.appendChild(threadRow(other, t, last, isUnread));
      }
    }

    document.addEventListener('DOMContentLoaded', loadInbox);
  </script>
</body>
</html>