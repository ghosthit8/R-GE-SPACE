name: Supabase Edge Functions (Deploy + Keepalive)

on:
  push:
    paths:
      - "supabase/functions/**"
      - ".github/workflows/supabase-edge.yml"
  workflow_dispatch:
  # Optional keepalive every 2 minutes (safe no-op when timer is live)
  schedule:
    - cron: "*/2 * * * *"

permissions:
  contents: read

# Avoid overlapping deploys
concurrency:
  group: supabase-edge
  cancel-in-progress: true

jobs:
  deploy_and_keepalive:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ‚¨áÔ∏è Check out repo
        uses: actions/checkout@v4

      - name: üß∞ Install Supabase CLI
        uses: supabase/setup-cli@v1

      # ---------------------------
      # üîê GITHUB SECRETS (CI/CD)
      #   SUPABASE_ACCESS_TOKEN  -> your Supabase Personal Access Token (PAT)
      #   SUPABASE_PROJECT_REF   -> e.g. tuqvpcevrhciursxrgav
      # ---------------------------
      - name: üîó Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: üöÄ Deploy Edge Function(s)
        # deploy just one:
        run: supabase functions deploy advance-tournament --project-ref "$SUPABASE_PROJECT_REF"
        # or deploy all functions:
        # run: supabase functions deploy --project-ref "$SUPABASE_PROJECT_REF"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # ---------------------------
      # üå°Ô∏è Keepalive (idempotent)
      # Uses ANON key to ping your function. No-op if timer still live.
      # ---------------------------
      - name: ü´Ä Keepalive ping
        run: |
          set -euo pipefail
          curl -sS -X POST \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            "${SUPABASE_URL}/functions/v1/advance-tournament" \
            >/dev/null || true
        env:
          # üîê GITHUB SECRETS (runtime for this step)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}