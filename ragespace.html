<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rage Space ‚Äî City Chat</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --green:#39ff14; --red:#ff0033; --bg:#000; --ink:#e5ffe5;
    --card:#070707; --muted:#8aff8a; --border:#0f2510;
    --maxw: 960px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background: radial-gradient(1200px 800px at 70% -20%, rgba(57,255,20,0.12), transparent 60%), #000;
    color:var(--green);
    font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
    letter-spacing:.2px;
  }
  a{ color:var(--muted); text-decoration:none; }
  a:hover{ text-decoration:underline; }

  /* ===== HEADER (fixed) ===== */
  header{
    position:fixed;
    top:calc(env(safe-area-inset-top,0px) + 8px);
    left:0; right:0; margin:0 auto;
    max-width:var(--maxw);
    z-index:999;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background:linear-gradient(180deg, rgba(255,0,51,0.06), rgba(255,0,51,0));
    border:1px solid var(--border); border-radius:18px; padding:14px 16px;
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
    box-shadow: 0 0 0 1px rgba(57,255,20,0.08), 0 8px 30px rgba(255,0,51,0.12) inset;
    transition: opacity .18s ease;
  }
  /* Spacer occupies the header's height in the flow so content never slides under */
  #header-spacer{ height:140px; } /* JS overwrites this with the exact height */

  .wrap{ max-width:var(--maxw); margin:0 auto 40px; padding:0 16px 16px; }

  .brand{ display:flex; align-items:center; gap:12px; user-select:none; }
  .badge{ font-size:12px; color:#111; background:var(--green); border-radius:999px; padding:2px 8px; font-weight:700; }
  h1{ margin:0; font-size:clamp(20px,2.4vw,28px); letter-spacing:2px; color:var(--green); text-shadow:0 0 6px rgba(255,0,51,0.55); }
  .glitch{ font-weight:900; display:inline-block; position:relative; }
  .glitch::before,.glitch::after{
    content:attr(data-text);
    position:absolute; left:0; top:0; opacity:.7; mix-blend-mode:screen; filter:blur(.3px);
  }
  .glitch::before{ transform:translate(-1px,-0.5px); color:#f0f; clip-path:polygon(0 0,100% 0,100% 40%,0 30%); }
  .glitch::after{  transform:translate(1px, .5px);  color:#0ff; clip-path:polygon(0 60%,100% 70%,100% 100%,0 100%); }
  .white-rabbit{ filter: drop-shadow(0 0 6px rgba(255,0,51,0.45)); }

  .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  select,input,button{
    background:#060606; color:var(--ink); border:1px solid var(--green);
    border-radius:12px; padding:10px 12px; font-family:inherit; font-size:14px; outline:none;
  }
  select{ min-width:170px; }
  button{
    cursor:pointer; font-weight:700;
    box-shadow:0 0 0 1px rgba(57,255,20,0.2), 0 0 12px rgba(57,255,20,0.15) inset;
    transition: transform .05s ease, box-shadow .2s ease;
  }
  button:hover{ box-shadow:0 0 0 1px rgba(57,255,20,0.45), 0 0 18px rgba(57,255,20,0.25) inset; }
  button:active{ transform:translateY(1px) scale(.99); }
  .btn-ghost{ background:#020402; border:1px dashed rgba(57,255,20,0.35); }

  /* ===== LAYOUT ===== */
  .grid{ display:grid; grid-template-columns:1fr 310px; gap:14px; margin-top:12px; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

  .panel{
    background:linear-gradient(180deg, rgba(57,255,20,0.06), rgba(57,255,20,0.02));
    border:1px solid var(--border); border-radius:18px; padding:12px;
    box-shadow:0 0 0 1px rgba(57,255,20,0.08) inset, 0 12px 32px rgba(0,0,0,0.35);
  }
  .panel h2{ margin:4px 6px 10px; font-size:14px; text-transform:uppercase; letter-spacing:2px; color:var(--muted); }
  .meta{ color:#9dff9d; opacity:.85; font-size:12px; margin:2px 6px 10px; }

  .chat{ display:flex; flex-direction:column; height:68vh; min-height:520px; gap:10px; }
  .messages{
    flex:1; overflow:auto; padding:10px; border:1px dashed rgba(57,255,20,0.25);
    border-radius:12px; background:repeating-linear-gradient(0deg, rgba(0,0,0,.7), rgba(0,0,0,.7) 28px, rgba(57,255,20,0.02) 29px);
    scroll-behavior:smooth;
  }
  .msg{
    background:#050805; border:1px solid rgba(57,255,20,0.25); border-left:3px solid var(--green);
    border-radius:12px; padding:8px 10px; margin:8px 0; box-shadow:0 1px 0 rgba(57,255,20,0.1) inset;
    display:flex; gap:10px; position:relative;
  }
  .me{ border-left-color:var(--red); }
  .msg .who{ font-weight:800; color:var(--green); }
  .msg .time{ color:#aaffaa; opacity:.6; font-size:11px; }
  .msg .txt{ color:#eaffea; white-space:pre-wrap; word-wrap:break-word; }
  .msg .ops{ position:absolute; right:6px; top:6px; display:flex; gap:6px; opacity:0; transition:opacity .15s ease; }
  .msg:hover .ops{ opacity:.9; }
  .msg .ops button{ border-color:rgba(57,255,20,0.35); padding:4px 6px; border-radius:8px; font-weight:700; font-size:11px; background:#041004; }

  .composer{ display:flex; gap:8px; }
  .composer input{ flex:1; height:44px; border-radius:14px; border-color:#0a260a; background:#020502; color:var(--ink); }
  .hint{ color:#a2ffa2; opacity:.75; font-size:12px; margin:2px 4px 0; }

  .statusline{ font-size:12px; color:#a2ffa2; opacity:.85; display:flex; gap:10px; align-items:center; }
  .dot{ width:8px; height:8px; border-radius:50%; background:var(--red); box-shadow:0 0 8px var(--red); display:inline-block; }
  .dot.ok{ background:var(--green); box-shadow:0 0 8px var(--green); }

  .sidebar .card{ background:#040704; border:1px solid var(--border); border-radius:14px; padding:10px; margin:10px 0; }
  .kicker{ font-size:12px; color:#a2ffa2; opacity:.7; }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--green); border-radius:999px; font-size:12px; background:#010301; margin:4px 4px 0 0; }
  .footer{ margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; color:#b9ffb9; opacity:.85; font-size:12px; }
</style>
</head>

<body>
  <!-- FIXED header -->
  <header id="site-header">
    <div class="brand">
      <span class="badge">18+</span>
      <h1>
        <span class="glitch" data-text="RŒîGE">RŒîGE</span>
        <span class="glitch" data-text="SPACE">SPACE</span>
        <span class="white-rabbit">üêá</span>
      </h1>
    </div>
    <div class="controls">
      <select id="roomSelect" title="Pick your city room">
        <option value="Dallas" selected>Dallas</option>
        <option value="Austin">Austin</option>
        <option value="Houston">Houston</option>
        <option value="NYC">NYC</option>
        <option value="LA">LA</option>
        <option value="Berlin">Berlin</option>
        <option value="Tokyo">Tokyo</option>
      </select>
      <input id="customRoom" placeholder="or type a room‚Ä¶ (e.g., dallas-north)" />
      <button id="joinBtn" title="Join room">Join</button>
      <button id="leaveBtn" class="btn-ghost" title="Leave room">Leave</button>
      <button id="logoutBtn" title="Sign out">Sign out</button>
    </div>
  </header>

  <!-- Spacer ensures nothing sits under the fixed header -->
  <div id="header-spacer"></div>

  <div class="wrap">
    <div class="grid">
      <section class="panel chat">
        <div class="meta">
          <span class="statusline">
            <span id="realtimeDot" class="dot"></span>
            <span id="statusText">Pick a room and press Join</span>
          </span>
        </div>

        <div id="messages" class="messages" aria-live="polite" aria-busy="true"></div>

        <div class="composer">
          <input id="messageInput" maxlength="800" placeholder="Join a room to chat‚Ä¶" disabled />
          <button id="sendBtn" disabled>Send</button>
        </div>
        <div class="hint">Tips: whats going down in your city // no nazis/alt right, no cp</div>
      </section>

      <aside class="panel sidebar">
        <h2>Who‚Äôs here</h2>
        <div id="presence" class="card kicker">Nobody yet. Be the first to speak.</div>

        <h2>Room</h2>
        <div id="roomInfo" class="card">
          <div><strong>Current:</strong> <span id="roomName">‚Äî</span></div>
          <div><strong>Messages:</strong> <span id="count">‚Äì</span></div>
        </div>

        <h2>Me</h2>
        <div class="card" id="meCard"></div>

        <div class="footer">
          <div>‚Äúfrom the digital crypt‚Äù</div>
          <div><a id="menuLink" href="menu.html">‚üµ back to menu</a></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Layout script: measure header, set spacer height, optional fade-on-scroll -->
  <script>
    (function(){
      const FADE_ON_SCROLL = true;
      const header = document.getElementById('site-header');
      const spacer = document.getElementById('header-spacer');

      function measure(){ spacer.style.height = (header.offsetHeight + 12) + 'px'; }
      function fade(){
        if(!FADE_ON_SCROLL) return;
        const y = window.scrollY;
        const min = 0.0, distance = 80;
        header.style.opacity = Math.max(min, 1 - (y/distance)).toFixed(3);
      }

      window.addEventListener('load', ()=>{ measure(); fade(); });
      window.addEventListener('resize', measure);
      window.addEventListener('orientationchange', measure);
      window.addEventListener('scroll', fade, { passive:true });
      setTimeout(measure, 400);
    })();
  </script>

  <!-- App logic -->
  <script type="module">
    const V = String(Date.now());
    const { createClient } = await import(`https://esm.sh/@supabase/supabase-js@2?v=${V}`);

    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const msgEl = document.getElementById("messages");
    const inputEl = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const presenceEl = document.getElementById("presence");
    const countEl = document.getElementById("count");
    const roomNameEl = document.getElementById("roomName");
    const rtDot = document.getElementById("realtimeDot");
    const statusText = document.getElementById("statusText");
    const roomSelect = document.getElementById("roomSelect");
    const customRoom = document.getElementById("customRoom");
    const joinBtn = document.getElementById("joinBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    let session=null;
    let me={ id:null, username:null };
    let currentRoom=null;
    let channel=null;
    let rateLimit={ last:0, ms:650 };
    let presence=new Map(); // uid -> { username, ts }
    let joined=false;       // <<< NEW: hard gate for sending

    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    function fmtTime(ts){ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
    function autoscroll(){ msgEl.scrollTop = msgEl.scrollHeight + 80; }
    function el(tag,attrs={},...kids){
      const e=document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className=v;
        else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
        else e.setAttribute(k,v);
      }
      kids.forEach(k=> typeof k==="string" ? e.appendChild(document.createTextNode(k)) : (k && e.appendChild(k)));
      return e;
    }
    const profileHref = (uid)=> `profile.html?uid=${encodeURIComponent(uid)}`;

    // enable/disable the composer UI
    function setComposerEnabled(on){
      joined = !!on;
      inputEl.disabled = !on;
      sendBtn.disabled = !on;
      if(on){
        inputEl.placeholder = "Type your message‚Ä¶ (Enter to send, Shift+Enter = newline)";
        status("Live in #" + currentRoom, true);
      }else{
        inputEl.placeholder = "Join a room to chat‚Ä¶";
        status("Pick a room and press Join", false);
      }
    }

    async function requireSession(){
      const { data:{ session:s } } = await supabase.auth.getSession();
      if(!s){ window.location.href="login.html"; return null; }
      session=s; me.id=s.user.id; me.username=s.user.user_metadata?.username ?? null;
      if(!me.username){
        const { data:prof, error } = await supabase.from("profiles").select("username").eq("id", me.id).maybeSingle();
        if(!error && prof?.username) me.username = prof.username;
      }
      me.username ??= "user-" + s.user.id.slice(0,6);
      return s;
    }

    function renderMessage(m){
      const mine = m.user_id === me.id;
      const row = el("div", { class:"msg" + (mine ? " me" : "") });

      // clickable name ‚Üí profile.html?uid=USER_ID
      let nameNode;
      const label = m.username || "anon";
      if (m.user_id) {
        nameNode = el("a", { class:"who", href: profileHref(m.user_id), title:`View ${label}'s profile` }, label);
      } else {
        nameNode = el("div", { class:"who" }, label);
      }

      const time = el("div", { class:"time" }, fmtTime(m.created_at || Date.now()));
      const meta = el("div", { style:"display:flex;flex-direction:column;gap:2px;min-width:94px;" }, nameNode, time);

      const txt  = el("div", { class:"txt" }, m.content || "");
      const ops = el("div", { class:"ops" });
      if (mine) ops.appendChild(el("button", { onclick:()=>deleteMessage(m.id) }, "delete"));

      row.append(meta, txt, ops);
      msgEl.appendChild(row);
    }

    function renderGhost(content){
      const row = el("div", { class:"msg ghost me" });
      const nameNode = el("a", { class:"who", href: profileHref(me.id), title:`View ${me.username}'s profile` }, me.username);
      const time = el("div", { class:"time" }, fmtTime(Date.now()));
      const txt  = el("div", { class:"txt" }, content);
      const meta = el("div", { style:"display:flex;flex-direction:column;gap:2px;min-width:94px;" }, nameNode, time);
      row.append(meta, txt);
      msgEl.appendChild(row);
      return row;
    }

    async function deleteMessage(id){
      const { error } = await supabase.from("messages").delete().eq("id", id).eq("user_id", me.id);
      if(error) alert("Delete failed: " + error.message);
    }

    function clearMessages(){ msgEl.innerHTML=""; msgEl.setAttribute("aria-busy","true"); }

    function touchPresence(user_id, username){ presence.set(user_id,{username,ts:Date.now()}); drawPresence(); }
    function prunePresence(){ const now=Date.now(); for(const [uid,info] of presence){ if(now-info.ts>60000) presence.delete(uid); } drawPresence(); }
    function drawPresence(){
      presenceEl.innerHTML = "";
      if(presence.size===0){
        presenceEl.textContent="Nobody yet. Be the first to speak.";
        return;
      }
      const seen=new Set();
      for(const [uid,info] of presence){
        const label = info.username || "anon";
        if(seen.has(uid)) continue;
        seen.add(uid);
        const pill = uid
          ? el("a", { class:"pill", href:profileHref(uid), title:`View ${label}'s profile` }, label)
          : el("span", { class:"pill" }, label);
        presenceEl.appendChild(pill);
      }
    }
    setInterval(prunePresence, 15000);

    async function joinRoom(name){
      currentRoom=(name||"Dallas").trim();
      roomNameEl.textContent=currentRoom;
      status("Loading messages‚Ä¶", false);

      // Immediate presence as soon as you join a room
      touchPresence(me.id, me.username);

      await subscribeRealtime(currentRoom);

      clearMessages();
      const { data, error, count } = await supabase
        .from("messages").select("*",{ count:"exact" })
        .eq("room", currentRoom).order("created_at",{ ascending:true }).limit(400);
      if(error){ msgEl.appendChild(el("div",{}, "Error loading messages: " + error.message)); }
      else{ data.forEach(renderMessage); countEl.textContent = count ?? data.length; }
      msgEl.removeAttribute("aria-busy");
      autoscroll();

      // Touch again after load (safe no-op if already present)
      touchPresence(me.id, me.username);

      // enable composer now that we're in
      setComposerEnabled(true);
    }

    async function subscribeRealtime(room){
      if(channel){ try{ await supabase.removeChannel(channel); }catch{} channel=null; }
      channel = supabase
        .channel(`room:${room}`)
        .on("postgres_changes",
            { event:"INSERT", schema:"public", table:"messages", filter:`room=eq.${room}` },
            payload=>{ renderMessage(payload.new); countEl.textContent=(parseInt(countEl.textContent||"0",10)+1).toString(); touchPresence(payload.new.user_id,payload.new.username); autoscroll(); })
        .on("postgres_changes",
            { event:"DELETE", schema:"public", table:"messages", filter:`room=eq.${room}` },
            ()=>{ joinRoom(currentRoom); })
        .subscribe(status=>{
          const sub = status==="SUBSCRIBED";
          rtDot.classList.toggle("ok", sub);
          if(sub){
            statusText.textContent = `Live in #${currentRoom}`;
            // Ensure presence reflects you once live
            touchPresence(me.id, me.username);
          }
        });
    }

    function status(text, ok=true){ statusText.textContent=text; rtDot.classList.toggle("ok", !!ok); }

    async function send(){
      // HARD GATE: not joined? block.
      if(!joined || !currentRoom){
        status("Join a room first", false);
        return;
      }

      const now=Date.now();
      if(now-rateLimit.last<rateLimit.ms){ status(`Whoa tiger‚Ä¶ ${Math.ceil((rateLimit.ms-(now-rateLimit.last))/1000)}s`, false); return; }
      const raw=inputEl.value;
      const content=raw.replace(/\s+$/,''); if(!content) return;

      rateLimit.last=now;
      inputEl.value="";
      const ghost=renderGhost(content);
      autoscroll();

      const row={ content, room:currentRoom, user_id:me.id, username:me.username };
      const { error } = await supabase.from("messages").insert(row);
      if(error){ ghost.style.opacity=.5; ghost.style.borderColor="rgba(255,0,51,0.6)"; status("Send failed: "+error.message,false); inputEl.value=content; }
      else status("Sent ‚úì", true);
    }

    sendBtn.addEventListener("click", send);
    inputEl.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){
        // If disabled, prevent any sneaky submits
        if(!joined){ e.preventDefault(); status("Join a room first", false); return; }
        e.preventDefault(); send();
      }
    });

    // Join: immediate presence + room switch
    joinBtn.addEventListener("click", ()=>{
      const choice=customRoom.value.trim()||roomSelect.value;
      touchPresence(me.id, me.username);   // instant ‚Äúwho‚Äôs here‚Äù update
      joinRoom(choice);
      customRoom.value="";
    });

    // Leave: instant removal + LOCK composer
    leaveBtn.addEventListener("click", async ()=>{
      if(channel){ try{ await supabase.removeChannel(channel); }catch{} }
      channel = null;
      presence.delete(me.id);
      drawPresence();
      setComposerEnabled(false);
      currentRoom=null;
      roomNameEl.textContent="‚Äî";
      clearMessages();
      msgEl.removeAttribute("aria-busy");
    });

    logoutBtn.addEventListener("click", async ()=>{ await supabase.auth.signOut(); window.location.href="login.html"; });

    await requireSession();

    // START LOCKED ‚Äî user must press Join
    setComposerEnabled(false);

    // message count refresher (only when joined)
    setInterval(async ()=>{
      if(!joined || !currentRoom) return;
      const { count } = await supabase.from("messages").select("*",{ count:"exact", head:true }).eq("room", currentRoom);
      if(typeof count==="number") countEl.textContent=count.toString();
    }, 20000);
  </script>
</body>
</html>