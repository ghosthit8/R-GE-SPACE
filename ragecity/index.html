<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî City Proto</title>

  <!-- Rage City styles -->
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <!-- note: now goes back UP one level -->
  <a id="btn-menu" class="home-btn" href="../menu.html">‚Üê Menu</a>

  <button id="btn-fullscreen" class="fullscreen-btn" tabindex="-1">‚õ∂ Fullscreen</button>

  <div id="game-container">
    <div id="game-fallback">Loading Rage City‚Ä¶</div>

    <div id="art-overlay">
      <div id="art-overlay-msg">Press "A" for fullscreen</div>
      <img
        id="art-overlay-img"
        src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=2000&q=80"
        alt="Gallery art"
      />
    </div>
  </div>

  <div class="controls-overlay">
    <div class="controls-inner">
      <div class="dpad">
        <button class="empty" disabled></button>
        <button id="btn-up" tabindex="-1">‚ñ≤</button>
        <button class="empty" disabled></button>

        <button id="btn-left" tabindex="-1">‚óÄ</button>
        <button class="empty" disabled></button>
        <button id="btn-right" tabindex="-1">‚ñ∂</button>

        <button class="empty" disabled></button>
        <button id="btn-down" tabindex="-1">‚ñº</button>
        <button class="empty" disabled></button>
      </div>

      <!-- ABXY (Xbox-style diamond) -->
      <div class="abxy">
        <button id="btn-y" class="abxy-btn btn-y" tabindex="-1">‚óè</button>
        <button id="btn-x" class="abxy-btn btn-x" tabindex="-1">‚óè</button>
        <button id="btn-b" class="abxy-btn btn-b" tabindex="-1">‚óè</button>
        <button id="btn-a" class="abxy-btn btn-a" tabindex="-1">‚óè</button>
      </div>
    </div>
  </div>

  <!-- üîß Hidden file input for per-painting uploads -->
  <input
    type="file"
    id="paintingUpload"
    accept="image/*,video/*"
    style="display:none"
  />

  <!-- Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>

  <!-- Supabase JS (global client for Rage City gallery) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // üîë Supabase project config for Rage City
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"; // ‚Üê paste your anon key

    // Make a global client so cityScene.js and others can use `window.supabase`
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Rage City scripts -->
  <script src="./js/input.js"></script>
  <script src="./js/overlay.js"></script>
  <script src="./js/cityScene.js"></script>
  <script src="./js/main.js"></script>

  <script>
    // --- Mobile fullscreen stability helpers ---
    (function () {
      // Prevent virtual gamepad buttons from stealing focus (which can exit fullscreen on mobile)
      const preventers = [
        ...document.querySelectorAll('.controls-overlay button'),
        document.getElementById('btn-fullscreen'),
      ].filter(Boolean);

      function preventFocus(e) { e.preventDefault(); }

      preventers.forEach(btn => {
        btn.addEventListener('touchstart', preventFocus, { passive: false });
        btn.addEventListener('mousedown', preventFocus);
        btn.addEventListener('pointerdown', preventFocus, { passive: false });
      });

      // Track when we *want* to be fullscreen (e.g., user pressed fullscreen once)
      let wantFullscreen = false;

      function requestAppFullscreen() {
        const el = document.documentElement;
        const fsEl = document.fullscreenElement || document.webkitFullscreenElement;
        if (fsEl) return;
        if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      }

      // Expose so other scripts can call it safely
      window.ensureAppFullscreen = function () {
        wantFullscreen = true;
        requestAppFullscreen();
      };

      // If the user clicks the fullscreen button, remember that fullscreen is desired.
      const fsBtn = document.getElementById('btn-fullscreen');
      if (fsBtn) {
        fsBtn.addEventListener('click', () => { wantFullscreen = true; });
        fsBtn.addEventListener('touchstart', () => { wantFullscreen = true; }, { passive: true });
      }

      // If the A button is used to open the file picker, browsers often exit fullscreen.
      // When the picker closes (tab becomes visible again), re-enter fullscreen.
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          if (wantFullscreen) requestAppFullscreen();
        }
      });

      // Also re-assert fullscreen after file selection changes
      const fileInput = document.getElementById('paintingUpload');
      if (fileInput) {
        fileInput.addEventListener('click', () => { wantFullscreen = true; });
        fileInput.addEventListener('change', () => {
          // give the UI a tick to settle, then re-request fullscreen
          setTimeout(() => { if (wantFullscreen) requestAppFullscreen(); }, 200);
        });
      }

      // When pressing the A virtual button, keep fullscreen "sticky"
      const aBtn = document.getElementById('btn-a');
      if (aBtn) {
        aBtn.addEventListener('touchstart', () => { wantFullscreen = true; }, { passive: true });
        aBtn.addEventListener('mousedown', () => { wantFullscreen = true; });
      }
    })();
  </script>

</body>
</html>