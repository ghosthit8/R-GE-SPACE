<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî City Proto</title>

  <!-- Rage City styles -->
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <!-- note: now goes back UP one level -->
  <a class="home-btn" href="../menu.html">‚Üê Menu</a>

  <button id="btn-fullscreen" class="fullscreen-btn">‚õ∂ Fullscreen</button>

  <div id="game-container">
    <div id="game-fallback">Loading Rage City‚Ä¶</div>

    <!-- Overlay container used by CityScene -->
    <div id="art-overlay" style="display:none;">
      <div id="art-overlay-msg">Press "A" for fullscreen</div>

      <!-- Image -->
      <img
        id="art-overlay-img"
        src=""
        alt="Gallery art"
        style="display:none;"
      />

      <!-- Video -->
      <video
        id="art-overlay-video"
        controls
        playsinline
        preload="metadata"
        style="display:none; max-width:92vw; max-height:72vh;"
      ></video>
    </div>
  </div>

  <div class="controls-overlay">
    <div class="controls-inner">
      <div class="dpad">
        <button class="empty" disabled></button>
        <button id="btn-up">‚ñ≤</button>
        <button class="empty" disabled></button>

        <button id="btn-left">‚óÄ</button>
        <button class="empty" disabled></button>
        <button id="btn-right">‚ñ∂</button>

        <button class="empty" disabled></button>
        <button id="btn-down">‚ñº</button>
        <button class="empty" disabled></button>
      </div>

      <div class="ab-buttons">
        <button id="btn-b" class="btn-b">‚óè</button>
        <button id="btn-a" class="btn-a">‚óè</button>
      </div>
    </div>
  </div>

  <!-- üîß Hidden file input for per-painting uploads -->
  <input
    type="file"
    id="paintingUpload"
    accept="image/*,video/*"
    style="display:none"
  />

  <!-- Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>

  <!-- Supabase JS (global client for Rage City gallery) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // üîë Supabase project config for Rage City
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE";

    // Make a global client so cityScene.js and others can use `window.supabase`
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Rage City scripts -->
  <script src="./js/input.js"></script>

  <!-- ‚úÖ NEW: overlay controller (supports image + video + fullscreen) -->
  <script>
    // Shared overlay state CityScene expects
    window.artOpen = false;

    const artOverlayEl = document.getElementById("art-overlay");
    const artMsgEl = document.getElementById("art-overlay-msg");
    const artImgEl = document.getElementById("art-overlay-img");
    const artVidEl = document.getElementById("art-overlay-video");

    // Detect video by mime or extension
    function _isVideo(mimeType, url) {
      const mt = (mimeType || "").toLowerCase();
      if (mt.startsWith("video/")) return true;
      const s = String(url || "").toLowerCase();
      return s.endsWith(".mp4") || s.endsWith(".webm") || s.endsWith(".mov") || s.endsWith(".m4v");
    }

    // Keep current media info so toggle fullscreen knows what to fullscreen
    let _currentUrl = null;
    let _currentMime = "";

    // openArtOverlay can accept:
    //  - a string URL (legacy)
    //  - { url, mimeType } (new)
    window.openArtOverlay = function(arg) {
      let url = null;
      let mimeType = "";

      if (typeof arg === "string") {
        url = arg;
      } else if (arg && typeof arg === "object") {
        url = arg.url || null;
        mimeType = arg.mimeType || "";
      }

      if (!url) return;

      _currentUrl = url;
      _currentMime = mimeType;

      const isVid = _isVideo(mimeType, url);

      // Reset
      artImgEl.style.display = "none";
      artVidEl.style.display = "none";

      // Apply
      if (isVid) {
        artMsgEl.textContent = 'Tap play (video) ‚Äî Press "A" for fullscreen';
        artVidEl.src = url;
        artVidEl.style.display = "block";
      } else {
        artMsgEl.textContent = 'Press "A" for fullscreen';
        artImgEl.src = url;
        artImgEl.style.display = "block";
      }

      artOverlayEl.style.display = "flex";
      window.artOpen = true;
    };

    window.closeArtOverlay = function() {
      // Stop video cleanly
      try {
        artVidEl.pause();
      } catch(_) {}

      artVidEl.removeAttribute("src");
      artVidEl.load();

      artImgEl.src = "";

      artOverlayEl.style.display = "none";
      window.artOpen = false;
      _currentUrl = null;
      _currentMime = "";
    };

    // Fullscreen toggle used by CityScene when overlay is open
    window.toggleArtFullscreen = function() {
      const isVid = _isVideo(_currentMime, _currentUrl);
      const target = isVid ? artVidEl : artImgEl;

      if (!target) return;

      if (!document.fullscreenElement) {
        if (target.requestFullscreen) target.requestFullscreen();
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
      }
    };

    // Click outside media closes overlay
    artOverlayEl.addEventListener("click", (e) => {
      if (e.target === artOverlayEl) window.closeArtOverlay();
    });
  </script>

  <!-- Your scene + game boot -->
  <script src="./js/cityScene.js"></script>
  <script src="./js/main.js"></script>
</body>
</html>