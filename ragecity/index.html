<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rage Space ‚Äî City Proto</title>

  <!-- Rage City styles -->
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <!-- note: now goes back UP one level -->
  <a id="btn-menu" class="home-btn" href="../menu.html">‚Üê Menu</a>

  <button id="btn-fullscreen" class="fullscreen-btn">‚õ∂ Fullscreen</button>

  <div id="game-container">
    <div id="game-fallback">Loading Rage City‚Ä¶</div>

    <div id="art-overlay">
      <div id="art-overlay-msg">Press "A" for fullscreen</div>
      <img
        id="art-overlay-img"
        src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=2000&q=80"
        alt="Gallery art"
      />
    </div>
  </div>

  <div class="controls-overlay">
    <div class="controls-inner">
      <div class="dpad">
        <button class="empty" disabled></button>
        <button id="btn-up">‚ñ≤</button>
        <button class="empty" disabled></button>

        <button id="btn-left">‚óÄ</button>
        <button class="empty" disabled></button>
        <button id="btn-right">‚ñ∂</button>

        <button class="empty" disabled></button>
        <button id="btn-down">‚ñº</button>
        <button class="empty" disabled></button>
      </div>

      <!-- ABXY (Xbox-style diamond) -->
      <div class="abxy">
        <button id="btn-y" class="abxy-btn btn-y">‚óè</button>
        <button id="btn-x" class="abxy-btn btn-x">‚óè</button>
        <button id="btn-b" class="abxy-btn btn-b">‚óè</button>
        <button id="btn-a" class="abxy-btn btn-a">‚óè</button>
      </div>
    </div>
  </div>

  <!-- üîß Hidden file input for per-painting uploads -->
  <input
    type="file"
    id="paintingUpload"
    accept="image/*,video/*"
    style="display:none"
  />

  <!-- Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>

  <!-- Supabase JS (global client for Rage City gallery) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // üîë Supabase project config for Rage City
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y"; // ‚Üê paste your anon key

    // Make a global client so cityScene.js and others can use `window.supabase`
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>


  <script>
    // ==== Fullscreen fixes (mobile-safe) ====
    // Mobile browsers require requestFullscreen() to be called directly from a user gesture
    // (touchstart/pointerdown). Also, opening a file picker often exits fullscreen, so we
    // "stick" fullscreen by re-requesting it when the page regains focus.
    (function () {
      let wantsFullscreen = false;

      function requestAppFullscreen() {
        const el = document.documentElement;

        // Already fullscreen?
        if (document.fullscreenElement || document.webkitFullscreenElement) return;

        // Standard
        if (el.requestFullscreen) {
          el.requestFullscreen().catch(() => {});
          return;
        }
        // iOS Safari
        if (el.webkitRequestFullscreen) {
          try { el.webkitRequestFullscreen(); } catch (e) {}
        }
      }

      // Expose for other scripts (optional)
      window.ensureAppFullscreen = function ensureAppFullscreen() {
        if (!wantsFullscreen) return;
        requestAppFullscreen();
      };

      function makeNoFocusButton(btn) {
        if (!btn) return;
        // Prevent focus/selection from breaking fullscreen or shifting UI
        btn.setAttribute("tabindex", "-1");

        // Prevent default scrolling / focus behavior on mobile
        btn.addEventListener("touchstart", (e) => { e.preventDefault(); }, { passive: false });
        btn.addEventListener("pointerdown", (e) => { e.preventDefault(); });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const fsBtn = document.getElementById("btn-fullscreen");
        const uploadInput = document.getElementById("paintingUpload");

        // Make control buttons "no-focus" so taps don't yank fullscreen/focus
        document.querySelectorAll(".controls-overlay button, #btn-fullscreen").forEach(makeNoFocusButton);

        // Fullscreen button: use touchstart/pointerdown (NOT click) for mobile reliability
        if (fsBtn) {
          const goFS = (e) => {
            if (e) e.preventDefault();
            wantsFullscreen = true;
            requestAppFullscreen();
          };

          fsBtn.addEventListener("touchstart", goFS, { passive: false });
          fsBtn.addEventListener("pointerdown", goFS);
        }

        // If you were fullscreen and open the file picker, many browsers drop fullscreen.
        // When you return to the app (window focus), re-request fullscreen.
        if (uploadInput) {
          uploadInput.addEventListener("click", () => {
            // The picker is about to open; remember we want fullscreen when we come back.
            wantsFullscreen = true;
          });
          uploadInput.addEventListener("change", () => {
            wantsFullscreen = true;
          });
        }

        // Keep fullscreen "sticky" when the user returns from file picker / app switch
        window.addEventListener("focus", () => {
          if (wantsFullscreen) {
            // small delay helps after file picker closes
            setTimeout(() => requestAppFullscreen(), 80);
          }
        });

        // If the user manually exits fullscreen, stop forcing it
        document.addEventListener("fullscreenchange", () => {
          if (!document.fullscreenElement) wantsFullscreen = false;
        });
        document.addEventListener("webkitfullscreenchange", () => {
          if (!document.webkitFullscreenElement) wantsFullscreen = false;
        });
      });
    })();
  </script>

  <!-- Rage City scripts -->
  <script src="./js/input.js"></script>
  <script src="./js/overlay.js"></script>
  <script src="./js/cityScene.js"></script>
  <script src="./js/main.js"></script>
</body>
</html>