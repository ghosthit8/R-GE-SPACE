<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RageSpace — Winners</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root { --bg:#060606; --card:#0c0f0c; --text:#e8ffe8; --muted:#9ee89e; --line:#1b221b; --accent:#00ff75; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width:900px; margin:0 auto; padding:18px 14px 64px; }
    h1 { margin:0 0 12px; font-size:24px; letter-spacing:.5px; }
    .toolbar { display:flex; gap:10px; align-items:center; margin:8px 0 18px; flex-wrap:wrap; }
    button, .btn {
      appearance: none; border:1px solid #1f2a1f; background:#0b120d; color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:0 0 18px #002a12 inset, 0 0 0 1px #0b150f;
    }
    button:hover { filter:brightness(1.15); }
    .list { display:flex; flex-direction:column; gap:10px; }
    .row {
      display:grid; grid-template-columns: 58px 84px 1fr auto; align-items:center;
      gap:12px; padding:10px; border-radius:16px; background:linear-gradient(180deg,#0a0d0a, #0a0f0a);
      border:1px solid var(--line); box-shadow:0 2px 14px rgba(0,0,0,.45);
    }
    .num { width:52px; height:52px; display:grid; place-items:center; border-radius:12px; border:1px solid var(--line); background:#0b110c; color:var(--muted); font-weight:800; }
    .thumb { width:84px; height:56px; object-fit:cover; border-radius:10px; border:1px solid var(--line); background:#090909; }
    .meta { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .name { font-weight:800; letter-spacing:.3px; }
    .color { font-weight:700; opacity:.9; }
    .ts { color:#b4ffb4; opacity:.75; font-size:12px; margin-left:auto; white-space:nowrap; }
    .empty { padding:26px; text-align:center; opacity:.6; border:1px dashed var(--line); border-radius:14px; }
    .badgeline { display:flex; gap:8px; align-items:center; }
    .badge { padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#0b120d; font-size:12px; }
    .danger { border-color:#3a1414; background:#170909; color:#ff9e9e; }
    .note { font-size:12px; opacity:.75; }
    a { color:var(--accent); text-decoration:none; }
    .foot { margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Recent Winners</h1>
    <div class="toolbar">
      <button id="refreshBtn">Refresh</button>
      <button id="liveBtn" aria-pressed="true">Live: On</button>
      <button id="clearBtn" class="danger">Clear (dev)</button>
      <span class="note">Ties show as <b>N/A</b> and are marked <b>via TIE</b>. Only votes decide wins.</span>
    </div>

    <div id="list" class="list"></div>

    <div class="foot">
      <span class="note">Showing most recent 50.</span>
      <a href="./matchup.html" class="note">Go to Matchup</a>
    </div>
  </div>

<script>
/* --- CONFIG --- */
const SUPABASE_URL  = window.ENV_SUPABASE_URL  || localStorage.getItem('SUPABASE_URL')  || '<YOUR_SUPABASE_URL>';
const SUPABASE_ANON = window.ENV_SUPABASE_ANON || localStorage.getItem('SUPABASE_ANON') || '<YOUR_SUPABASE_ANON_KEY>';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* --- UI --- */
const listEl = document.getElementById('list');
const liveBtn = document.getElementById('liveBtn');
const refreshBtn = document.getElementById('refreshBtn');
const clearBtn = document.getElementById('clearBtn');
let live = true;
let sub;

/** Render winners list */
function render(rows){
  if(!rows || rows.length === 0){
    listEl.innerHTML = `<div class="empty">No winners yet.</div>`;
    return;
  }
  const total = rows.length;
  listEl.innerHTML = rows.map((r, i) => {
    const n  = total - i;
    const ts = new Date(r.decided_at).toLocaleString();
    const decided = (r.decided_by || '').toUpperCase(); // 'VOTES' or 'TIE'
    const showName  = r.color ? (r.name || '').toUpperCase() : 'N/A';
    const showColor = r.color ? (r.color || '').toUpperCase() : '—';
    const decidedBadge = decided ? `<span class="badge">via ${decided}</span>` : '';
    const rc = (r.red_count ?? null), bc = (r.blue_count ?? null);
    const counts = (rc!=null || bc!=null) ? `<span class="badge">${rc ?? 0}R · ${bc ?? 0}B</span>` : '';

    return `
      <div class="row">
        <div class="num">#${n}</div>
        <img class="thumb" src="${r.image_url}" alt="${showColor}">
        <div class="meta">
          <div class="badgeline">
            <div class="name">${showName}</div>
            <div class="color">${showColor}</div>
            ${decidedBadge}
            ${counts}
          </div>
        </div>
        <div class="ts">${ts}</div>
      </div>
    `;
  }).join("");
}

/** Load latest winners */
async function load(){
  const { data, error } = await supabase
    .from('winners')
    .select('phase_key,color,name,decided_at,image_url,decided_by,red_count,blue_count')
    .order('decided_at', { ascending:false })
    .limit(50);
  if(error){ console.error(error); return; }
  render(data);
}

/** Live changes */
async function startLive(){
  await stopLive();
  sub = supabase
    .channel('winners-live')
    .on('postgres_changes', { event:'*', schema:'public', table:'winners' }, load)
    .subscribe();
}
async function stopLive(){ try{ if(sub){ await supabase.removeChannel(sub); sub = null; } }catch{} }

refreshBtn.onclick = load;
liveBtn.onclick = async () => {
  live = !live;
  liveBtn.setAttribute('aria-pressed', String(live));
  liveBtn.textContent = `Live: ${live? 'On':'Off'}`;
  if(live) startLive(); else stopLive();
};

// dev-only helper to clear table
clearBtn.onclick = async () => {
  if(!confirm('Delete all winners?')) return;
  const { error } = await supabase.from('winners').delete().neq('phase_key', null);
  if(error){ alert(error.message); return; }
  await load();
};

load(); startLive();
</script>
</body>
</html>