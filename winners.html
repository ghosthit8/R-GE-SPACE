<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Winners</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#98a2b3; --card:#0f1318; --line:#20242a; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif}
    .wrap{max-width:780px;margin:0 auto;padding:16px 12px 24px}
    h1{margin:0 0 10px;font-size:20px;font-weight:800;letter-spacing:.5px}
    .top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
    a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#131920;color:var(--fg);font-weight:700;text-decoration:none;cursor:pointer}
    .meta{color:var(--muted);font-size:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .tz{padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #1a2636;color:#cbd5e1;font-weight:700;font-size:11px;letter-spacing:.06em}
    .card{border:1px solid var(--line);background:var(--card);border-radius:14px;overflow:hidden}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:#cbd5e1;font-weight:700;font-size:12px;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap}
    .pillA{background:#2a1212;border:1px solid #4c2222;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .pillB{background:#0f1f33;border:1px solid #20344d;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .pillU{background:#27272a;border:1px solid #3f3f46;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .score{font-variant-numeric:tabular-nums;white-space:nowrap;font-weight:700}
    .cycle{word-break:break-all;color:#cbd5e1;opacity:.9}
    .thumb{width:42px;height:42px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
    @media (max-width:520px){ th.cycle,td.cycle{display:none} th,td{padding:8px 10px} table{font-size:13px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Winners Log</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="matchup.html">← Back</a>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="clear">Clear Data</button>
      </div>
    </div>

    <div class="meta" id="meta">
      Loading…
      <span class="tz" id="tzBadge"></span>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Decided At</th>
              <th class="cycle">Cycle</th>
              <th>Winner</th>
              <th>Thumbnail</th>
              <th>Score</th>
              <th>Decided By</th>
            </tr>
          </thead>
          <tbody id="body">
            <tr><td colspan="7" style="padding:18px;color:#9aa0a6;">Loading winners…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const FUNCTION_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer-v2";
    const ADMIN_KEY = "Inklink88!";
    const metaEl = document.getElementById('meta');
    const tzBadge = document.getElementById('tzBadge');
    const tbody  = document.getElementById('body');

    // timezone badge
    try {
      const fmt = new Intl.DateTimeFormat(undefined, { timeZoneName: "short" });
      const tz = fmt.formatToParts(new Date()).find(p=>p.type==="timeZoneName")?.value || "";
      tzBadge.textContent = tz ? `Local time: ${tz}` : "Local time";
    } catch { tzBadge.textContent = "Local time"; }

    // --- time helpers ---
    function parseAsUTCish(s){
      if (!s) return NaN;
      const str = String(s);
      if (/Z|[+-]\d{2}:\d{2}$/.test(str)) return Date.parse(str);
      return Date.parse(str.replace(" ", "T") + "Z");
    }
    function fmtLocal(ts){
      if (isNaN(ts)) return "—";
      return new Date(ts).toLocaleString(undefined, {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"numeric", minute:"2-digit", second:"2-digit", hour12:true
      });
    }
    // Stable final decision time even when page was closed
    function computeFinalTs(row){
      const base = parseAsUTCish(row.base_iso);
      if (!isNaN(base)) {
        const secs = Number(row.period_sec) > 0 ? Number(row.period_sec) : 90;
        return base + secs * 1000;
      }
      const d = parseAsUTCish(row.decided_at);
      return isNaN(d) ? NaN : d;
    }

    // ---------- ORIGINAL SEED (A–H) INFERENCE ----------
    // Build map of seed -> url from any fields that may be present
    function buildSeedMap(r){
      const m = {};
      const set=(k,v)=>{ if(v) m[k]=v; };
      // canonical
      set("a", r.seed_a_url); set("b", r.seed_b_url);
      set("c", r.seed_c_url); set("d", r.seed_d_url);
      set("e", r.seed_e_url); set("f", r.seed_f_url);
      set("g", r.seed_g_url); set("h", r.seed_h_url);
      // snapshots some payloads include
      set("a", r.q1_a_url || m.a); set("b", r.q1_b_url || m.b);
      set("c", r.q2_c_url || m.c); set("d", r.q2_d_url || m.d);
      set("e", r.q3_e_url || m.e); set("f", r.q3_f_url || m.f);
      set("g", r.q4_g_url || m.g); set("h", r.q4_h_url || m.h);
      return m;
    }
    // Very tolerant normalizer: strips scheme/host, querystrings, extensions, and keeps last path piece
    function normalizeUrl(u){
      if(!u) return "";
      try{
        const dec = decodeURIComponent(String(u)).toLowerCase();
        const path = dec.replace(/^https?:\/\/[^/]+/,'').split('?')[0];
        const last = path.split('/').filter(Boolean).pop() || path;
        return last.replace(/\.(jpg|jpeg|png|webp|gif|avif)$/,'');
      }catch{ return String(u).toLowerCase().split('?')[0]; }
    }
    function originSeedLetter(row){
      const win = normalizeUrl(row.image_url || row.winner_url);
      if (!win) return null;
      const map = buildSeedMap(row);
      for (const [letter,url] of Object.entries(map)){
        if (!url) continue;
        if (normalizeUrl(url) === win) return letter;
      }
      return null;
    }
    function pillClassFor(letter){
      if (!letter) return "pillU";
      return /^(a|c|e|g)$/i.test(letter) ? "pillA" : "pillB";
    }

    // ---------- FINALS ONLY + DEDUPE ----------
    function finalsOnly(rows){
      const finals = rows.filter(r=>{
        const phase = (r.phase||r.stage||"").toLowerCase();
        const laneSeed = String(r.winner_seed||"").toLowerCase();
        return phase.includes("final") || laneSeed==="a" || laneSeed==="b";
      });

      const keep = new Map();
      for (const r of finals){
        const key = r.base_iso || r.cycle_key || r.id || Math.random().toString(36);
        const existing = keep.get(key);
        if (!existing) { keep.set(key, r); continue; }
        const ta = parseAsUTCish(r.decided_at);
        const tb = parseAsUTCish(existing.decided_at);
        if (!isNaN(ta) && (isNaN(tb) || ta > tb)) keep.set(key, r);
      }
      return Array.from(keep.values());
    }

    // ---------- RENDER ----------
    function render(rows){
      if(!rows || rows.length===0){
        tbody.innerHTML = `<tr><td colspan="7" style="padding:18px;color:#9aa0a6;">No finals yet.</td></tr>`;
        return;
      }
      const N = rows.length;
      tbody.innerHTML = rows.map((r, idx) => {
        const n = N - idx;

        // prefer original A–H; if unknown show ?
        const inferred = originSeedLetter(r);
        const letter = (inferred ? inferred.toUpperCase() : "?");
        const pillClass = pillClassFor(inferred);

        const by = r.decided_by === 'random_tie' ? 'random tie' : 'votes';
        const score = `${r.red_count ?? 0}–${r.blue_count ?? 0}`;
        const img = r.image_url || r.winner_url || '';
        const thumb = img ? `<img src="${img}" class="thumb">` : `<span style="color:#666;">—</span>`;
        const ts = computeFinalTs(r);

        return `
          <tr>
            <td>${n}</td>
            <td>${fmtLocal(ts)}</td>
            <td class="cycle">${r.base_iso || "—"}</td>
            <td><span class="${pillClass}">Seed ${letter}</span></td>
            <td>${thumb}</td>
            <td class="score">${score}</td>
            <td>${by}</td>
          </tr>`;
      }).join('');
    }

    async function load(){
      metaEl.firstChild ? metaEl.firstChild.nodeValue = 'Loading… ' : (metaEl.textContent = 'Loading… ');
      const res = await fetch(FUNCTION_URL + "?winners=1&limit=400");
      const data = await res.json().catch(()=> ({}));
      const all = Array.isArray(data) ? data : (data.winners || []);

      const finals = finalsOnly(all);
      finals.sort((a,b) => computeFinalTs(b) - computeFinalTs(a));
      render(finals);

      const total = finals.length;
      metaEl.firstChild ? metaEl.firstChild.nodeValue = `Showing ${total} finals • newest is #${total} at top • #1 at bottom ` :
        (metaEl.textContent = `Showing ${total} finals • newest is #${total} at top • #1 at bottom `);
    }

    async function clearData(){
      if(!confirm("⚠️ Permanently delete all winner data?")) return;
      metaEl.firstChild.nodeValue = 'Clearing data… ';
      const res = await fetch(FUNCTION_URL + "?clear=1", {
        method:"DELETE",
        headers:{ "x-admin-key": ADMIN_KEY }
      });
      if(res.ok){ alert("Winner data cleared."); load(); }
      else { const msg = await res.json().catch(()=>({})); alert("Error: " + (msg.error || "failed to clear")); }
    }

    document.getElementById('refresh').onclick = load;
    document.getElementById('clear').onclick = clearData;

    load();
    setInterval(load, 5000);
  </script>
</body>
</html>