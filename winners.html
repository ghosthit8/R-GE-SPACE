<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Winners</title>
  <style>
    body{background:#000;color:#39ff14;font-family:system-ui,Arial,sans-serif;margin:0;padding:20px}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .btn{border:1px solid #39ff14;color:#39ff14;background:transparent;padding:6px 10px;border-radius:8px;text-decoration:none;cursor:pointer}
    .btn:hover{background:rgba(57,255,20,.1)}
    .winner-card{border:1px solid #153b16;border-radius:12px;background:#0b0b0b;margin-bottom:14px;overflow:hidden}
    .winner-card img{width:100%;display:block}
    .meta{padding:8px 12px;display:flex;justify-content:space-between}
    .live{color:#39ff14;font-weight:bold}
    .error{background:#400;color:#f88;padding:6px;border-radius:8px;margin:8px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="bar">
    <span>üü¢ <span class="live">live</span></span>
    <div>
      <a href="matchup.html" class="btn">‚Üê Back to Matchup</a>
      <button id="btnInsert" class="btn">‚úèÔ∏è Test Insert</button>
      <button id="btnRefresh" class="btn">‚ü≥ Refresh</button>
    </div>
  </div>

  <div id="errorBox" class="error" style="display:none"></div>
  <div id="winnersList">No winners yet.</div>

<script>
const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1cXZwY2V2cmhjaXVyc3hyZ2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDA0NDQsImV4cCI6MjA3MjA3NjQ0NH0.JbIWJmioBNB_hN9nrLXX83u4OazV49UokvTjNB6xa_Y";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const EDGE_URL = `${SUPABASE_URL}/functions/v1/global-timer`;
const RED_IMAGE_URL  = 'https://dummyimage.com/800x600/ff0000/ffffff&text=RED';
const BLUE_IMAGE_URL = 'https://dummyimage.com/800x600/0060ff/ffffff&text=BLUE';

const listEl = document.getElementById('winnersList');
const errBox = document.getElementById('errorBox');

function showError(msg){ errBox.style.display='block'; errBox.textContent=msg; }
function clearError(){ errBox.style.display='none'; }

function renderWinners(rows){
  if(!rows || !rows.length){ listEl.textContent="No winners yet."; return; }
  listEl.innerHTML = rows.map(r=>`
    <div class="winner-card">
      <img src="${r.image_url}" alt="${r.color}">
      <div class="meta">
        <span><b>${r.name}</b> ‚Äî ${r.color.toUpperCase()}</span>
        <span>${new Date(r.decided_at).toLocaleString()}</span>
      </div>
    </div>
  `).join("");
}

async function loadWinners(){
  const { data, error } = await supabase.from('winners').select('*').order('decided_at',{ascending:false}).limit(20);
  if(error){ showError("SELECT error: "+error.message); return; }
  clearError();
  renderWinners(data);
}

document.getElementById('btnRefresh').onclick = loadWinners;

document.getElementById('btnInsert').onclick = async()=>{
  const picked = Math.random()<0.5
    ? { color:'red',  name:'Test Winner', image_url: RED_IMAGE_URL }
    : { color:'blue', name:'Test Winner', image_url: BLUE_IMAGE_URL };
  const { error } = await supabase.from('winners').upsert(
    { decided_at:new Date().toISOString(), color:picked.color, name:picked.name,
      image_url:picked.image_url, phase_key: new Date().toISOString(), round_num:1, meta:{source:'manual'} },
    { onConflict:'phase_key' }
  );
  if(error) showError("INSERT error: "+error.message); else clearError();
};

supabase.channel('winners-feed')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'winners'},payload=>{
    loadWinners();
  })
  .subscribe();

loadWinners();

/* === Headless decider so winners keep rolling even if matchup is closed === */
let lastPhaseKey = null;
async function edgeState(){
  const res = await fetch(EDGE_URL,{
    headers:{ 'Authorization':`Bearer ${SUPABASE_ANON_KEY}`,'apikey':SUPABASE_ANON_KEY }
  });
  const j = await res.json().catch(()=> ({}));
  return j.state||j;
}
async function ensureWinner(phaseKey){
  const { data:existing } = await supabase.from('winners').select('id').eq('phase_key',phaseKey).maybeSingle();
  if(existing) return;
  const picked = Math.random()<0.5
    ? { color:'red', name:'RED', image_url:RED_IMAGE_URL }
    : { color:'blue',name:'BLUE',image_url:BLUE_IMAGE_URL };
  await supabase.from('winners').upsert(
    { decided_at:new Date().toISOString(), color:picked.color, name:picked.name,
      image_url:picked.image_url, phase_key:phaseKey, round_num:1, meta:{source:'winners-headless'} },
    { onConflict:'phase_key' }
  );
}
setInterval(async()=>{
  try{
    const st = await edgeState();
    const phaseKey = st.phase_end_at||null;
    if(phaseKey && phaseKey!==lastPhaseKey){
      lastPhaseKey=phaseKey;
      await ensureWinner(phaseKey);
    }
  }catch(e){/* ignore */}
},2000);
</script>
</body>
</html>