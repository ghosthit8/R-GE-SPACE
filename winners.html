<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space ‚Äî Winners</title>

  <!-- Global neon / scanline styles -->
  <link rel="stylesheet" href="style.css">

  <style>
    :root {
      /* tie into your global neon variables */
      --fg: var(--green);
      --bg: #000;
      --accent: var(--green);
      --muted: #6aff6a;
      --card: #050505;
      --line: #133313;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif;
    }

    .wrap{
      max-width:780px;
      margin:0 auto;
      padding:16px 12px 24px;
      position:relative;
      z-index:2; /* sit above scanlines */
    }

    /* glitch title is defined in style.css, this just tweaks spacing */
    h1{
      margin:0 0 10px;
      font-size:22px;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .top{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    /* Cyberpunk buttons that match your global .btn style */
    a.btn,
    button.btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 14px;
      border-radius:12px;
      border:1px solid var(--accent);
      background:#010101;
      color:var(--accent);
      font-weight:700;
      text-decoration:none;
      cursor:pointer;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.08em;
      transition:.18s ease;
    }
    a.btn:hover,
    button.btn:hover{
      box-shadow:0 0 10px var(--accent);
      background:#050805;
    }

    .meta{
      color:var(--muted);
      font-size:12px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .tz{
      padding:2px 10px;
      border-radius:999px;
      background:#020602;
      border:1px solid var(--accent);
      color:var(--accent);
      font-weight:700;
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .seg{
      display:inline-block;
      margin-left:6px;
      padding:2px 10px;
      border:1px dashed var(--accent);
      border-radius:999px;
      font-size:11px;
      color:var(--accent);
      background:#020202;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .card{
      border:1px solid var(--accent);
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
      box-shadow:
        0 0 18px rgba(57,255,20,.25),
        0 0 40px rgba(0,0,0,.9) inset;
      position:relative;
      z-index:2;
    }

    .table-wrap{overflow-x:auto;}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      color:var(--fg);
    }

    th,td{
      padding:10px 12px;
      border-bottom:1px solid rgba(57,255,20,.25);
      text-align:left;
      vertical-align:middle;
    }

    th{
      color:var(--accent);
      font-weight:700;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      white-space:nowrap;
      background:rgba(0,0,0,.7);
    }

    /* winner pills ‚Äì red vs blue glow, but text stays neon green */
    .pillA,
    .pillB{
      display:inline-block;
      padding:4px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--accent);
      border:1px solid var(--accent);
      box-shadow:0 0 8px rgba(57,255,20,.6);
    }

    .pillA{
      background:radial-gradient(circle at 0% 0%, rgba(255,0,51,.45), #140307);
    }

    .pillB{
      background:radial-gradient(circle at 100% 0%, rgba(0,140,255,.4), #020812);
    }

    .score{
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
      font-weight:700;
      color:var(--accent);
    }

    .cycle{
      word-break:break-all;
      color:var(--muted);
      opacity:.9;
      font-size:11px;
    }

    .thumb{
      width:42px;
      height:42px;
      object-fit:cover;
      border-radius:6px;
      border:1px solid var(--accent);
      box-shadow:0 0 10px rgba(57,255,20,.4);
    }

    /* description button */
    .descBtn{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--accent);
      background:#020602;
      color:var(--accent);
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .descBtn:hover{
      background:#041104;
      box-shadow:0 0 6px var(--accent);
    }

    /* description modal */
    .desc-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.88);
      z-index:9999;
    }
    .desc-modal-inner{
      max-width:380px;
      width:90%;
      background:var(--card);
      border-radius:14px;
      border:1px solid var(--accent);
      padding:12px 14px;
      color:var(--fg);
      box-shadow:0 0 20px rgba(57,255,20,.4);
    }
    .desc-modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .desc-modal-close{
      border:none;
      background:transparent;
      color:var(--accent);
      cursor:pointer;
      font-size:16px;
    }
    .desc-modal-body{
      font-size:14px;
      color:var(--fg);
      max-height:260px;
      overflow-y:auto;
      white-space:pre-wrap;
    }

    @media (max-width:560px){
      th.cycle,td.cycle{display:none;}
      table{font-size:13px;}
      th,td{padding:8px 10px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <!-- glitch-title class + data-text uses your cyberpunk title effect -->
      <h1 class="glitch-title" data-text="Winners Log">Winners Log</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="matchup.html">‚Üê Back</a>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="toggleAuto">Auto-Refresh: On</button>
        <button class="btn" id="toggleMode">Mode: All Phases</button>
        <button class="btn" id="clear">Clear Data</button>
      </div>
    </div>

    <div class="meta" id="meta">
      Loading‚Ä¶
      <span class="tz" id="tzBadge"></span>
      <span class="seg">Cycle: R32@120s ‚Üí R16@90s ‚Üí QF@60s ‚Üí SF@30s ‚Üí Final@0s</span>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Decided At</th>
              <th>Phase</th>
              <th class="cycle">Cycle</th>
              <th>Winner</th>
              <th>Piece Name</th>
              <th>Description</th>
              <th>Artist</th>
              <th>Thumbnail</th>
              <th>Score</th>
              <th>Decided By</th>
            </tr>
          </thead>
          <tbody id="body">
            <tr><td colspan="11" style="padding:18px;color:var(--muted);">Loading winners‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Piece description modal -->
  <div id="descModal" class="desc-modal">
    <div class="desc-modal-inner">
      <div class="desc-modal-header">
        <span id="descTitle">Piece description</span>
        <button id="descClose" class="desc-modal-close">‚úï</button>
      </div>
      <div id="descBody" class="desc-modal-body"></div>
    </div>
  </div>

  <!-- Fullscreen image viewer -->
  <div id="fsView" style="
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.88);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9998;
    backdrop-filter:blur(4px);
  ">
    <img id="fsImg" src="" alt="fullscreen winner" style="
      max-width:90%;
      max-height:90%;
      border:2px solid var(--accent);
      border-radius:14px;
      box-shadow:0 0 20px var(--accent);
    ">
  </div>

  <script>
    // -------- config --------
    const FUNCTION_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer-v2";
    const ADMIN_KEY = "Inklink88!";

    const metaEl = document.getElementById('meta');
    const tzBadge = document.getElementById('tzBadge');
    const tbody  = document.getElementById('body');
    const btnRefresh = document.getElementById('refresh');
    const btnToggleAuto = document.getElementById('toggleAuto');
    const btnToggleMode = document.getElementById('toggleMode');
    const btnClear = document.getElementById('clear');

    // fullscreen overlay elements
    const fsView = document.getElementById("fsView");
    const fsImg  = document.getElementById("fsImg");

    fsView.onclick = () => {
      fsView.style.display = "none";
      fsImg.src = "";
    };

    function enableThumbFullscreen() {
      document.querySelectorAll(".thumb").forEach(thumb => {
        thumb.style.cursor = "pointer";
        thumb.onclick = () => {
          fsImg.src = thumb.src;
          fsView.style.display = "flex";
        };
      });
    }

    // description modal elements
    const descModal = document.getElementById('descModal');
    const descTitleEl = document.getElementById('descTitle');
    const descBodyEl = document.getElementById('descBody');
    const descCloseBtn = document.getElementById('descClose');
    let descStore = [];
    let descTitleStore = [];

    function openDesc(idx){
      const title = descTitleStore[idx] || 'Piece description';
      const txt = (descStore[idx] || '').trim();
      descTitleEl.textContent = title;
      descBodyEl.textContent = txt || 'No description provided yet.';
      descModal.style.display = 'flex';
    }
    function closeDesc(){
      descModal.style.display = 'none';
    }
    descCloseBtn.addEventListener('click', closeDesc);
    descModal.addEventListener('click', (e) => {
      if (e.target === descModal) closeDesc();
    });

    // persistent view mode
    const MODE_KEY = "winners_mode_v2"; // "all" | "finals"
    let viewMode = localStorage.getItem(MODE_KEY) || "all";
    function applyModeBtn(){
      btnToggleMode.textContent = viewMode==="all" ? "Mode: All Phases" : "Mode: Finals Only";
    }
    applyModeBtn();

    btnToggleMode.onclick = () => {
      viewMode = (viewMode==="all" ? "finals" : "all");
      localStorage.setItem(MODE_KEY, viewMode);
      applyModeBtn();
      load();
    };
    btnRefresh.onclick = () => load();
    let auto = true;
    btnToggleAuto.onclick = () => {
      auto = !auto;
      btnToggleAuto.textContent = `Auto-Refresh: ${auto ? "On" : "Off"}`;
    };
    btnClear.onclick = clearData;

    // timezone badge
    try {
      const fmt = new Intl.DateTimeFormat(undefined, { timeZoneName: "short" });
      const tz = fmt.formatToParts(new Date()).find(p=>p.type==="timeZoneName")?.value || "";
      tzBadge.textContent = tz ? `Local time: ${tz}` : "Local time";
    } catch {
      tzBadge.textContent = "Local time";
    }

    // --- helpers ---
    function parseAsUTCish(s){
      if (!s) return NaN;
      const str = String(s);
      if (/Z|[+-]\d{2}:\d{2}$/.test(str)) return Date.parse(str);
      return Date.parse(str.replace(" ", "T") + "Z");
    }
    function fmtLocal(ts){
      if (isNaN(ts)) return "‚Äî";
      return new Date(ts).toLocaleString(undefined, {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"numeric", minute:"2-digit", second:"2-digit", hour12:true
      });
    }
    function phaseFromBase(base){
      const s = String(base||"");
      if (!s.includes("::")) return "Final";
      const suf = s.split("::")[1];
      const map = {
        q1:"Quarter 1", q2:"Quarter 2", q3:"Quarter 3", q4:"Quarter 4",
        semi1:"Semi 1", semi2:"Semi 2"
      };
      if (suf.startsWith("r32_")) return "R32 " + suf.split("_")[1];
      return map[suf] || suf.toUpperCase();
    }

    function computeDecidedAt(row){
      const d = parseAsUTCish(row.decided_at);
      if (!isNaN(d)) return d;
      const base = parseAsUTCish(row.base_iso);
      if (!isNaN(base)) {
        const secs = Number(row.period_sec) > 0 ? Number(row.period_sec) : 150; // fallback now 150s
        return base + secs * 1000;
      }
      return NaN;
    }

    function isFinalRow(w){
      return !String(w.base_iso || "").includes("::");
    }

    // Build a map per cycle: image_url ‚Üí original seed (a..af)
    // Include both R16 and R32 rows to backfill original seed letters cleanly.
    function buildUrlToSeedMap(all){
      const byCycle = new Map(); // cycleBase -> Map(url -> seedLetter)
      for (const r of all){
        const base = String(r.base_iso||"");
        const root = base.split("::")[0];
        if (!byCycle.has(root)) byCycle.set(root, new Map());
        if (base.includes("::r16_") || base.includes("::r32_")){
          const url = r.image_url || r.winner_url || "";
          const seed = (r.winner_seed || "").toLowerCase();
          if (url && seed) byCycle.get(root).set(url, seed);
        }
      }
      return byCycle;
    }

    // map a..af ‚Üí 1..32
    function seedLetterToNumber(letter) {
      const list = [
        "a","b","c","d","e","f","g","h",
        "i","j","k","l","m","n","o","p",
        "q","r","s","t","u","v","w","x",
        "y","z","aa","ab","ac","ad","ae","af"
      ];
      const idx = list.indexOf(String(letter || "").toLowerCase());
      return idx >= 0 ? idx + 1 : null;
    }

    function render(rows){
      if(!rows || rows.length===0){
        tbody.innerHTML = `<tr><td colspan="11" style="padding:18px;color:#9aa0a6;">No winners yet.</td></tr>`;
        return;
      }
      descStore = [];
      descTitleStore = [];
      const N = rows.length;
      tbody.innerHTML = rows.map((r, idx) => {
        const n = N - idx;
        const seed = (r._resolved_seed || r.winner_seed || "").toLowerCase();
        const isLeft = ["a","c","e","g","i","k","m","o","q","s","u","w","y","aa","ac","ae"].includes(seed);
        const pillClass = isLeft ? "pillA" : "pillB";

        // letters ‚Üí numbers
        const num = seedLetterToNumber(seed);
        const seedLabel = num ? `Seed #${num}` : "Seed ?";

        const pieceName = r.piece_name || "";
        const artistName = r.artist_name || "";
        const pieceDesc = r.piece_description || r.description || "";

        descStore[idx] = pieceDesc || "";
        descTitleStore[idx] = pieceName || seedLabel || "Piece description";

        const by = r.decided_by === 'random_tie' ? 'random tie' : 'votes';
        const score = `${r.red_count ?? 0}‚Äì${r.blue_count ?? 0}`;
        const img = r.image_url || r.winner_url || '';
        const thumb = img ? `<img src="${img}" class="thumb" alt="winner">` : `<span style="color:#666;">‚Äî</span>`;
        const decidedTs = computeDecidedAt(r);
        const phase = phaseFromBase(r.base_iso);
        return `
          <tr>
            <td>${n}</td>
            <td>${fmtLocal(decidedTs)}</td>
            <td>${phase}</td>
            <td class="cycle">${r.base_iso || "‚Äî"}</td>
            <td><span class="${pillClass}">${seedLabel}</span></td>
            <td>${pieceName || "‚Äî"}</td>
            <td><button class="descBtn" onclick="openDesc(${idx})">üîç</button></td>
            <td>${artistName || "‚Äî"}</td>
            <td>${thumb}</td>
            <td class="score">${score}</td>
            <td>${by}</td>
          </tr>`;
      }).join('');

      // hook up fullscreen click handlers for thumbnails
      enableThumbFullscreen();
    }

    async function load(){
      try {
        const ts = Date.now(); // cache-buster
        metaEl.firstChild ? metaEl.firstChild.nodeValue = 'Loading‚Ä¶ ' : (metaEl.textContent = 'Loading‚Ä¶ ');
        const res = await fetch(`${FUNCTION_URL}?winners=1&limit=500&_=${ts}`, { cache: "no-store" });
        const data = await res.json().catch(()=> ({}));
        const all = Array.isArray(data) ? data : (data.winners || []);

        // Resolve original seeds by matching image_url back to R32/R16 rows
        const mapByCycle = buildUrlToSeedMap(all);
        for (const r of all){
          const root = String(r.base_iso||"").split("::")[0];
          const url = r.image_url || r.winner_url || "";
          const m = mapByCycle.get(root);
          if (m && url && m.has(url)){
            r._resolved_seed = m.get(url); // a..af
          }
        }

        // filter according to mode
        const rows = viewMode==="finals" ? (all||[]).filter(isFinalRow) : (all||[]);
        // newest first by decided_at
        rows.sort((a,b) => computeDecidedAt(b) - computeDecidedAt(a));
        render(rows);

        const total = rows.length;
        const newest = rows[0];
        const newestTs = newest ? computeDecidedAt(newest) : NaN;
        const prefix = `Showing ${total} ${viewMode==="finals"?"finals":"winners"}`;
        const newestTxt = isNaN(newestTs) ? '' : ` ‚Ä¢ newest at ${fmtLocal(newestTs)}`;
        const tail = total ? newestTxt : '';
        metaEl.firstChild ? metaEl.firstChild.nodeValue = prefix + tail : (metaEl.textContent = prefix + tail);
      } catch (e){
        metaEl.firstChild ? metaEl.firstChild.nodeValue = 'Error loading winners' : (metaEl.textContent = 'Error loading winners');
        console.error(e);
      }
    }

    async function clearData(){
      const ok = prompt("Admin key to clear winners:") === ADMIN_KEY;
      if (!ok) return;
      try{
        const res = await fetch(`${FUNCTION_URL}?clear=1`, {
          method: "DELETE",
          headers: { "x-admin-key": ADMIN_KEY }
        });
        if (!res.ok) throw new Error("clear failed");
        await load();
      }catch(e){
        alert("Clear failed: " + (e?.message||e));
      }
    }

    // auto refresh loop
    (function loop(){
      if (auto) load();
      setTimeout(loop, 15000);
    })();

    // initial load
    load();
  </script>
</body>
</html>