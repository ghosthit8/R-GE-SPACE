<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rage Space ‚Äî Winners</title>
<style>
  :root { --fg:#e5e7eb; --bg:#0b0d0f; --muted:#98a2b3; --card:#0f1318; --line:#20242a; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif}
  .wrap{max-width:780px;margin:0 auto;padding:16px 12px 24px}
  h1{margin:0 0 10px;font-size:20px;font-weight:800;letter-spacing:.5px}
  .top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
  a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#131920;color:var(--fg);font-weight:700;text-decoration:none;cursor:pointer}
  .meta{color:var(--muted);font-size:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .tz{padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #1a2636;color:#cbd5e1;font-weight:700;font-size:11px;letter-spacing:.06em}
  .card{border:1px solid var(--line);background:var(--card);border-radius:14px;overflow:hidden}
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
  th{color:#cbd5e1;font-weight:700;font-size:12px;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap}
  .pill{background:#0f1f33;border:1px solid #20344d;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
  .score{font-variant-numeric:tabular-nums;white-space:nowrap;font-weight:700}
  .cycle{word-break:break-all;color:#cbd5e1;opacity:.9}
  .thumb{width:42px;height:42px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Winners Log</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="matchup.html">‚Üê Back</a>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="clear">Clear Data</button>
      </div>
    </div>

    <div class="meta" id="meta">
      Loading‚Ä¶
      <span class="tz" id="tzBadge"></span>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Decided At</th>
              <th class="cycle">Cycle</th>
              <th>Winner</th>
              <th>Thumbnail</th>
              <th>Score</th>
              <th>Decided By</th>
            </tr>
          </thead>
          <tbody id="body">
            <tr><td colspan="7" style="padding:18px;color:#9aa0a6;">Loading winners‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // === CONFIG (update if your function URL changes) ===
  const FUNCTION_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer-v2";
  const ADMIN_KEY    = "Inklink88!";

  const metaEl = document.getElementById('meta');
  const tzBadge = document.getElementById('tzBadge');
  const tbody = document.getElementById('body');

  // timezone badge
  try {
    const fmt = new Intl.DateTimeFormat(undefined, { timeZoneName: "short" });
    const tz = fmt.formatToParts(new Date()).find(p=>p.type==="timeZoneName")?.value || "";
    tzBadge.textContent = tz ? `Local time: ${tz}` : "Local time";
  } catch { tzBadge.textContent = "Local time"; }

  // ---------- helpers ----------
  function asNumber(x){ if (x==null||x==="") return NaN; const n=Number(x); return Number.isFinite(n)?(n<1e12?n*1000:n):NaN; }
  function parseAsUTCish(s){
    if (s==null) return NaN;
    const n=asNumber(s); if(!isNaN(n)) return n;
    const str=String(s).trim(); if(!str) return NaN;
    if (/Z|[+-]\d{2}:\d{2}$/.test(str)) return Date.parse(str);
    const t=Date.parse(str.replace(" ","T")+"Z");
    return Number.isFinite(t)?t:NaN;
  }
  function fmtLocal(ts){
    if (isNaN(ts)) return "‚Äî";
    return new Date(ts).toLocaleString(undefined,{
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"numeric",minute:"2-digit",second:"2-digit",hour12:true
    });
  }

  // Finals filter: include finals; exclude quarters (q1..q4) and semis (sf1/sf2)
  function isFinalRow(r){
    const tag = (r.base_iso || r.cycle || r.tag || "").toString();
    if (/::q[1-4]\b/i.test(tag)) return false;
    if (/::sf[12]\b/i.test(tag)) return false;
    if (/::(final|f|champ|winner)\b/i.test(tag)) return true;
    const fields = [r.phase,r.round,r.stage,r.match];
    if (fields.some(v => String(v||"").toLowerCase()==="final")) return true;
    if (r.is_final === true) return true;
    if (!/::/.test(tag)) return true; // no sub-stage tag ‚Üí treat as final log
    return false;
  }

  function bestFinalTimestamp(row){
    const cands = [
      row.final_decided_at, row.decided_at_final, row.final_at,
      row.decided_at, row.created_at, row.inserted_at, row.at, row.ts
    ];
    for (const c of cands){ const t=parseAsUTCish(c); if(!isNaN(t)) return t; }
    const base = parseAsUTCish(row.base_iso);
    if (!isNaN(base)){
      const secs = Number(row.final_offset_sec)||Number(row.period_sec)||Number(row.total_sec)||90;
      return base + secs*1000;
    }
    return NaN;
  }

  // Normalize URL for matching (ignore scheme/host/query and size segments)
  function norm(url){
    const s = String(url||"").trim().toLowerCase();
    if (!s) return "";
    try {
      const u = new URL(s, location.origin);
      return (u.pathname + u.search).replace(/\?.*$/,"");
    } catch {
      // raw path
      return s.replace(/^https?:\/\//,"").replace(/^[^/]*\//,"/").replace(/\?.*$/,"");
    }
  }

  // Map a URL to seed letter using seed_*_url fields or picsum `/seed/<x>/` pattern
  function mapUrlToSeed(row, url){
    const p = norm(url);
    if (!p) return "";

    // Picsum pattern: /seed/<letter>/
    const m = p.match(/\/seed\/([a-h])\b/i);
    if (m) return m[1].toLowerCase();

    // Compare against seed_a_url..seed_h_url
    const map = {
      a: norm(row.seed_a_url), b: norm(row.seed_b_url), c: norm(row.seed_c_url), d: norm(row.seed_d_url),
      e: norm(row.seed_e_url), f: norm(row.seed_f_url), g: norm(row.seed_g_url), h: norm(row.seed_h_url)
    };
    for (const k of Object.keys(map)){
      if (map[k] && (p === map[k] || p.includes(map[k]))) return k;
    }
    return "";
  }

  // Decide which image actually won (from explicit winner fields or by counts)
  function winnerImageUrl(row){
    const direct = row.winner_thumb || row.winner_thumbnail || row.winner_image_url ||
                   row.final_winner_thumb || row.final_winner_url ||
                   row.winner_url || row.image_url;
    if (direct) return direct;

    const red = Number(row.red_count), blue = Number(row.blue_count);
    if (Number.isFinite(red) && Number.isFinite(blue)){
      if (red > blue && row.red_url)  return row.red_url;
      if (blue > red && row.blue_url) return row.blue_url;
    }
    // last resort: any non-empty side url
    return row.red_url || row.blue_url || "";
  }

  // Resolve winner seed (never assume A/B)
  function resolveWinnerSeed(row){
    // explicit seed fields
    let s = (row.winner_seed || row.final_winner_seed || row.winner || row.final_winner || row.seed_winner || "").toString().trim().toLowerCase().replace(/^seed\s+/,'');
    if (/^[a-h]$/.test(s)) return s;

    // from explicit side + known seeds
    const side = String(row.winner_side||row.victor_side||"").toLowerCase();
    const sideSeed = side==="left" ? String(row.left_seed||"").toLowerCase()
                     : side==="right" ? String(row.right_seed||"").toLowerCase() : "";
    if (/^[a-h]$/.test(sideSeed)) return sideSeed;

    // from the image URL we determined
    const url = winnerImageUrl(row);
    const byUrl = mapUrlToSeed(row, url);
    if (/^[a-h]$/.test(byUrl)) return byUrl;

    // give up
    return "";
  }

  function render(rows){
    if(!rows || rows.length===0){
      tbody.innerHTML = `<tr><td colspan="7" style="padding:18px;color:#9aa0a6;">No final winners yet.</td></tr>`;
      metaEl.firstChild ? metaEl.firstChild.nodeValue = 'Showing 0 finals ' : (metaEl.textContent='Showing 0 finals ');
      return;
    }

    const augmented = rows.map(r=>({ ...r, _decided: bestFinalTimestamp(r) }));
    augmented.sort((a,b)=>(isNaN(b._decided)?-Infinity:b._decided)-(isNaN(a._decided)?-Infinity:a._decided));

    // unique clock strings
    const used = new Set();
    for (const r of augmented){
      let t=r._decided, s=fmtLocal(t);
      while(used.has(s)){ t+=1000; s=fmtLocal(t); }
      used.add(s);
      r._displayTs=t; r._displayStr=s;
    }

    const N = augmented.length;
    tbody.innerHTML = augmented.map((r,idx)=>{
      const n = N-idx;
      const seed = resolveWinnerSeed(r);
      const seedTxt = seed ? `Seed ${seed.toUpperCase()}` : "Seed ?";
      const url = winnerImageUrl(r);
      const thumb = url ? `<img src="${url}" class="thumb" loading="lazy">` : `<span style="color:#666;">‚Äî</span>`;
      const by = r.decided_by === "random_tie" ? "random tie" : "votes";
      const score = `${r.red_count ?? 0}‚Äì${r.blue_count ?? 0}`;

      return `
        <tr>
          <td>${n}</td>
          <td title="${fmtLocal(r._decided)}">${r._displayStr}</td>
          <td class="cycle">${r.base_iso || "‚Äî"}</td>
          <td><span class="pill">${seedTxt}</span></td>
          <td>${thumb}</td>
          <td class="score">${score}</td>
          <td>${by}</td>
        </tr>`;
    }).join('');

    const total = augmented.length;
    metaEl.firstChild
      ? metaEl.firstChild.nodeValue = `Showing ${total} finals ‚Ä¢ newest is #${total} at top ‚Ä¢ #1 at bottom `
      : (metaEl.textContent = `Showing ${total} finals ‚Ä¢ newest is #${total} at top ‚Ä¢ #1 at bottom `);
  }

  async function load(){
    metaEl.firstChild ? metaEl.firstChild.nodeValue = 'Loading‚Ä¶ ' : (metaEl.textContent='Loading‚Ä¶ ');
    const res = await fetch(FUNCTION_URL + "?winners=1&limit=500");
    const payload = await res.json().catch(()=> ({}));
    const all = Array.isArray(payload) ? payload : (payload.winners || []);
    const finalsOnly = (all||[]).filter(isFinalRow);
    render(finalsOnly);
  }

  async function clearData(){
    if(!confirm("‚ö†Ô∏è Permanently delete all winner data?")) return;
    metaEl.firstChild.nodeValue = 'Clearing data‚Ä¶ ';
    const res = await fetch(FUNCTION_URL + "?clear=1", {
      method:"DELETE",
      headers:{ "x-admin-key": ADMIN_KEY }
    });
    if(res.ok){ alert("Winner data cleared."); load(); }
    else { const msg = await res.json().catch(()=>({})); alert("Error: " + (msg.error || "failed to clear")); }
  }

  document.getElementById('refresh').onclick = load;
  document.getElementById('clear').onclick = clearData;

  load();
  setInterval(load, 5000);
</script>
<!-- ================== RAGE DEBUGGER v2 (fixed button) ================== -->
<script>
(function () {
  const MAX_LINES = 2000;
  const EDGE_MATCH = /\/functions\/v1\/global-timer/;

  // --- create floating button OUTSIDE the hidden panel ---
  const floatBtn = document.createElement('button');
  floatBtn.id = 'dbgFloatingBtn';
  floatBtn.textContent = 'üêõ Debug';
  floatBtn.style.cssText = `
    position: fixed; right: 8px; bottom: 8px;
    z-index: 2147483647; background:#000; color:#0f0;
    border:1px solid #0f0; border-radius:6px; padding:6px 10px;
    font: 12px/1.1 monospace; cursor:pointer;
  `;
  document.body.appendChild(floatBtn);

  // --- panel wrapper (starts hidden) ---
  const wrap = document.createElement('div');
  wrap.id = 'dbg';
  wrap.style.cssText = `
    position: fixed; right: 0; bottom: 0; left: 0;
    background: rgba(0,0,0,.92); color:#9f9; font: 12px/1.4 monospace;
    z-index: 2147483646; max-height: 45vh; display:none; box-shadow:0 -2px 12px rgba(0,0,0,.6);
  `;

  const bar = document.createElement('div');
  bar.style.cssText = 'display:flex; align-items:center; gap:6px; padding:6px; position:sticky; top:0; background:#111;';
  bar.innerHTML = `
    <span style="color:#6f6">Rage Debug</span>
    <label>Filter:
      <select id="dbgFilter">
        <option value="">All</option>
        <option>NET</option><option>EDGE</option><option>TIMER</option><option>CLOCK</option>
        <option>STAGE</option><option>UI</option><option>IMG</option><option>OBS</option>
        <option>ERR</option><option>WARN</option><option>LOG</option>
      </select>
    </label>
    <label><input id="dbgRecord" type="checkbox" checked> Record</label>
    <button id="dbgCopy">Copy</button>
    <button id="dbgDownload">Download</button>
    <button id="dbgClear">Clear</button>
    <span style="margin-left:auto"></span>
    <button id="dbgClose">‚úï</button>
  `;

  const list = document.createElement('div');
  list.style.cssText = 'padding:6px 8px; white-space:pre-wrap; overflow:auto; max-height:calc(45vh - 42px);';

  wrap.appendChild(bar); wrap.appendChild(list);
  document.body.appendChild(wrap);

  // button wiring
  function showDbg(v){ wrap.style.display = v ? 'block' : 'none'; }
  floatBtn.onclick = () => showDbg(wrap.style.display === 'none');
  bar.querySelector('#dbgClose').onclick = () => showDbg(false);

  // controls
  const filterSel  = bar.querySelector('#dbgFilter');
  const recordChk  = bar.querySelector('#dbgRecord');
  bar.querySelector('#dbgClear').onclick = () => { buffer = []; render(); };
  bar.querySelector('#dbgCopy').onclick = () => navigator.clipboard.writeText(buffer.map(r => r.line).join("\n"));
  bar.querySelector('#dbgDownload').onclick = () => {
    const blob = new Blob([buffer.map(r => r.line).join("\n")], {type:'text/plain'});
    const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download: `rage_debug_${Date.now()}.log`});
    a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  };

  // ring buffer + rendering
  let buffer = [];
  function push(kind, msg, extra) {
    if (!recordChk.checked) return;
    const ts = new Date().toLocaleTimeString();
    const line = `[${ts}] ${kind}: ${msg}`;
    buffer.push({kind, line, extra});
    if (buffer.length > MAX_LINES) buffer.shift();
    const f = filterSel.value;
    if (!f || f === kind) addLine({kind, line});
  }
  function addLine(r){
    const div = document.createElement('div');
    div.textContent = r.line;
    if (r.kind === 'ERR') div.style.color = '#f88';
    else if (r.kind === 'WARN') div.style.color = '#ff8';
    else if (r.kind === 'EDGE') div.style.color = '#8ff';
    else if (r.kind === 'NET')  div.style.color = '#8cf';
    else if (r.kind === 'TIMER' || r.kind === 'CLOCK') div.style.color = '#6f6';
    list.appendChild(div); list.scrollTop = list.scrollHeight;
  }
  function render(){
    list.innerHTML = '';
    const f = filterSel.value;
    for (const r of buffer) if (!f || f === r.kind) addLine(r);
  }
  filterSel.onchange = render;

  // console hooks
  const _log = console.log, _warn = console.warn, _err = console.error;
  console.log = (...a) => { try{push('LOG', a.map(String).join(' '));}catch{} _log.apply(console,a); };
  console.warn= (...a) => { try{push('WARN',a.map(String).join(' '));}catch{} _warn.apply(console,a);};
  console.error=(...a) => { try{push('ERR', a.map(String).join(' '));}catch{} _err.apply(console,a);};

  window.addEventListener('error', (e)=> push('ERR', `${e.message} @ ${e.filename}:${e.lineno}`));
  window.addEventListener('unhandledrejection', (e)=> push('ERR', (e.reason && e.reason.message) || String(e.reason)));

  // visibility & UI observers
  document.addEventListener('visibilitychange', () => push('OBS', `visibility: ${document.visibilityState}`));
  const q = (id) => document.getElementById(id);

  function observeText(id, kind) {
    const el = q(id); if (!el) return;
    let last = el.textContent;
    const mo = new MutationObserver(() => {
      if (el.textContent !== last) {
        last = el.textContent;
        push(kind, `${id} ‚Üí ${last}`);
      }
    });
    mo.observe(el, {childList:true, characterData:true, subtree:true});
  }
  observeText('phaseKey', 'STAGE');
  observeText('state', 'STAGE');

  (function watchClock(){
    const el = q('clock'); if (!el) return;
    let last = el.textContent, lastAt = performance.now();
    const mo = new MutationObserver(() => {
      const now = performance.now();
      if (el.textContent !== last) {
        const dt = ((now - lastAt)/1000).toFixed(2);
        push('CLOCK', `clock ${last} ‚Üí ${el.textContent} (Œîdom ${dt}s)`);
        last = el.textContent; lastAt = now;
      }
    });
    mo.observe(el, {childList:true, characterData:true, subtree:true});
  })();

  // fetch tracer
  const _fetch = window.fetch.bind(window);
  window.fetch = async function(url, opts = {}) {
    const start = performance.now();
    const method = (opts && opts.method) || 'GET';
    const tag = EDGE_MATCH.test(String(url)) ? 'EDGE' : 'NET';
    push(tag, `${method} ${url}`);
    try {
      const res = await _fetch(url, opts);
      const ms = (performance.now() - start).toFixed(0);
      push(tag, `${method} ${url} ‚Üí ${res.status} (${ms}ms)`);
      return res;
    } catch (e) {
      const ms = (performance.now() - start).toFixed(0);
      push(tag, `${method} ${url} ‚úñ ${e.name||'error'} (${ms}ms)`);
      throw e;
    }
  };

  // timers & rAF
  const _setInterval = window.setInterval, _clearInterval = window.clearInterval;
  const _setTimeout  = window.setTimeout,  _clearTimeout  = window.clearTimeout;
  const _raf = window.requestAnimationFrame, _caf = window.cancelAnimationFrame;

  const timers = new Map();
  window.setInterval = function(fn, ms, ...rest){
    const id = _setInterval(function(){ const t0=performance.now(); try{fn()}finally{push('TIMER',`interval ${id} tick ${ (performance.now()-t0).toFixed(1)}ms`)} }, ms, ...rest);
    timers.set(id, {type:'interval', ms}); push('TIMER', `interval ${id} set @ ${ms}ms`); return id;
  };
  window.clearInterval = function(id){ if(timers.has(id)) push('TIMER', `interval ${id} cleared`); return _clearInterval(id); };
  window.setTimeout  = function(fn, ms, ...rest){
    const id = _setTimeout(function(){ const t0=performance.now(); try{fn()}finally{push('TIMER',`timeout ${id} run ${ (performance.now()-t0).toFixed(1)}ms`)} }, ms, ...rest);
    timers.set(id, {type:'timeout', ms}); push('TIMER', `timeout ${id} set @ ${ms}ms`); return id;
  };
  window.clearTimeout = function(id){ if(timers.has(id)) push('TIMER', `timeout ${id} cleared`); return _clearTimeout(id); };
  window.requestAnimationFrame = function(fn){
    return _raf(function(t){ const t0=performance.now(); try{fn(t)}finally{push('TIMER',`rAF ${(performance.now()-t0).toFixed(1)}ms`)} });
  };
  window.cancelAnimationFrame = function(id){ _caf(id); };

  // image load tracing
  function hookImg(img){
    if (!img || img.__dbgHooked) return;
    img.__dbgHooked = true;
    img.addEventListener('load',  ()=> push('IMG', `loaded ${img.id||''} ${img.src}`));
    img.addEventListener('error', ()=> push('IMG', `ERROR  ${img.id||''} ${img.src}`));
  }
  Array.from(document.images).forEach(hookImg);
  const imgObs = new MutationObserver((ms)=>{
    for (const m of ms) for (const n of m.addedNodes) {
      if (n.tagName === 'IMG') hookImg(n);
      else if (n.querySelectorAll) n.querySelectorAll('img').forEach(hookImg);
    }
  });
  imgObs.observe(document.documentElement, {childList:true, subtree:true});

  // bracket observer
  const brows = document.getElementById('brows');
  if (brows) {
    const mo = new MutationObserver((ms)=>{
      let adds = 0, rems = 0;
      for (const m of ms) { adds += m.addedNodes.length; rems += m.removedNodes.length; }
      push('OBS', `bracket changed: +${adds} -${rems} (children=${brows.children.length})`);
    });
    mo.observe(brows, {childList:true, subtree:false});
  }

  // public helpers
  window.RageDebug = {
    log: (k, m) => push(k||'LOG', m||''),
    markStage: (stage, base) => push('STAGE', `mark stage=${stage} base=${base||''}`),
    markPaint: (slot, base) => push('UI', `paint slot=${slot} base=${base||''}`),
    markCounts: (slot, r, b) => push('UI', `counts slot=${slot} r=${r} b=${b}`),
  };

  // small banner
  (console.log||(()=>{}))('Debugger ready');
})();
</script>
<!-- ================== /RAGE DEBUGGER v2 ================== -->
</body>
</html>