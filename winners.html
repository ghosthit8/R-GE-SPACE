<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Winners Log</title>
  <style>
    :root {
      --bg:#0b0d0f; --card:#101418; --muted:#97a1ab; --fg:#e5e7eb; --accent:#39ff14;
      --border:#1f2630; --pill:#0f1822; --danger:#ff0033;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Inter,Roboto,ui-sans-serif;}
    .wrap{max-width:900px;margin:0 auto;padding:18px 14px 100px;}
    h1{margin:0 0 14px 0;font-size:26px;letter-spacing:.3px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#131922;color:#fff;padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:700}
    .btn.ghost{color:#b7c1cc}
    .note{margin-top:8px;color:var(--muted);font-size:12px}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#0d1821;border:1px solid var(--border);font-size:12px;color:#c7d0da}
    .table{margin-top:14px;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--card)}
    .thead,.rowitem{display:grid;grid-template-columns:60px 1.2fr 1.2fr 1.2fr .8fr;align-items:center}
    .thead{background:#0e141a;color:#a9b3bd;font-size:12px;font-weight:700;border-bottom:1px solid var(--border)}
    .thead div,.rowitem>div{padding:10px 12px}
    .rowitem{border-top:1px solid var(--border);font-size:14px}
    .rowitem:nth-child(even){background:#0d1217}
    .idx{opacity:.9;text-align:right;font-variant-numeric:tabular-nums;}
    .seedpill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1620;border:1px solid #1a2430;font-weight:800;color:#d1deea}
    .seedpill .dot{width:8px;height:8px;border-radius:50%;display:inline-block;background:var(--accent)}
    .thumb{display:inline-grid;place-items:center;width:42px;height:42px;border-radius:9px;overflow:hidden;background:#000;border:1px solid var(--border)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .score{font-weight:800;font-variant-numeric:tabular-nums;}
    .back{margin-right:auto}
    .local{display:inline-block;margin-top:8px}
    .warn{color:#ffb4b4}
    .foot{margin-top:10px;color:#8fa0b2;font-size:12px}
    @media (max-width:700px){
      .thead,.rowitem{grid-template-columns:46px 1fr 1fr .9fr .8fr}
      .thead div,.rowitem>div{padding:10px 8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="margin-bottom:6px">
      <button class="btn back" onclick="history.back()">← Back</button>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="clearBtn" class="btn ghost">Clear Data</button>
    </div>

    <h1>Winners Log</h1>
    <div class="note" id="summary">Loading…</div>
    <span id="localTz" class="chip">Local time: …</span>

    <div class="table" id="table" style="display:none">
      <div class="thead">
        <div>#</div>
        <div>Decided At</div>
        <div>Winner</div>
        <div>Thumbnail</div>
        <div>Score</div>
      </div>
      <div id="tbody"></div>
    </div>

    <div class="foot">Shows only <b>Final</b> rows. Quarters/Semis are hidden to keep this clean.</div>
  </div>

  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = "https://tuqvpcevrhciursxrgav.supabase.co";
    const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/global-timer-v2`;
    const ADMIN_CLEAR_KEY = "Inklink88!"; // must match your function

    const elSummary = document.getElementById("summary");
    const elBody = document.getElementById("tbody");
    const elTable = document.getElementById("table");
    const elLocal = document.getElementById("localTz");
    const refreshBtn = document.getElementById("refreshBtn");
    const clearBtn = document.getElementById("clearBtn");

    elLocal.textContent = "Local time: " + Intl.DateTimeFormat([], { timeZoneName:"short"}).format(new Date()).split(" ").pop();

    function isFinalRow(base_iso){
      // Finals use plain base_iso; quarters/semi rows are suffixed with ::q1/::q2/::semi…
      return !String(base_iso||"").includes("::");
    }

    function seedBadge(seed){
      const s = (seed||"?").toUpperCase();
      return `<span class="seedpill"><span class="dot"></span> SEED&nbsp;${s}</span>`;
    }

    function imgTag(url){
      const u = url || "data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='#000'/><text x='50%' y='50%' fill='#39ff14' dy='.35em' text-anchor='middle' font-family='monospace' font-size='18'>?</text></svg>`);
      return `<span class="thumb"><img src="${u}"/></span>`;
    }

    function fmtLocal(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { hour12:true });
    }

    function scoreStr(row){
      // Edge returns red_count and blue_count; display as “R–B”
      const r = Number(row.red_count ?? row.seed_a_count ?? 0);
      const b = Number(row.blue_count ?? row.seed_b_count ?? 0);
      return `${r}–${b}`;
    }

    async function fetchWinners(){
      const res = await fetch(`${FUNCTION_URL}?winners=1&limit=500`, { method:"GET" });
      if(!res.ok) throw new Error("Fetch failed");
      const payload = await res.json();
      return Array.isArray(payload?.winners) ? payload.winners : [];
    }

    function render(rows){
      // finals only
      const finals = rows.filter(r => isFinalRow(r.base_iso));
      // newest on top
      finals.sort((a,b)=> new Date(b.decided_at).getTime() - new Date(a.decided_at).getTime());

      elBody.innerHTML = "";
      let idx = finals.length;
      finals.forEach((w,i)=>{
        const tr = document.createElement("div");
        tr.className = "rowitem";
        tr.innerHTML = `
          <div class="idx">${idx--}</div>
          <div>${fmtLocal(w.decided_at)}</div>
          <div>${seedBadge(w.winner_seed)}</div>
          <div>${imgTag(w.image_url)}</div>
          <div class="score">${scoreStr(w)}</div>
        `;
        elBody.appendChild(tr);
      });

      elTable.style.display = "block";
      if (finals.length === 0){
        elSummary.innerHTML = "No finals yet. Play a round to populate.";
      } else {
        elSummary.innerHTML = `Showing <b>${finals.length}</b> finals • newest is <b>#${finals.length}</b> at top • <b>#1</b> at bottom`;
      }
    }

    async function refresh(){
      elSummary.textContent = "Loading…";
      try{
        const winners = await fetchWinners();
        render(winners);
      }catch(e){
        elSummary.innerHTML = `<span class="warn">Error:</span> ${e.message||e}`;
      }
    }

    async function clearAll(){
      if (!confirm("Clear ALL winners_v2 rows?")) return;
      try{
        const res = await fetch(`${FUNCTION_URL}?clear=1`, {
          method:"DELETE",
          headers: { "x-admin-key": ADMIN_CLEAR_KEY }
        });
        if (!res.ok){
          const t = await res.text();
          alert("Failed to clear: " + t);
          return;
        }
        await refresh();
      }catch(e){
        alert("Error: " + (e.message||e));
      }
    }

    refreshBtn.addEventListener("click", refresh);
    clearBtn.addEventListener("click", clearAll);

    // boot
    refresh();
  </script>
</body>
</html>