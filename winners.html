<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rage Space — Winners</title>
  <style>
    :root { --fg:#e5e7eb; --bg:#0b0d0f; --accent:#39ff14; --muted:#98a2b3; --card:#0f1318; --line:#20242a; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Inter,ui-sans-serif}
    .wrap{max-width:780px;margin:0 auto;padding:16px 12px 24px}
    h1{margin:0 0 10px;font-size:20px;font-weight:800;letter-spacing:.5px}
    .top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
    a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#131920;color:var(--fg);font-weight:700;text-decoration:none;cursor:pointer}
    .meta{color:var(--muted);font-size:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .tz{padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #1a2636;color:#cbd5e1;font-weight:700;font-size:11px;letter-spacing:.06em}
    .seg{display:inline-block;margin-left:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:#cbd5e1;background:#0b1220}
    .card{border:1px solid var(--line);background:var(--card);border-radius:14px;overflow:hidden}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:#cbd5e1;font-weight:700;font-size:12px;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap}
    .pillA{background:#2a1212;border:1px solid #4c2222;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .pillB{background:#0f1f33;border:1px solid #20344d;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .score{font-variant-numeric:tabular-nums;white-space:nowrap;font-weight:700}
    .cycle{word-break:break-all;color:#cbd5e1;opacity:.9}
    .thumb{width:42px;height:42px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
    @media (max-width:560px){
      th.cycle,td.cycle{display:none}
      table{font-size:13px}
      th,td{padding:8px 10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Winners Log</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="matchup.html">← Back</a>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="toggleAuto">Auto-Refresh: On</button>
        <button class="btn" id="toggleMode">Mode: All Phases</button>
        <button class="btn" id="clear">Clear Data</button>
      </div>
    </div>

    <div class="meta" id="meta">
      Loading…
      <span class="tz" id="tzBadge"></span>
      <span class="seg">Cycle: R32@120s → R16@90s → QF@60s → SF@30s → Final@0s</span>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Decided At</th>
              <th>Phase</th>
              <th class="cycle">Cycle</th>
              <th>Winner</th>
              <th>Thumbnail</th>
              <th>Score</th>
              <th>Decided By</th>
            </tr>
          </thead>
          <tbody id="body">
            <tr><td colspan="8" style="padding:18px;color:#9aa0a6;">Loading winners…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // -------- config --------
    const FUNCTION_URL = "https://tuqvpcevrhciursxrgav.supabase.co/functions/v1/global-timer-v2";
    const ADMIN_KEY = "Inklink88!";

    const metaEl = document.getElementById('meta');
    const tzBadge = document.getElementById('tzBadge');
    const tbody  = document.getElementById('body');
    const btnRefresh = document.getElementById('refresh');
    const btnToggleAuto = document.getElementById('toggleAuto');
    const btnToggleMode = document.getElementById('toggleMode');
    const btnClear = document.getElementById('clear');

    // persistent view mode
    const MODE_KEY = "winners_mode_v2"; // "all" | "finals"
    let viewMode = localStorage.getItem(MODE_KEY) || "all";
    function applyModeBtn(){
      btnToggleMode.textContent = viewMode==="all" ? "Mode: All Phases" : "Mode: Finals Only";
    }
    applyModeBtn();

    btnToggleMode.onclick = () => { viewMode = (viewMode==="all" ? "finals" : "all"); localStorage.setItem(MODE_KEY, viewMode); applyModeBtn(); load(true); };
    btnRefresh.onclick = () => load(true);
    btnToggleAuto.onclick = () => {
      auto = !auto;
      btnToggleAuto.textContent = `Auto-Refresh: ${auto ? "On" : "Off"}`;
    };
    btnClear.onclick = clearData;

    // timezone badge
    try {
      const fmt = new Intl.DateTimeFormat(undefined, { timeZoneName: "short" });
      const tz = fmt.formatToParts(new Date()).find(p=>p.type==="timeZoneName")?.value || "";
      tzBadge.textContent = tz ? `Local time: ${tz}` : "Local time";
    } catch { tzBadge.textContent = "Local time"; }

    // --- helpers ---
    function parseAsUTCish(s){
      if (!s) return NaN;
      const str = String(s);
      if (/Z|[+-]\d{2}:\d{2}$/.test(str)) return Date.parse(str);
      return Date.parse(str.replace(" ", "T") + "Z");
    }
    function fmtLocal(ts){
      if (isNaN(ts)) return "—";
      return new Date(ts).toLocaleString(undefined, {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"numeric", minute:"2-digit", second:"2-digit", hour12:true
      });
    }
    function phaseFromBase(base){
      const s = String(base||"");
      if (!s.includes("::")) return "Final";
      const suf = s.split("::")[1];
      const map = { q1:"Quarter 1", q2:"Quarter 2", q3:"Quarter 3", q4:"Quarter 4",
                    semi1:"Semi 1", semi2:"Semi 2" };
      if (suf.startsWith("r32_")) return "R32 " + suf.split("_")[1];
      return map[suf] || suf.toUpperCase();
    }
    function computeDecidedAt(row){
      const d = parseAsUTCish(row.decided_at);
      if (!isNaN(d)) return d;
      const base = parseAsUTCish(row.base_iso);
      if (!isNaN(base)) {
        const secs = Number(row.period_sec) > 0 ? Number(row.period_sec) : 150;
        return base + secs * 1000;
      }
      return NaN;
    }
    function isFinalRow(w){ return !String(w.base_iso || "").includes("::"); }

    // LETTER → NUMBER mapping for 32 seeds:
    const L32 = [..."abcdefghijklmnopqrstuvwxyz".split(""), "aa","ab","ac","ad","ae","af"];
    const L2N = Object.fromEntries(L32.map((s,i)=>[s, i+1]));

    // Build a map per cycle: image_url → original seed (a..af)
    function buildUrlToSeedMap(all){
      const byCycle = new Map(); // cycleBase -> Map(url -> seedLetter)
      for (const r of all){
        const base = String(r.base_iso||"");
        const root = base.split("::")[0];
        if (!byCycle.has(root)) byCycle.set(root, new Map());
        if (base.includes("::r16_") || base.includes("::r32_")){
          const url = r.image_url || r.winner_url || "";
          const seed = (r.winner_seed || "").toLowerCase();
          if (url && seed) byCycle.get(root).set(url, seed);
        }
      }
      return byCycle;
    }

    function render(rows){
      if(!rows || rows.length===0){
        tbody.innerHTML = `<tr><td colspan="8" style="padding:18px;color:#9aa0a6;">No winners yet.</td></tr>`;
        return;
      }
      const N = rows.length;
      tbody.innerHTML = rows.map((r, idx) => {
        const n = N - idx;

        const seedLetter = (r._resolved_seed || r.winner_seed || "").toLowerCase();
        const seedNum = L2N[seedLetter];
        const seedLabel = seedNum ? `Seed #${seedNum}` : "Seed ?";

        const leftLetters = new Set(["a","c","e","g","i","k","m","o","q","s","u","w","y","aa","ac","ae"]);
        const isLeft = leftLetters.has(seedLetter);
        const pillClass = isLeft ? "pillA" : "pillB";

        const by = r.decided_by === 'random_tie' ? 'random tie' : 'votes';
        const score = `${r.red_count ?? 0}–${r.blue_count ?? 0}`;
        const img = r.image_url || r.winner_url || '';
        const thumb = img ? `<img src="${img}" class="thumb" alt="winner">` : `<span style="color:#666;">—</span>`;
        const decidedTs = computeDecidedAt(r);
        const phase = phaseFromBase(r.base_iso);

        return `
          <tr>
            <td>${n}</td>
            <td>${fmtLocal(decidedTs)}</td>
            <td>${phase}</td>
            <td class="cycle">${r.base_iso || "—"}</td>
            <td><span class="${pillClass}">${seedLabel}</span></td>
            <td>${thumb}</td>
            <td class="score">${score}</td>
            <td>${by}</td>
          </tr>`;
      }).join('');
    }

    // ------------- Robust loader (CORS-safe) -------------
    let currentLoadAbort;
    async function load(force=false){
      try {
        if (currentLoadAbort) currentLoadAbort.abort();
        currentLoadAbort = new AbortController();
        const { signal } = currentLoadAbort;

        btnRefresh.disabled = true;
        metaEl.firstChild ? metaEl.firstChild.nodeValue = 'Loading… ' : (metaEl.textContent = 'Loading… ');

        // Cache-buster & no-store; DO NOT send extra headers (they trigger CORS preflight failures)
        const ts = Date.now();
        const res = await fetch(`${FUNCTION_URL}?winners=1&limit=500&_=${ts}`, {
          cache: "no-store",
          mode: "cors",
          credentials: "omit",
          signal
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json().catch(()=> ({}));
        const all = Array.isArray(data) ? data : (data.winners || []);

        // Resolve original seeds by matching image_url back to R32/R16 rows
        const mapByCycle = buildUrlToSeedMap(all);
        for (const r of all){
          const root = String(r.base_iso||"").split("::")[0];
          const url = r.image_url || r.winner_url || "";
          const m = mapByCycle.get(root);
          if (m && url && m.has(url)){
            r._resolved_seed = m.get(url); // letter a..af
          }
        }

        const rows = viewMode==="finals" ? (all||[]).filter(isFinalRow) : (all||[]);
        rows.sort((a,b) => computeDecidedAt(b) - computeDecidedAt(a));
        render(rows);

        const total = rows.length;
        const newest = rows[0];
        const newestTs = newest ? computeDecidedAt(newest) : NaN;
        const prefix = `Showing ${total} ${viewMode==="finals"?"finals":"winners"}`;
        const newestTxt = isNaN(newestTs) ? '' : ` • newest at ${fmtLocal(newestTs)}`;
        const tail = total ? ` • newest is #${total} at top • #1 at bottom` : '';
        metaEl.firstChild
          ? metaEl.firstChild.nodeValue = `${prefix}${newestTxt}${tail} `
          : (metaEl.textContent = `${prefix}${newestTxt}${tail} `);
      } catch (e) {
        console.error("Winners load error:", e);
        tbody.innerHTML = `<tr><td colspan="8" style="padding:18px;color:#ef4444;">Error loading winners.</td></tr>`;
      } finally {
        btnRefresh.disabled = false;
      }
    }

    async function clearData(){
      try {
        const ok = confirm("Delete winners_v2 and reset cycle counts? (Admin)");
        if (!ok) return;
        await fetch(`${FUNCTION_URL}?clear=1`, {
          method:"DELETE",
          headers:{ "x-admin-key": ADMIN_KEY }
        });
        await load(true);
      } catch(e){
        alert("Clear failed.");
      }
    }

    // auto-refresh
    let auto = true;
    setInterval(()=>{ if (auto) load(false); }, 5000);

    // initial
    load(true);
  </script>
</body>
</html>